<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Leptonica: src/jbclass.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="moller52-tiny.jpg"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Leptonica&#160;<span id="projectnumber">1.68</span></div>
   <div id="projectbrief">C Image Processing Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('jbclass_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>jbclass.c</h1>  </div>
</div>
<div class="contents">
<a href="jbclass_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*====================================================================*</span>
<a name="l00002"></a>00002 <span class="comment"> -  Copyright (C) 2001 Leptonica.  All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> -  This software is distributed in the hope that it will be</span>
<a name="l00004"></a>00004 <span class="comment"> -  useful, but with NO WARRANTY OF ANY KIND.</span>
<a name="l00005"></a>00005 <span class="comment"> -  No author or distributor accepts responsibility to anyone for the</span>
<a name="l00006"></a>00006 <span class="comment"> -  consequences of using this software, or for whether it serves any</span>
<a name="l00007"></a>00007 <span class="comment"> -  particular purpose or works at all, unless he or she says so in</span>
<a name="l00008"></a>00008 <span class="comment"> -  writing.  Everyone is granted permission to copy, modify and</span>
<a name="l00009"></a>00009 <span class="comment"> -  redistribute this source code, for commercial or non-commercial</span>
<a name="l00010"></a>00010 <span class="comment"> -  purposes, with the following restrictions: (1) the origin of this</span>
<a name="l00011"></a>00011 <span class="comment"> -  source code must not be misrepresented; (2) modified versions must</span>
<a name="l00012"></a>00012 <span class="comment"> -  be plainly marked as such; and (3) this notice may not be removed</span>
<a name="l00013"></a>00013 <span class="comment"> -  or altered from any source or modified source distribution.</span>
<a name="l00014"></a>00014 <span class="comment"> *====================================================================*/</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment">/*</span>
<a name="l00018"></a>00018 <span class="comment"> * jbclass.c</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> *     These are functions for unsupervised classification of</span>
<a name="l00021"></a>00021 <span class="comment"> *     collections of connected components -- either characters or</span>
<a name="l00022"></a>00022 <span class="comment"> *     words -- in binary images.  They can be used as image</span>
<a name="l00023"></a>00023 <span class="comment"> *     processing steps in jbig2 compression.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> *     Initialization</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> *         JBCLASSER         *jbRankHausInit()      [rank hausdorff encoder]</span>
<a name="l00028"></a>00028 <span class="comment"> *         JBCLASSER         *jbCorrelationInit()   [correlation encoder]</span>
<a name="l00029"></a>00029 <span class="comment"> *         JBCLASSER         *jbCorrelationInitWithoutComponents()  [ditto]</span>
<a name="l00030"></a>00030 <span class="comment"> *         static JBCLASSER  *jbCorrelationInitInternal()</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> *     Classify the pages</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *         l_int32     jbAddPages()</span>
<a name="l00035"></a>00035 <span class="comment"> *         l_int32     jbAddPage()</span>
<a name="l00036"></a>00036 <span class="comment"> *         l_int32     jbAddPageComponents()</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *     Rank hausdorff classifier</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> *         l_int32     jbClassifyRankHaus()</span>
<a name="l00041"></a>00041 <span class="comment"> *         l_int32     pixHaustest()</span>
<a name="l00042"></a>00042 <span class="comment"> *         l_int32     pixRankHaustest()</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> *     Binary correlation classifier</span>
<a name="l00045"></a>00045 <span class="comment"> *</span>
<a name="l00046"></a>00046 <span class="comment"> *         l_int32     jbClassifyCorrelation()</span>
<a name="l00047"></a>00047 <span class="comment"> *</span>
<a name="l00048"></a>00048 <span class="comment"> *     Determine the image components we start with</span>
<a name="l00049"></a>00049 <span class="comment"> *</span>
<a name="l00050"></a>00050 <span class="comment"> *         l_int32     jbGetComponents()</span>
<a name="l00051"></a>00051 <span class="comment"> *         PIX        *pixWordMaskByDilation()</span>
<a name="l00052"></a>00052 <span class="comment"> *</span>
<a name="l00053"></a>00053 <span class="comment"> *     Build grayscale composites (templates)</span>
<a name="l00054"></a>00054 <span class="comment"> *</span>
<a name="l00055"></a>00055 <span class="comment"> *         PIXA       *jbAccumulateComposites</span>
<a name="l00056"></a>00056 <span class="comment"> *         PIXA       *jbTemplatesFromComposites</span>
<a name="l00057"></a>00057 <span class="comment"> *</span>
<a name="l00058"></a>00058 <span class="comment"> *     Utility functions for Classer</span>
<a name="l00059"></a>00059 <span class="comment"> *</span>
<a name="l00060"></a>00060 <span class="comment"> *         JBCLASSER  *jbClasserCreate()</span>
<a name="l00061"></a>00061 <span class="comment"> *         void        jbClasserDestroy()</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *     Utility functions for Data</span>
<a name="l00064"></a>00064 <span class="comment"> *</span>
<a name="l00065"></a>00065 <span class="comment"> *         JBDATA     *jbDataSave()</span>
<a name="l00066"></a>00066 <span class="comment"> *         void        jbDataDestroy()</span>
<a name="l00067"></a>00067 <span class="comment"> *         l_int32     jbDataWrite()</span>
<a name="l00068"></a>00068 <span class="comment"> *         JBDATA     *jbDataRead()</span>
<a name="l00069"></a>00069 <span class="comment"> *         PIXA       *jbDataRender()</span>
<a name="l00070"></a>00070 <span class="comment"> *         l_int32     jbGetULCorners()</span>
<a name="l00071"></a>00071 <span class="comment"> *         l_int32     jbGetLLCorners()</span>
<a name="l00072"></a>00072 <span class="comment"> *</span>
<a name="l00073"></a>00073 <span class="comment"> *     Static helpers</span>
<a name="l00074"></a>00074 <span class="comment"> *</span>
<a name="l00075"></a>00075 <span class="comment"> *         static JBFINDCTX *findSimilarSizedTemplatesInit()</span>
<a name="l00076"></a>00076 <span class="comment"> *         static l_int32    findSimilarSizedTemplatesNext()</span>
<a name="l00077"></a>00077 <span class="comment"> *         static void       findSimilarSizedTemplatesDestroy()</span>
<a name="l00078"></a>00078 <span class="comment"> *         static l_int32    finalPositioningForAlignment()</span>
<a name="l00079"></a>00079 <span class="comment"> *</span>
<a name="l00080"></a>00080 <span class="comment"> *     Note: this is NOT an implementation of the JPEG jbig2</span>
<a name="l00081"></a>00081 <span class="comment"> *     proposed standard encoder, the specifications for which</span>
<a name="l00082"></a>00082 <span class="comment"> *     can be found at http://www.jpeg.org/jbigpt2.html.</span>
<a name="l00083"></a>00083 <span class="comment"> *     (See below for a full implementation.)</span>
<a name="l00084"></a>00084 <span class="comment"> *     It is an implementation of the lower-level part of an encoder that:</span>
<a name="l00085"></a>00085 <span class="comment"> *</span>
<a name="l00086"></a>00086 <span class="comment"> *        (1) identifies connected components that are going to be used</span>
<a name="l00087"></a>00087 <span class="comment"> *        (2) puts them in similarity classes (this is an unsupervised</span>
<a name="l00088"></a>00088 <span class="comment"> *            classifier), and</span>
<a name="l00089"></a>00089 <span class="comment"> *        (3) stores the result in a simple file format (2 files,</span>
<a name="l00090"></a>00090 <span class="comment"> *            one for templates and one for page/coordinate/template-index</span>
<a name="l00091"></a>00091 <span class="comment"> *            quartets).</span>
<a name="l00092"></a>00092 <span class="comment"> *</span>
<a name="l00093"></a>00093 <span class="comment"> *     An actual implementation of the official jbig2 encoder could</span>
<a name="l00094"></a>00094 <span class="comment"> *     start with parts (1) and (2), and would then compress the quartets</span>
<a name="l00095"></a>00095 <span class="comment"> *     according to the standards requirements (e.g., Huffman or</span>
<a name="l00096"></a>00096 <span class="comment"> *     arithmetic coding of coordinate differences and image templates).</span>
<a name="l00097"></a>00097 <span class="comment"> *</span>
<a name="l00098"></a>00098 <span class="comment"> *     The low-level part of the encoder provided here has the</span>
<a name="l00099"></a>00099 <span class="comment"> *     following useful features:</span>
<a name="l00100"></a>00100 <span class="comment"> *</span>
<a name="l00101"></a>00101 <span class="comment"> *         - It is accurate in the identification of templates</span>
<a name="l00102"></a>00102 <span class="comment"> *           and classes because it uses a windowed hausdorff</span>
<a name="l00103"></a>00103 <span class="comment"> *           distance metric.</span>
<a name="l00104"></a>00104 <span class="comment"> *         - It is accurate in the placement of the connected</span>
<a name="l00105"></a>00105 <span class="comment"> *           components, doing a two step process of first aligning</span>
<a name="l00106"></a>00106 <span class="comment"> *           the the centroids of the template with those of each instance,</span>
<a name="l00107"></a>00107 <span class="comment"> *           and then making a further correction of up to +- 1 pixel</span>
<a name="l00108"></a>00108 <span class="comment"> *           in each direction to best align the templates.</span>
<a name="l00109"></a>00109 <span class="comment"> *         - It is fast because it uses a morphologically based</span>
<a name="l00110"></a>00110 <span class="comment"> *           matching algorithm to implement the hausdorff criterion,</span>
<a name="l00111"></a>00111 <span class="comment"> *           and it selects the patterns that are possible matches</span>
<a name="l00112"></a>00112 <span class="comment"> *           based on their size.</span>
<a name="l00113"></a>00113 <span class="comment"> *</span>
<a name="l00114"></a>00114 <span class="comment"> *     We provide two different matching functions, one using Hausdorff</span>
<a name="l00115"></a>00115 <span class="comment"> *     distance and one using a simple image correlation.</span>
<a name="l00116"></a>00116 <span class="comment"> *     The Hausdorff method sometimes produces better results for the</span>
<a name="l00117"></a>00117 <span class="comment"> *     same number of classes, because it gives a relatively small</span>
<a name="l00118"></a>00118 <span class="comment"> *     effective weight to foreground pixels near the boundary,</span>
<a name="l00119"></a>00119 <span class="comment"> *     and a relatively  large weight to foreground pixels that are</span>
<a name="l00120"></a>00120 <span class="comment"> *     not near the boundary.  By effectively ignoring these boundary</span>
<a name="l00121"></a>00121 <span class="comment"> *     pixels, Hausdorff weighting corresponds better to the expected</span>
<a name="l00122"></a>00122 <span class="comment"> *     probabilities of the pixel values in a scanned image, where the</span>
<a name="l00123"></a>00123 <span class="comment"> *     variations in instances of the same printed character are much</span>
<a name="l00124"></a>00124 <span class="comment"> *     more likely to be in pixels near the boundary.  By contrast,</span>
<a name="l00125"></a>00125 <span class="comment"> *     the correlation method gives equal weight to all foreground pixels.</span>
<a name="l00126"></a>00126 <span class="comment"> *</span>
<a name="l00127"></a>00127 <span class="comment"> *     For best results, use the correlation method.  Correlation takes</span>
<a name="l00128"></a>00128 <span class="comment"> *     the number of fg pixels in the AND of instance and template,</span>
<a name="l00129"></a>00129 <span class="comment"> *     divided by the product of the number of fg pixels in instance</span>
<a name="l00130"></a>00130 <span class="comment"> *     and template.  It compares this with a threshold that, in</span>
<a name="l00131"></a>00131 <span class="comment"> *     general, depends on the fractional coverage of the template.</span>
<a name="l00132"></a>00132 <span class="comment"> *     For heavy text, the threshold is raised above that for light</span>
<a name="l00133"></a>00133 <span class="comment"> *     text,  By using both these parameters (basic threshold and</span>
<a name="l00134"></a>00134 <span class="comment"> *     adjustment factor for text weight), one has more flexibility</span>
<a name="l00135"></a>00135 <span class="comment"> *     and can arrive at the fewest substitution errors, although</span>
<a name="l00136"></a>00136 <span class="comment"> *     this comes at the price of more templates.</span>
<a name="l00137"></a>00137 <span class="comment"> *</span>
<a name="l00138"></a>00138 <span class="comment"> *     The strict Hausdorff scoring is not a rank weighting, because a</span>
<a name="l00139"></a>00139 <span class="comment"> *     single pixel beyond the given distance will cause a match</span>
<a name="l00140"></a>00140 <span class="comment"> *     failure.  A rank Hausdorff is more robust to non-boundary noise,</span>
<a name="l00141"></a>00141 <span class="comment"> *     but it is also more susceptible to confusing components that</span>
<a name="l00142"></a>00142 <span class="comment"> *     should be in different classes.  For implementing a jbig2</span>
<a name="l00143"></a>00143 <span class="comment"> *     application for visually lossless binary image compression,</span>
<a name="l00144"></a>00144 <span class="comment"> *     you have two choices:</span>
<a name="l00145"></a>00145 <span class="comment"> *</span>
<a name="l00146"></a>00146 <span class="comment"> *        (1) use a 3x3 structuring element (size = 3) and a strict</span>
<a name="l00147"></a>00147 <span class="comment"> *            Hausdorff comparison (rank = 1.0 in the rank Hausdorff</span>
<a name="l00148"></a>00148 <span class="comment"> *            function).  This will result in a minimal number of classes,</span>
<a name="l00149"></a>00149 <span class="comment"> *            but confusion of small characters, such as italic and</span>
<a name="l00150"></a>00150 <span class="comment"> *            non-italic lower-case &#39;o&#39;, can still occur.</span>
<a name="l00151"></a>00151 <span class="comment"> *        (2) use the correlation method with a threshold of 0.85</span>
<a name="l00152"></a>00152 <span class="comment"> *            and a weighting factor of about 0.7.  This will result in</span>
<a name="l00153"></a>00153 <span class="comment"> *            a larger number of classes, but should not be confused</span>
<a name="l00154"></a>00154 <span class="comment"> *            either by similar small characters or by extremely</span>
<a name="l00155"></a>00155 <span class="comment"> *            thick sans serif characters, such as in prog/cootoots.png.</span>
<a name="l00156"></a>00156 <span class="comment"> *</span>
<a name="l00157"></a>00157 <span class="comment"> *     As mentioned above, if visual substitution errors must be</span>
<a name="l00158"></a>00158 <span class="comment"> *     avoided, you should use the correlation method.</span>
<a name="l00159"></a>00159 <span class="comment"> *</span>
<a name="l00160"></a>00160 <span class="comment"> *     We provide executables that show how to do the encoding:</span>
<a name="l00161"></a>00161 <span class="comment"> *         prog/jbrankhaus.c</span>
<a name="l00162"></a>00162 <span class="comment"> *         prog/jbcorrelation.c</span>
<a name="l00163"></a>00163 <span class="comment"> *</span>
<a name="l00164"></a>00164 <span class="comment"> *     The basic flow for correlation classification goes as follows,</span>
<a name="l00165"></a>00165 <span class="comment"> *     where specific choices have been made for parameters (Hausdorff</span>
<a name="l00166"></a>00166 <span class="comment"> *     is the same except for initialization):</span>
<a name="l00167"></a>00167 <span class="comment"> *</span>
<a name="l00168"></a>00168 <span class="comment"> *             // Initialize and save data in the classer</span>
<a name="l00169"></a>00169 <span class="comment"> *         JBCLASSER *classer =</span>
<a name="l00170"></a>00170 <span class="comment"> *             jbCorrelationInit(JB_CONN_COMPS, 0, 0, 0.8, 0.7);</span>
<a name="l00171"></a>00171 <span class="comment"> *         SARRAY *safiles = getSortedPathnamesInDirectory(directory,</span>
<a name="l00172"></a>00172 <span class="comment"> *                                                         NULL, 0, 0);</span>
<a name="l00173"></a>00173 <span class="comment"> *         jbAddPages(classer, safiles);</span>
<a name="l00174"></a>00174 <span class="comment"> *</span>
<a name="l00175"></a>00175 <span class="comment"> *             // Save the data in a data structure for serialization,</span>
<a name="l00176"></a>00176 <span class="comment"> *             // and write it into two files.</span>
<a name="l00177"></a>00177 <span class="comment"> *         JBDATA *data = jbDataSave(classer);</span>
<a name="l00178"></a>00178 <span class="comment"> *         jbDataWrite(rootname, data);</span>
<a name="l00179"></a>00179 <span class="comment"> *</span>
<a name="l00180"></a>00180 <span class="comment"> *             // Reconstruct (render) the pages from the encoded data.</span>
<a name="l00181"></a>00181 <span class="comment"> *         PIXA *pixa = jbDataRender(data, FALSE);</span>
<a name="l00182"></a>00182 <span class="comment"> *</span>
<a name="l00183"></a>00183 <span class="comment"> *     Adam Langley has recently built a jbig2 standards-compliant</span>
<a name="l00184"></a>00184 <span class="comment"> *     encoder, the first one to appear in open source.  You can get</span>
<a name="l00185"></a>00185 <span class="comment"> *     this encoder at:</span>
<a name="l00186"></a>00186 <span class="comment"> *</span>
<a name="l00187"></a>00187 <span class="comment"> *          http://www.imperialviolet.org/jbig2.html</span>
<a name="l00188"></a>00188 <span class="comment"> *</span>
<a name="l00189"></a>00189 <span class="comment"> *     It uses arithmetic encoding throughout.  It encodes binary images</span>
<a name="l00190"></a>00190 <span class="comment"> *     losslessly with a single arithmetic coding over the full image.</span>
<a name="l00191"></a>00191 <span class="comment"> *     It also does both lossy and lossless encoding from connected</span>
<a name="l00192"></a>00192 <span class="comment"> *     components, using leptonica to generate the templates representing</span>
<a name="l00193"></a>00193 <span class="comment"> *     each cluster.</span>
<a name="l00194"></a>00194 <span class="comment"> */</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00197"></a>00197 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00198"></a>00198 <span class="preprocessor">#include &quot;<a class="code" href="allheaders_8h.html" title="Includes all required Leptonica header files.">allheaders.h</a>&quot;</span>
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="comment">/* MSVC can&#39;t handle arrays dimensioned by static const integers */</span>
<a name="l00201"></a><a class="code" href="jbclass_8c.html#af1791633b3a1a12a9aa449aa6d558327">00201</a> <span class="preprocessor">#define  L_BUF_SIZE  512</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>
<a name="l00203"></a>00203     <span class="comment">/* For jbClassifyRankHaus(): size of border added around</span>
<a name="l00204"></a>00204 <span class="comment">     * pix of each c.c., to allow further processing.  This</span>
<a name="l00205"></a>00205 <span class="comment">     * should be at least the sum of the MAX_DIFF_HEIGHT</span>
<a name="l00206"></a>00206 <span class="comment">     * (or MAX_DIFF_WIDTH) and one-half the size of the Sel  */</span>
<a name="l00207"></a><a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">00207</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a> = 6;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="comment">/* For pixHaustest(), pixRankHaustest() and pixCorrelationScore():</span>
<a name="l00210"></a>00210 <span class="comment">     * choose these to be 2 or greater */</span>
<a name="l00211"></a><a class="code" href="jbclass_8c.html#adc7490eefcd583ef090d7846e062b311">00211</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="jbclass_8c.html#adc7490eefcd583ef090d7846e062b311">MAX_DIFF_WIDTH</a> = 2;  <span class="comment">/* use at least 2 */</span>
<a name="l00212"></a><a class="code" href="jbclass_8c.html#ac889e8e6a5db45e2d611c17dcfc06830">00212</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="jbclass_8c.html#ac889e8e6a5db45e2d611c17dcfc06830">MAX_DIFF_HEIGHT</a> = 2;  <span class="comment">/* use at least 2 */</span>
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="comment">/* In initialization, you have the option to discard components</span>
<a name="l00215"></a>00215 <span class="comment">     * (cc, characters or words) that have either width or height larger</span>
<a name="l00216"></a>00216 <span class="comment">     * than a given size.  This is convenient for jbDataSave(), because</span>
<a name="l00217"></a>00217 <span class="comment">     * the components are placed onto a regular lattice with cell</span>
<a name="l00218"></a>00218 <span class="comment">     * dimension equal to the maximum component size.  The default</span>
<a name="l00219"></a>00219 <span class="comment">     * values are given here.  If you want to save all components,</span>
<a name="l00220"></a>00220 <span class="comment">     * use a sufficiently large set of dimensions. */</span>
<a name="l00221"></a><a class="code" href="jbclass_8c.html#a1c84786c33ecbc6cb3874a88adae07ff">00221</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="jbclass_8c.html#a1c84786c33ecbc6cb3874a88adae07ff">MAX_CONN_COMP_WIDTH</a> = 350;  <span class="comment">/* default max cc width */</span>
<a name="l00222"></a><a class="code" href="jbclass_8c.html#af85a52071ffe96bddd49d52010646f28">00222</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="jbclass_8c.html#af85a52071ffe96bddd49d52010646f28">MAX_CHAR_COMP_WIDTH</a> = 350;  <span class="comment">/* default max char width */</span>
<a name="l00223"></a><a class="code" href="jbclass_8c.html#a400343963c507d6bacac7ddbf11195f5">00223</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="jbclass_8c.html#a400343963c507d6bacac7ddbf11195f5">MAX_WORD_COMP_WIDTH</a> = 1000;  <span class="comment">/* default max word width */</span>
<a name="l00224"></a><a class="code" href="jbclass_8c.html#a8d73dbb42dcb113808335fbac75d248f">00224</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="jbclass_8c.html#a8d73dbb42dcb113808335fbac75d248f">MAX_COMP_HEIGHT</a> = 120;  <span class="comment">/* default max component height */</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">/* Max allowed dilation to merge characters into words */</span>
<a name="l00227"></a><a class="code" href="jbclass_8c.html#aea03502e6165da8502f438a16b430dfb">00227</a> <span class="preprocessor">#define  MAX_ALLOWED_DILATION  14</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span>
<a name="l00229"></a>00229     <span class="comment">/* This stores the state of a state machine which fetches</span>
<a name="l00230"></a>00230 <span class="comment">     * similar sized templates */</span>
<a name="l00231"></a><a class="code" href="struct_jb_find_templates_state.html">00231</a> <span class="keyword">struct </span><a class="code" href="struct_jb_find_templates_state.html">JbFindTemplatesState</a>
<a name="l00232"></a>00232 {
<a name="l00233"></a><a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">00233</a>     <a class="code" href="struct_jb_classer.html">JBCLASSER</a>       *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;    <span class="comment">/* classer                               */</span>
<a name="l00234"></a><a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">00234</a>     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>          <a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a>;          <span class="comment">/* desired width                         */</span>
<a name="l00235"></a><a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">00235</a>     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>          <a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a>;          <span class="comment">/* desired height                        */</span>
<a name="l00236"></a><a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">00236</a>     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>          <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>;          <span class="comment">/* index into two_by_two step array      */</span>
<a name="l00237"></a><a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">00237</a>     <a class="code" href="struct_numa.html">NUMA</a>            *<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a>;       <span class="comment">/* current number array                  */</span>
<a name="l00238"></a><a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">00238</a>     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>          <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>;          <span class="comment">/* current element of numa               */</span>
<a name="l00239"></a>00239 };
<a name="l00240"></a><a class="code" href="jbclass_8c.html#a55af54c40f3f30c77cf1f683524ac820">00240</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct_jb_find_templates_state.html">JbFindTemplatesState</a> <a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="comment">/* Static initialization function */</span>
<a name="l00244"></a>00244 <span class="keyword">static</span> <a class="code" href="struct_jb_classer.html">JBCLASSER</a> * <a class="code" href="jbclass_8c.html#ac3160c2a27d31616088d1aa014b35f4f">jbCorrelationInitInternal</a>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> components,
<a name="l00245"></a>00245                        <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> maxwidth, <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> maxheight, <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a> thresh,
<a name="l00246"></a>00246                        <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a> weightfactor, <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> keep_components);
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="comment">/* Static helper functions */</span>
<a name="l00249"></a>00249 <span class="keyword">static</span> <a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a> * <a class="code" href="jbclass_8c.html#a47a48f9129c3e9295d496e5e623d107d">findSimilarSizedTemplatesInit</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>, <a class="code" href="struct_pix.html">PIX</a> *pixs);
<a name="l00250"></a>00250 <span class="keyword">static</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> <a class="code" href="jbclass_8c.html#a0b32c0b0c58c190fce595dcb8bc51853">findSimilarSizedTemplatesNext</a>(<a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a> *context);
<a name="l00251"></a>00251 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="jbclass_8c.html#a87378eb1cec7b96091aa115ad78890ba">findSimilarSizedTemplatesDestroy</a>(<a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a> **pcontext);
<a name="l00252"></a>00252 <span class="keyword">static</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> <a class="code" href="jbclass_8c.html#a1daded8379f0aae4dc6b60e7b33b89ee">finalPositioningForAlignment</a>(<a class="code" href="struct_pix.html">PIX</a> *pixs, <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> x, <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> y,
<a name="l00253"></a>00253                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> idelx, <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> idely, <a class="code" href="struct_pix.html">PIX</a> *pixt,
<a name="l00254"></a>00254                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *sumtab, <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *pdx, <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *pdy);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="preprocessor">#ifndef NO_CONSOLE_IO</span>
<a name="l00257"></a><a class="code" href="jbclass_8c.html#a6e537cf1f668ec40fc7791d3553e64b4">00257</a> <span class="preprocessor"></span><span class="preprocessor">#define  DEBUG_PLOT_CC             0</span>
<a name="l00258"></a><a class="code" href="jbclass_8c.html#a48853117643bbae12c0e80904e2bef41">00258</a> <span class="preprocessor"></span><span class="preprocessor">#define  DEBUG_CORRELATION_SCORE   0</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">#endif  </span><span class="comment">/* ~NO_CONSOLE_IO */</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l00263"></a>00263 <span class="comment"> *                            Initialization                            *</span>
<a name="l00264"></a>00264 <span class="comment"> *----------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00265"></a>00265 <span class="comment">/*!</span>
<a name="l00266"></a>00266 <span class="comment"> *  jbRankHausInit()</span>
<a name="l00267"></a>00267 <span class="comment"> *</span>
<a name="l00268"></a>00268 <span class="comment"> *      Input:  components (JB_CONN_COMPS, JB_CHARACTERS, JB_WORDS)</span>
<a name="l00269"></a>00269 <span class="comment"> *              maxwidth (of component; use 0 for default)</span>
<a name="l00270"></a>00270 <span class="comment"> *              maxheight (of component; use 0 for default)</span>
<a name="l00271"></a>00271 <span class="comment"> *              size  (of square structuring element; 2, representing</span>
<a name="l00272"></a>00272 <span class="comment"> *                     2x2 sel, is necessary for reasonable accuracy of</span>
<a name="l00273"></a>00273 <span class="comment"> *                     small components; combine this with rank ~ 0.97</span>
<a name="l00274"></a>00274 <span class="comment"> *                     to avoid undue class expansion)</span>
<a name="l00275"></a>00275 <span class="comment"> *              rank (rank val of match, each way; in [0.5 - 1.0];</span>
<a name="l00276"></a>00276 <span class="comment"> *                    when using size = 2, 0.97 is a reasonable value)</span>
<a name="l00277"></a>00277 <span class="comment"> *      Return: jbclasser if OK; NULL on error</span>
<a name="l00278"></a>00278 <span class="comment"> */</span>
<a name="l00279"></a>00279 <a class="code" href="struct_jb_classer.html">JBCLASSER</a> *
<a name="l00280"></a><a class="code" href="leptprotos_8h.html#a1abc539257fae351d2c18f5640bd3096">00280</a> <a class="code" href="jbclass_8c.html#a931c9f565b503871ce6d7ebad9655362">jbRankHausInit</a>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    components,
<a name="l00281"></a>00281                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxwidth,
<a name="l00282"></a>00282                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxheight,
<a name="l00283"></a>00283                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>,
<a name="l00284"></a>00284                <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  rank)
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286 <a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbRankHausInit&quot;</span>);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="keywordflow">if</span> (components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a27e7cdfb87413a6d3686bebc93a3dac6">JB_CONN_COMPS</a> &amp;&amp; components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad563d0eeaf2c300cf43b05c2e6871708">JB_CHARACTERS</a> &amp;&amp;
<a name="l00291"></a>00291         components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a130c542f7784940fd858243d1c05b898">JB_WORDS</a>)
<a name="l00292"></a>00292         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;invalid components&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00293"></a>00293     <span class="keywordflow">if</span> (size &lt; 1 || size &gt; 10)
<a name="l00294"></a>00294         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;size not reasonable&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00295"></a>00295     <span class="keywordflow">if</span> (rank &lt; 0.5 || rank &gt; 1.0)
<a name="l00296"></a>00296         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;rank not in [0.5-1.0]&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (maxwidth == 0) {
<a name="l00298"></a>00298         <span class="keywordflow">if</span> (components == <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a27e7cdfb87413a6d3686bebc93a3dac6">JB_CONN_COMPS</a>)
<a name="l00299"></a>00299             maxwidth = <a class="code" href="jbclass_8c.html#a1c84786c33ecbc6cb3874a88adae07ff">MAX_CONN_COMP_WIDTH</a>;
<a name="l00300"></a>00300         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (components == <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad563d0eeaf2c300cf43b05c2e6871708">JB_CHARACTERS</a>)
<a name="l00301"></a>00301             maxwidth = <a class="code" href="jbclass_8c.html#af85a52071ffe96bddd49d52010646f28">MAX_CHAR_COMP_WIDTH</a>;
<a name="l00302"></a>00302         <span class="keywordflow">else</span>  <span class="comment">/* JB_WORDS */</span>
<a name="l00303"></a>00303             maxwidth = <a class="code" href="jbclass_8c.html#a400343963c507d6bacac7ddbf11195f5">MAX_WORD_COMP_WIDTH</a>;
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305     <span class="keywordflow">if</span> (maxheight == 0)
<a name="l00306"></a>00306         maxheight = <a class="code" href="jbclass_8c.html#a8d73dbb42dcb113808335fbac75d248f">MAX_COMP_HEIGHT</a>;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="keywordflow">if</span> ((classer = <a class="code" href="jbclass_8c.html#aceeab4ff692f0678d098ec66bf507f4d">jbClasserCreate</a>(<a class="code" href="jbclass_8h.html#abc5c98fcc1211af2b80116dd6e0a035da1b98462873a302ca0fee887395223613">JB_RANKHAUS</a>, components)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00309"></a>00309         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;classer not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00310"></a>00310     classer-&gt;<a class="code" href="struct_jb_classer.html#a73c9a1b1290939d61a0a01b3d0791c9f">maxwidth</a> = maxwidth;
<a name="l00311"></a>00311     classer-&gt;<a class="code" href="struct_jb_classer.html#af5d228f85fca195336e9b73b42f85d9c">maxheight</a> = maxheight;
<a name="l00312"></a>00312     classer-&gt;<a class="code" href="struct_jb_classer.html#a9d3e307cb4de9c5c35e013892d246a77">sizehaus</a> = <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>;
<a name="l00313"></a>00313     classer-&gt;<a class="code" href="struct_jb_classer.html#a3b1fe29bfe5ba80fe1aff01225b72abc">rankhaus</a> = rank;
<a name="l00314"></a>00314     classer-&gt;<a class="code" href="struct_jb_classer.html#a1d395848f89b39b2a6c0626c0b9d33c1">nahash</a> = <a class="code" href="leptprotos_8h.html#ab0e53e46e5776fcd38c674f03d5585da">numaHashCreate</a>(5507, 4);  <span class="comment">/* 5507 is prime */</span>
<a name="l00315"></a>00315     <span class="keywordflow">return</span> <a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="comment"></span>
<a name="l00319"></a>00319 <span class="comment">/*!</span>
<a name="l00320"></a>00320 <span class="comment"> *  jbCorrelationInit()</span>
<a name="l00321"></a>00321 <span class="comment"> *</span>
<a name="l00322"></a>00322 <span class="comment"> *      Input:  components (JB_CONN_COMPS, JB_CHARACTERS, JB_WORDS)</span>
<a name="l00323"></a>00323 <span class="comment"> *              maxwidth (of component; use 0 for default)</span>
<a name="l00324"></a>00324 <span class="comment"> *              maxheight (of component; use 0 for default)</span>
<a name="l00325"></a>00325 <span class="comment"> *              thresh (value for correlation score: in [0.4 - 0.98])</span>
<a name="l00326"></a>00326 <span class="comment"> *              weightfactor (corrects thresh for thick characters [0.0 - 1.0])</span>
<a name="l00327"></a>00327 <span class="comment"> *      Return: jbclasser if OK; NULL on error</span>
<a name="l00328"></a>00328 <span class="comment"> *</span>
<a name="l00329"></a>00329 <span class="comment"> *  Notes:</span>
<a name="l00330"></a>00330 <span class="comment"> *      (1) For scanned text, suggested input values are:</span>
<a name="l00331"></a>00331 <span class="comment"> *            thresh ~ [0.8 - 0.85]</span>
<a name="l00332"></a>00332 <span class="comment"> *            weightfactor ~ [0.5 - 0.6]</span>
<a name="l00333"></a>00333 <span class="comment"> *      (2) For electronically generated fonts (e.g., rasterized pdf),</span>
<a name="l00334"></a>00334 <span class="comment"> *          a very high thresh (e.g., 0.95) will not cause a significant</span>
<a name="l00335"></a>00335 <span class="comment"> *          increase in the number of classes.</span>
<a name="l00336"></a>00336 <span class="comment"> */</span>
<a name="l00337"></a>00337 <a class="code" href="struct_jb_classer.html">JBCLASSER</a> *
<a name="l00338"></a><a class="code" href="leptprotos_8h.html#a32770f426c74de8a6aa2355d6cd47293">00338</a> <a class="code" href="jbclass_8c.html#a91e7cefbfd51053340ec2befc79c81ed">jbCorrelationInit</a>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    components,
<a name="l00339"></a>00339                   <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxwidth,
<a name="l00340"></a>00340                   <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxheight,
<a name="l00341"></a>00341                   <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  thresh,
<a name="l00342"></a>00342                   <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  weightfactor)
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344     <span class="keywordflow">return</span> <a class="code" href="jbclass_8c.html#ac3160c2a27d31616088d1aa014b35f4f">jbCorrelationInitInternal</a>(components, maxwidth, maxheight, thresh,
<a name="l00345"></a>00345                                      weightfactor, 1);
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 <span class="comment"></span>
<a name="l00348"></a>00348 <span class="comment">/*!</span>
<a name="l00349"></a>00349 <span class="comment"> *  jbCorrelationInitWithoutComponents()</span>
<a name="l00350"></a>00350 <span class="comment"> *</span>
<a name="l00351"></a>00351 <span class="comment"> *      Input:  same as jbCorrelationInit</span>
<a name="l00352"></a>00352 <span class="comment"> *      Output: same as jbCorrelationInit</span>
<a name="l00353"></a>00353 <span class="comment"> *</span>
<a name="l00354"></a>00354 <span class="comment"> *  Note: acts the same as jbCorrelationInit(), but the resulting</span>
<a name="l00355"></a>00355 <span class="comment"> *        object doesn&#39;t keep a list of all the components.</span>
<a name="l00356"></a>00356 <span class="comment"> */</span>
<a name="l00357"></a>00357 <a class="code" href="struct_jb_classer.html">JBCLASSER</a> *
<a name="l00358"></a><a class="code" href="leptprotos_8h.html#ad18b9043006c8f5890838f57ca352c5a">00358</a> <a class="code" href="jbclass_8c.html#a80ff385e97c5edceff41f76e8a5c8420">jbCorrelationInitWithoutComponents</a>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    components,
<a name="l00359"></a>00359                                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxwidth,
<a name="l00360"></a>00360                                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxheight,
<a name="l00361"></a>00361                                    <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  thresh,
<a name="l00362"></a>00362                                    <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  weightfactor)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364     <span class="keywordflow">return</span> <a class="code" href="jbclass_8c.html#ac3160c2a27d31616088d1aa014b35f4f">jbCorrelationInitInternal</a>(components, maxwidth, maxheight, thresh,
<a name="l00365"></a>00365                                      weightfactor, 0);
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="keyword">static</span> <a class="code" href="struct_jb_classer.html">JBCLASSER</a> *
<a name="l00370"></a><a class="code" href="jbclass_8c.html#ac3160c2a27d31616088d1aa014b35f4f">00370</a> <a class="code" href="jbclass_8c.html#ac3160c2a27d31616088d1aa014b35f4f">jbCorrelationInitInternal</a>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    components,
<a name="l00371"></a>00371                           <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxwidth,
<a name="l00372"></a>00372                           <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxheight,
<a name="l00373"></a>00373                           <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  thresh,
<a name="l00374"></a>00374                           <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  weightfactor,
<a name="l00375"></a>00375                           <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    keep_components)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377 <a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbCorrelationInitInternal&quot;</span>);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a27e7cdfb87413a6d3686bebc93a3dac6">JB_CONN_COMPS</a> &amp;&amp; components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad563d0eeaf2c300cf43b05c2e6871708">JB_CHARACTERS</a> &amp;&amp;
<a name="l00382"></a>00382         components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a130c542f7784940fd858243d1c05b898">JB_WORDS</a>)
<a name="l00383"></a>00383         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;invalid components&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00384"></a>00384     <span class="keywordflow">if</span> (thresh &lt; 0.4 || thresh &gt; 0.98)
<a name="l00385"></a>00385         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;thresh not in range [0.4 - 0.98]&quot;</span>,
<a name="l00386"></a>00386                 procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (weightfactor &lt; 0.0 || weightfactor &gt; 1.0)
<a name="l00388"></a>00388         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;weightfactor not in range [0.0 - 1.0]&quot;</span>,
<a name="l00389"></a>00389                 procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (maxwidth == 0) {
<a name="l00391"></a>00391         <span class="keywordflow">if</span> (components == <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a27e7cdfb87413a6d3686bebc93a3dac6">JB_CONN_COMPS</a>)
<a name="l00392"></a>00392             maxwidth = <a class="code" href="jbclass_8c.html#a1c84786c33ecbc6cb3874a88adae07ff">MAX_CONN_COMP_WIDTH</a>;
<a name="l00393"></a>00393         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (components == <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad563d0eeaf2c300cf43b05c2e6871708">JB_CHARACTERS</a>)
<a name="l00394"></a>00394             maxwidth = <a class="code" href="jbclass_8c.html#af85a52071ffe96bddd49d52010646f28">MAX_CHAR_COMP_WIDTH</a>;
<a name="l00395"></a>00395         <span class="keywordflow">else</span>  <span class="comment">/* JB_WORDS */</span>
<a name="l00396"></a>00396             maxwidth = <a class="code" href="jbclass_8c.html#a400343963c507d6bacac7ddbf11195f5">MAX_WORD_COMP_WIDTH</a>;
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398     <span class="keywordflow">if</span> (maxheight == 0)
<a name="l00399"></a>00399         maxheight = <a class="code" href="jbclass_8c.html#a8d73dbb42dcb113808335fbac75d248f">MAX_COMP_HEIGHT</a>;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="keywordflow">if</span> ((classer = <a class="code" href="jbclass_8c.html#aceeab4ff692f0678d098ec66bf507f4d">jbClasserCreate</a>(<a class="code" href="jbclass_8h.html#abc5c98fcc1211af2b80116dd6e0a035da430cbfbe3fcfef28053503c9fb373302">JB_CORRELATION</a>, components)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00403"></a>00403         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;classer not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00404"></a>00404     classer-&gt;<a class="code" href="struct_jb_classer.html#a73c9a1b1290939d61a0a01b3d0791c9f">maxwidth</a> = maxwidth;
<a name="l00405"></a>00405     classer-&gt;<a class="code" href="struct_jb_classer.html#af5d228f85fca195336e9b73b42f85d9c">maxheight</a> = maxheight;
<a name="l00406"></a>00406     classer-&gt;<a class="code" href="struct_jb_classer.html#a12c66f8caabd083b023983031bb0c938">thresh</a> = thresh;
<a name="l00407"></a>00407     classer-&gt;<a class="code" href="struct_jb_classer.html#a76e3fc7010a842050e6211b0007494d0">weightfactor</a> = weightfactor;
<a name="l00408"></a>00408     classer-&gt;<a class="code" href="struct_jb_classer.html#a1d395848f89b39b2a6c0626c0b9d33c1">nahash</a> = <a class="code" href="leptprotos_8h.html#ab0e53e46e5776fcd38c674f03d5585da">numaHashCreate</a>(5507, 4);  <span class="comment">/* 5507 is prime */</span>
<a name="l00409"></a>00409     classer-&gt;<a class="code" href="struct_jb_classer.html#a82111f37d806ec02741af588ecf380d4">keep_pixaa</a> = keep_components;
<a name="l00410"></a>00410     <span class="keywordflow">return</span> <a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l00415"></a>00415 <span class="comment"> *                       Classify the pages                             *</span>
<a name="l00416"></a>00416 <span class="comment"> *----------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00417"></a>00417 <span class="comment">/*!</span>
<a name="l00418"></a>00418 <span class="comment"> *  jbAddPages()</span>
<a name="l00419"></a>00419 <span class="comment"> *</span>
<a name="l00420"></a>00420 <span class="comment"> *      Input:  jbclasser</span>
<a name="l00421"></a>00421 <span class="comment"> *              safiles (of page image file names)</span>
<a name="l00422"></a>00422 <span class="comment"> *      Return: 0 if OK; 1 on error</span>
<a name="l00423"></a>00423 <span class="comment"> *</span>
<a name="l00424"></a>00424 <span class="comment"> *  Note:</span>
<a name="l00425"></a>00425 <span class="comment"> *      (1) jbclasser makes a copy of the array of file names.</span>
<a name="l00426"></a>00426 <span class="comment"> *      (2) The caller is still responsible for destroying the input array.</span>
<a name="l00427"></a>00427 <span class="comment"> */</span>
<a name="l00428"></a>00428 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l00429"></a><a class="code" href="leptprotos_8h.html#a9f911f5cd5b7a5a2cb0ce0f3c229a720">00429</a> <a class="code" href="jbclass_8c.html#add78db94c7b7d2a144dc6aed8eb7d418">jbAddPages</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>,
<a name="l00430"></a>00430            <a class="code" href="struct_sarray.html">SARRAY</a>     *safiles)
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, <a class="code" href="pixserial__reg_8c.html#a65cc14b190f64718ec3c0e4f492aae99">nfiles</a>;
<a name="l00433"></a>00433 <span class="keywordtype">char</span>    *fname;
<a name="l00434"></a>00434 <a class="code" href="struct_pix.html">PIX</a>     *pix;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbAddPages&quot;</span>);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (!classer)
<a name="l00439"></a>00439         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;classer not defined&quot;</span>, procName, 1);
<a name="l00440"></a>00440     <span class="keywordflow">if</span> (!safiles)
<a name="l00441"></a>00441         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;safiles not defined&quot;</span>, procName, 1);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     classer-&gt;<a class="code" href="struct_jb_classer.html#a2d8e64834d0aac76c4a96645e016d2f0">safiles</a> = <a class="code" href="leptprotos_8h.html#a0a8333dc0e2958317513d97ecc24e53a">sarrayCopy</a>(safiles);
<a name="l00444"></a>00444     nfiles = <a class="code" href="leptprotos_8h.html#a32bccb817e096fe813a49bb11dabf873">sarrayGetCount</a>(safiles);
<a name="l00445"></a>00445     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="pixserial__reg_8c.html#a65cc14b190f64718ec3c0e4f492aae99">nfiles</a>; i++) {
<a name="l00446"></a>00446         fname = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(safiles, i, 0);
<a name="l00447"></a>00447         <span class="keywordflow">if</span> ((pix = <a class="code" href="leptprotos_8h.html#a84634846cbb5e01df667d6e9241dfc53">pixRead</a>(fname)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00448"></a>00448             <a class="code" href="environ_8h.html#add590e3e30a10de7e26ba277898c89aa">L_WARNING_INT</a>(<span class="stringliteral">&quot;image file %d not read&quot;</span>, procName, i);
<a name="l00449"></a>00449             <span class="keywordflow">continue</span>;
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451         <span class="keywordflow">if</span> (<a class="code" href="leptprotos_8h.html#a1646270a1eae38cd7af74c68351ce513">pixGetDepth</a>(pix) != 1) {
<a name="l00452"></a>00452             <a class="code" href="environ_8h.html#add590e3e30a10de7e26ba277898c89aa">L_WARNING_INT</a>(<span class="stringliteral">&quot;image file %d not 1 bpp&quot;</span>, procName, i);
<a name="l00453"></a>00453             <span class="keywordflow">continue</span>;
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455         <a class="code" href="jbclass_8c.html#a9d9629483ca22afcc193c499ec11f5ee">jbAddPage</a>(classer, pix);
<a name="l00456"></a>00456         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix);
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="keywordflow">return</span> 0;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="comment"></span>
<a name="l00463"></a>00463 <span class="comment">/*!</span>
<a name="l00464"></a>00464 <span class="comment"> *  jbAddPage()</span>
<a name="l00465"></a>00465 <span class="comment"> *</span>
<a name="l00466"></a>00466 <span class="comment"> *      Input:  jbclasser</span>
<a name="l00467"></a>00467 <span class="comment"> *              pixs (of input page)</span>
<a name="l00468"></a>00468 <span class="comment"> *      Return: 0 if OK; 1 on error</span>
<a name="l00469"></a>00469 <span class="comment"> */</span>
<a name="l00470"></a>00470 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l00471"></a><a class="code" href="leptprotos_8h.html#a7bf52915bb726a178968899c81b47c37">00471</a> <a class="code" href="jbclass_8c.html#a9d9629483ca22afcc193c499ec11f5ee">jbAddPage</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>,
<a name="l00472"></a>00472           <a class="code" href="struct_pix.html">PIX</a>        *pixs)
<a name="l00473"></a>00473 {
<a name="l00474"></a>00474 <a class="code" href="struct_boxa.html">BOXA</a>  *boxas;
<a name="l00475"></a>00475 <a class="code" href="struct_pixa.html">PIXA</a>  *pixas;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbAddPage&quot;</span>);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="keywordflow">if</span> (!classer)
<a name="l00480"></a>00480         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;classer not defined&quot;</span>, procName, 1);
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (!pixs || <a class="code" href="leptprotos_8h.html#a1646270a1eae38cd7af74c68351ce513">pixGetDepth</a>(pixs) != 1)
<a name="l00482"></a>00482         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixs not defined or not 1 bpp&quot;</span>, procName, 1);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     classer-&gt;<a class="code" href="struct_jb_classer.html#aa2edd4d8997b309e5bf52cb6d0dee9ef">w</a> = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pixs);
<a name="l00485"></a>00485     classer-&gt;<a class="code" href="struct_jb_classer.html#a25499466fd3b0f8edebca53ce87e3930">h</a> = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pixs);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <span class="comment">/* Get the appropriate components and their bounding boxes */</span>
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (<a class="code" href="jbclass_8c.html#adabba55e90ce4d780626fe54d1b95141">jbGetComponents</a>(pixs, classer-&gt;<a class="code" href="struct_jb_classer.html#aed468ae5fb0a0189a6c1571e7bf2c8dd">components</a>, classer-&gt;<a class="code" href="struct_jb_classer.html#a73c9a1b1290939d61a0a01b3d0791c9f">maxwidth</a>,
<a name="l00489"></a>00489                         classer-&gt;<a class="code" href="struct_jb_classer.html#af5d228f85fca195336e9b73b42f85d9c">maxheight</a>, &amp;boxas, &amp;pixas)) {
<a name="l00490"></a>00490         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;components not made&quot;</span>, procName, 1);
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <a class="code" href="jbclass_8c.html#a5700186ed777b11eb69ab93373c700b6">jbAddPageComponents</a>(classer, pixs, boxas, pixas);
<a name="l00494"></a>00494     <a class="code" href="boxbasic_8c.html#ab61d85b07650c3e6c004878d8653b39a">boxaDestroy</a>(&amp;boxas);
<a name="l00495"></a>00495     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixas);
<a name="l00496"></a>00496     <span class="keywordflow">return</span> 0;
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498     
<a name="l00499"></a>00499 <span class="comment"></span>
<a name="l00500"></a>00500 <span class="comment">/*!</span>
<a name="l00501"></a>00501 <span class="comment"> *  jbAddPageComponents()</span>
<a name="l00502"></a>00502 <span class="comment"> *</span>
<a name="l00503"></a>00503 <span class="comment"> *      Input:  jbclasser</span>
<a name="l00504"></a>00504 <span class="comment"> *              pixs (of input page)</span>
<a name="l00505"></a>00505 <span class="comment"> *              boxas (b.b. of components for this page)</span>
<a name="l00506"></a>00506 <span class="comment"> *              pixas (components for this page)</span>
<a name="l00507"></a>00507 <span class="comment"> *      Return: 0 if OK; 1 on error</span>
<a name="l00508"></a>00508 <span class="comment"> *</span>
<a name="l00509"></a>00509 <span class="comment"> *  Notes:</span>
<a name="l00510"></a>00510 <span class="comment"> *      (1) If there are no components on the page, we don&#39;t require input</span>
<a name="l00511"></a>00511 <span class="comment"> *          of empty boxas or pixas, although that&#39;s the typical situation.</span>
<a name="l00512"></a>00512 <span class="comment"> */</span>
<a name="l00513"></a>00513 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l00514"></a><a class="code" href="leptprotos_8h.html#ae2452280f4b042fd973b1760318640e0">00514</a> <a class="code" href="jbclass_8c.html#a5700186ed777b11eb69ab93373c700b6">jbAddPageComponents</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>,
<a name="l00515"></a>00515                     <a class="code" href="struct_pix.html">PIX</a>        *pixs,
<a name="l00516"></a>00516                     <a class="code" href="struct_boxa.html">BOXA</a>       *boxas,
<a name="l00517"></a>00517                     <a class="code" href="struct_pixa.html">PIXA</a>       *pixas)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbAddPageComponents&quot;</span>);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="keywordflow">if</span> (!classer)
<a name="l00524"></a>00524         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;classer not defined&quot;</span>, procName, 1);
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (!pixs)
<a name="l00526"></a>00526         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pix not defined&quot;</span>, procName, 1);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <span class="comment">/* Test for no components on the current page.  Always update the</span>
<a name="l00529"></a>00529 <span class="comment">         * number of pages processed, even if nothing is on it. */</span>
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (!boxas || !pixas || (<a class="code" href="boxbasic_8c.html#a82555cab9ef5578c4728ef5109264723">boxaGetCount</a>(boxas) == 0)) {
<a name="l00531"></a>00531         classer-&gt;<a class="code" href="struct_jb_classer.html#a39fb1c2330fe7cabb44758fa99bdc0ed">npages</a>++;
<a name="l00532"></a>00532         <span class="keywordflow">return</span> 0;
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="comment">/* Get classes.  For hausdorff, it uses a specified size of</span>
<a name="l00536"></a>00536 <span class="comment">         * structuring element and specified rank.  For correlation,</span>
<a name="l00537"></a>00537 <span class="comment">         * it uses a specified threshold. */</span>
<a name="l00538"></a>00538     <span class="keywordflow">if</span> (classer-&gt;<a class="code" href="struct_jb_classer.html#af425c85b5125be856f3284894c4c5248">method</a> == <a class="code" href="jbclass_8h.html#abc5c98fcc1211af2b80116dd6e0a035da1b98462873a302ca0fee887395223613">JB_RANKHAUS</a>) {
<a name="l00539"></a>00539         <span class="keywordflow">if</span> (<a class="code" href="jbclass_8c.html#a6fbbf1f8a2ec5b4d876c3d6ac76ca31f">jbClassifyRankHaus</a>(classer, boxas, pixas))
<a name="l00540"></a>00540             <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;rankhaus classification failed&quot;</span>, procName, 1);
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542     <span class="keywordflow">else</span> {  <span class="comment">/* classer-&gt;method == JB_CORRELATION */</span>
<a name="l00543"></a>00543         <span class="keywordflow">if</span> (<a class="code" href="jbclass_8c.html#a55677126ee1d3617dc8bca24992a0171">jbClassifyCorrelation</a>(classer, boxas, pixas))
<a name="l00544"></a>00544             <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;correlation classification failed&quot;</span>, procName, 1);
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="comment">/* Find the global UL corners, adjusted for each instance so</span>
<a name="l00548"></a>00548 <span class="comment">         * that the class template and instance will have their</span>
<a name="l00549"></a>00549 <span class="comment">         * centroids in the same place.  Then the template can be</span>
<a name="l00550"></a>00550 <span class="comment">         * used to replace the instance. */</span>
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (<a class="code" href="jbclass_8c.html#a507a86337bc6aa22975be9e3766472ab">jbGetULCorners</a>(classer, pixs, boxas))
<a name="l00552"></a>00552         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;UL corners not found&quot;</span>, procName, 1);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="comment">/* Update total component counts and number of pages processed. */</span>
<a name="l00555"></a>00555     n = <a class="code" href="boxbasic_8c.html#a82555cab9ef5578c4728ef5109264723">boxaGetCount</a>(boxas);
<a name="l00556"></a>00556     classer-&gt;<a class="code" href="struct_jb_classer.html#af63b2e0cd21875df8dae166d33eb458f">baseindex</a> += <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>;
<a name="l00557"></a>00557     <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(classer-&gt;<a class="code" href="struct_jb_classer.html#adb5d976c29fedc3bc2b2564810328871">nacomps</a>, n);
<a name="l00558"></a>00558     classer-&gt;<a class="code" href="struct_jb_classer.html#a39fb1c2330fe7cabb44758fa99bdc0ed">npages</a>++;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <span class="keywordflow">return</span> 0;
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l00565"></a>00565 <span class="comment"> *         Classification using windowed rank hausdorff metric          *</span>
<a name="l00566"></a>00566 <span class="comment"> *----------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00567"></a>00567 <span class="comment">/*!</span>
<a name="l00568"></a>00568 <span class="comment"> *  jbClassifyRankHaus()</span>
<a name="l00569"></a>00569 <span class="comment"> *</span>
<a name="l00570"></a>00570 <span class="comment"> *      Input:  jbclasser</span>
<a name="l00571"></a>00571 <span class="comment"> *              boxa (of new components for classification)</span>
<a name="l00572"></a>00572 <span class="comment"> *              pixas (of new components for classification)</span>
<a name="l00573"></a>00573 <span class="comment"> *      Return: 0 if OK; 1 on error</span>
<a name="l00574"></a>00574 <span class="comment"> */</span>
<a name="l00575"></a>00575 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l00576"></a><a class="code" href="leptprotos_8h.html#a5440f0471bb8b2197c6f60f5dd56aa17">00576</a> <a class="code" href="jbclass_8c.html#a6fbbf1f8a2ec5b4d876c3d6ac76ca31f">jbClassifyRankHaus</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>,
<a name="l00577"></a>00577                    <a class="code" href="struct_boxa.html">BOXA</a>       *boxa,
<a name="l00578"></a>00578                    <a class="code" href="struct_pixa.html">PIXA</a>       *pixas)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>     <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>, nt, <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, wt, ht, iclass, <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>, found, testval;
<a name="l00581"></a>00581 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    *sumtab;
<a name="l00582"></a>00582 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>     npages, area1, area3;
<a name="l00583"></a>00583 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    *tab8;
<a name="l00584"></a>00584 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>   rank, <a class="code" href="affine__reg_8c.html#ae7a35515457046b7539c24062cf94d40">x1</a>, <a class="code" href="affine__reg_8c.html#af3df0e6eba20b6ae09d0111c121aac36">y1</a>, <a class="code" href="affine__reg_8c.html#ad85afc03d55324b175bbccc3ecfc983c">x2</a>, <a class="code" href="affine__reg_8c.html#a5afb8355b4d1b35dd123f44f1743d9f4">y2</a>;
<a name="l00585"></a>00585 <a class="code" href="struct_box.html">BOX</a>        *box;
<a name="l00586"></a>00586 <a class="code" href="struct_numa.html">NUMA</a>       *naclass, *napage;
<a name="l00587"></a>00587 <a class="code" href="struct_numa.html">NUMA</a>       *nafg;   <span class="comment">/* fg area of all instances */</span>
<a name="l00588"></a>00588 <a class="code" href="struct_numa.html">NUMA</a>       *nafgt;  <span class="comment">/* fg area of all templates */</span>
<a name="l00589"></a>00589 <a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>  *findcontext;
<a name="l00590"></a>00590 <a class="code" href="struct_numa_hash.html">NUMAHASH</a>   *nahash;
<a name="l00591"></a>00591 <a class="code" href="struct_pix.html">PIX</a>        *pix, *pix1, *pix2, *pix3, *pix4;
<a name="l00592"></a>00592 <a class="code" href="struct_pixa.html">PIXA</a>       *pixa, *pixa1, *pixa2, *pixat, *pixatd;
<a name="l00593"></a>00593 <a class="code" href="struct_pixaa.html">PIXAA</a>      *pixaa;
<a name="l00594"></a>00594 <a class="code" href="struct_pta.html">PTA</a>        *pta, *ptac, *ptact;
<a name="l00595"></a>00595 <span class="keywordtype">SEL</span>        *sel;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbClassifyRankHaus&quot;</span>);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (!classer)
<a name="l00600"></a>00600         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;classer not found&quot;</span>, procName, 1);
<a name="l00601"></a>00601     <span class="keywordflow">if</span> (!boxa)
<a name="l00602"></a>00602         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;boxa not found&quot;</span>, procName, 1);
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (!pixas)
<a name="l00604"></a>00604         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixas not found&quot;</span>, procName, 1);
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     npages = classer-&gt;<a class="code" href="struct_jb_classer.html#a39fb1c2330fe7cabb44758fa99bdc0ed">npages</a>;
<a name="l00607"></a>00607     size = classer-&gt;<a class="code" href="struct_jb_classer.html#a9d3e307cb4de9c5c35e013892d246a77">sizehaus</a>;
<a name="l00608"></a>00608     sel = <a class="code" href="leptprotos_8h.html#acee5ec03dbf621f7bf42f4c4d5f4abd9">selCreateBrick</a>(size, size, size / 2, size / 2, <a class="code" href="morph_8h.html#aba01db17f4a2bfbc3db60dc172972a25a23bacbc5f9d51af0d2fd25f5b80baa87">SEL_HIT</a>);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         <span class="comment">/* Generate the bordered pixa, with and without dilation.</span>
<a name="l00611"></a>00611 <span class="comment">         * pixa1 and pixa2 contain all the input components. */</span>
<a name="l00612"></a>00612     n = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixas);
<a name="l00613"></a>00613     pixa1 = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(n);
<a name="l00614"></a>00614     pixa2 = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(n);
<a name="l00615"></a>00615     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l00616"></a>00616         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00617"></a>00617         pix1 = <a class="code" href="leptprotos_8h.html#a49c0fe42967413f1ea501de77da30813">pixAddBorderGeneral</a>(pix, <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>, <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>,
<a name="l00618"></a>00618                     <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>, <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>, 0);
<a name="l00619"></a>00619         pix2 = <a class="code" href="leptprotos_8h.html#adac7488ed26d7c269cd10d0ea9cc2c79">pixDilate</a>(<a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pix1, sel);
<a name="l00620"></a>00620         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa1, pix1, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);   <span class="comment">/* un-dilated */</span>
<a name="l00621"></a>00621         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa2, pix2, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);   <span class="comment">/* dilated */</span>
<a name="l00622"></a>00622         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix);
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         <span class="comment">/* Get the centroids of all the bordered images.</span>
<a name="l00626"></a>00626 <span class="comment">         * These are relative to the UL corner of each (bordered) pix.  */</span>
<a name="l00627"></a>00627     pta = <a class="code" href="leptprotos_8h.html#ab3509eb44877b85988432e6e2462e1bb">pixaCentroids</a>(pixa1);  <span class="comment">/* centroids for this page; use here */</span>
<a name="l00628"></a>00628     ptac = classer-&gt;<a class="code" href="struct_jb_classer.html#a2462eb667abe08e30b22676b4e30d101">ptac</a>;  <span class="comment">/* holds centroids of components up to this page */</span>
<a name="l00629"></a>00629     <a class="code" href="leptprotos_8h.html#a3778f83a81dc91bb96d4f66b14782b97">ptaJoin</a>(ptac, pta, 0, 0);  <span class="comment">/* save centroids of all components */</span>
<a name="l00630"></a>00630     ptact = classer-&gt;<a class="code" href="struct_jb_classer.html#af15ce939e8925d3971799c6cc4ce68a5">ptact</a>;  <span class="comment">/* holds centroids of templates */</span>
<a name="l00631"></a>00631         
<a name="l00632"></a>00632         <span class="comment">/* Use these to save the class and page of each component. */</span>
<a name="l00633"></a>00633     naclass = classer-&gt;<a class="code" href="struct_jb_classer.html#a61916a7940b3d7d011b536c16acdf587">naclass</a>;
<a name="l00634"></a>00634     napage = classer-&gt;<a class="code" href="struct_jb_classer.html#a47fa04849b137efb50869f8a182c781c">napage</a>;
<a name="l00635"></a>00635     sumtab = <a class="code" href="leptprotos_8h.html#a230d6654519b5c847e49798b37cd5d1d">makePixelSumTab8</a>();
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="comment">/* Store the unbordered pix in a pixaa, in a hierarchical</span>
<a name="l00638"></a>00638 <span class="comment">         * set of arrays.  There is one pixa for each class,</span>
<a name="l00639"></a>00639 <span class="comment">         * and the pix in each pixa are all the instances found</span>
<a name="l00640"></a>00640 <span class="comment">         * of that class.  This is actually more than one would need</span>
<a name="l00641"></a>00641 <span class="comment">         * for a jbig2 encoder, but there are two reasons to keep</span>
<a name="l00642"></a>00642 <span class="comment">         * them around: (1) the set of instances for each class</span>
<a name="l00643"></a>00643 <span class="comment">         * can be used to make an improved binary (or, better,</span>
<a name="l00644"></a>00644 <span class="comment">         * a grayscale) template, rather than simply using the first</span>
<a name="l00645"></a>00645 <span class="comment">         * one in the set; (2) we can investigate the failures</span>
<a name="l00646"></a>00646 <span class="comment">         * of the classifier.  This pixaa grows as we process</span>
<a name="l00647"></a>00647 <span class="comment">         * successive pages. */</span>
<a name="l00648"></a>00648     pixaa = classer-&gt;<a class="code" href="struct_jb_classer.html#a7a3928f69ea217d8463e8d7e00076a67">pixaa</a>;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <span class="comment">/* arrays to store class exemplars (templates) */</span>
<a name="l00651"></a>00651     pixat = classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>;   <span class="comment">/* un-dilated */</span>
<a name="l00652"></a>00652     pixatd = classer-&gt;<a class="code" href="struct_jb_classer.html#afaf65037366791c6591a4f520c7826f1">pixatd</a>;   <span class="comment">/* dilated */</span>
<a name="l00653"></a>00653 
<a name="l00654"></a>00654         <span class="comment">/* Fill up the pixaa tree with the template exemplars as</span>
<a name="l00655"></a>00655 <span class="comment">         * the first pix in each pixa.  As we add each pix,</span>
<a name="l00656"></a>00656 <span class="comment">         * we also add the associated box to the pixa.</span>
<a name="l00657"></a>00657 <span class="comment">         * We also keep track of the centroid of each pix,</span>
<a name="l00658"></a>00658 <span class="comment">         * and use the difference between centroids (of the</span>
<a name="l00659"></a>00659 <span class="comment">         * pix with the exemplar we are checking it with)</span>
<a name="l00660"></a>00660 <span class="comment">         * to align the two when checking that the Hausdorff</span>
<a name="l00661"></a>00661 <span class="comment">         * distance does not exceed a threshold.</span>
<a name="l00662"></a>00662 <span class="comment">         * The threshold is set by the Sel used for dilating.</span>
<a name="l00663"></a>00663 <span class="comment">         * For example, a 3x3 brick, sel_3, corresponds to a</span>
<a name="l00664"></a>00664 <span class="comment">         * Hausdorff distance of 1.  In general, for an NxN brick,</span>
<a name="l00665"></a>00665 <span class="comment">         * with N odd, corresponds to a Hausdorff distance of (N - 1)/2.</span>
<a name="l00666"></a>00666 <span class="comment">         * It turns out that we actually need to use a sel of size 2x2</span>
<a name="l00667"></a>00667 <span class="comment">         * to avoid small bad components when there is a halftone image</span>
<a name="l00668"></a>00668 <span class="comment">         * from which components can be chosen.</span>
<a name="l00669"></a>00669 <span class="comment">         * The larger the Sel you use, the fewer the number of classes,</span>
<a name="l00670"></a>00670 <span class="comment">         * and the greater the likelihood of putting semantically</span>
<a name="l00671"></a>00671 <span class="comment">         * different objects in the same class.  For simplicity,</span>
<a name="l00672"></a>00672 <span class="comment">         * we do this separately for the case of rank == 1.0 (exact</span>
<a name="l00673"></a>00673 <span class="comment">         * match within the Hausdorff distance) and rank &lt; 1.0.  */</span>
<a name="l00674"></a>00674     rank = classer-&gt;<a class="code" href="struct_jb_classer.html#a3b1fe29bfe5ba80fe1aff01225b72abc">rankhaus</a>;
<a name="l00675"></a>00675     nahash = classer-&gt;<a class="code" href="struct_jb_classer.html#a1d395848f89b39b2a6c0626c0b9d33c1">nahash</a>;
<a name="l00676"></a>00676     <span class="keywordflow">if</span> (rank == 1.0) {
<a name="l00677"></a>00677         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l00678"></a>00678             pix1 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa1, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00679"></a>00679             pix2 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa2, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00680"></a>00680             <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(pta, i, &amp;x1, &amp;y1);
<a name="l00681"></a>00681             nt = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixat);  <span class="comment">/* number of templates */</span>
<a name="l00682"></a>00682             found = <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00683"></a>00683             findcontext = <a class="code" href="jbclass_8c.html#a47a48f9129c3e9295d496e5e623d107d">findSimilarSizedTemplatesInit</a>(classer, pix1);
<a name="l00684"></a>00684             <span class="keywordflow">while</span> ((iclass = <a class="code" href="jbclass_8c.html#a0b32c0b0c58c190fce595dcb8bc51853">findSimilarSizedTemplatesNext</a>(findcontext)) &gt; -1) {
<a name="l00685"></a>00685                     <span class="comment">/* Find score for this template */</span>
<a name="l00686"></a>00686                 pix3 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixat, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00687"></a>00687                 pix4 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixatd, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00688"></a>00688                 <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(ptact, iclass, &amp;x2, &amp;y2);
<a name="l00689"></a>00689                 testval = <a class="code" href="jbclass_8c.html#ac787a3e3e651374769164f7a1a16ae76">pixHaustest</a>(pix1, pix2, pix3, pix4, x1 - x2, y1 - y2,
<a name="l00690"></a>00690                                       <a class="code" href="jbclass_8c.html#adc7490eefcd583ef090d7846e062b311">MAX_DIFF_WIDTH</a>, <a class="code" href="jbclass_8c.html#ac889e8e6a5db45e2d611c17dcfc06830">MAX_DIFF_HEIGHT</a>);
<a name="l00691"></a>00691                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix3);
<a name="l00692"></a>00692                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix4);
<a name="l00693"></a>00693                 <span class="keywordflow">if</span> (testval == 1) {
<a name="l00694"></a>00694                     found = <a class="code" href="environ_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00695"></a>00695                     <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naclass, iclass);
<a name="l00696"></a>00696                     <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(napage, npages);
<a name="l00697"></a>00697                     <span class="keywordflow">if</span> (classer-&gt;<a class="code" href="struct_jb_classer.html#a82111f37d806ec02741af588ecf380d4">keep_pixaa</a>) {
<a name="l00698"></a>00698                         pixa = <a class="code" href="leptprotos_8h.html#abb96ec0a09fa720b62cabb2604406938">pixaaGetPixa</a>(pixaa, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00699"></a>00699                         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00700"></a>00700                         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pix, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00701"></a>00701                         box = <a class="code" href="boxbasic_8c.html#ac7c6fcfadf130bfa738ce6aab51318e5">boxaGetBox</a>(boxa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00702"></a>00702                         <a class="code" href="leptprotos_8h.html#a1abb61141468578877eb70e15202df0d">pixaAddBox</a>(pixa, box, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00703"></a>00703                         <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa);
<a name="l00704"></a>00704                     }
<a name="l00705"></a>00705                     <span class="keywordflow">break</span>;
<a name="l00706"></a>00706                 }
<a name="l00707"></a>00707             }
<a name="l00708"></a>00708             <a class="code" href="jbclass_8c.html#a87378eb1cec7b96091aa115ad78890ba">findSimilarSizedTemplatesDestroy</a>(&amp;findcontext);
<a name="l00709"></a>00709             <span class="keywordflow">if</span> (found == <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {  <span class="comment">/* new class */</span>
<a name="l00710"></a>00710                 <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naclass, nt);
<a name="l00711"></a>00711                 <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(napage, npages);
<a name="l00712"></a>00712                 pixa = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(0);
<a name="l00713"></a>00713                 pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);  <span class="comment">/* unbordered instance */</span>
<a name="l00714"></a>00714                 <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pix, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00715"></a>00715                 wt = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix);
<a name="l00716"></a>00716                 ht = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix);
<a name="l00717"></a>00717                 <a class="code" href="leptprotos_8h.html#a2123f20499744a1ceedbd062634be808">numaHashAdd</a>(nahash, ht * wt, nt);
<a name="l00718"></a>00718                 box = <a class="code" href="boxbasic_8c.html#ac7c6fcfadf130bfa738ce6aab51318e5">boxaGetBox</a>(boxa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00719"></a>00719                 <a class="code" href="leptprotos_8h.html#a1abb61141468578877eb70e15202df0d">pixaAddBox</a>(pixa, box, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00720"></a>00720                 <a class="code" href="leptprotos_8h.html#a275f473ad8258e43948fb6e0b76a5199">pixaaAddPixa</a>(pixaa, pixa, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);  <span class="comment">/* unbordered instance */</span>
<a name="l00721"></a>00721                 <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(ptact, x1, y1);
<a name="l00722"></a>00722                 <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixat, pix1, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);  <span class="comment">/* bordered template */</span>
<a name="l00723"></a>00723                 <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixatd, pix2, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);  <span class="comment">/* bordered dil template */</span>
<a name="l00724"></a>00724             }
<a name="l00725"></a>00725             <span class="keywordflow">else</span> {   <span class="comment">/* don&#39;t save them */</span>
<a name="l00726"></a>00726                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix1);
<a name="l00727"></a>00727                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix2);
<a name="l00728"></a>00728             }
<a name="l00729"></a>00729         }
<a name="l00730"></a>00730     }
<a name="l00731"></a>00731     <span class="keywordflow">else</span> {  <span class="comment">/* rank &lt; 1.0 */</span>
<a name="l00732"></a>00732         <span class="keywordflow">if</span> ((nafg = <a class="code" href="leptprotos_8h.html#a2b7100825faf7ca34c1278b2a71b827d">pixaCountPixels</a>(pixas)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)  <span class="comment">/* areas for this page */</span>
<a name="l00733"></a>00733             <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;nafg not made&quot;</span>, procName, 1);
<a name="l00734"></a>00734         nafgt = classer-&gt;<a class="code" href="struct_jb_classer.html#a795a12e05bff1ca4e34106046db1c5cb">nafgt</a>;
<a name="l00735"></a>00735         tab8 = <a class="code" href="leptprotos_8h.html#a230d6654519b5c847e49798b37cd5d1d">makePixelSumTab8</a>();
<a name="l00736"></a>00736         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {   <span class="comment">/* all instances on this page */</span>
<a name="l00737"></a>00737             pix1 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa1, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00738"></a>00738             <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(nafg, i, &amp;area1);
<a name="l00739"></a>00739             pix2 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa2, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00740"></a>00740             <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(pta, i, &amp;x1, &amp;y1);   <span class="comment">/* use pta for this page */</span>
<a name="l00741"></a>00741             nt = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixat);  <span class="comment">/* number of templates */</span>
<a name="l00742"></a>00742             found = <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00743"></a>00743             findcontext = <a class="code" href="jbclass_8c.html#a47a48f9129c3e9295d496e5e623d107d">findSimilarSizedTemplatesInit</a>(classer, pix1);
<a name="l00744"></a>00744             <span class="keywordflow">while</span> ((iclass = <a class="code" href="jbclass_8c.html#a0b32c0b0c58c190fce595dcb8bc51853">findSimilarSizedTemplatesNext</a>(findcontext)) &gt; -1) {
<a name="l00745"></a>00745                     <span class="comment">/* Find score for this template */</span>
<a name="l00746"></a>00746                 pix3 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixat, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00747"></a>00747                 <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(nafgt, iclass, &amp;area3);
<a name="l00748"></a>00748                 pix4 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixatd, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00749"></a>00749                 <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(ptact, iclass, &amp;x2, &amp;y2);
<a name="l00750"></a>00750                 testval = <a class="code" href="jbclass_8c.html#a9dc3f1b28677455796ce73eded3b024e">pixRankHaustest</a>(pix1, pix2, pix3, pix4,
<a name="l00751"></a>00751                                           x1 - x2, y1 - y2,
<a name="l00752"></a>00752                                           <a class="code" href="jbclass_8c.html#adc7490eefcd583ef090d7846e062b311">MAX_DIFF_WIDTH</a>, <a class="code" href="jbclass_8c.html#ac889e8e6a5db45e2d611c17dcfc06830">MAX_DIFF_HEIGHT</a>,
<a name="l00753"></a>00753                                           area1, area3, rank, tab8);
<a name="l00754"></a>00754                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix3);
<a name="l00755"></a>00755                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix4);
<a name="l00756"></a>00756                 <span class="keywordflow">if</span> (testval == 1) {  <span class="comment">/* greedy match; take the first */</span>
<a name="l00757"></a>00757                     found = <a class="code" href="environ_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00758"></a>00758                     <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naclass, iclass);
<a name="l00759"></a>00759                     <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(napage, npages);
<a name="l00760"></a>00760                     <span class="keywordflow">if</span> (classer-&gt;<a class="code" href="struct_jb_classer.html#a82111f37d806ec02741af588ecf380d4">keep_pixaa</a>) {
<a name="l00761"></a>00761                         pixa = <a class="code" href="leptprotos_8h.html#abb96ec0a09fa720b62cabb2604406938">pixaaGetPixa</a>(pixaa, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00762"></a>00762                         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00763"></a>00763                         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pix, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00764"></a>00764                         box = <a class="code" href="boxbasic_8c.html#ac7c6fcfadf130bfa738ce6aab51318e5">boxaGetBox</a>(boxa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00765"></a>00765                         <a class="code" href="leptprotos_8h.html#a1abb61141468578877eb70e15202df0d">pixaAddBox</a>(pixa, box, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00766"></a>00766                         <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa);
<a name="l00767"></a>00767                     }
<a name="l00768"></a>00768                     <span class="keywordflow">break</span>;
<a name="l00769"></a>00769                 }
<a name="l00770"></a>00770             }
<a name="l00771"></a>00771             <a class="code" href="jbclass_8c.html#a87378eb1cec7b96091aa115ad78890ba">findSimilarSizedTemplatesDestroy</a>(&amp;findcontext);
<a name="l00772"></a>00772             <span class="keywordflow">if</span> (found == <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {  <span class="comment">/* new class */</span>
<a name="l00773"></a>00773                 <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naclass, nt);
<a name="l00774"></a>00774                 <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(napage, npages);
<a name="l00775"></a>00775                 pixa = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(0);
<a name="l00776"></a>00776                 pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);  <span class="comment">/* unbordered instance */</span>
<a name="l00777"></a>00777                 <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pix, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00778"></a>00778                 wt = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix);
<a name="l00779"></a>00779                 ht = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix);
<a name="l00780"></a>00780                 <a class="code" href="leptprotos_8h.html#a2123f20499744a1ceedbd062634be808">numaHashAdd</a>(nahash, ht * wt, nt);
<a name="l00781"></a>00781                 box = <a class="code" href="boxbasic_8c.html#ac7c6fcfadf130bfa738ce6aab51318e5">boxaGetBox</a>(boxa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l00782"></a>00782                 <a class="code" href="leptprotos_8h.html#a1abb61141468578877eb70e15202df0d">pixaAddBox</a>(pixa, box, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l00783"></a>00783                 <a class="code" href="leptprotos_8h.html#a275f473ad8258e43948fb6e0b76a5199">pixaaAddPixa</a>(pixaa, pixa, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);  <span class="comment">/* unbordered instance */</span>
<a name="l00784"></a>00784                 <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(ptact, x1, y1);
<a name="l00785"></a>00785                 <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixat, pix1, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);  <span class="comment">/* bordered template */</span>
<a name="l00786"></a>00786                 <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixatd, pix2, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);  <span class="comment">/* ditto */</span>
<a name="l00787"></a>00787                 <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(nafgt, area1);
<a name="l00788"></a>00788             }
<a name="l00789"></a>00789             <span class="keywordflow">else</span> {   <span class="comment">/* don&#39;t save them */</span>
<a name="l00790"></a>00790                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix1);
<a name="l00791"></a>00791                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix2);
<a name="l00792"></a>00792             }
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794         <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(tab8);
<a name="l00795"></a>00795         <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;nafg);
<a name="l00796"></a>00796     }
<a name="l00797"></a>00797     classer-&gt;<a class="code" href="struct_jb_classer.html#a64be52ca0b1240ceafa17123be0470fd">nclass</a> = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixat);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(sumtab);
<a name="l00800"></a>00800     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;pta);
<a name="l00801"></a>00801     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa1);
<a name="l00802"></a>00802     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa2);
<a name="l00803"></a>00803     <a class="code" href="leptprotos_8h.html#a4bb811007e4d825b4be1712433584df9">selDestroy</a>(&amp;sel);
<a name="l00804"></a>00804     <span class="keywordflow">return</span> 0;
<a name="l00805"></a>00805 }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807 <span class="comment"></span>
<a name="l00808"></a>00808 <span class="comment">/*!</span>
<a name="l00809"></a>00809 <span class="comment"> *  pixHaustest()</span>
<a name="l00810"></a>00810 <span class="comment"> *</span>
<a name="l00811"></a>00811 <span class="comment"> *      Input:  pix1   (new pix, not dilated)</span>
<a name="l00812"></a>00812 <span class="comment"> *              pix2   (new pix, dilated)</span>
<a name="l00813"></a>00813 <span class="comment"> *              pix3   (exemplar pix, not dilated)</span>
<a name="l00814"></a>00814 <span class="comment"> *              pix4   (exemplar pix, dilated)</span>
<a name="l00815"></a>00815 <span class="comment"> *              delx   (x comp of centroid difference)</span>
<a name="l00816"></a>00816 <span class="comment"> *              dely   (y comp of centroid difference)</span>
<a name="l00817"></a>00817 <span class="comment"> *              maxdiffw (max width difference of pix1 and pix2)</span>
<a name="l00818"></a>00818 <span class="comment"> *              maxdiffh (max height difference of pix1 and pix2)</span>
<a name="l00819"></a>00819 <span class="comment"> *      Return: 0 (FALSE) if no match, 1 (TRUE) if the new</span>
<a name="l00820"></a>00820 <span class="comment"> *              pix is in the same class as the exemplar.</span>
<a name="l00821"></a>00821 <span class="comment"> *</span>
<a name="l00822"></a>00822 <span class="comment"> *  Note: we check first that the two pix are roughly</span>
<a name="l00823"></a>00823 <span class="comment"> *  the same size.  Only if they meet that criterion do</span>
<a name="l00824"></a>00824 <span class="comment"> *  we compare the bitmaps.  The Hausdorff is a 2-way</span>
<a name="l00825"></a>00825 <span class="comment"> *  check.  The centroid difference is used to align the two</span>
<a name="l00826"></a>00826 <span class="comment"> *  images to the nearest integer for each of the checks.</span>
<a name="l00827"></a>00827 <span class="comment"> *  These check that the dilated image of one contains</span>
<a name="l00828"></a>00828 <span class="comment"> *  ALL the pixels of the undilated image of the other.</span>
<a name="l00829"></a>00829 <span class="comment"> *  Checks are done in both direction.  A single pixel not</span>
<a name="l00830"></a>00830 <span class="comment"> *  contained in either direction results in failure of the test.</span>
<a name="l00831"></a>00831 <span class="comment"> */</span>
<a name="l00832"></a>00832 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l00833"></a><a class="code" href="leptprotos_8h.html#a1ab8ee69cd9d6329b48194abfadb92eb">00833</a> <a class="code" href="jbclass_8c.html#ac787a3e3e651374769164f7a1a16ae76">pixHaustest</a>(<a class="code" href="struct_pix.html">PIX</a>       *pix1,
<a name="l00834"></a>00834             <a class="code" href="struct_pix.html">PIX</a>       *pix2,
<a name="l00835"></a>00835             <a class="code" href="struct_pix.html">PIX</a>       *pix3,
<a name="l00836"></a>00836             <a class="code" href="struct_pix.html">PIX</a>       *pix4,
<a name="l00837"></a>00837             <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  delx,   <span class="comment">/* x(1) - x(3) */</span>
<a name="l00838"></a>00838             <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  dely,   <span class="comment">/* y(1) - y(3) */</span>
<a name="l00839"></a>00839             <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxdiffw,
<a name="l00840"></a>00840             <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxdiffh)
<a name="l00841"></a>00841 {
<a name="l00842"></a>00842 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  wi, hi, wt, ht, delw, delh, idelx, idely, boolmatch;
<a name="l00843"></a>00843 <a class="code" href="struct_pix.html">PIX</a>     *pixt;
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         <span class="comment">/* Eliminate possible matches based on size difference */</span>
<a name="l00846"></a>00846     wi = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix1);
<a name="l00847"></a>00847     hi = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix1);
<a name="l00848"></a>00848     wt = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix3);
<a name="l00849"></a>00849     ht = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix3);
<a name="l00850"></a>00850     delw = <a class="code" href="environ_8h.html#ad422c21d3f8664d230423cf5638b0e6e">L_ABS</a>(wi - wt);
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (delw &gt; maxdiffw)
<a name="l00852"></a>00852         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00853"></a>00853     delh = <a class="code" href="environ_8h.html#ad422c21d3f8664d230423cf5638b0e6e">L_ABS</a>(hi - ht);
<a name="l00854"></a>00854     <span class="keywordflow">if</span> (delh &gt; maxdiffh)
<a name="l00855"></a>00855         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         <span class="comment">/* Round difference in centroid location to nearest integer;</span>
<a name="l00858"></a>00858 <span class="comment">         * use this as a shift when doing the matching. */</span>
<a name="l00859"></a>00859     <span class="keywordflow">if</span> (delx &gt;= 0)
<a name="l00860"></a>00860         idelx = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(delx + 0.5);
<a name="l00861"></a>00861     <span class="keywordflow">else</span>
<a name="l00862"></a>00862         idelx = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(delx - 0.5);
<a name="l00863"></a>00863     <span class="keywordflow">if</span> (dely &gt;= 0)
<a name="l00864"></a>00864         idely = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(dely + 0.5);
<a name="l00865"></a>00865     <span class="keywordflow">else</span>
<a name="l00866"></a>00866         idely = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(dely - 0.5);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868         <span class="comment">/*  Do 1-direction hausdorff, checking that every pixel in pix1</span>
<a name="l00869"></a>00869 <span class="comment">         *  is within a dilation distance of some pixel in pix3.  Namely,</span>
<a name="l00870"></a>00870 <span class="comment">         *  that pix4 entirely covers pix1:</span>
<a name="l00871"></a>00871 <span class="comment">         *       pixt = pixSubtract(NULL, pix1, pix4), including shift</span>
<a name="l00872"></a>00872 <span class="comment">         *  where pixt has no ON pixels.  */</span>
<a name="l00873"></a>00873     pixt = <a class="code" href="leptprotos_8h.html#a818df07aa55f619dee3073a9f75c5754">pixCreateTemplate</a>(pix1);
<a name="l00874"></a>00874     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, 0, 0, wi, hi, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>, pix1, 0, 0);
<a name="l00875"></a>00875     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, idelx, idely, wi, hi, <a class="code" href="pix_8h.html#a0bc9848843e824c84419cd73ec4af5f2">PIX_DST</a> &amp; <a class="code" href="pix_8h.html#ab4a01060d66392c3be2233922dc390c8">PIX_NOT</a>(<a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>),
<a name="l00876"></a>00876                 pix4, 0, 0);
<a name="l00877"></a>00877     <a class="code" href="leptprotos_8h.html#a6a235d616cb936fa779f4aea0706a0b3">pixZero</a>(pixt, &amp;boolmatch);
<a name="l00878"></a>00878     <span class="keywordflow">if</span> (boolmatch == 0) {
<a name="l00879"></a>00879         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt);
<a name="l00880"></a>00880         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00881"></a>00881     }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883         <span class="comment">/*  Do 1-direction hausdorff, checking that every pixel in pix3</span>
<a name="l00884"></a>00884 <span class="comment">         *  is within a dilation distance of some pixel in pix1.  Namely,</span>
<a name="l00885"></a>00885 <span class="comment">         *  that pix2 entirely covers pix3:</span>
<a name="l00886"></a>00886 <span class="comment">         *      pixSubtract(pixt, pix3, pix2), including shift</span>
<a name="l00887"></a>00887 <span class="comment">         *  where pixt has no ON pixels. */</span>
<a name="l00888"></a>00888     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, idelx, idely, wt, ht, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>, pix3, 0, 0);
<a name="l00889"></a>00889     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, 0, 0, wt, ht, <a class="code" href="pix_8h.html#a0bc9848843e824c84419cd73ec4af5f2">PIX_DST</a> &amp; <a class="code" href="pix_8h.html#ab4a01060d66392c3be2233922dc390c8">PIX_NOT</a>(<a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>), pix2, 0, 0);
<a name="l00890"></a>00890     <a class="code" href="leptprotos_8h.html#a6a235d616cb936fa779f4aea0706a0b3">pixZero</a>(pixt, &amp;boolmatch);
<a name="l00891"></a>00891     <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt);
<a name="l00892"></a>00892     <span class="keywordflow">return</span> boolmatch;
<a name="l00893"></a>00893 }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 <span class="comment"></span>
<a name="l00896"></a>00896 <span class="comment">/*!</span>
<a name="l00897"></a>00897 <span class="comment"> *  pixRankHaustest()</span>
<a name="l00898"></a>00898 <span class="comment"> *</span>
<a name="l00899"></a>00899 <span class="comment"> *      Input:  pix1   (new pix, not dilated)</span>
<a name="l00900"></a>00900 <span class="comment"> *              pix2   (new pix, dilated)</span>
<a name="l00901"></a>00901 <span class="comment"> *              pix3   (exemplar pix, not dilated)</span>
<a name="l00902"></a>00902 <span class="comment"> *              pix4   (exemplar pix, dilated)</span>
<a name="l00903"></a>00903 <span class="comment"> *              delx   (x comp of centroid difference)</span>
<a name="l00904"></a>00904 <span class="comment"> *              dely   (y comp of centroid difference)</span>
<a name="l00905"></a>00905 <span class="comment"> *              maxdiffw (max width difference of pix1 and pix2)</span>
<a name="l00906"></a>00906 <span class="comment"> *              maxdiffh (max height difference of pix1 and pix2)</span>
<a name="l00907"></a>00907 <span class="comment"> *              area1  (fg pixels in pix1)</span>
<a name="l00908"></a>00908 <span class="comment"> *              area3  (fg pixels in pix3)</span>
<a name="l00909"></a>00909 <span class="comment"> *              rank   (rank value of test, each way)</span>
<a name="l00910"></a>00910 <span class="comment"> *              tab8   (table of pixel sums for byte)</span>
<a name="l00911"></a>00911 <span class="comment"> *      Return: 0 (FALSE) if no match, 1 (TRUE) if the new</span>
<a name="l00912"></a>00912 <span class="comment"> *                 pix is in the same class as the exemplar.</span>
<a name="l00913"></a>00913 <span class="comment"> *</span>
<a name="l00914"></a>00914 <span class="comment"> *  Note: we check first that the two pix are roughly</span>
<a name="l00915"></a>00915 <span class="comment"> *  the same size.  Only if they meet that criterion do</span>
<a name="l00916"></a>00916 <span class="comment"> *  we compare the bitmaps.  We convert the rank value to</span>
<a name="l00917"></a>00917 <span class="comment"> *  a number of pixels by multiplying the rank fraction by the number</span>
<a name="l00918"></a>00918 <span class="comment"> *  of pixels in the undilated image.  The Hausdorff is a 2-way</span>
<a name="l00919"></a>00919 <span class="comment"> *  check.  The centroid difference is used to align the two</span>
<a name="l00920"></a>00920 <span class="comment"> *  images to the nearest integer for each of the checks.</span>
<a name="l00921"></a>00921 <span class="comment"> *  The rank hausdorff checks that the dilated image of one</span>
<a name="l00922"></a>00922 <span class="comment"> *  contains the rank fraction of the pixels of the undilated</span>
<a name="l00923"></a>00923 <span class="comment"> *  image of the other.   Checks are done in both direction. </span>
<a name="l00924"></a>00924 <span class="comment"> *  Failure of the test in either direction results in failure</span>
<a name="l00925"></a>00925 <span class="comment"> *  of the test.</span>
<a name="l00926"></a>00926 <span class="comment"> */</span>
<a name="l00927"></a>00927 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l00928"></a><a class="code" href="leptprotos_8h.html#a9f8657b5e131488a967435368d2dd0a8">00928</a> <a class="code" href="jbclass_8c.html#a9dc3f1b28677455796ce73eded3b024e">pixRankHaustest</a>(<a class="code" href="struct_pix.html">PIX</a>       *pix1,
<a name="l00929"></a>00929                 <a class="code" href="struct_pix.html">PIX</a>       *pix2,
<a name="l00930"></a>00930                 <a class="code" href="struct_pix.html">PIX</a>       *pix3,
<a name="l00931"></a>00931                 <a class="code" href="struct_pix.html">PIX</a>       *pix4,
<a name="l00932"></a>00932                 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  delx,   <span class="comment">/* x(1) - x(3) */</span>
<a name="l00933"></a>00933                 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  dely,   <span class="comment">/* y(1) - y(3) */</span>
<a name="l00934"></a>00934                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxdiffw,
<a name="l00935"></a>00935                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    maxdiffh,
<a name="l00936"></a>00936                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    area1,
<a name="l00937"></a>00937                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    area3,
<a name="l00938"></a>00938                 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  rank,
<a name="l00939"></a>00939                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *tab8)
<a name="l00940"></a>00940 {
<a name="l00941"></a>00941 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  wi, hi, wt, ht, delw, delh, idelx, idely, boolmatch;
<a name="l00942"></a>00942 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  thresh1, thresh3;
<a name="l00943"></a>00943 <a class="code" href="struct_pix.html">PIX</a>     *pixt;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945         <span class="comment">/* Eliminate possible matches based on size difference */</span>
<a name="l00946"></a>00946     wi = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix1);
<a name="l00947"></a>00947     hi = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix1);
<a name="l00948"></a>00948     wt = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix3);
<a name="l00949"></a>00949     ht = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix3);
<a name="l00950"></a>00950     delw = <a class="code" href="environ_8h.html#ad422c21d3f8664d230423cf5638b0e6e">L_ABS</a>(wi - wt);
<a name="l00951"></a>00951     <span class="keywordflow">if</span> (delw &gt; maxdiffw)
<a name="l00952"></a>00952         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00953"></a>00953     delh = <a class="code" href="environ_8h.html#ad422c21d3f8664d230423cf5638b0e6e">L_ABS</a>(hi - ht);
<a name="l00954"></a>00954     <span class="keywordflow">if</span> (delh &gt; maxdiffh)
<a name="l00955"></a>00955         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <span class="comment">/* Upper bounds in remaining pixels for allowable match */</span>
<a name="l00958"></a>00958     thresh1 = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(area1 * (1. - rank) + 0.5);
<a name="l00959"></a>00959     thresh3 = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(area3 * (1. - rank) + 0.5);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         <span class="comment">/* Round difference in centroid location to nearest integer;</span>
<a name="l00962"></a>00962 <span class="comment">         * use this as a shift when doing the matching. */</span>
<a name="l00963"></a>00963     <span class="keywordflow">if</span> (delx &gt;= 0)
<a name="l00964"></a>00964         idelx = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(delx + 0.5);
<a name="l00965"></a>00965     <span class="keywordflow">else</span>
<a name="l00966"></a>00966         idelx = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(delx - 0.5);
<a name="l00967"></a>00967     <span class="keywordflow">if</span> (dely &gt;= 0)
<a name="l00968"></a>00968         idely = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(dely + 0.5);
<a name="l00969"></a>00969     <span class="keywordflow">else</span>
<a name="l00970"></a>00970         idely = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(dely - 0.5);
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         <span class="comment">/*  Do 1-direction hausdorff, checking that every pixel in pix1</span>
<a name="l00973"></a>00973 <span class="comment">         *  is within a dilation distance of some pixel in pix3.  Namely,</span>
<a name="l00974"></a>00974 <span class="comment">         *  that pix4 entirely covers pix1:</span>
<a name="l00975"></a>00975 <span class="comment">         *       pixt = pixSubtract(NULL, pix1, pix4), including shift</span>
<a name="l00976"></a>00976 <span class="comment">         *  where pixt has no ON pixels.  */</span>
<a name="l00977"></a>00977     pixt = <a class="code" href="leptprotos_8h.html#a818df07aa55f619dee3073a9f75c5754">pixCreateTemplate</a>(pix1);
<a name="l00978"></a>00978     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, 0, 0, wi, hi, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>, pix1, 0, 0);
<a name="l00979"></a>00979     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, idelx, idely, wi, hi, <a class="code" href="pix_8h.html#a0bc9848843e824c84419cd73ec4af5f2">PIX_DST</a> &amp; <a class="code" href="pix_8h.html#ab4a01060d66392c3be2233922dc390c8">PIX_NOT</a>(<a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>),
<a name="l00980"></a>00980                 pix4, 0, 0);
<a name="l00981"></a>00981     <a class="code" href="leptprotos_8h.html#a86eb952e0cc7d79ab23e97d2b8dbc5fd">pixThresholdPixelSum</a>(pixt, thresh1, &amp;boolmatch, tab8);
<a name="l00982"></a>00982     <span class="keywordflow">if</span> (boolmatch == 1) { <span class="comment">/* above thresh1 */</span>
<a name="l00983"></a>00983         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt);
<a name="l00984"></a>00984         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987         <span class="comment">/*  Do 1-direction hausdorff, checking that every pixel in pix3</span>
<a name="l00988"></a>00988 <span class="comment">         *  is within a dilation distance of some pixel in pix1.  Namely,</span>
<a name="l00989"></a>00989 <span class="comment">         *  that pix2 entirely covers pix3:</span>
<a name="l00990"></a>00990 <span class="comment">         *      pixSubtract(pixt, pix3, pix2), including shift</span>
<a name="l00991"></a>00991 <span class="comment">         *  where pixt has no ON pixels. */</span>
<a name="l00992"></a>00992     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, idelx, idely, wt, ht, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>, pix3, 0, 0);
<a name="l00993"></a>00993     <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt, 0, 0, wt, ht, <a class="code" href="pix_8h.html#a0bc9848843e824c84419cd73ec4af5f2">PIX_DST</a> &amp; <a class="code" href="pix_8h.html#ab4a01060d66392c3be2233922dc390c8">PIX_NOT</a>(<a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>), pix2, 0, 0);
<a name="l00994"></a>00994     <a class="code" href="leptprotos_8h.html#a86eb952e0cc7d79ab23e97d2b8dbc5fd">pixThresholdPixelSum</a>(pixt, thresh3, &amp;boolmatch, tab8);
<a name="l00995"></a>00995     <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt);
<a name="l00996"></a>00996     <span class="keywordflow">if</span> (boolmatch == 1)  <span class="comment">/* above thresh3 */</span>
<a name="l00997"></a>00997         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00998"></a>00998     <span class="keywordflow">else</span>
<a name="l00999"></a>00999         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l01004"></a>01004 <span class="comment"> *            Classification using windowed correlation score           *</span>
<a name="l01005"></a>01005 <span class="comment"> *----------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01006"></a>01006 <span class="comment">/*!</span>
<a name="l01007"></a>01007 <span class="comment"> *  jbClassifyCorrelation()</span>
<a name="l01008"></a>01008 <span class="comment"> *</span>
<a name="l01009"></a>01009 <span class="comment"> *      Input:  jbclasser</span>
<a name="l01010"></a>01010 <span class="comment"> *              boxa (of new components for classification)</span>
<a name="l01011"></a>01011 <span class="comment"> *              pixas (of new components for classification)</span>
<a name="l01012"></a>01012 <span class="comment"> *      Return: 0 if OK; 1 on error</span>
<a name="l01013"></a>01013 <span class="comment"> */</span>
<a name="l01014"></a>01014 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l01015"></a><a class="code" href="leptprotos_8h.html#a4e0346aab81c8203baef60390af860e6">01015</a> <a class="code" href="jbclass_8c.html#a55677126ee1d3617dc8bca24992a0171">jbClassifyCorrelation</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>,
<a name="l01016"></a>01016                       <a class="code" href="struct_boxa.html">BOXA</a>       *boxa,
<a name="l01017"></a>01017                       <a class="code" href="struct_pixa.html">PIXA</a>       *pixas)
<a name="l01018"></a>01018 {
<a name="l01019"></a>01019 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>     <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>, nt, <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, iclass, wt, ht, found, area, area1, area2, npages,
<a name="l01020"></a>01020             overthreshold;
<a name="l01021"></a>01021 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    *sumtab, *centtab;
<a name="l01022"></a>01022 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   *row, word;
<a name="l01023"></a>01023 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>   <a class="code" href="affine__reg_8c.html#ae7a35515457046b7539c24062cf94d40">x1</a>, <a class="code" href="affine__reg_8c.html#af3df0e6eba20b6ae09d0111c121aac36">y1</a>, <a class="code" href="affine__reg_8c.html#ad85afc03d55324b175bbccc3ecfc983c">x2</a>, <a class="code" href="affine__reg_8c.html#a5afb8355b4d1b35dd123f44f1743d9f4">y2</a>, xsum, ysum;
<a name="l01024"></a>01024 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>   thresh, weight, threshold;
<a name="l01025"></a>01025 <a class="code" href="struct_box.html">BOX</a>        *box;
<a name="l01026"></a>01026 <a class="code" href="struct_numa.html">NUMA</a>       *naclass, *napage;
<a name="l01027"></a>01027 <a class="code" href="struct_numa.html">NUMA</a>       *nafgt;   <span class="comment">/* fg area of all templates */</span>
<a name="l01028"></a>01028 <a class="code" href="struct_numa.html">NUMA</a>       *naarea;   <span class="comment">/* w * h area of all templates */</span>
<a name="l01029"></a>01029 <a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>  *findcontext;
<a name="l01030"></a>01030 <a class="code" href="struct_numa_hash.html">NUMAHASH</a>   *nahash;
<a name="l01031"></a>01031 <a class="code" href="struct_pix.html">PIX</a>        *pix, *pix1, *pix2;
<a name="l01032"></a>01032 <a class="code" href="struct_pixa.html">PIXA</a>       *pixa, *pixa1, *pixat;
<a name="l01033"></a>01033 <a class="code" href="struct_pixaa.html">PIXAA</a>      *pixaa;
<a name="l01034"></a>01034 <a class="code" href="struct_pta.html">PTA</a>        *pta, *ptac, *ptact;
<a name="l01035"></a>01035 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    *pixcts;  <span class="comment">/* pixel counts of each pixa */</span>
<a name="l01036"></a>01036 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   **pixrowcts;  <span class="comment">/* row-by-row pixel counts of each pixa */</span>
<a name="l01037"></a>01037 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>     x, y, rowcount, downcount, wpl;
<a name="l01038"></a>01038 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>     byte;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbClassifyCorrelation&quot;</span>);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="keywordflow">if</span> (!classer)
<a name="l01043"></a>01043         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;classer not found&quot;</span>, procName, 1);
<a name="l01044"></a>01044     <span class="keywordflow">if</span> (!boxa)
<a name="l01045"></a>01045         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;boxa not found&quot;</span>, procName, 1);
<a name="l01046"></a>01046     <span class="keywordflow">if</span> (!pixas)
<a name="l01047"></a>01047         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixas not found&quot;</span>, procName, 1);
<a name="l01048"></a>01048 
<a name="l01049"></a>01049     npages = classer-&gt;<a class="code" href="struct_jb_classer.html#a39fb1c2330fe7cabb44758fa99bdc0ed">npages</a>;
<a name="l01050"></a>01050 
<a name="l01051"></a>01051         <span class="comment">/* Generate the bordered pixa, which contains all the the</span>
<a name="l01052"></a>01052 <span class="comment">         * input components.  This will not be saved.   */</span>
<a name="l01053"></a>01053     n = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixas);
<a name="l01054"></a>01054     pixa1 = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(n);
<a name="l01055"></a>01055     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l01056"></a>01056         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01057"></a>01057         pix1 = <a class="code" href="leptprotos_8h.html#a49c0fe42967413f1ea501de77da30813">pixAddBorderGeneral</a>(pix, <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>, <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>,
<a name="l01058"></a>01058                     <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>, <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>, 0);
<a name="l01059"></a>01059         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa1, pix1, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l01060"></a>01060         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix);
<a name="l01061"></a>01061     }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         <span class="comment">/* Use these to save the class and page of each component. */</span>
<a name="l01064"></a>01064     naclass = classer-&gt;<a class="code" href="struct_jb_classer.html#a61916a7940b3d7d011b536c16acdf587">naclass</a>;
<a name="l01065"></a>01065     napage = classer-&gt;<a class="code" href="struct_jb_classer.html#a47fa04849b137efb50869f8a182c781c">napage</a>;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067         <span class="comment">/* Get the number of fg pixels in each component.  */</span>
<a name="l01068"></a>01068     nafgt = classer-&gt;<a class="code" href="struct_jb_classer.html#a795a12e05bff1ca4e34106046db1c5cb">nafgt</a>;    <span class="comment">/* holds fg areas of the templates */</span>
<a name="l01069"></a>01069     sumtab = <a class="code" href="leptprotos_8h.html#a230d6654519b5c847e49798b37cd5d1d">makePixelSumTab8</a>();
<a name="l01070"></a>01070 
<a name="l01071"></a>01071     pixcts = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(n, <span class="keyword">sizeof</span>(*pixcts));
<a name="l01072"></a>01072     pixrowcts = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> **)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(n, <span class="keyword">sizeof</span>(*pixrowcts));
<a name="l01073"></a>01073     centtab = <a class="code" href="leptprotos_8h.html#a3bab57232e526c64a41ab890704ead3c">makePixelCentroidTab8</a>();
<a name="l01074"></a>01074     <span class="keywordflow">if</span> (!pixcts || !pixrowcts || !centtab)
<a name="l01075"></a>01075         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;calloc fail in pix*cts or centtab&quot;</span>, procName, 1);
<a name="l01076"></a>01076 
<a name="l01077"></a>01077         <span class="comment">/* Count the &quot;1&quot; pixels in each row of the pix in pixa1; this</span>
<a name="l01078"></a>01078 <span class="comment">         * allows pixCorrelationScoreThresholded to abort early if a match</span>
<a name="l01079"></a>01079 <span class="comment">         * is impossible.  This loop merges three calculations: the total</span>
<a name="l01080"></a>01080 <span class="comment">         * number of &quot;1&quot; pixels, the number of &quot;1&quot; pixels in each row, and</span>
<a name="l01081"></a>01081 <span class="comment">         * the centroid.  The centroids are relative to the UL corner of</span>
<a name="l01082"></a>01082 <span class="comment">         * each (bordered) pix.  The pixrowcts[i][y] are the total number</span>
<a name="l01083"></a>01083 <span class="comment">         * of fg pixels in pixa[i] below row y. */</span>
<a name="l01084"></a>01084     pta = <a class="code" href="leptprotos_8h.html#a6f854462ee35cb8c974752cacc4170ed">ptaCreate</a>(n);
<a name="l01085"></a>01085     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l01086"></a>01086         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa1, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01087"></a>01087         pixrowcts[<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>] = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(<a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix),
<a name="l01088"></a>01088                                          <span class="keyword">sizeof</span>(**pixrowcts));
<a name="l01089"></a>01089         xsum = 0;
<a name="l01090"></a>01090         ysum = 0;
<a name="l01091"></a>01091         wpl = <a class="code" href="leptprotos_8h.html#af0b490472ab7999f208098dd37167d73">pixGetWpl</a>(pix);
<a name="l01092"></a>01092         row = <a class="code" href="leptprotos_8h.html#a44546f758f2cf71bb109bfc114e3ca7f">pixGetData</a>(pix) + (<a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix) - 1) * wpl;
<a name="l01093"></a>01093         downcount = 0;
<a name="l01094"></a>01094         <span class="keywordflow">for</span> (y = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix) - 1; y &gt;= 0; y--, row -= wpl) {
<a name="l01095"></a>01095             pixrowcts[<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>][y] = downcount;
<a name="l01096"></a>01096             rowcount = 0;
<a name="l01097"></a>01097             <span class="keywordflow">for</span> (x = 0; x &lt; wpl; x++) {
<a name="l01098"></a>01098                 word = row[x];
<a name="l01099"></a>01099                 byte = word &amp; 0xff;
<a name="l01100"></a>01100                 rowcount += sumtab[byte];
<a name="l01101"></a>01101                 xsum += centtab[byte] + (x * 32 + 24) * sumtab[byte];
<a name="l01102"></a>01102                 byte = (word &gt;&gt; 8) &amp; 0xff;
<a name="l01103"></a>01103                 rowcount += sumtab[byte];
<a name="l01104"></a>01104                 xsum += centtab[byte] + (x * 32 + 16) * sumtab[byte];
<a name="l01105"></a>01105                 byte = (word &gt;&gt; 16) &amp; 0xff;
<a name="l01106"></a>01106                 rowcount += sumtab[byte];
<a name="l01107"></a>01107                 xsum += centtab[byte] + (x * 32 + 8) * sumtab[byte];
<a name="l01108"></a>01108                 byte = (word &gt;&gt; 24) &amp; 0xff;
<a name="l01109"></a>01109                 rowcount += sumtab[byte];
<a name="l01110"></a>01110                 xsum += centtab[byte] + x * 32 * sumtab[byte];
<a name="l01111"></a>01111             }
<a name="l01112"></a>01112             downcount += rowcount;
<a name="l01113"></a>01113             ysum += rowcount * y;
<a name="l01114"></a>01114         }
<a name="l01115"></a>01115         pixcts[<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>] = downcount;
<a name="l01116"></a>01116         <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(pta,
<a name="l01117"></a>01117                  xsum / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)downcount, ysum / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)downcount);
<a name="l01118"></a>01118         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix);
<a name="l01119"></a>01119     }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121     ptac = classer-&gt;<a class="code" href="struct_jb_classer.html#a2462eb667abe08e30b22676b4e30d101">ptac</a>;  <span class="comment">/* holds centroids of components up to this page */</span>
<a name="l01122"></a>01122     <a class="code" href="leptprotos_8h.html#a3778f83a81dc91bb96d4f66b14782b97">ptaJoin</a>(ptac, pta, 0, 0);  <span class="comment">/* save centroids of all components */</span>
<a name="l01123"></a>01123     ptact = classer-&gt;<a class="code" href="struct_jb_classer.html#af15ce939e8925d3971799c6cc4ce68a5">ptact</a>;  <span class="comment">/* holds centroids of templates */</span>
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">/* Store the unbordered pix in a pixaa, in a hierarchical</span>
<a name="l01126"></a>01126 <span class="comment">     * set of arrays.  There is one pixa for each class,</span>
<a name="l01127"></a>01127 <span class="comment">     * and the pix in each pixa are all the instances found</span>
<a name="l01128"></a>01128 <span class="comment">     * of that class.  This is actually more than one would need</span>
<a name="l01129"></a>01129 <span class="comment">     * for a jbig2 encoder, but there are two reasons to keep</span>
<a name="l01130"></a>01130 <span class="comment">     * them around: (1) the set of instances for each class</span>
<a name="l01131"></a>01131 <span class="comment">     * can be used to make an improved binary (or, better,</span>
<a name="l01132"></a>01132 <span class="comment">     * a grayscale) template, rather than simply using the first</span>
<a name="l01133"></a>01133 <span class="comment">     * one in the set; (2) we can investigate the failures</span>
<a name="l01134"></a>01134 <span class="comment">     * of the classifier.  This pixaa grows as we process</span>
<a name="l01135"></a>01135 <span class="comment">     * successive pages. */</span>
<a name="l01136"></a>01136     pixaa = classer-&gt;<a class="code" href="struct_jb_classer.html#a7a3928f69ea217d8463e8d7e00076a67">pixaa</a>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138         <span class="comment">/* Array to store class exemplars */</span>
<a name="l01139"></a>01139     pixat = classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141         <span class="comment">/* Fill up the pixaa tree with the template exemplars as</span>
<a name="l01142"></a>01142 <span class="comment">         * the first pix in each pixa.  As we add each pix,</span>
<a name="l01143"></a>01143 <span class="comment">         * we also add the associated box to the pixa.</span>
<a name="l01144"></a>01144 <span class="comment">         * We also keep track of the centroid of each pix,</span>
<a name="l01145"></a>01145 <span class="comment">         * and use the difference between centroids (of the</span>
<a name="l01146"></a>01146 <span class="comment">         * pix with the exemplar we are checking it with)</span>
<a name="l01147"></a>01147 <span class="comment">         * to align the two when checking that the correlation</span>
<a name="l01148"></a>01148 <span class="comment">         * score exceeds a threshold.  The correlation score</span>
<a name="l01149"></a>01149 <span class="comment">         * is given by the square of the area of the AND</span>
<a name="l01150"></a>01150 <span class="comment">         * between aligned instance and template, divided by</span>
<a name="l01151"></a>01151 <span class="comment">         * the product of areas of each image.  For identical</span>
<a name="l01152"></a>01152 <span class="comment">         * template and instance, the score is 1.0.</span>
<a name="l01153"></a>01153 <span class="comment">         * If the threshold is too small, non-equivalent instances</span>
<a name="l01154"></a>01154 <span class="comment">         * will be placed in the same class; if too large, there will</span>
<a name="l01155"></a>01155 <span class="comment">         * be an unnecessary division of classes representing the</span>
<a name="l01156"></a>01156 <span class="comment">         * same character.  The weightfactor adds in some of the</span>
<a name="l01157"></a>01157 <span class="comment">         * difference (1.0 - thresh), depending on the heaviness</span>
<a name="l01158"></a>01158 <span class="comment">         * of the template (measured as the fraction of fg pixels). */</span>
<a name="l01159"></a>01159     thresh = classer-&gt;<a class="code" href="struct_jb_classer.html#a12c66f8caabd083b023983031bb0c938">thresh</a>;
<a name="l01160"></a>01160     weight = classer-&gt;<a class="code" href="struct_jb_classer.html#a76e3fc7010a842050e6211b0007494d0">weightfactor</a>;
<a name="l01161"></a>01161     naarea = classer-&gt;<a class="code" href="struct_jb_classer.html#a36a7c9bb53818520f10017b622f84a77">naarea</a>;
<a name="l01162"></a>01162     nahash = classer-&gt;<a class="code" href="struct_jb_classer.html#a1d395848f89b39b2a6c0626c0b9d33c1">nahash</a>;
<a name="l01163"></a>01163     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l01164"></a>01164         pix1 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa1, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01165"></a>01165         area1 = pixcts[<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>];
<a name="l01166"></a>01166         <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(pta, i, &amp;x1, &amp;y1);  <span class="comment">/* centroid for this instance */</span>
<a name="l01167"></a>01167         nt = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixat);
<a name="l01168"></a>01168         found = <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01169"></a>01169         findcontext = <a class="code" href="jbclass_8c.html#a47a48f9129c3e9295d496e5e623d107d">findSimilarSizedTemplatesInit</a>(classer, pix1);
<a name="l01170"></a>01170         <span class="keywordflow">while</span> ( (iclass = <a class="code" href="jbclass_8c.html#a0b32c0b0c58c190fce595dcb8bc51853">findSimilarSizedTemplatesNext</a>(findcontext)) &gt; -1) {
<a name="l01171"></a>01171                 <span class="comment">/* Get the template */</span>
<a name="l01172"></a>01172             pix2 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixat, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01173"></a>01173             <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(nafgt, iclass, &amp;area2);
<a name="l01174"></a>01174             <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(ptact, iclass, &amp;x2, &amp;y2);  <span class="comment">/* template centroid */</span>
<a name="l01175"></a>01175 
<a name="l01176"></a>01176                 <span class="comment">/* Find threshold for this template */</span>
<a name="l01177"></a>01177             <span class="keywordflow">if</span> (weight &gt; 0.0) {
<a name="l01178"></a>01178                 <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(naarea, iclass, &amp;area);
<a name="l01179"></a>01179                 threshold = thresh + (1. - thresh) * weight * area2 / area;
<a name="l01180"></a>01180             }
<a name="l01181"></a>01181             <span class="keywordflow">else</span>
<a name="l01182"></a>01182                 threshold = thresh;
<a name="l01183"></a>01183 
<a name="l01184"></a>01184                 <span class="comment">/* Find score for this template */</span>
<a name="l01185"></a>01185             overthreshold = <a class="code" href="correlscore_8c.html#ae7d52c4981de00005f0d137f74a8af5e">pixCorrelationScoreThresholded</a>(pix1, pix2,
<a name="l01186"></a>01186                                                            area1, area2,
<a name="l01187"></a>01187                                                            x1 - x2, y1 - y2,
<a name="l01188"></a>01188                                                            <a class="code" href="jbclass_8c.html#adc7490eefcd583ef090d7846e062b311">MAX_DIFF_WIDTH</a>,
<a name="l01189"></a>01189                                                            <a class="code" href="jbclass_8c.html#ac889e8e6a5db45e2d611c17dcfc06830">MAX_DIFF_HEIGHT</a>,
<a name="l01190"></a>01190                                                            sumtab,
<a name="l01191"></a>01191                                                            pixrowcts[i],
<a name="l01192"></a>01192                                                            threshold);
<a name="l01193"></a>01193 <span class="preprocessor">#if DEBUG_CORRELATION_SCORE</span>
<a name="l01194"></a>01194 <span class="preprocessor"></span>            {
<a name="l01195"></a>01195                 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a> score, testscore;
<a name="l01196"></a>01196                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> count, testcount;
<a name="l01197"></a>01197                 score = <a class="code" href="correlscore_8c.html#a9c67a499da3bb885af4b7a4e36631bc4">pixCorrelationScore</a>(pix1, pix2, area1, area2,
<a name="l01198"></a>01198                                             x1 - x2, y1 - y2,
<a name="l01199"></a>01199                                             <a class="code" href="jbclass_8c.html#adc7490eefcd583ef090d7846e062b311">MAX_DIFF_WIDTH</a>, <a class="code" href="jbclass_8c.html#ac889e8e6a5db45e2d611c17dcfc06830">MAX_DIFF_HEIGHT</a>,
<a name="l01200"></a>01200                                             sumtab);
<a name="l01201"></a>01201 
<a name="l01202"></a>01202                 testscore = <a class="code" href="correlscore_8c.html#a46f5d9c8cd9d814f038d6fd673ee99e8">pixCorrelationScoreSimple</a>(pix1, pix2, area1, area2,
<a name="l01203"></a>01203                                   x1 - x2, y1 - y2, <a class="code" href="jbclass_8c.html#adc7490eefcd583ef090d7846e062b311">MAX_DIFF_WIDTH</a>,
<a name="l01204"></a>01204                                   <a class="code" href="jbclass_8c.html#ac889e8e6a5db45e2d611c17dcfc06830">MAX_DIFF_HEIGHT</a>, sumtab);
<a name="l01205"></a>01205                 count = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)rint(sqrt(score * area1 * area2));
<a name="l01206"></a>01206                 testcount = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)rint(sqrt(testscore * area1 * area2));
<a name="l01207"></a>01207                 <span class="keywordflow">if</span> ((score &gt;= threshold) != (testscore &gt;= threshold)) {
<a name="l01208"></a>01208                     fprintf(stderr, <span class="stringliteral">&quot;Correlation score mismatch: %d(%g,%d) vs %d(%g,%d) (%g)\n&quot;</span>,
<a name="l01209"></a>01209                             count, score, score &gt;= threshold,
<a name="l01210"></a>01210                             testcount, testscore, testscore &gt;= threshold,
<a name="l01211"></a>01211                             score - testscore);
<a name="l01212"></a>01212                 }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214                 <span class="keywordflow">if</span> ((score &gt;= threshold) != overthreshold) {
<a name="l01215"></a>01215                     fprintf(stderr, <span class="stringliteral">&quot;Mismatch between correlation/threshold comparison: %g(%g,%d) &gt;= %g(%g) vs %s\n&quot;</span>,
<a name="l01216"></a>01216                             score, score*area1*area2, count, threshold, threshold*area1*area2, (overthreshold ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>));
<a name="l01217"></a>01217                 }
<a name="l01218"></a>01218             }
<a name="l01219"></a>01219 <span class="preprocessor">#endif  </span><span class="comment">/* DEBUG_CORRELATION_SCORE */</span>
<a name="l01220"></a>01220             <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix2);
<a name="l01221"></a>01221 
<a name="l01222"></a>01222             <span class="keywordflow">if</span> (overthreshold) {  <span class="comment">/* greedy match */</span>
<a name="l01223"></a>01223                 found = <a class="code" href="environ_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01224"></a>01224                 <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naclass, iclass);
<a name="l01225"></a>01225                 <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(napage, npages);
<a name="l01226"></a>01226                 <span class="keywordflow">if</span> (classer-&gt;<a class="code" href="struct_jb_classer.html#a82111f37d806ec02741af588ecf380d4">keep_pixaa</a>) {
<a name="l01227"></a>01227                         <span class="comment">/* We are keeping a record of all components */</span>
<a name="l01228"></a>01228                     pixa = <a class="code" href="leptprotos_8h.html#abb96ec0a09fa720b62cabb2604406938">pixaaGetPixa</a>(pixaa, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01229"></a>01229                     pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01230"></a>01230                     <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pix, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l01231"></a>01231                     box = <a class="code" href="boxbasic_8c.html#ac7c6fcfadf130bfa738ce6aab51318e5">boxaGetBox</a>(boxa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01232"></a>01232                     <a class="code" href="leptprotos_8h.html#a1abb61141468578877eb70e15202df0d">pixaAddBox</a>(pixa, box, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l01233"></a>01233                     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa);
<a name="l01234"></a>01234                 }
<a name="l01235"></a>01235                 <span class="keywordflow">break</span>;
<a name="l01236"></a>01236             }
<a name="l01237"></a>01237         }
<a name="l01238"></a>01238         <a class="code" href="jbclass_8c.html#a87378eb1cec7b96091aa115ad78890ba">findSimilarSizedTemplatesDestroy</a>(&amp;findcontext);
<a name="l01239"></a>01239         <span class="keywordflow">if</span> (found == <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {  <span class="comment">/* new class */</span>
<a name="l01240"></a>01240             <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naclass, nt);
<a name="l01241"></a>01241             <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(napage, npages);
<a name="l01242"></a>01242             pixa = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(0);
<a name="l01243"></a>01243             pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixas, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);  <span class="comment">/* unbordered instance */</span>
<a name="l01244"></a>01244             <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pix, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l01245"></a>01245             wt = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix);
<a name="l01246"></a>01246             ht = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix);
<a name="l01247"></a>01247             <a class="code" href="leptprotos_8h.html#a2123f20499744a1ceedbd062634be808">numaHashAdd</a>(nahash, ht * wt, nt);
<a name="l01248"></a>01248             box = <a class="code" href="boxbasic_8c.html#ac7c6fcfadf130bfa738ce6aab51318e5">boxaGetBox</a>(boxa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01249"></a>01249             <a class="code" href="leptprotos_8h.html#a1abb61141468578877eb70e15202df0d">pixaAddBox</a>(pixa, box, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l01250"></a>01250             <a class="code" href="leptprotos_8h.html#a275f473ad8258e43948fb6e0b76a5199">pixaaAddPixa</a>(pixaa, pixa, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);  <span class="comment">/* unbordered instance */</span>
<a name="l01251"></a>01251             <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(ptact, x1, y1);
<a name="l01252"></a>01252             <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(nafgt, area1);
<a name="l01253"></a>01253             <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixat, pix1, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);   <span class="comment">/* bordered template */</span>
<a name="l01254"></a>01254             area = (<a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix1) - 2 * <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>) *
<a name="l01255"></a>01255                    (<a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix1) - 2 * <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>);
<a name="l01256"></a>01256             <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naarea, area);
<a name="l01257"></a>01257         }
<a name="l01258"></a>01258         <span class="keywordflow">else</span> {   <span class="comment">/* don&#39;t save it */</span>
<a name="l01259"></a>01259             <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix1);
<a name="l01260"></a>01260         }
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262     classer-&gt;<a class="code" href="struct_jb_classer.html#a64be52ca0b1240ceafa17123be0470fd">nclass</a> = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixat);
<a name="l01263"></a>01263 
<a name="l01264"></a>01264     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(pixcts);
<a name="l01265"></a>01265     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(centtab);
<a name="l01266"></a>01266     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l01267"></a>01267         <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(pixrowcts[i]);
<a name="l01268"></a>01268     }
<a name="l01269"></a>01269     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(pixrowcts);
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(sumtab);
<a name="l01272"></a>01272     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;pta);
<a name="l01273"></a>01273     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa1);
<a name="l01274"></a>01274     <span class="keywordflow">return</span> 0;
<a name="l01275"></a>01275 }
<a name="l01276"></a>01276 
<a name="l01277"></a>01277 
<a name="l01278"></a>01278 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l01279"></a>01279 <span class="comment"> *             Determine the image components we start with             *</span>
<a name="l01280"></a>01280 <span class="comment"> *----------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01281"></a>01281 <span class="comment">/*!</span>
<a name="l01282"></a>01282 <span class="comment"> *  jbGetComponents()</span>
<a name="l01283"></a>01283 <span class="comment"> *</span>
<a name="l01284"></a>01284 <span class="comment"> *      Input:  pixs (1 bpp)</span>
<a name="l01285"></a>01285 <span class="comment"> *              components (JB_CONN_COMPS, JB_CHARACTERS, JB_WORDS)</span>
<a name="l01286"></a>01286 <span class="comment"> *              maxwidth, maxheight (of saved components; larger are discarded)</span>
<a name="l01287"></a>01287 <span class="comment"> *              &amp;pboxa (&lt;return&gt; b.b. of component items)</span>
<a name="l01288"></a>01288 <span class="comment"> *              &amp;ppixa (&lt;return&gt; component items)</span>
<a name="l01289"></a>01289 <span class="comment"> *      Return: 0 if OK, 1 on error</span>
<a name="l01290"></a>01290 <span class="comment"> */</span>
<a name="l01291"></a>01291 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l01292"></a><a class="code" href="leptprotos_8h.html#a928437ec10efdf016822bace13fd799f">01292</a> <a class="code" href="jbclass_8c.html#adabba55e90ce4d780626fe54d1b95141">jbGetComponents</a>(<a class="code" href="struct_pix.html">PIX</a>     *pixs,
<a name="l01293"></a>01293                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  components,
<a name="l01294"></a>01294                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  maxwidth,
<a name="l01295"></a>01295                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  maxheight,
<a name="l01296"></a>01296                 <a class="code" href="struct_boxa.html">BOXA</a>   **pboxad,
<a name="l01297"></a>01297                 <a class="code" href="struct_pixa.html">PIXA</a>   **ppixad)
<a name="l01298"></a>01298 {
<a name="l01299"></a>01299 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    empty, res, redfactor;
<a name="l01300"></a>01300 <a class="code" href="struct_boxa.html">BOXA</a>      *boxa;
<a name="l01301"></a>01301 <a class="code" href="struct_pix.html">PIX</a>       *pixt1, *pixt2, *pixt3;
<a name="l01302"></a>01302 <a class="code" href="struct_pixa.html">PIXA</a>      *pixa, *pixat;
<a name="l01303"></a>01303 
<a name="l01304"></a>01304     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbGetComponents&quot;</span>);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306     <span class="keywordflow">if</span> (!pboxad)
<a name="l01307"></a>01307         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;&amp;boxad not defined&quot;</span>, procName, 1);
<a name="l01308"></a>01308     *pboxad = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01309"></a>01309     <span class="keywordflow">if</span> (!ppixad)
<a name="l01310"></a>01310         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;&amp;pixad not defined&quot;</span>, procName, 1);
<a name="l01311"></a>01311     *ppixad = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01312"></a>01312     <span class="keywordflow">if</span> (!pixs)
<a name="l01313"></a>01313         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixs not defined&quot;</span>, procName, 1);
<a name="l01314"></a>01314     <span class="keywordflow">if</span> (components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a27e7cdfb87413a6d3686bebc93a3dac6">JB_CONN_COMPS</a> &amp;&amp; components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad563d0eeaf2c300cf43b05c2e6871708">JB_CHARACTERS</a> &amp;&amp;
<a name="l01315"></a>01315         components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a130c542f7784940fd858243d1c05b898">JB_WORDS</a>)
<a name="l01316"></a>01316         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;invalid components&quot;</span>, procName, 1);
<a name="l01317"></a>01317 
<a name="l01318"></a>01318     <a class="code" href="leptprotos_8h.html#a6a235d616cb936fa779f4aea0706a0b3">pixZero</a>(pixs, &amp;empty);
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (empty) {
<a name="l01320"></a>01320         *pboxad = <a class="code" href="boxbasic_8c.html#ae59916b7506831be9bf2119dea063253">boxaCreate</a>(0);
<a name="l01321"></a>01321         *ppixad = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(0);
<a name="l01322"></a>01322         <span class="keywordflow">return</span> 0;
<a name="l01323"></a>01323     }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325         <span class="comment">/* If required, preprocess input pixs.  The method for both</span>
<a name="l01326"></a>01326 <span class="comment">         * characters and words is to generate a connected component</span>
<a name="l01327"></a>01327 <span class="comment">         * mask over the units that we want to aggregrate, which are,</span>
<a name="l01328"></a>01328 <span class="comment">         * in general, sets of related connected components in pixs.</span>
<a name="l01329"></a>01329 <span class="comment">         * For characters, we want to include the dots with</span>
<a name="l01330"></a>01330 <span class="comment">         * &#39;i&#39;, &#39;j&#39; and &#39;!&#39;, so we do a small vertical closing to</span>
<a name="l01331"></a>01331 <span class="comment">         * generate the mask.  For words, we make a mask over all</span>
<a name="l01332"></a>01332 <span class="comment">         * characters in each word.  This is a bit more tricky, because</span>
<a name="l01333"></a>01333 <span class="comment">         * the spacing between words is difficult to predict a priori,</span>
<a name="l01334"></a>01334 <span class="comment">         * and words can be typeset with variable spacing that can</span>
<a name="l01335"></a>01335 <span class="comment">         * in some cases be barely larger than the space between</span>
<a name="l01336"></a>01336 <span class="comment">         * characters.  The first step is to generate the mask and</span>
<a name="l01337"></a>01337 <span class="comment">         * identify each of its connected components.  */</span>
<a name="l01338"></a>01338     <span class="keywordflow">if</span> (components == <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a27e7cdfb87413a6d3686bebc93a3dac6">JB_CONN_COMPS</a>) {  <span class="comment">/* no preprocessing */</span>
<a name="l01339"></a>01339         boxa = <a class="code" href="conncomp_8c.html#a31a8af5ee8d794de01c31eff7697bb44">pixConnComp</a>(pixs, &amp;pixa, 8);
<a name="l01340"></a>01340     } 
<a name="l01341"></a>01341     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (components == <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad563d0eeaf2c300cf43b05c2e6871708">JB_CHARACTERS</a>) {
<a name="l01342"></a>01342         pixt1 = <a class="code" href="leptprotos_8h.html#aac143671b2099c1306d08047e9caf097">pixMorphSequence</a>(pixs, <span class="stringliteral">&quot;c1.6&quot;</span>, 0);
<a name="l01343"></a>01343         boxa = <a class="code" href="conncomp_8c.html#a31a8af5ee8d794de01c31eff7697bb44">pixConnComp</a>(pixt1, &amp;pixat, 8);
<a name="l01344"></a>01344         pixa = <a class="code" href="leptprotos_8h.html#a1e6a280a98124e0f08cacc16c933da9a">pixaClipToPix</a>(pixat, pixs);
<a name="l01345"></a>01345         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt1);
<a name="l01346"></a>01346         <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixat);
<a name="l01347"></a>01347     } 
<a name="l01348"></a>01348     <span class="keywordflow">else</span> {  <span class="comment">/* components == JB_WORDS */</span>
<a name="l01349"></a>01349 
<a name="l01350"></a>01350             <span class="comment">/* Do the operations at about 150 ppi resolution.</span>
<a name="l01351"></a>01351 <span class="comment">             * It is much faster at 75 ppi, but the results are</span>
<a name="l01352"></a>01352 <span class="comment">             * more accurate at 150 ppi.  This will segment the</span>
<a name="l01353"></a>01353 <span class="comment">             * words in body text.  It can be expected that relatively</span>
<a name="l01354"></a>01354 <span class="comment">             * infrequent words in a larger font will be split. */</span>
<a name="l01355"></a>01355         res = <a class="code" href="leptprotos_8h.html#ab47b081faee7f1193117ece8178daaee">pixGetXRes</a>(pixs);
<a name="l01356"></a>01356         <span class="keywordflow">if</span> (res &lt;= 200) {
<a name="l01357"></a>01357             redfactor = 1;
<a name="l01358"></a>01358             pixt1 = <a class="code" href="leptprotos_8h.html#a48c3df1b04f60de6d7fcabd8375250d8">pixClone</a>(pixs);
<a name="l01359"></a>01359         }
<a name="l01360"></a>01360         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &lt;= 400) {
<a name="l01361"></a>01361             redfactor = 2;
<a name="l01362"></a>01362             pixt1 = <a class="code" href="binreduce_8c.html#a62049d35f70ff0b49d89bfb7e40d6a84">pixReduceRankBinaryCascade</a>(pixs, 1, 0, 0, 0);
<a name="l01363"></a>01363         }
<a name="l01364"></a>01364         <span class="keywordflow">else</span> {
<a name="l01365"></a>01365             redfactor = 4;
<a name="l01366"></a>01366             pixt1 = <a class="code" href="binreduce_8c.html#a62049d35f70ff0b49d89bfb7e40d6a84">pixReduceRankBinaryCascade</a>(pixs, 1, 1, 0, 0);
<a name="l01367"></a>01367         }
<a name="l01368"></a>01368 
<a name="l01369"></a>01369         pixt2 = <a class="code" href="jbclass_8c.html#a1086ff75f2b78e26da435fcbda847d71">pixWordMaskByDilation</a>(pixt1, 0, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01370"></a>01370 
<a name="l01371"></a>01371             <span class="comment">/* Expand the optimally dilated word mask to full res. */</span>
<a name="l01372"></a>01372         pixt3 = <a class="code" href="leptprotos_8h.html#ac76b2a8bd772e8aa08921d60481a3c91">pixExpandReplicate</a>(pixt2, redfactor);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374             <span class="comment">/* Pull out the pixels in pixs corresponding to the mask</span>
<a name="l01375"></a>01375 <span class="comment">             * components in pixt3.  Note that above we used threshold</span>
<a name="l01376"></a>01376 <span class="comment">             * levels in the reduction of 1 to insure that the resulting</span>
<a name="l01377"></a>01377 <span class="comment">             * mask fully covers the input pixs.  The downside of using</span>
<a name="l01378"></a>01378 <span class="comment">             * a threshold of 1 is that very close characters from adjacent</span>
<a name="l01379"></a>01379 <span class="comment">             * lines can be joined.  But with a level of 2 or greater,</span>
<a name="l01380"></a>01380 <span class="comment">             * it is necessary to use a seedfill, followed by a pixOr():</span>
<a name="l01381"></a>01381 <span class="comment">             *       pixt4 = pixSeedfillBinary(NULL, pixt3, pixs, 8);</span>
<a name="l01382"></a>01382 <span class="comment">             *       pixOr(pixt3, pixt3, pixt4);</span>
<a name="l01383"></a>01383 <span class="comment">             * to insure that the mask coverage is complete over pixs.  */</span>
<a name="l01384"></a>01384         boxa = <a class="code" href="conncomp_8c.html#a31a8af5ee8d794de01c31eff7697bb44">pixConnComp</a>(pixt3, &amp;pixat, 4);
<a name="l01385"></a>01385         pixa = <a class="code" href="leptprotos_8h.html#a1e6a280a98124e0f08cacc16c933da9a">pixaClipToPix</a>(pixat, pixs);
<a name="l01386"></a>01386         <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixat);
<a name="l01387"></a>01387         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt1);
<a name="l01388"></a>01388         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt2);
<a name="l01389"></a>01389         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt3);
<a name="l01390"></a>01390     }
<a name="l01391"></a>01391 
<a name="l01392"></a>01392         <span class="comment">/* Remove large components, and save the results.  */</span>
<a name="l01393"></a>01393     *ppixad = <a class="code" href="leptprotos_8h.html#a78fd9b5f7816f92ba7887c013b8459ee">pixaSelectBySize</a>(pixa, maxwidth, maxheight, <a class="code" href="pix_8h.html#a96a58e29e8dbf2b5bdeb775cba46556ea13974144514be468c58cc55636701af9">L_SELECT_IF_BOTH</a>,
<a name="l01394"></a>01394                                <a class="code" href="pix_8h.html#ab48899087cc647f0f791ed0c459adc53a233101dff04c411f5dfd54663e83087a">L_SELECT_IF_LTE</a>, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01395"></a>01395     *pboxad = <a class="code" href="boxfunc1_8c.html#a2f7eac861b2be231f1377d4506692bc0">boxaSelectBySize</a>(boxa, maxwidth, maxheight, <a class="code" href="pix_8h.html#a96a58e29e8dbf2b5bdeb775cba46556ea13974144514be468c58cc55636701af9">L_SELECT_IF_BOTH</a>,
<a name="l01396"></a>01396                                <a class="code" href="pix_8h.html#ab48899087cc647f0f791ed0c459adc53a233101dff04c411f5dfd54663e83087a">L_SELECT_IF_LTE</a>, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01397"></a>01397     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa);
<a name="l01398"></a>01398     <a class="code" href="boxbasic_8c.html#ab61d85b07650c3e6c004878d8653b39a">boxaDestroy</a>(&amp;boxa);
<a name="l01399"></a>01399 
<a name="l01400"></a>01400     <span class="keywordflow">return</span> 0;
<a name="l01401"></a>01401 }
<a name="l01402"></a>01402 
<a name="l01403"></a>01403 <span class="comment"></span>
<a name="l01404"></a>01404 <span class="comment">/*!</span>
<a name="l01405"></a>01405 <span class="comment"> *  pixWordMaskByDilation()</span>
<a name="l01406"></a>01406 <span class="comment"> *</span>
<a name="l01407"></a>01407 <span class="comment"> *      Input:  pixs (1 bpp; typ. at 75 to 150 ppi)</span>
<a name="l01408"></a>01408 <span class="comment"> *              maxsize (use 0 for default; not to exceed 14)</span>
<a name="l01409"></a>01409 <span class="comment"> *              &amp;size (&lt;optional return&gt; size of optimal horiz Sel)</span>
<a name="l01410"></a>01410 <span class="comment"> *      Return: pixd (dilated word mask), or null on error</span>
<a name="l01411"></a>01411 <span class="comment"> *</span>
<a name="l01412"></a>01412 <span class="comment"> *  Notes:</span>
<a name="l01413"></a>01413 <span class="comment"> *      (1) For 75 to 150 ppi, the optimal dilation should not exceed 7.</span>
<a name="l01414"></a>01414 <span class="comment"> *          This is the default size chosen if maxsize &lt;= 0.</span>
<a name="l01415"></a>01415 <span class="comment"> *      (2) To run this on images at resolution between 200 and 300, it</span>
<a name="l01416"></a>01416 <span class="comment"> *          is advisable to use a larger maxsize, say between 10 and 14.</span>
<a name="l01417"></a>01417 <span class="comment"> *      (3) The best size for dilating to get word masks is optionally returned.</span>
<a name="l01418"></a>01418 <span class="comment"> */</span>
<a name="l01419"></a>01419 <a class="code" href="struct_pix.html">PIX</a> *
<a name="l01420"></a><a class="code" href="leptprotos_8h.html#a637572df019a0720c9d3b002b179d746">01420</a> <a class="code" href="jbclass_8c.html#a1086ff75f2b78e26da435fcbda847d71">pixWordMaskByDilation</a>(<a class="code" href="struct_pix.html">PIX</a>      *pixs,
<a name="l01421"></a>01421                       <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   <a class="code" href="overlap__reg_8c.html#a332ff7829674eedb7280f7ea608e11c3">maxsize</a>,
<a name="l01422"></a>01422                       <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  *psize)
<a name="l01423"></a>01423 {
<a name="l01424"></a>01424 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, diffmin, ndiff, imin;
<a name="l01425"></a>01425 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  ncc[<a class="code" href="jbclass_8c.html#aea03502e6165da8502f438a16b430dfb">MAX_ALLOWED_DILATION</a> + 1];
<a name="l01426"></a>01426 <a class="code" href="struct_boxa.html">BOXA</a>    *boxa;
<a name="l01427"></a>01427 <a class="code" href="struct_numa.html">NUMA</a>    *nacc;
<a name="l01428"></a>01428 <a class="code" href="struct_pix.html">PIX</a>     *pixt1, *pixt2, *pixt3;
<a name="l01429"></a>01429 <a class="code" href="struct_pixa.html">PIXA</a>    *pixa;
<a name="l01430"></a>01430 <span class="keywordtype">SEL</span>     *sel;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;pixWordMaskbyDilation&quot;</span>);
<a name="l01433"></a>01433 
<a name="l01434"></a>01434     <span class="keywordflow">if</span> (!pixs)
<a name="l01435"></a>01435         <span class="keywordflow">return</span> (<a class="code" href="struct_pix.html">PIX</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;pixs not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01436"></a>01436 
<a name="l01437"></a>01437         <span class="comment">/* Find the optimal dilation to create the word mask.</span>
<a name="l01438"></a>01438 <span class="comment">         * Look for successively increasing dilations where the</span>
<a name="l01439"></a>01439 <span class="comment">         * number of connected components doesn&#39;t decrease.</span>
<a name="l01440"></a>01440 <span class="comment">         * This is the situation where the components in the</span>
<a name="l01441"></a>01441 <span class="comment">         * word mask should properly cover each word.  Use of</span>
<a name="l01442"></a>01442 <span class="comment">         * 4 cc slightly reduces the likelihood that words from</span>
<a name="l01443"></a>01443 <span class="comment">         * different lines are joined.  */</span>
<a name="l01444"></a>01444     diffmin = 1000000;
<a name="l01445"></a>01445     pixa = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(8);
<a name="l01446"></a>01446     pixt1 = <a class="code" href="leptprotos_8h.html#a421e342a65236aa6770965d34101e0ee">pixCopy</a>(<a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pixs);
<a name="l01447"></a>01447     <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pixt1, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa5d4fddf26f28ac80063028939562e17d">L_COPY</a>); 
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     <span class="keywordflow">if</span> (maxsize &lt;= 0)
<a name="l01450"></a>01450         maxsize = 7;  <span class="comment">/* default */</span>
<a name="l01451"></a>01451     <span class="keywordflow">if</span> (maxsize &gt; <a class="code" href="jbclass_8c.html#aea03502e6165da8502f438a16b430dfb">MAX_ALLOWED_DILATION</a>)
<a name="l01452"></a>01452         maxsize = <a class="code" href="jbclass_8c.html#aea03502e6165da8502f438a16b430dfb">MAX_ALLOWED_DILATION</a>;
<a name="l01453"></a>01453     nacc = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(maxsize);
<a name="l01454"></a>01454     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="overlap__reg_8c.html#a332ff7829674eedb7280f7ea608e11c3">maxsize</a>; i++) {
<a name="l01455"></a>01455         <span class="keywordflow">if</span> (i == 0)     <span class="comment">/* first one not dilated */</span>
<a name="l01456"></a>01456             pixt2 = <a class="code" href="leptprotos_8h.html#a421e342a65236aa6770965d34101e0ee">pixCopy</a>(<a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pixt1); 
<a name="l01457"></a>01457         <span class="keywordflow">else</span>    <span class="comment">/* successive dilation by sel_2h */</span>
<a name="l01458"></a>01458             pixt2 = <a class="code" href="leptprotos_8h.html#aac143671b2099c1306d08047e9caf097">pixMorphSequence</a>(pixt1, <span class="stringliteral">&quot;d2.1&quot;</span>, 0);
<a name="l01459"></a>01459         boxa = <a class="code" href="conncomp_8c.html#a134833bb47a2481e5c137b9933c71cc4">pixConnCompBB</a>(pixt2, 4);
<a name="l01460"></a>01460         ncc[<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>] = <a class="code" href="boxbasic_8c.html#a82555cab9ef5578c4728ef5109264723">boxaGetCount</a>(boxa);
<a name="l01461"></a>01461         <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(nacc, ncc[i]);
<a name="l01462"></a>01462         <span class="keywordflow">if</span> (i &gt; 0) {
<a name="l01463"></a>01463             ndiff = ncc[i - 1] - ncc[<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>];
<a name="l01464"></a>01464 <span class="preprocessor">#if  DEBUG_PLOT_CC</span>
<a name="l01465"></a>01465 <span class="preprocessor"></span>            fprintf(stderr, <span class="stringliteral">&quot;ndiff[%d] = %d\n&quot;</span>, i - 1, ndiff);
<a name="l01466"></a>01466 <span class="preprocessor">#endif  </span><span class="comment">/* DEBUG_PLOT_CC */</span>
<a name="l01467"></a>01467             <span class="keywordflow">if</span> (ndiff &lt; diffmin) {
<a name="l01468"></a>01468                 imin = <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>;
<a name="l01469"></a>01469                 diffmin = ndiff;
<a name="l01470"></a>01470             }
<a name="l01471"></a>01471         }
<a name="l01472"></a>01472         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixa, pixt2, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa5d4fddf26f28ac80063028939562e17d">L_COPY</a>);
<a name="l01473"></a>01473         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt1);
<a name="l01474"></a>01474         pixt1 = pixt2;
<a name="l01475"></a>01475         <a class="code" href="boxbasic_8c.html#ab61d85b07650c3e6c004878d8653b39a">boxaDestroy</a>(&amp;boxa);
<a name="l01476"></a>01476     }
<a name="l01477"></a>01477     <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt1);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479 <span class="preprocessor">#if  DEBUG_PLOT_CC</span>
<a name="l01480"></a>01480 <span class="preprocessor"></span>    {<a class="code" href="struct_g_plot.html">GPLOT</a> *gplot;
<a name="l01481"></a>01481      <a class="code" href="struct_numa.html">NUMA</a>  *naseq;
<a name="l01482"></a>01482         naseq = <a class="code" href="leptprotos_8h.html#aa3ca46ccb99596c9e5fe11d418999051">numaMakeSequence</a>(1, 1, <a class="code" href="leptprotos_8h.html#a3d022536ec48f28421c56f586d697295">numaGetCount</a>(nacc));
<a name="l01483"></a>01483         gplot = <a class="code" href="gplot_8c.html#a1cea7ad39c28d5fafe6d7c78dcde1a38">gplotCreate</a>(<span class="stringliteral">&quot;/tmp/cc_output&quot;</span>, <a class="code" href="gplot_8h.html#ad61780b3a55293b7407ebc21664d12c7a4b08f0c99fe0e26e5d711e1e62e9fd28">GPLOT_PNG</a>,
<a name="l01484"></a>01484                             <span class="stringliteral">&quot;Number of cc vs. horizontal dilation&quot;</span>,
<a name="l01485"></a>01485                             <span class="stringliteral">&quot;Sel horiz&quot;</span>, <span class="stringliteral">&quot;Number of cc&quot;</span>);
<a name="l01486"></a>01486         <a class="code" href="gplot_8c.html#a22647c46c1f717aa07b7fb32c3ff4405">gplotAddPlot</a>(gplot, naseq, nacc, <a class="code" href="gplot_8h.html#a06937a26d77a22b1f8a05a56d51f3e0fa6a9387171728ae8645d8b9b723656874">GPLOT_LINES</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01487"></a>01487         <a class="code" href="gplot_8c.html#a845b86586092c48fa4e8d3e85ee8538b">gplotMakeOutput</a>(gplot);
<a name="l01488"></a>01488         <a class="code" href="gplot_8c.html#a4aa17b7b0a295467906f76b7d7209d4f">gplotDestroy</a>(&amp;gplot);
<a name="l01489"></a>01489         <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;naseq);
<a name="l01490"></a>01490     }
<a name="l01491"></a>01491 <span class="preprocessor">#endif  </span><span class="comment">/* DEBUG_PLOT_CC */</span>
<a name="l01492"></a>01492 
<a name="l01493"></a>01493         <span class="comment">/* Save the result of the optimal dilation */</span>
<a name="l01494"></a>01494     pixt2 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa, imin, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01495"></a>01495     sel = <a class="code" href="leptprotos_8h.html#acee5ec03dbf621f7bf42f4c4d5f4abd9">selCreateBrick</a>(1, imin, 0, imin - 1, <a class="code" href="morph_8h.html#aba01db17f4a2bfbc3db60dc172972a25a23bacbc5f9d51af0d2fd25f5b80baa87">SEL_HIT</a>);
<a name="l01496"></a>01496     pixt3 = <a class="code" href="leptprotos_8h.html#a4ad2d04919aa0b65fab93f693c9323b1">pixErode</a>(<a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pixt2, sel);  <span class="comment">/* remove effect of dilation */</span>
<a name="l01497"></a>01497     <a class="code" href="leptprotos_8h.html#a4bb811007e4d825b4be1712433584df9">selDestroy</a>(&amp;sel);
<a name="l01498"></a>01498     <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt2);
<a name="l01499"></a>01499     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa);
<a name="l01500"></a>01500     <span class="keywordflow">if</span> (psize)
<a name="l01501"></a>01501         *psize = imin + 1;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;nacc);
<a name="l01504"></a>01504     <span class="keywordflow">return</span> pixt3;
<a name="l01505"></a>01505 }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l01509"></a>01509 <span class="comment"> *                 Build grayscale composites (templates)               *</span>
<a name="l01510"></a>01510 <span class="comment"> *----------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01511"></a>01511 <span class="comment">/*!</span>
<a name="l01512"></a>01512 <span class="comment"> *  jbAccumulateComposites()</span>
<a name="l01513"></a>01513 <span class="comment"> *</span>
<a name="l01514"></a>01514 <span class="comment"> *      Input:  pixaa (one pixa for each class)</span>
<a name="l01515"></a>01515 <span class="comment"> *              &amp;pna (&lt;return&gt; number of samples used to build each composite)</span>
<a name="l01516"></a>01516 <span class="comment"> *              &amp;ptat (&lt;return&gt; centroids of bordered composites)</span>
<a name="l01517"></a>01517 <span class="comment"> *      Return: pixad (accumulated sum of samples in each class),</span>
<a name="l01518"></a>01518 <span class="comment"> *                     or null on error</span>
<a name="l01519"></a>01519 <span class="comment"> *</span>
<a name="l01520"></a>01520 <span class="comment"> */</span>
<a name="l01521"></a>01521 <a class="code" href="struct_pixa.html">PIXA</a> *
<a name="l01522"></a><a class="code" href="leptprotos_8h.html#a365485894b9424fdaf26fc26d77d9339">01522</a> <a class="code" href="jbclass_8c.html#ac5f0220df26bda8ba3080b0fef17b8f4">jbAccumulateComposites</a>(<a class="code" href="struct_pixaa.html">PIXAA</a>  *pixaa,
<a name="l01523"></a>01523                        <a class="code" href="struct_numa.html">NUMA</a>  **pna,
<a name="l01524"></a>01524                        <a class="code" href="struct_pta.html">PTA</a>   **pptat)
<a name="l01525"></a>01525 {
<a name="l01526"></a>01526 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>, nt, <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, j, d, minw, maxw, minh, maxh, xdiff, ydiff;
<a name="l01527"></a>01527 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  x, y, xave, yave;
<a name="l01528"></a>01528 <a class="code" href="struct_numa.html">NUMA</a>      *na;
<a name="l01529"></a>01529 <a class="code" href="struct_pix.html">PIX</a>       *pix, *pixt1, *pixt2, *pixsum;
<a name="l01530"></a>01530 <a class="code" href="struct_pixa.html">PIXA</a>      *pixa, *pixad;
<a name="l01531"></a>01531 <a class="code" href="struct_pta.html">PTA</a>       *ptat, *pta;
<a name="l01532"></a>01532 
<a name="l01533"></a>01533     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbAccumulateComposites&quot;</span>);
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     <span class="keywordflow">if</span> (!pptat)
<a name="l01536"></a>01536         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;&amp;ptat not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01537"></a>01537     *pptat = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01538"></a>01538     <span class="keywordflow">if</span> (!pna)
<a name="l01539"></a>01539         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;&amp;na not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01540"></a>01540     *pna = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01541"></a>01541     <span class="keywordflow">if</span> (!pixaa)
<a name="l01542"></a>01542         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;pixaa not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01543"></a>01543 
<a name="l01544"></a>01544     n = <a class="code" href="leptprotos_8h.html#a0692c542d46daef23fb86d0122553d6a">pixaaGetCount</a>(pixaa);
<a name="l01545"></a>01545     <span class="keywordflow">if</span> ((ptat = <a class="code" href="leptprotos_8h.html#a6f854462ee35cb8c974752cacc4170ed">ptaCreate</a>(n)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01546"></a>01546         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;ptat not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01547"></a>01547     *pptat = ptat;
<a name="l01548"></a>01548     pixad = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(n);
<a name="l01549"></a>01549     na = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(n);
<a name="l01550"></a>01550     *pna = na;
<a name="l01551"></a>01551 
<a name="l01552"></a>01552     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l01553"></a>01553         pixa = <a class="code" href="leptprotos_8h.html#abb96ec0a09fa720b62cabb2604406938">pixaaGetPixa</a>(pixaa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01554"></a>01554         nt = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixa);
<a name="l01555"></a>01555         <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(na, nt);
<a name="l01556"></a>01556         <span class="keywordflow">if</span> (nt == 0) {
<a name="l01557"></a>01557             <a class="code" href="environ_8h.html#a80ea4add6888dc55f0f6af9c488f1f21">L_WARNING</a>(<span class="stringliteral">&quot;empty pixa found!&quot;</span>, procName);
<a name="l01558"></a>01558             <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa);
<a name="l01559"></a>01559             <span class="keywordflow">continue</span>;
<a name="l01560"></a>01560         }
<a name="l01561"></a>01561         <a class="code" href="leptprotos_8h.html#a3123ecc9bfd2fd709ad18e4a745963a9">pixaSizeRange</a>(pixa, &amp;minw, &amp;minh, &amp;maxw, &amp;maxh);
<a name="l01562"></a>01562         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa, 0, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01563"></a>01563         d = <a class="code" href="leptprotos_8h.html#a1646270a1eae38cd7af74c68351ce513">pixGetDepth</a>(pix);
<a name="l01564"></a>01564         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix);
<a name="l01565"></a>01565         pixt1 = <a class="code" href="leptprotos_8h.html#a009df4671d39f94b50a0368af210aebe">pixCreate</a>(maxw, maxh, d);
<a name="l01566"></a>01566         pixsum = <a class="code" href="leptprotos_8h.html#ad179fc83968ea8799fd53d9ea55e3e36">pixInitAccumulate</a>(maxw, maxh, 0);
<a name="l01567"></a>01567         pta = <a class="code" href="leptprotos_8h.html#ab3509eb44877b85988432e6e2462e1bb">pixaCentroids</a>(pixa);
<a name="l01568"></a>01568 
<a name="l01569"></a>01569             <span class="comment">/* Find the average value of the centroids ... */</span>
<a name="l01570"></a>01570         xave = yave = 0;
<a name="l01571"></a>01571         <span class="keywordflow">for</span> (j = 0; j &lt; nt; j++) {
<a name="l01572"></a>01572             <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(pta, j, &amp;x, &amp;y);
<a name="l01573"></a>01573             xave += x;
<a name="l01574"></a>01574             yave += y;
<a name="l01575"></a>01575         }
<a name="l01576"></a>01576         xave = xave / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)nt;
<a name="l01577"></a>01577         yave = yave / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)nt;
<a name="l01578"></a>01578 
<a name="l01579"></a>01579             <span class="comment">/* and place all centroids at their average value */</span>
<a name="l01580"></a>01580         <span class="keywordflow">for</span> (j = 0; j &lt; nt; j++) {
<a name="l01581"></a>01581             pixt2 = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixa, j, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l01582"></a>01582             <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(pta, j, &amp;x, &amp;y);
<a name="l01583"></a>01583             xdiff = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(x - xave);
<a name="l01584"></a>01584             ydiff = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(y - yave);
<a name="l01585"></a>01585             <a class="code" href="leptprotos_8h.html#a075babbe353b694d401d47bdf5210d82">pixClearAll</a>(pixt1);
<a name="l01586"></a>01586             <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixt1, xdiff, ydiff, maxw, maxh, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a>,
<a name="l01587"></a>01587                         pixt2, 0, 0);
<a name="l01588"></a>01588             <a class="code" href="leptprotos_8h.html#aabe4c42dae835c3f590acb661e8902c9">pixAccumulate</a>(pixsum, pixt1, <a class="code" href="morph_8h.html#aae05225933a42f81e7c4a9fb286596f9a92a06b4235c960c8efd4bace9836a731">L_ARITH_ADD</a>);
<a name="l01589"></a>01589             <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt2);
<a name="l01590"></a>01590         }
<a name="l01591"></a>01591         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixad, pixsum, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l01592"></a>01592         <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(ptat, xave, yave);
<a name="l01593"></a>01593 
<a name="l01594"></a>01594         <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixa);
<a name="l01595"></a>01595         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt1);
<a name="l01596"></a>01596         <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;pta);
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599     <span class="keywordflow">return</span> pixad;
<a name="l01600"></a>01600 }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="comment"></span>
<a name="l01603"></a>01603 <span class="comment">/*!</span>
<a name="l01604"></a>01604 <span class="comment"> *  jbTemplatesFromComposites()</span>
<a name="l01605"></a>01605 <span class="comment"> *</span>
<a name="l01606"></a>01606 <span class="comment"> *      Input:  pixac (one pix of composites for each class)</span>
<a name="l01607"></a>01607 <span class="comment"> *              na (number of samples used for each class composite)</span>
<a name="l01608"></a>01608 <span class="comment"> *      Return: pixad (8 bpp templates for each class), or null on error</span>
<a name="l01609"></a>01609 <span class="comment"> *</span>
<a name="l01610"></a>01610 <span class="comment"> */</span>
<a name="l01611"></a>01611 <a class="code" href="struct_pixa.html">PIXA</a> *
<a name="l01612"></a><a class="code" href="leptprotos_8h.html#a61c855095c0d379f3a395748f4223e4c">01612</a> <a class="code" href="jbclass_8c.html#aebc85937d82c13a6ae81dc2cd456e5e7">jbTemplatesFromComposites</a>(<a class="code" href="struct_pixa.html">PIXA</a>  *pixac,
<a name="l01613"></a>01613                           <a class="code" href="struct_numa.html">NUMA</a>  *na)
<a name="l01614"></a>01614 {
<a name="l01615"></a>01615 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>, <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>;
<a name="l01616"></a>01616 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  nt;  <span class="comment">/* number of samples in the composite; always an integer */</span>
<a name="l01617"></a>01617 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  factor;
<a name="l01618"></a>01618 <a class="code" href="struct_pix.html">PIX</a>       *pixsum;   <span class="comment">/* accumulated composite */</span>
<a name="l01619"></a>01619 <a class="code" href="struct_pix.html">PIX</a>       *pixd;
<a name="l01620"></a>01620 <a class="code" href="struct_pixa.html">PIXA</a>      *pixad;
<a name="l01621"></a>01621 
<a name="l01622"></a>01622     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbTemplatesFromComposites&quot;</span>);
<a name="l01623"></a>01623 
<a name="l01624"></a>01624     <span class="keywordflow">if</span> (!pixac)
<a name="l01625"></a>01625         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;pixac not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01626"></a>01626     <span class="keywordflow">if</span> (!na)
<a name="l01627"></a>01627         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;na not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01628"></a>01628 
<a name="l01629"></a>01629     n = <a class="code" href="leptprotos_8h.html#a098d32e94acc16c5d6e91a930a4b45ff">pixaGetCount</a>(pixac);
<a name="l01630"></a>01630     pixad = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(n);
<a name="l01631"></a>01631     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l01632"></a>01632         pixsum = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixac, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa5d4fddf26f28ac80063028939562e17d">L_COPY</a>);  <span class="comment">/* changed internally */</span>
<a name="l01633"></a>01633         <a class="code" href="leptprotos_8h.html#a9fc8c2ee1c5af6d982bda74e44a9fabe">numaGetFValue</a>(na, i, &amp;nt);
<a name="l01634"></a>01634         factor = 255. / nt;
<a name="l01635"></a>01635         <a class="code" href="leptprotos_8h.html#a87174a55550cc89dacdc5162a4819bb1">pixMultConstAccumulate</a>(pixsum, factor, 0);  <span class="comment">/* changes pixsum */</span>
<a name="l01636"></a>01636         pixd = <a class="code" href="leptprotos_8h.html#afe6100b79aea3d53b38e3d5e1c6ecfcf">pixFinalAccumulate</a>(pixsum, 0, 8);
<a name="l01637"></a>01637         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixad, pixd, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l01638"></a>01638         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixsum);
<a name="l01639"></a>01639     }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641     <span class="keywordflow">return</span> pixad;
<a name="l01642"></a>01642 }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644 
<a name="l01645"></a>01645 
<a name="l01646"></a>01646 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l01647"></a>01647 <span class="comment"> *                       jbig2 utility routines                         *</span>
<a name="l01648"></a>01648 <span class="comment"> *----------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01649"></a>01649 <span class="comment">/*!</span>
<a name="l01650"></a>01650 <span class="comment"> *  jbClasserCreate()</span>
<a name="l01651"></a>01651 <span class="comment"> *</span>
<a name="l01652"></a>01652 <span class="comment"> *      Input:  method (JB_RANKHAUS, JB_CORRELATION) </span>
<a name="l01653"></a>01653 <span class="comment"> *              components (JB_CONN_COMPS, JB_CHARACTERS, JB_WORDS)</span>
<a name="l01654"></a>01654 <span class="comment"> *      Return: jbclasser, or null on error</span>
<a name="l01655"></a>01655 <span class="comment"> */</span>
<a name="l01656"></a>01656 <a class="code" href="struct_jb_classer.html">JBCLASSER</a> *
<a name="l01657"></a><a class="code" href="leptprotos_8h.html#af5c465196ec29fac441da6700d33d6eb">01657</a> <a class="code" href="jbclass_8c.html#aceeab4ff692f0678d098ec66bf507f4d">jbClasserCreate</a>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  method,
<a name="l01658"></a>01658                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  components)
<a name="l01659"></a>01659 {
<a name="l01660"></a>01660 <a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l01661"></a>01661 
<a name="l01662"></a>01662     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbClasserCreate&quot;</span>);
<a name="l01663"></a>01663 
<a name="l01664"></a>01664     <span class="keywordflow">if</span> ((classer = (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(1, <span class="keyword">sizeof</span>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01665"></a>01665         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;classer not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01666"></a>01666     <span class="keywordflow">if</span> (method != <a class="code" href="jbclass_8h.html#abc5c98fcc1211af2b80116dd6e0a035da1b98462873a302ca0fee887395223613">JB_RANKHAUS</a> &amp;&amp; method != <a class="code" href="jbclass_8h.html#abc5c98fcc1211af2b80116dd6e0a035da430cbfbe3fcfef28053503c9fb373302">JB_CORRELATION</a>)
<a name="l01667"></a>01667         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;invalid type&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01668"></a>01668     <span class="keywordflow">if</span> (components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a27e7cdfb87413a6d3686bebc93a3dac6">JB_CONN_COMPS</a> &amp;&amp; components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad563d0eeaf2c300cf43b05c2e6871708">JB_CHARACTERS</a> &amp;&amp;
<a name="l01669"></a>01669         components != <a class="code" href="jbclass_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a130c542f7784940fd858243d1c05b898">JB_WORDS</a>)
<a name="l01670"></a>01670         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_classer.html">JBCLASSER</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;invalid type&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01671"></a>01671 
<a name="l01672"></a>01672     classer-&gt;<a class="code" href="struct_jb_classer.html#af425c85b5125be856f3284894c4c5248">method</a> = method;
<a name="l01673"></a>01673     classer-&gt;<a class="code" href="struct_jb_classer.html#aed468ae5fb0a0189a6c1571e7bf2c8dd">components</a> = components;
<a name="l01674"></a>01674     classer-&gt;<a class="code" href="struct_jb_classer.html#adb5d976c29fedc3bc2b2564810328871">nacomps</a> = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(0);
<a name="l01675"></a>01675     classer-&gt;<a class="code" href="struct_jb_classer.html#a7a3928f69ea217d8463e8d7e00076a67">pixaa</a> = <a class="code" href="leptprotos_8h.html#a1ac1e184cbacdf1288408d58c6f426f0">pixaaCreate</a>(0);
<a name="l01676"></a>01676     classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a> = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(0);
<a name="l01677"></a>01677     classer-&gt;<a class="code" href="struct_jb_classer.html#afaf65037366791c6591a4f520c7826f1">pixatd</a> = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(0);
<a name="l01678"></a>01678     classer-&gt;<a class="code" href="struct_jb_classer.html#a795a12e05bff1ca4e34106046db1c5cb">nafgt</a> = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(0);
<a name="l01679"></a>01679     classer-&gt;<a class="code" href="struct_jb_classer.html#a36a7c9bb53818520f10017b622f84a77">naarea</a> = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(0);
<a name="l01680"></a>01680     classer-&gt;<a class="code" href="struct_jb_classer.html#a2462eb667abe08e30b22676b4e30d101">ptac</a> = <a class="code" href="leptprotos_8h.html#a6f854462ee35cb8c974752cacc4170ed">ptaCreate</a>(0);
<a name="l01681"></a>01681     classer-&gt;<a class="code" href="struct_jb_classer.html#af15ce939e8925d3971799c6cc4ce68a5">ptact</a> = <a class="code" href="leptprotos_8h.html#a6f854462ee35cb8c974752cacc4170ed">ptaCreate</a>(0);
<a name="l01682"></a>01682     classer-&gt;<a class="code" href="struct_jb_classer.html#a61916a7940b3d7d011b536c16acdf587">naclass</a> = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(0);
<a name="l01683"></a>01683     classer-&gt;<a class="code" href="struct_jb_classer.html#a47fa04849b137efb50869f8a182c781c">napage</a> = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(0);
<a name="l01684"></a>01684     classer-&gt;<a class="code" href="struct_jb_classer.html#a718333fe33da446fb87af8797c01b9c9">ptaul</a> = <a class="code" href="leptprotos_8h.html#a6f854462ee35cb8c974752cacc4170ed">ptaCreate</a>(0);
<a name="l01685"></a>01685 
<a name="l01686"></a>01686     <span class="keywordflow">return</span> <a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l01687"></a>01687 }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689 
<a name="l01690"></a>01690 <span class="comment">/*</span>
<a name="l01691"></a>01691 <span class="comment"> *  jbClasserDestroy()</span>
<a name="l01692"></a>01692 <span class="comment"> *</span>
<a name="l01693"></a>01693 <span class="comment"> *      Input: &amp;classer (&lt;to be nulled&gt;)</span>
<a name="l01694"></a>01694 <span class="comment"> *      Return: void</span>
<a name="l01695"></a>01695 <span class="comment"> */</span>
<a name="l01696"></a>01696 <span class="keywordtype">void</span>
<a name="l01697"></a><a class="code" href="leptprotos_8h.html#a0c454e17688f373881ea116d2a8a38c1">01697</a> <a class="code" href="jbclass_8c.html#a9d7dfe6cf87846dd129e541b51563b5e">jbClasserDestroy</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  **pclasser)
<a name="l01698"></a>01698 {
<a name="l01699"></a>01699 <a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701     <span class="keywordflow">if</span> (!pclasser)
<a name="l01702"></a>01702         <span class="keywordflow">return</span>;
<a name="l01703"></a>01703     <span class="keywordflow">if</span> ((classer = *pclasser) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01704"></a>01704         <span class="keywordflow">return</span>;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     <a class="code" href="leptprotos_8h.html#a6bc238d36ad4599585c7de09105f83c2">sarrayDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a2d8e64834d0aac76c4a96645e016d2f0">safiles</a>);
<a name="l01707"></a>01707     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#adb5d976c29fedc3bc2b2564810328871">nacomps</a>);
<a name="l01708"></a>01708     <a class="code" href="leptprotos_8h.html#a46ae0572a3faf3ccbda850973855d849">pixaaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a7a3928f69ea217d8463e8d7e00076a67">pixaa</a>);
<a name="l01709"></a>01709     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>);
<a name="l01710"></a>01710     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#afaf65037366791c6591a4f520c7826f1">pixatd</a>);
<a name="l01711"></a>01711     <a class="code" href="leptprotos_8h.html#a453be41b417b90351a9759f1f88f2fef">numaHashDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a1d395848f89b39b2a6c0626c0b9d33c1">nahash</a>);
<a name="l01712"></a>01712     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a795a12e05bff1ca4e34106046db1c5cb">nafgt</a>);
<a name="l01713"></a>01713     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a36a7c9bb53818520f10017b622f84a77">naarea</a>);
<a name="l01714"></a>01714     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a2462eb667abe08e30b22676b4e30d101">ptac</a>);
<a name="l01715"></a>01715     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#af15ce939e8925d3971799c6cc4ce68a5">ptact</a>);
<a name="l01716"></a>01716     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a61916a7940b3d7d011b536c16acdf587">naclass</a>);
<a name="l01717"></a>01717     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a47fa04849b137efb50869f8a182c781c">napage</a>);
<a name="l01718"></a>01718     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a718333fe33da446fb87af8797c01b9c9">ptaul</a>);
<a name="l01719"></a>01719     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a4477cf4397273988d90b3f51091420b6">ptall</a>);
<a name="l01720"></a>01720     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(classer);
<a name="l01721"></a>01721     *pclasser = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01722"></a>01722     <span class="keywordflow">return</span>;
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724     
<a name="l01725"></a>01725 <span class="comment"></span>
<a name="l01726"></a>01726 <span class="comment">/*!</span>
<a name="l01727"></a>01727 <span class="comment"> *  jbDataSave()</span>
<a name="l01728"></a>01728 <span class="comment"> *</span>
<a name="l01729"></a>01729 <span class="comment"> *      Input:  jbclasser</span>
<a name="l01730"></a>01730 <span class="comment"> *              latticew, latticeh (cell size used to store each</span>
<a name="l01731"></a>01731 <span class="comment"> *                  connected component in the composite)</span>
<a name="l01732"></a>01732 <span class="comment"> *      Return: jbdata, or null on error</span>
<a name="l01733"></a>01733 <span class="comment"> *</span>
<a name="l01734"></a>01734 <span class="comment"> *  Notes:</span>
<a name="l01735"></a>01735 <span class="comment"> *      (1) This routine stores the jbig2-type data required for</span>
<a name="l01736"></a>01736 <span class="comment"> *          generating a lossy jbig2 version of the image.</span>
<a name="l01737"></a>01737 <span class="comment"> *          It can be losslessly written to (and read from) two files.</span>
<a name="l01738"></a>01738 <span class="comment"> *      (2) It generates and stores the mosaic of templates.</span>
<a name="l01739"></a>01739 <span class="comment"> *      (3) It clones the Numa and Pta arrays, so these must all</span>
<a name="l01740"></a>01740 <span class="comment"> *          be destroyed by the caller.</span>
<a name="l01741"></a>01741 <span class="comment"> *      (4) Input 0 to use the default values for latticew and/or latticeh,</span>
<a name="l01742"></a>01742 <span class="comment"> */</span>
<a name="l01743"></a>01743 <a class="code" href="struct_jb_data.html">JBDATA</a> *
<a name="l01744"></a><a class="code" href="leptprotos_8h.html#a8eab01d20de7b8c7fc647a0ae3529786">01744</a> <a class="code" href="jbclass_8c.html#a546a6532d265ba45c380d94a9a1f2461">jbDataSave</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>)
<a name="l01745"></a>01745 {
<a name="l01746"></a>01746 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  maxw, maxh;
<a name="l01747"></a>01747 <a class="code" href="struct_jb_data.html">JBDATA</a>  *data;
<a name="l01748"></a>01748 <a class="code" href="struct_pix.html">PIX</a>     *pix;
<a name="l01749"></a>01749 
<a name="l01750"></a>01750     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbDataSave&quot;</span>);
<a name="l01751"></a>01751 
<a name="l01752"></a>01752     <span class="keywordflow">if</span> (!classer)
<a name="l01753"></a>01753         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;classer not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01754"></a>01754 
<a name="l01755"></a>01755         <span class="comment">/* Write the templates into an array. */</span>
<a name="l01756"></a>01756     <a class="code" href="leptprotos_8h.html#a3123ecc9bfd2fd709ad18e4a745963a9">pixaSizeRange</a>(classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;maxw, &amp;maxh);
<a name="l01757"></a>01757     <span class="keywordflow">if</span> ((pix = <a class="code" href="leptprotos_8h.html#aa484d914ef5145af5582d39d1b2ba24a">pixaDisplayOnLattice</a>(classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>, maxw + 1, maxh + 1))
<a name="l01758"></a>01758             == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01759"></a>01759         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;data not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01760"></a>01760 
<a name="l01761"></a>01761     <span class="keywordflow">if</span> ((data = (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(1, <span class="keyword">sizeof</span>(<a class="code" href="struct_jb_data.html">JBDATA</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01762"></a>01762         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;data not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01763"></a>01763     data-&gt;<a class="code" href="struct_jb_data.html#a54b277fae33c3486e6bc721185842222">pix</a> = pix;
<a name="l01764"></a>01764     data-&gt;<a class="code" href="struct_jb_data.html#a3ab8a799f36135ac48d62aef4eb3b713">npages</a> = classer-&gt;<a class="code" href="struct_jb_classer.html#a39fb1c2330fe7cabb44758fa99bdc0ed">npages</a>;
<a name="l01765"></a>01765     data-&gt;<a class="code" href="struct_jb_data.html#a74b90ce854e8694afbd0c697f8a2aa9a">w</a> = classer-&gt;<a class="code" href="struct_jb_classer.html#aa2edd4d8997b309e5bf52cb6d0dee9ef">w</a>;
<a name="l01766"></a>01766     data-&gt;<a class="code" href="struct_jb_data.html#a61dd09a5b7af651a9c95a4755fa0588d">h</a> = classer-&gt;<a class="code" href="struct_jb_classer.html#a25499466fd3b0f8edebca53ce87e3930">h</a>;
<a name="l01767"></a>01767     data-&gt;<a class="code" href="struct_jb_data.html#a44c70538c4464b12f0320745fa00d9f9">nclass</a> = classer-&gt;<a class="code" href="struct_jb_classer.html#a64be52ca0b1240ceafa17123be0470fd">nclass</a>;
<a name="l01768"></a>01768     data-&gt;<a class="code" href="struct_jb_data.html#a0f27384101bb8b530dd9e3932ba78272">latticew</a> = maxw + 1;
<a name="l01769"></a>01769     data-&gt;<a class="code" href="struct_jb_data.html#a386cbc2c5bf7dc20a079809e774d7efc">latticeh</a> = maxh + 1;
<a name="l01770"></a>01770     data-&gt;<a class="code" href="struct_jb_data.html#a4470068b339a471b41fc0bd22e25d998">naclass</a> = <a class="code" href="leptprotos_8h.html#ad97cb5a7bb5a66a9f631ffce6f2ae3d1">numaClone</a>(classer-&gt;<a class="code" href="struct_jb_classer.html#a61916a7940b3d7d011b536c16acdf587">naclass</a>);
<a name="l01771"></a>01771     data-&gt;<a class="code" href="struct_jb_data.html#a2cfa7fe12f8d7171d5b0023c01099e0a">napage</a> = <a class="code" href="leptprotos_8h.html#ad97cb5a7bb5a66a9f631ffce6f2ae3d1">numaClone</a>(classer-&gt;<a class="code" href="struct_jb_classer.html#a47fa04849b137efb50869f8a182c781c">napage</a>);
<a name="l01772"></a>01772     data-&gt;<a class="code" href="struct_jb_data.html#a5931bcde3516065865678d4388884eee">ptaul</a> = <a class="code" href="leptprotos_8h.html#a237cb666a7203e9363db5545dee47200">ptaClone</a>(classer-&gt;<a class="code" href="struct_jb_classer.html#a718333fe33da446fb87af8797c01b9c9">ptaul</a>);
<a name="l01773"></a>01773 
<a name="l01774"></a>01774     <span class="keywordflow">return</span> data;
<a name="l01775"></a>01775 }
<a name="l01776"></a>01776 
<a name="l01777"></a>01777 
<a name="l01778"></a>01778 <span class="comment">/*</span>
<a name="l01779"></a>01779 <span class="comment"> *  jbDataDestroy()</span>
<a name="l01780"></a>01780 <span class="comment"> *</span>
<a name="l01781"></a>01781 <span class="comment"> *      Input: &amp;data (&lt;to be nulled&gt;)</span>
<a name="l01782"></a>01782 <span class="comment"> *      Return: void</span>
<a name="l01783"></a>01783 <span class="comment"> */</span>
<a name="l01784"></a>01784 <span class="keywordtype">void</span>
<a name="l01785"></a><a class="code" href="leptprotos_8h.html#a5386b99f32f2199d504595022713f555">01785</a> <a class="code" href="jbclass_8c.html#a2b36f1ed22475956e5382fbd79787893">jbDataDestroy</a>(<a class="code" href="struct_jb_data.html">JBDATA</a>  **pdata)
<a name="l01786"></a>01786 {
<a name="l01787"></a>01787 <a class="code" href="struct_jb_data.html">JBDATA</a>  *data;
<a name="l01788"></a>01788 
<a name="l01789"></a>01789     <span class="keywordflow">if</span> (!pdata)
<a name="l01790"></a>01790         <span class="keywordflow">return</span>;
<a name="l01791"></a>01791     <span class="keywordflow">if</span> ((data = *pdata) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01792"></a>01792         <span class="keywordflow">return</span>;
<a name="l01793"></a>01793 
<a name="l01794"></a>01794     <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;data-&gt;<a class="code" href="struct_jb_data.html#a54b277fae33c3486e6bc721185842222">pix</a>);
<a name="l01795"></a>01795     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;data-&gt;<a class="code" href="struct_jb_data.html#a4470068b339a471b41fc0bd22e25d998">naclass</a>);
<a name="l01796"></a>01796     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;data-&gt;<a class="code" href="struct_jb_data.html#a2cfa7fe12f8d7171d5b0023c01099e0a">napage</a>);
<a name="l01797"></a>01797     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;data-&gt;<a class="code" href="struct_jb_data.html#a5931bcde3516065865678d4388884eee">ptaul</a>);
<a name="l01798"></a>01798     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(data);
<a name="l01799"></a>01799     *pdata = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01800"></a>01800     <span class="keywordflow">return</span>;
<a name="l01801"></a>01801 }
<a name="l01802"></a>01802     
<a name="l01803"></a>01803 <span class="comment"></span>
<a name="l01804"></a>01804 <span class="comment">/*!</span>
<a name="l01805"></a>01805 <span class="comment"> *  jbDataWrite()</span>
<a name="l01806"></a>01806 <span class="comment"> *</span>
<a name="l01807"></a>01807 <span class="comment"> *      Input:  rootname (for output files; everything but the extension)</span>
<a name="l01808"></a>01808 <span class="comment"> *              jbdata</span>
<a name="l01809"></a>01809 <span class="comment"> *      Return: 0 if OK, 1 on error</span>
<a name="l01810"></a>01810 <span class="comment"> *</span>
<a name="l01811"></a>01811 <span class="comment"> *  Notes:</span>
<a name="l01812"></a>01812 <span class="comment"> *      (1) Serialization function that writes data in jbdata to file.</span>
<a name="l01813"></a>01813 <span class="comment"> */</span>
<a name="l01814"></a>01814 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l01815"></a><a class="code" href="leptprotos_8h.html#a08d2fac58dd54b58dbcee43113819100">01815</a> <a class="code" href="jbclass_8c.html#a2c3cad0429ed158423f0b9b82b51f80a">jbDataWrite</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>  *rootout,
<a name="l01816"></a>01816             <a class="code" href="struct_jb_data.html">JBDATA</a>      *jbdata)
<a name="l01817"></a>01817 {
<a name="l01818"></a>01818 <span class="keywordtype">char</span>     <a class="code" href="otsutest1_8c.html#a866e3eea299e33d1f7cdc6e46e65835f">buf</a>[<a class="code" href="jbclass_8c.html#af1791633b3a1a12a9aa449aa6d558327">L_BUF_SIZE</a>];
<a name="l01819"></a>01819 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a>, <a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a>, nclass, npages, cellw, cellh, ncomp, <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, x, y, iclass, ipage;
<a name="l01820"></a>01820 <a class="code" href="struct_numa.html">NUMA</a>    *naclass, *napage;
<a name="l01821"></a>01821 <a class="code" href="struct_pta.html">PTA</a>     *ptaul;
<a name="l01822"></a>01822 <a class="code" href="struct_pix.html">PIX</a>     *pixt;
<a name="l01823"></a>01823 FILE    *fp;
<a name="l01824"></a>01824     
<a name="l01825"></a>01825     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbDataWrite&quot;</span>);
<a name="l01826"></a>01826 
<a name="l01827"></a>01827     <span class="keywordflow">if</span> (!rootout)
<a name="l01828"></a>01828         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;no rootout&quot;</span>, procName, 1);
<a name="l01829"></a>01829     <span class="keywordflow">if</span> (!jbdata)
<a name="l01830"></a>01830         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;no jbdata&quot;</span>, procName, 1);
<a name="l01831"></a>01831 
<a name="l01832"></a>01832     npages = jbdata-&gt;<a class="code" href="struct_jb_data.html#a3ab8a799f36135ac48d62aef4eb3b713">npages</a>;
<a name="l01833"></a>01833     w = jbdata-&gt;<a class="code" href="struct_jb_data.html#a74b90ce854e8694afbd0c697f8a2aa9a">w</a>;
<a name="l01834"></a>01834     h = jbdata-&gt;<a class="code" href="struct_jb_data.html#a61dd09a5b7af651a9c95a4755fa0588d">h</a>;
<a name="l01835"></a>01835     pixt = jbdata-&gt;<a class="code" href="struct_jb_data.html#a54b277fae33c3486e6bc721185842222">pix</a>;
<a name="l01836"></a>01836     nclass = jbdata-&gt;<a class="code" href="struct_jb_data.html#a44c70538c4464b12f0320745fa00d9f9">nclass</a>;
<a name="l01837"></a>01837     cellw = jbdata-&gt;<a class="code" href="struct_jb_data.html#a0f27384101bb8b530dd9e3932ba78272">latticew</a>;
<a name="l01838"></a>01838     cellh = jbdata-&gt;<a class="code" href="struct_jb_data.html#a386cbc2c5bf7dc20a079809e774d7efc">latticeh</a>;
<a name="l01839"></a>01839     naclass = jbdata-&gt;<a class="code" href="struct_jb_data.html#a4470068b339a471b41fc0bd22e25d998">naclass</a>;
<a name="l01840"></a>01840     napage = jbdata-&gt;<a class="code" href="struct_jb_data.html#a2cfa7fe12f8d7171d5b0023c01099e0a">napage</a>;
<a name="l01841"></a>01841     ptaul = jbdata-&gt;<a class="code" href="struct_jb_data.html#a5931bcde3516065865678d4388884eee">ptaul</a>;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843     snprintf(buf, <a class="code" href="jbclass_8c.html#af1791633b3a1a12a9aa449aa6d558327">L_BUF_SIZE</a>, <span class="stringliteral">&quot;%s%s&quot;</span>, rootout, <a class="code" href="jbclass_8h.html#a3be4ca42b3affc03f186bca3643970cc">JB_TEMPLATE_EXT</a>); 
<a name="l01844"></a>01844     <a class="code" href="leptprotos_8h.html#a5a9a534e77de5e57d74ff3d678ca59e0">pixWrite</a>(buf, pixt, <a class="code" href="imageio_8h.html#a726ca809ffd3d67ab4b8476646f26635a2ec77ead70eea85c6d7cc7372ea7394e">IFF_PNG</a>);
<a name="l01845"></a>01845 
<a name="l01846"></a>01846     snprintf(buf, <a class="code" href="jbclass_8c.html#af1791633b3a1a12a9aa449aa6d558327">L_BUF_SIZE</a>, <span class="stringliteral">&quot;%s%s&quot;</span>, rootout, <a class="code" href="jbclass_8h.html#a882296adc539209f84cca33f8e7f5af4">JB_DATA_EXT</a>); 
<a name="l01847"></a>01847     <span class="keywordflow">if</span> ((fp = <a class="code" href="leptprotos_8h.html#a33897cfec13616080528eaefe37954b1">fopenWriteStream</a>(buf, <span class="stringliteral">&quot;wb&quot;</span>)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01848"></a>01848         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;stream not opened&quot;</span>, procName, 1);
<a name="l01849"></a>01849     ncomp = <a class="code" href="leptprotos_8h.html#a9d82186f3918b3a1ea80c90e6a1d7439">ptaGetCount</a>(ptaul);
<a name="l01850"></a>01850     fprintf(fp, <span class="stringliteral">&quot;jb data file\n&quot;</span>);
<a name="l01851"></a>01851     fprintf(fp, <span class="stringliteral">&quot;num pages = %d\n&quot;</span>, npages);
<a name="l01852"></a>01852     fprintf(fp, <span class="stringliteral">&quot;page size: w = %d, h = %d\n&quot;</span>, w, h);
<a name="l01853"></a>01853     fprintf(fp, <span class="stringliteral">&quot;num components = %d\n&quot;</span>, ncomp);
<a name="l01854"></a>01854     fprintf(fp, <span class="stringliteral">&quot;num classes = %d\n&quot;</span>, nclass);
<a name="l01855"></a>01855     fprintf(fp, <span class="stringliteral">&quot;template lattice size: w = %d, h = %d\n&quot;</span>, cellw, cellh);
<a name="l01856"></a>01856     <span class="keywordflow">for</span> (i = 0; i &lt; ncomp; i++) {
<a name="l01857"></a>01857         <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(napage, i, &amp;ipage);
<a name="l01858"></a>01858         <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(naclass, i, &amp;iclass);
<a name="l01859"></a>01859         <a class="code" href="leptprotos_8h.html#ae6f6802a5d75f596d84ffa8451443aa0">ptaGetIPt</a>(ptaul, i, &amp;x, &amp;y);
<a name="l01860"></a>01860         fprintf(fp, <span class="stringliteral">&quot;%d %d %d %d\n&quot;</span>, ipage, iclass, x, y);
<a name="l01861"></a>01861     }
<a name="l01862"></a>01862     fclose(fp);
<a name="l01863"></a>01863 
<a name="l01864"></a>01864     <span class="keywordflow">return</span> 0;
<a name="l01865"></a>01865 }
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 <span class="comment"></span>
<a name="l01868"></a>01868 <span class="comment">/*!</span>
<a name="l01869"></a>01869 <span class="comment"> *  jbDataRead()</span>
<a name="l01870"></a>01870 <span class="comment"> *</span>
<a name="l01871"></a>01871 <span class="comment"> *      Input:  rootname (for template and data files)</span>
<a name="l01872"></a>01872 <span class="comment"> *      Return: jbdata, or NULL on error</span>
<a name="l01873"></a>01873 <span class="comment"> */</span>
<a name="l01874"></a>01874 <a class="code" href="struct_jb_data.html">JBDATA</a> *
<a name="l01875"></a><a class="code" href="leptprotos_8h.html#a68314c73e703a15993bb141a8c5b637b">01875</a> <a class="code" href="jbclass_8c.html#a26760ab516ce31a4951cbeb469494e5a">jbDataRead</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>  *rootname)
<a name="l01876"></a>01876 {
<a name="l01877"></a>01877 <span class="keywordtype">char</span>      fname[<a class="code" href="jbclass_8c.html#af1791633b3a1a12a9aa449aa6d558327">L_BUF_SIZE</a>];
<a name="l01878"></a>01878 <span class="keywordtype">char</span>     *linestr;
<a name="l01879"></a>01879 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>  *data;
<a name="l01880"></a>01880 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   nsa, <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, <a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a>, <a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a>, cellw, cellh, x, y, iclass, ipage;
<a name="l01881"></a>01881 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   npages, nclass, ncomp;
<a name="l01882"></a>01882 <span class="keywordtype">size_t</span>    <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>;
<a name="l01883"></a>01883 <a class="code" href="struct_jb_data.html">JBDATA</a>   *jbdata;
<a name="l01884"></a>01884 <a class="code" href="struct_numa.html">NUMA</a>     *naclass, *napage;
<a name="l01885"></a>01885 <a class="code" href="struct_pix.html">PIX</a>      *pixs;
<a name="l01886"></a>01886 <a class="code" href="struct_pta.html">PTA</a>      *ptaul;
<a name="l01887"></a>01887 <a class="code" href="struct_sarray.html">SARRAY</a>   *sa;
<a name="l01888"></a>01888     
<a name="l01889"></a>01889     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbDataRead&quot;</span>);
<a name="l01890"></a>01890 
<a name="l01891"></a>01891     <span class="keywordflow">if</span> (!rootname)
<a name="l01892"></a>01892         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;rootname not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01893"></a>01893 
<a name="l01894"></a>01894     snprintf(fname, <a class="code" href="jbclass_8c.html#af1791633b3a1a12a9aa449aa6d558327">L_BUF_SIZE</a>, <span class="stringliteral">&quot;%s%s&quot;</span>, rootname, <a class="code" href="jbclass_8h.html#a3be4ca42b3affc03f186bca3643970cc">JB_TEMPLATE_EXT</a>);
<a name="l01895"></a>01895     <span class="keywordflow">if</span> ((pixs = <a class="code" href="leptprotos_8h.html#a84634846cbb5e01df667d6e9241dfc53">pixRead</a>(fname)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01896"></a>01896         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;pix not read&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01897"></a>01897 
<a name="l01898"></a>01898     snprintf(fname, <a class="code" href="jbclass_8c.html#af1791633b3a1a12a9aa449aa6d558327">L_BUF_SIZE</a>, <span class="stringliteral">&quot;%s%s&quot;</span>, rootname, <a class="code" href="jbclass_8h.html#a882296adc539209f84cca33f8e7f5af4">JB_DATA_EXT</a>);
<a name="l01899"></a>01899     <span class="keywordflow">if</span> ((data = <a class="code" href="leptprotos_8h.html#a3c6cc030405a520b5ad850c80c9211ae">l_binaryRead</a>(fname, &amp;size)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01900"></a>01900         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;data not read&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01901"></a>01901 
<a name="l01902"></a>01902     <span class="keywordflow">if</span> ((sa = <a class="code" href="leptprotos_8h.html#a34eb1025d0583695e599c5043734145e">sarrayCreateLinesFromString</a>((<span class="keywordtype">char</span> *)data, 0)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01903"></a>01903         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;sa not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01904"></a>01904     nsa = <a class="code" href="leptprotos_8h.html#a32bccb817e096fe813a49bb11dabf873">sarrayGetCount</a>(sa);   <span class="comment">/* number of cc + 6 */</span>
<a name="l01905"></a>01905     linestr = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(sa, 0, 0);
<a name="l01906"></a>01906     <span class="keywordflow">if</span> (strcmp(linestr, <span class="stringliteral">&quot;jb data file&quot;</span>))
<a name="l01907"></a>01907         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;invalid jb data file&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01908"></a>01908     linestr = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(sa, 1, 0);
<a name="l01909"></a>01909     sscanf(linestr, <span class="stringliteral">&quot;num pages = %d&quot;</span>, &amp;npages);
<a name="l01910"></a>01910     linestr = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(sa, 2, 0);
<a name="l01911"></a>01911     sscanf(linestr, <span class="stringliteral">&quot;page size: w = %d, h = %d&quot;</span>, &amp;w, &amp;h);
<a name="l01912"></a>01912     linestr = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(sa, 3, 0);
<a name="l01913"></a>01913     sscanf(linestr, <span class="stringliteral">&quot;num components = %d&quot;</span>, &amp;ncomp);
<a name="l01914"></a>01914     linestr = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(sa, 4, 0);
<a name="l01915"></a>01915     sscanf(linestr, <span class="stringliteral">&quot;num classes = %d\n&quot;</span>, &amp;nclass);
<a name="l01916"></a>01916     linestr = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(sa, 5, 0);
<a name="l01917"></a>01917     sscanf(linestr, <span class="stringliteral">&quot;template lattice size: w = %d, h = %d\n&quot;</span>, &amp;cellw, &amp;cellh);
<a name="l01918"></a>01918 
<a name="l01919"></a>01919 <span class="preprocessor">#if 1</span>
<a name="l01920"></a>01920 <span class="preprocessor"></span>    fprintf(stderr, <span class="stringliteral">&quot;num pages = %d\n&quot;</span>, npages);
<a name="l01921"></a>01921     fprintf(stderr, <span class="stringliteral">&quot;page size: w = %d, h = %d\n&quot;</span>, w, h);
<a name="l01922"></a>01922     fprintf(stderr, <span class="stringliteral">&quot;num components = %d\n&quot;</span>, ncomp);
<a name="l01923"></a>01923     fprintf(stderr, <span class="stringliteral">&quot;num classes = %d\n&quot;</span>, nclass);
<a name="l01924"></a>01924     fprintf(stderr, <span class="stringliteral">&quot;template lattice size: w = %d, h = %d\n&quot;</span>, cellw, cellh);
<a name="l01925"></a>01925 <span class="preprocessor">#endif</span>
<a name="l01926"></a>01926 <span class="preprocessor"></span>
<a name="l01927"></a>01927     <span class="keywordflow">if</span> ((naclass = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(ncomp)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01928"></a>01928         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;naclass not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01929"></a>01929     <span class="keywordflow">if</span> ((napage = <a class="code" href="leptprotos_8h.html#afd300f95a02894e9529623a260ffac8a">numaCreate</a>(ncomp)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01930"></a>01930         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;napage not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01931"></a>01931     <span class="keywordflow">if</span> ((ptaul = <a class="code" href="leptprotos_8h.html#a6f854462ee35cb8c974752cacc4170ed">ptaCreate</a>(ncomp)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01932"></a>01932         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;pta not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01933"></a>01933     <span class="keywordflow">for</span> (i = 6; i &lt; nsa; i++) {
<a name="l01934"></a>01934         linestr = <a class="code" href="leptprotos_8h.html#aaf3120597e2de74305d3f7b6d603e7aa">sarrayGetString</a>(sa, i, 0);
<a name="l01935"></a>01935         sscanf(linestr, <span class="stringliteral">&quot;%d %d %d %d\n&quot;</span>, &amp;ipage, &amp;iclass, &amp;x, &amp;y);
<a name="l01936"></a>01936         <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(napage, ipage);
<a name="l01937"></a>01937         <a class="code" href="leptprotos_8h.html#a50f6b1a964dc2bb2b200a228dc92ca2c">numaAddNumber</a>(naclass, iclass);
<a name="l01938"></a>01938         <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(ptaul, x, y);
<a name="l01939"></a>01939     }
<a name="l01940"></a>01940 
<a name="l01941"></a>01941     <span class="keywordflow">if</span> ((jbdata = (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(1, <span class="keyword">sizeof</span>(<a class="code" href="struct_jb_data.html">JBDATA</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01942"></a>01942         <span class="keywordflow">return</span> (<a class="code" href="struct_jb_data.html">JBDATA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;data not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01943"></a>01943     jbdata-&gt;<a class="code" href="struct_jb_data.html#a54b277fae33c3486e6bc721185842222">pix</a> = pixs;
<a name="l01944"></a>01944     jbdata-&gt;<a class="code" href="struct_jb_data.html#a3ab8a799f36135ac48d62aef4eb3b713">npages</a> = npages;
<a name="l01945"></a>01945     jbdata-&gt;<a class="code" href="struct_jb_data.html#a74b90ce854e8694afbd0c697f8a2aa9a">w</a> = <a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a>;
<a name="l01946"></a>01946     jbdata-&gt;<a class="code" href="struct_jb_data.html#a61dd09a5b7af651a9c95a4755fa0588d">h</a> = <a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a>;
<a name="l01947"></a>01947     jbdata-&gt;<a class="code" href="struct_jb_data.html#a44c70538c4464b12f0320745fa00d9f9">nclass</a> = nclass;
<a name="l01948"></a>01948     jbdata-&gt;<a class="code" href="struct_jb_data.html#a0f27384101bb8b530dd9e3932ba78272">latticew</a> = cellw;
<a name="l01949"></a>01949     jbdata-&gt;<a class="code" href="struct_jb_data.html#a386cbc2c5bf7dc20a079809e774d7efc">latticeh</a> = cellh;
<a name="l01950"></a>01950     jbdata-&gt;<a class="code" href="struct_jb_data.html#a4470068b339a471b41fc0bd22e25d998">naclass</a> = naclass;
<a name="l01951"></a>01951     jbdata-&gt;<a class="code" href="struct_jb_data.html#a2cfa7fe12f8d7171d5b0023c01099e0a">napage</a> = napage;
<a name="l01952"></a>01952     jbdata-&gt;<a class="code" href="struct_jb_data.html#a5931bcde3516065865678d4388884eee">ptaul</a> = ptaul;
<a name="l01953"></a>01953 
<a name="l01954"></a>01954     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(data);
<a name="l01955"></a>01955     <a class="code" href="leptprotos_8h.html#a6bc238d36ad4599585c7de09105f83c2">sarrayDestroy</a>(&amp;sa);
<a name="l01956"></a>01956     <span class="keywordflow">return</span> jbdata;
<a name="l01957"></a>01957 }
<a name="l01958"></a>01958 
<a name="l01959"></a>01959 <span class="comment"></span>
<a name="l01960"></a>01960 <span class="comment">/*!</span>
<a name="l01961"></a>01961 <span class="comment"> *  jbDataRender()</span>
<a name="l01962"></a>01962 <span class="comment"> *</span>
<a name="l01963"></a>01963 <span class="comment"> *      Input:  jbdata</span>
<a name="l01964"></a>01964 <span class="comment"> *              debugflag (if TRUE, writes into 2 bpp pix and adds </span>
<a name="l01965"></a>01965 <span class="comment"> *                         component outlines in color)</span>
<a name="l01966"></a>01966 <span class="comment"> *      Return: pixa (reconstruction of original images, using templates) or</span>
<a name="l01967"></a>01967 <span class="comment"> *              null on error</span>
<a name="l01968"></a>01968 <span class="comment"> */</span>
<a name="l01969"></a>01969 <a class="code" href="struct_pixa.html">PIXA</a> *
<a name="l01970"></a><a class="code" href="leptprotos_8h.html#a0f88672ce2e8616d45e641925f9577a0">01970</a> <a class="code" href="jbclass_8c.html#a212fa51d15830e2fd48da0d6bbaade0e">jbDataRender</a>(<a class="code" href="struct_jb_data.html">JBDATA</a>  *data,
<a name="l01971"></a>01971              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  debugflag)
<a name="l01972"></a>01972 {
<a name="l01973"></a>01973 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, <a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a>, <a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a>, cellw, cellh, x, y, iclass, ipage;
<a name="l01974"></a>01974 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   npages, nclass, ncomp, wp, hp;
<a name="l01975"></a>01975 <a class="code" href="struct_box.html">BOX</a>      *box;
<a name="l01976"></a>01976 <a class="code" href="struct_numa.html">NUMA</a>     *naclass, *napage;
<a name="l01977"></a>01977 <a class="code" href="struct_pix.html">PIX</a>      *pixt, *pixt2, *pix, *pixd;
<a name="l01978"></a>01978 <a class="code" href="struct_pixa.html">PIXA</a>     *pixat;   <span class="comment">/* pixa of templates */</span>
<a name="l01979"></a>01979 <a class="code" href="struct_pixa.html">PIXA</a>     *pixad;   <span class="comment">/* pixa of output images */</span>
<a name="l01980"></a>01980 <a class="code" href="struct_pix_colormap.html">PIXCMAP</a>  *cmap;
<a name="l01981"></a>01981 <a class="code" href="struct_pta.html">PTA</a>      *ptaul;
<a name="l01982"></a>01982     
<a name="l01983"></a>01983     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbDataRender&quot;</span>);
<a name="l01984"></a>01984 
<a name="l01985"></a>01985     <span class="keywordflow">if</span> (!data)
<a name="l01986"></a>01986         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;data not defined&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01987"></a>01987 
<a name="l01988"></a>01988     npages = data-&gt;<a class="code" href="struct_jb_data.html#a3ab8a799f36135ac48d62aef4eb3b713">npages</a>;
<a name="l01989"></a>01989     w = data-&gt;<a class="code" href="struct_jb_data.html#a74b90ce854e8694afbd0c697f8a2aa9a">w</a>;
<a name="l01990"></a>01990     h = data-&gt;<a class="code" href="struct_jb_data.html#a61dd09a5b7af651a9c95a4755fa0588d">h</a>;
<a name="l01991"></a>01991     pixt = data-&gt;<a class="code" href="struct_jb_data.html#a54b277fae33c3486e6bc721185842222">pix</a>;
<a name="l01992"></a>01992     nclass = data-&gt;<a class="code" href="struct_jb_data.html#a44c70538c4464b12f0320745fa00d9f9">nclass</a>;
<a name="l01993"></a>01993     cellw = data-&gt;<a class="code" href="struct_jb_data.html#a0f27384101bb8b530dd9e3932ba78272">latticew</a>;
<a name="l01994"></a>01994     cellh = data-&gt;<a class="code" href="struct_jb_data.html#a386cbc2c5bf7dc20a079809e774d7efc">latticeh</a>;
<a name="l01995"></a>01995     naclass = data-&gt;<a class="code" href="struct_jb_data.html#a4470068b339a471b41fc0bd22e25d998">naclass</a>;
<a name="l01996"></a>01996     napage = data-&gt;<a class="code" href="struct_jb_data.html#a2cfa7fe12f8d7171d5b0023c01099e0a">napage</a>;
<a name="l01997"></a>01997     ptaul = data-&gt;<a class="code" href="struct_jb_data.html#a5931bcde3516065865678d4388884eee">ptaul</a>;
<a name="l01998"></a>01998     ncomp = <a class="code" href="leptprotos_8h.html#a3d022536ec48f28421c56f586d697295">numaGetCount</a>(naclass);
<a name="l01999"></a>01999     
<a name="l02000"></a>02000         <span class="comment">/* Reconstruct the original set of images from the templates</span>
<a name="l02001"></a>02001 <span class="comment">         * and the data associated with each component.  First,</span>
<a name="l02002"></a>02002 <span class="comment">         * generate the output pixa as a set of empty pix. */</span>
<a name="l02003"></a>02003     <span class="keywordflow">if</span> ((pixad = <a class="code" href="leptprotos_8h.html#a7a6d1b9b5457c3dc9bc8f77a39a81147">pixaCreate</a>(npages)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02004"></a>02004         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;pixad not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02005"></a>02005     <span class="keywordflow">for</span> (i = 0; i &lt; npages; i++) {
<a name="l02006"></a>02006         <span class="keywordflow">if</span> (debugflag == <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02007"></a>02007             pix = <a class="code" href="leptprotos_8h.html#a009df4671d39f94b50a0368af210aebe">pixCreate</a>(w, h, 1);
<a name="l02008"></a>02008         <span class="keywordflow">else</span> {
<a name="l02009"></a>02009             pix = <a class="code" href="leptprotos_8h.html#a009df4671d39f94b50a0368af210aebe">pixCreate</a>(w, h, 2);
<a name="l02010"></a>02010             cmap = <a class="code" href="colormap_8c.html#a41b80672f852c84d4867952c820ac00e">pixcmapCreate</a>(2);
<a name="l02011"></a>02011             <a class="code" href="colormap_8c.html#a910c7bc866f19b8b07a0aa74eb8e1b5e">pixcmapAddColor</a>(cmap, 255, 255, 255);
<a name="l02012"></a>02012             <a class="code" href="colormap_8c.html#a910c7bc866f19b8b07a0aa74eb8e1b5e">pixcmapAddColor</a>(cmap, 0, 0, 0);
<a name="l02013"></a>02013             <a class="code" href="colormap_8c.html#a910c7bc866f19b8b07a0aa74eb8e1b5e">pixcmapAddColor</a>(cmap, 255, 0, 0);  <span class="comment">/* for box outlines */</span>
<a name="l02014"></a>02014             <a class="code" href="leptprotos_8h.html#a6015decaf96da4e73708bc34527df065">pixSetColormap</a>(pix, cmap);
<a name="l02015"></a>02015         }
<a name="l02016"></a>02016         <a class="code" href="leptprotos_8h.html#a4dd659e18d878e2f3b900c2565b61ccc">pixaAddPix</a>(pixad, pix, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fac1bdfee98ef4dbb3637c7d329cc460a3">L_INSERT</a>);
<a name="l02017"></a>02017     }
<a name="l02018"></a>02018     
<a name="l02019"></a>02019         <span class="comment">/* Put the class templates into a pixa. */</span>
<a name="l02020"></a>02020     <span class="keywordflow">if</span> ((pixat = <a class="code" href="leptprotos_8h.html#ae384a2f908c4d8806b9997ed5bac89c2">pixaCreateFromPix</a>(pixt, nclass, cellw, cellh)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02021"></a>02021         <span class="keywordflow">return</span> (<a class="code" href="struct_pixa.html">PIXA</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;pixat not made&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02022"></a>02022 
<a name="l02023"></a>02023         <span class="comment">/* Place each component in the right location on its page. */</span>
<a name="l02024"></a>02024     <span class="keywordflow">for</span> (i = 0; i &lt; ncomp; i++) {
<a name="l02025"></a>02025         <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(napage, i, &amp;ipage);
<a name="l02026"></a>02026         <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(naclass, i, &amp;iclass);
<a name="l02027"></a>02027         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixat, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);  <span class="comment">/* the template */</span>
<a name="l02028"></a>02028         wp = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pix);
<a name="l02029"></a>02029         hp = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix);
<a name="l02030"></a>02030         <a class="code" href="leptprotos_8h.html#ae6f6802a5d75f596d84ffa8451443aa0">ptaGetIPt</a>(ptaul, i, &amp;x, &amp;y);
<a name="l02031"></a>02031         pixd = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixad, ipage, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);   <span class="comment">/* the output page */</span>
<a name="l02032"></a>02032         <span class="keywordflow">if</span> (debugflag == <a class="code" href="environ_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02033"></a>02033             <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixd, x, y, wp, hp, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a> | <a class="code" href="pix_8h.html#a0bc9848843e824c84419cd73ec4af5f2">PIX_DST</a>, pix, 0, 0);
<a name="l02034"></a>02034         <span class="keywordflow">else</span> {
<a name="l02035"></a>02035             pixt2 = <a class="code" href="leptprotos_8h.html#ae1a36301492cf215436e4456d6f1e469">pixConvert1To2Cmap</a>(pix);
<a name="l02036"></a>02036             <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixd, x, y, wp, hp, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a> | <a class="code" href="pix_8h.html#a0bc9848843e824c84419cd73ec4af5f2">PIX_DST</a>, pixt2, 0, 0);
<a name="l02037"></a>02037             box = <a class="code" href="boxbasic_8c.html#ad846c5f00e3aaed3dd4329347acac89d">boxCreate</a>(x, y, wp, hp);
<a name="l02038"></a>02038             <a class="code" href="graphics_8c.html#a2978ca29c3f2226604bb56ed005f94e3">pixRenderBoxArb</a>(pixd, box, 1, 255, 0, 0);
<a name="l02039"></a>02039             <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt2);
<a name="l02040"></a>02040             <a class="code" href="boxbasic_8c.html#a494a2b1bf2e00d030dae5e11e12dbddb">boxDestroy</a>(&amp;box);
<a name="l02041"></a>02041         }
<a name="l02042"></a>02042         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix);   <span class="comment">/* the clone only */</span>
<a name="l02043"></a>02043         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixd);  <span class="comment">/* the clone only */</span>
<a name="l02044"></a>02044     }
<a name="l02045"></a>02045 
<a name="l02046"></a>02046     <a class="code" href="leptprotos_8h.html#a6775cff91fdef2336a3f3037f7bb55f3">pixaDestroy</a>(&amp;pixat);
<a name="l02047"></a>02047     <span class="keywordflow">return</span> pixad;
<a name="l02048"></a>02048 }
<a name="l02049"></a>02049 
<a name="l02050"></a>02050 <span class="comment"></span>
<a name="l02051"></a>02051 <span class="comment">/*!</span>
<a name="l02052"></a>02052 <span class="comment"> *  jbGetULCorners()</span>
<a name="l02053"></a>02053 <span class="comment"> *</span>
<a name="l02054"></a>02054 <span class="comment"> *      Input:  jbclasser</span>
<a name="l02055"></a>02055 <span class="comment"> *              pixs (full res image)</span>
<a name="l02056"></a>02056 <span class="comment"> *              boxa (of c.c. bounding rectangles for this page)</span>
<a name="l02057"></a>02057 <span class="comment"> *      Return: 0 if OK, 1 on error</span>
<a name="l02058"></a>02058 <span class="comment"> *</span>
<a name="l02059"></a>02059 <span class="comment"> *  Notes:</span>
<a name="l02060"></a>02060 <span class="comment"> *      (1) This computes the ptaul field, which has the global UL corners,</span>
<a name="l02061"></a>02061 <span class="comment"> *          adjusted for each specific component, so that each component</span>
<a name="l02062"></a>02062 <span class="comment"> *          can be replaced by the template for its class and have the</span>
<a name="l02063"></a>02063 <span class="comment"> *          centroid in the template in the same position as the</span>
<a name="l02064"></a>02064 <span class="comment"> *          centroid of the original connected component.  It is important</span>
<a name="l02065"></a>02065 <span class="comment"> *          that this be done properly to avoid a wavy baseline in the</span>
<a name="l02066"></a>02066 <span class="comment"> *          result.</span>
<a name="l02067"></a>02067 <span class="comment"> *      (2) The array fields ptac and ptact give the centroids of</span>
<a name="l02068"></a>02068 <span class="comment"> *          those components relative to the UL corner of each component.</span>
<a name="l02069"></a>02069 <span class="comment"> *          Here, we compute the difference in each component, round to</span>
<a name="l02070"></a>02070 <span class="comment"> *          nearest integer, and correct the box-&gt;x and box-&gt;y by</span>
<a name="l02071"></a>02071 <span class="comment"> *          the appropriate integral difference.</span>
<a name="l02072"></a>02072 <span class="comment"> *      (3) The templates and stored instances are all bordered.</span>
<a name="l02073"></a>02073 <span class="comment"> */</span>
<a name="l02074"></a>02074 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l02075"></a><a class="code" href="leptprotos_8h.html#a08c29588538eb40a51e7fd116d0cc3ec">02075</a> <a class="code" href="jbclass_8c.html#a507a86337bc6aa22975be9e3766472ab">jbGetULCorners</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>,
<a name="l02076"></a>02076                <a class="code" href="struct_pix.html">PIX</a>        *pixs,
<a name="l02077"></a>02077                <a class="code" href="struct_boxa.html">BOXA</a>       *boxa)
<a name="l02078"></a>02078 {
<a name="l02079"></a>02079 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, baseindex, index, <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>, iclass, idelx, idely, x, y, dx, dy;
<a name="l02080"></a>02080 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *sumtab;
<a name="l02081"></a>02081 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  <a class="code" href="affine__reg_8c.html#ae7a35515457046b7539c24062cf94d40">x1</a>, <a class="code" href="affine__reg_8c.html#ad85afc03d55324b175bbccc3ecfc983c">x2</a>, <a class="code" href="affine__reg_8c.html#af3df0e6eba20b6ae09d0111c121aac36">y1</a>, <a class="code" href="affine__reg_8c.html#a5afb8355b4d1b35dd123f44f1743d9f4">y2</a>, delx, dely;
<a name="l02082"></a>02082 <a class="code" href="struct_box.html">BOX</a>       *box;
<a name="l02083"></a>02083 <a class="code" href="struct_numa.html">NUMA</a>      *naclass;
<a name="l02084"></a>02084 <a class="code" href="struct_pix.html">PIX</a>       *pixt;
<a name="l02085"></a>02085 <a class="code" href="struct_pta.html">PTA</a>       *ptac, *ptact, *ptaul;
<a name="l02086"></a>02086 
<a name="l02087"></a>02087     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbGetULCorners&quot;</span>);
<a name="l02088"></a>02088 
<a name="l02089"></a>02089     <span class="keywordflow">if</span> (!classer)
<a name="l02090"></a>02090         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;classer not defined&quot;</span>, procName, 1);
<a name="l02091"></a>02091     <span class="keywordflow">if</span> (!pixs)
<a name="l02092"></a>02092         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixs not defined&quot;</span>, procName, 1);
<a name="l02093"></a>02093     <span class="keywordflow">if</span> (!boxa)
<a name="l02094"></a>02094         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;boxa not defined&quot;</span>, procName, 1);
<a name="l02095"></a>02095 
<a name="l02096"></a>02096     n = <a class="code" href="boxbasic_8c.html#a82555cab9ef5578c4728ef5109264723">boxaGetCount</a>(boxa);
<a name="l02097"></a>02097     ptaul = classer-&gt;<a class="code" href="struct_jb_classer.html#a718333fe33da446fb87af8797c01b9c9">ptaul</a>;
<a name="l02098"></a>02098     naclass = classer-&gt;<a class="code" href="struct_jb_classer.html#a61916a7940b3d7d011b536c16acdf587">naclass</a>;
<a name="l02099"></a>02099     ptac = classer-&gt;<a class="code" href="struct_jb_classer.html#a2462eb667abe08e30b22676b4e30d101">ptac</a>;
<a name="l02100"></a>02100     ptact = classer-&gt;<a class="code" href="struct_jb_classer.html#af15ce939e8925d3971799c6cc4ce68a5">ptact</a>;
<a name="l02101"></a>02101     baseindex = classer-&gt;<a class="code" href="struct_jb_classer.html#af63b2e0cd21875df8dae166d33eb458f">baseindex</a>;  <span class="comment">/* num components before this page */</span>
<a name="l02102"></a>02102     sumtab = <a class="code" href="leptprotos_8h.html#a230d6654519b5c847e49798b37cd5d1d">makePixelSumTab8</a>();
<a name="l02103"></a>02103     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l02104"></a>02104         index = baseindex + <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>;
<a name="l02105"></a>02105         <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(ptac, index, &amp;x1, &amp;y1);
<a name="l02106"></a>02106         <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(naclass, index, &amp;iclass);
<a name="l02107"></a>02107         <a class="code" href="leptprotos_8h.html#a8c9c39712d916f24af8f9c60523ccc44">ptaGetPt</a>(ptact, iclass, &amp;x2, &amp;y2);
<a name="l02108"></a>02108         delx = x2 - <a class="code" href="affine__reg_8c.html#ae7a35515457046b7539c24062cf94d40">x1</a>;
<a name="l02109"></a>02109         dely = y2 - <a class="code" href="affine__reg_8c.html#af3df0e6eba20b6ae09d0111c121aac36">y1</a>;
<a name="l02110"></a>02110         <span class="keywordflow">if</span> (delx &gt;= 0)
<a name="l02111"></a>02111             idelx = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(delx + 0.5);
<a name="l02112"></a>02112         <span class="keywordflow">else</span>
<a name="l02113"></a>02113             idelx = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(delx - 0.5);
<a name="l02114"></a>02114         <span class="keywordflow">if</span> (dely &gt;= 0)
<a name="l02115"></a>02115             idely = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(dely + 0.5);
<a name="l02116"></a>02116         <span class="keywordflow">else</span>
<a name="l02117"></a>02117             idely = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(dely - 0.5);
<a name="l02118"></a>02118         <span class="keywordflow">if</span> ((box = <a class="code" href="boxbasic_8c.html#ac7c6fcfadf130bfa738ce6aab51318e5">boxaGetBox</a>(boxa, i, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>)) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02119"></a>02119             <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;box not found&quot;</span>, procName, 1);
<a name="l02120"></a>02120         <a class="code" href="boxbasic_8c.html#aaf754e00c062c3f0f726bea73a17e646">boxGetGeometry</a>(box, &amp;x, &amp;y, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02121"></a>02121 
<a name="l02122"></a>02122             <span class="comment">/* Get final increments dx and dy for best alignment */</span>
<a name="l02123"></a>02123         pixt = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l02124"></a>02124         <a class="code" href="jbclass_8c.html#a1daded8379f0aae4dc6b60e7b33b89ee">finalPositioningForAlignment</a>(pixs, x, y, idelx, idely,
<a name="l02125"></a>02125                                      pixt, sumtab, &amp;dx, &amp;dy);
<a name="l02126"></a>02126 <span class="comment">/*        if (i % 20 == 0)</span>
<a name="l02127"></a>02127 <span class="comment">            fprintf(stderr, &quot;dx = %d, dy = %d\n&quot;, dx, dy); */</span>
<a name="l02128"></a>02128         <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(ptaul, x - idelx + dx, y - idely + dy);
<a name="l02129"></a>02129         <a class="code" href="boxbasic_8c.html#a494a2b1bf2e00d030dae5e11e12dbddb">boxDestroy</a>(&amp;box);
<a name="l02130"></a>02130         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt);
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132 
<a name="l02133"></a>02133     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(sumtab);
<a name="l02134"></a>02134     <span class="keywordflow">return</span> 0;
<a name="l02135"></a>02135 }
<a name="l02136"></a>02136 
<a name="l02137"></a>02137 <span class="comment"></span>
<a name="l02138"></a>02138 <span class="comment">/*!</span>
<a name="l02139"></a>02139 <span class="comment"> *  jbGetLLCorners()</span>
<a name="l02140"></a>02140 <span class="comment"> *</span>
<a name="l02141"></a>02141 <span class="comment"> *      Input:  jbclasser</span>
<a name="l02142"></a>02142 <span class="comment"> *      Return: 0 if OK, 1 on error</span>
<a name="l02143"></a>02143 <span class="comment"> *</span>
<a name="l02144"></a>02144 <span class="comment"> *  Notes:</span>
<a name="l02145"></a>02145 <span class="comment"> *      (1) This computes the ptall field, which has the global LL corners,</span>
<a name="l02146"></a>02146 <span class="comment"> *          adjusted for each specific component, so that each component</span>
<a name="l02147"></a>02147 <span class="comment"> *          can be replaced by the template for its class and have the</span>
<a name="l02148"></a>02148 <span class="comment"> *          centroid in the template in the same position as the</span>
<a name="l02149"></a>02149 <span class="comment"> *          centroid of the original connected component. It is important</span>
<a name="l02150"></a>02150 <span class="comment"> *          that this be done properly to avoid a wavy baseline in the result.</span>
<a name="l02151"></a>02151 <span class="comment"> *      (2) It is computed here from the corresponding UL corners, where</span>
<a name="l02152"></a>02152 <span class="comment"> *          the input templates and stored instances are all bordered.</span>
<a name="l02153"></a>02153 <span class="comment"> *          This should be done after all pages have been processed.</span>
<a name="l02154"></a>02154 <span class="comment"> *      (3) For proper substitution, the templates whose LL corners are</span>
<a name="l02155"></a>02155 <span class="comment"> *          placed in these locations must be UN-bordered.</span>
<a name="l02156"></a>02156 <span class="comment"> *          This is available for a realistic jbig2 encoder, which would</span>
<a name="l02157"></a>02157 <span class="comment"> *          (1) encode each template without a border, and (2) encode</span>
<a name="l02158"></a>02158 <span class="comment"> *          the position using the LL corner (rather than the UL</span>
<a name="l02159"></a>02159 <span class="comment"> *          corner) because the difference between y-values</span>
<a name="l02160"></a>02160 <span class="comment"> *          of successive instances is typically close to zero.</span>
<a name="l02161"></a>02161 <span class="comment"> */</span>
<a name="l02162"></a>02162 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l02163"></a><a class="code" href="leptprotos_8h.html#a1bd19b1afcb6962013e0c4e5552c774a">02163</a> <a class="code" href="jbclass_8c.html#addd30a80d9beb213620e9852eff74918">jbGetLLCorners</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>)
<a name="l02164"></a>02164 {
<a name="l02165"></a>02165 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, iclass, <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>, <a class="code" href="affine__reg_8c.html#ae7a35515457046b7539c24062cf94d40">x1</a>, <a class="code" href="affine__reg_8c.html#af3df0e6eba20b6ae09d0111c121aac36">y1</a>, <a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a>;
<a name="l02166"></a>02166 <a class="code" href="struct_numa.html">NUMA</a>      *naclass;
<a name="l02167"></a>02167 <a class="code" href="struct_pix.html">PIX</a>       *pix;
<a name="l02168"></a>02168 <a class="code" href="struct_pixa.html">PIXA</a>      *pixat;
<a name="l02169"></a>02169 <a class="code" href="struct_pta.html">PTA</a>       *ptaul, *ptall;
<a name="l02170"></a>02170 
<a name="l02171"></a>02171     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;jbGetLLCorners&quot;</span>);
<a name="l02172"></a>02172 
<a name="l02173"></a>02173     <span class="keywordflow">if</span> (!classer)
<a name="l02174"></a>02174         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;classer not defined&quot;</span>, procName, 1);
<a name="l02175"></a>02175 
<a name="l02176"></a>02176     ptaul = classer-&gt;<a class="code" href="struct_jb_classer.html#a718333fe33da446fb87af8797c01b9c9">ptaul</a>;
<a name="l02177"></a>02177     naclass = classer-&gt;<a class="code" href="struct_jb_classer.html#a61916a7940b3d7d011b536c16acdf587">naclass</a>;
<a name="l02178"></a>02178     pixat = classer-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>;
<a name="l02179"></a>02179 
<a name="l02180"></a>02180     <a class="code" href="leptprotos_8h.html#a42d592277e3ea9d8f0c308e9db38d8cb">ptaDestroy</a>(&amp;classer-&gt;<a class="code" href="struct_jb_classer.html#a4477cf4397273988d90b3f51091420b6">ptall</a>);
<a name="l02181"></a>02181     n = <a class="code" href="leptprotos_8h.html#a9d82186f3918b3a1ea80c90e6a1d7439">ptaGetCount</a>(ptaul);
<a name="l02182"></a>02182     ptall = <a class="code" href="leptprotos_8h.html#a6f854462ee35cb8c974752cacc4170ed">ptaCreate</a>(n);
<a name="l02183"></a>02183     classer-&gt;<a class="code" href="struct_jb_classer.html#a4477cf4397273988d90b3f51091420b6">ptall</a> = ptall;
<a name="l02184"></a>02184 
<a name="l02185"></a>02185         <span class="comment">/* If the templates were bordered, we would add h - 1 to the UL</span>
<a name="l02186"></a>02186 <span class="comment">         * corner y-value.  However, because the templates to be used</span>
<a name="l02187"></a>02187 <span class="comment">         * here have their borders removed, and the borders are</span>
<a name="l02188"></a>02188 <span class="comment">         * JB_ADDED_PIXELS on each side, we add h - 1 - 2 * JB_ADDED_PIXELS</span>
<a name="l02189"></a>02189 <span class="comment">         * to the UL corner y-value.  */</span>
<a name="l02190"></a>02190     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>; i++) {
<a name="l02191"></a>02191         <a class="code" href="leptprotos_8h.html#ae6f6802a5d75f596d84ffa8451443aa0">ptaGetIPt</a>(ptaul, i, &amp;x1, &amp;y1);
<a name="l02192"></a>02192         <a class="code" href="leptprotos_8h.html#af59481588f8640c51cb411f6cff18d3c">numaGetIValue</a>(naclass, i, &amp;iclass);
<a name="l02193"></a>02193         pix = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(pixat, iclass, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l02194"></a>02194         h = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pix);
<a name="l02195"></a>02195         <a class="code" href="leptprotos_8h.html#af57296aef44526f203752fa079d4dbb5">ptaAddPt</a>(ptall, x1, y1 + h - 1 - 2 * <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>);
<a name="l02196"></a>02196         <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pix);
<a name="l02197"></a>02197     }
<a name="l02198"></a>02198 
<a name="l02199"></a>02199     <span class="keywordflow">return</span> 0;
<a name="l02200"></a>02200 }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202 
<a name="l02203"></a>02203 <span class="comment">/*----------------------------------------------------------------------*</span>
<a name="l02204"></a>02204 <span class="comment"> *                              Static helpers                          *</span>
<a name="l02205"></a>02205 <span class="comment"> *----------------------------------------------------------------------*/</span>
<a name="l02206"></a>02206 <span class="comment">/* When looking for similar matches we check templates whose size is +/- 2 in</span>
<a name="l02207"></a>02207 <span class="comment"> * each direction. This involves 25 possible sizes. This array contains the</span>
<a name="l02208"></a>02208 <span class="comment"> * offsets for each of those positions in a spiral pattern. There are 25 pairs</span>
<a name="l02209"></a>02209 <span class="comment"> * of numbers in this array: even positions are x values. */</span>
<a name="l02210"></a><a class="code" href="jbclass_8c.html#a17cdd08ccdb383b471e014b6ef9ca598">02210</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="jbclass_8c.html#a17cdd08ccdb383b471e014b6ef9ca598">two_by_two_walk</a>[50] = {
<a name="l02211"></a>02211   0, 0,
<a name="l02212"></a>02212   0, 1,
<a name="l02213"></a>02213   -1, 0,
<a name="l02214"></a>02214   0, -1,
<a name="l02215"></a>02215   1, 0,
<a name="l02216"></a>02216   -1, 1,
<a name="l02217"></a>02217   1, 1,
<a name="l02218"></a>02218   -1, -1,
<a name="l02219"></a>02219   1, -1,
<a name="l02220"></a>02220   0, -2,
<a name="l02221"></a>02221   2, 0,
<a name="l02222"></a>02222   0, 2,
<a name="l02223"></a>02223   -2, 0,
<a name="l02224"></a>02224   -1, -2,
<a name="l02225"></a>02225   1, -2,
<a name="l02226"></a>02226   2, -1,
<a name="l02227"></a>02227   2, 1,
<a name="l02228"></a>02228   1, 2,
<a name="l02229"></a>02229   -1, 2,
<a name="l02230"></a>02230   -2, 1,
<a name="l02231"></a>02231   -2, -1,
<a name="l02232"></a>02232   -2, -2,
<a name="l02233"></a>02233   2, -2,
<a name="l02234"></a>02234   2, 2,
<a name="l02235"></a>02235   -2, 2};
<a name="l02236"></a>02236 
<a name="l02237"></a>02237 <span class="comment"></span>
<a name="l02238"></a>02238 <span class="comment">/*!</span>
<a name="l02239"></a>02239 <span class="comment"> *  findSimilarSizedTemplatesInit()</span>
<a name="l02240"></a>02240 <span class="comment"> *</span>
<a name="l02241"></a>02241 <span class="comment"> *      Input:  classer</span>
<a name="l02242"></a>02242 <span class="comment"> *              pixs (instance to be matched)</span>
<a name="l02243"></a>02243 <span class="comment"> *      Return: Allocated context to be used with findSimilar*</span>
<a name="l02244"></a>02244 <span class="comment"> */</span>
<a name="l02245"></a>02245 <span class="keyword">static</span> <a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a> *
<a name="l02246"></a><a class="code" href="jbclass_8c.html#a47a48f9129c3e9295d496e5e623d107d">02246</a> <a class="code" href="jbclass_8c.html#a47a48f9129c3e9295d496e5e623d107d">findSimilarSizedTemplatesInit</a>(<a class="code" href="struct_jb_classer.html">JBCLASSER</a>  *<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>,
<a name="l02247"></a>02247                               <a class="code" href="struct_pix.html">PIX</a>        *pixs)
<a name="l02248"></a>02248 {
<a name="l02249"></a>02249 <a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>  *state;
<a name="l02250"></a>02250 
<a name="l02251"></a>02251     state = (<a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(1, <span class="keyword">sizeof</span>(<a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>));
<a name="l02252"></a>02252     state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a> = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pixs) - 2 * <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>;
<a name="l02253"></a>02253     state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a> = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pixs) - 2 * <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>;
<a name="l02254"></a>02254     state-&gt;<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a> = <a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>;
<a name="l02255"></a>02255 
<a name="l02256"></a>02256     <span class="keywordflow">return</span> state;
<a name="l02257"></a>02257 }
<a name="l02258"></a>02258 
<a name="l02259"></a>02259 
<a name="l02260"></a>02260 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02261"></a><a class="code" href="jbclass_8c.html#a87378eb1cec7b96091aa115ad78890ba">02261</a> <a class="code" href="jbclass_8c.html#a87378eb1cec7b96091aa115ad78890ba">findSimilarSizedTemplatesDestroy</a>(<a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>  **pstate)
<a name="l02262"></a>02262 {
<a name="l02263"></a>02263 <a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>  *state;
<a name="l02264"></a>02264 
<a name="l02265"></a>02265     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;findSimilarSizedTemplatesDestroy&quot;</span>);
<a name="l02266"></a>02266 
<a name="l02267"></a>02267     <span class="keywordflow">if</span> (pstate == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02268"></a>02268         <a class="code" href="environ_8h.html#a80ea4add6888dc55f0f6af9c488f1f21">L_WARNING</a>(<span class="stringliteral">&quot;ptr address is null&quot;</span>, procName);
<a name="l02269"></a>02269         <span class="keywordflow">return</span>;
<a name="l02270"></a>02270     }
<a name="l02271"></a>02271     <span class="keywordflow">if</span> ((state = *pstate) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02272"></a>02272         <span class="keywordflow">return</span>;
<a name="l02273"></a>02273 
<a name="l02274"></a>02274     <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a>);
<a name="l02275"></a>02275     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(state);
<a name="l02276"></a>02276     *pstate = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02277"></a>02277     <span class="keywordflow">return</span>;
<a name="l02278"></a>02278 }
<a name="l02279"></a>02279 
<a name="l02280"></a>02280 <span class="comment"></span>
<a name="l02281"></a>02281 <span class="comment">/*!</span>
<a name="l02282"></a>02282 <span class="comment"> *  findSimilarSizedTemplatesNext()</span>
<a name="l02283"></a>02283 <span class="comment"> *</span>
<a name="l02284"></a>02284 <span class="comment"> *      Input:  state (from findSimilarSizedTemplatesInit)</span>
<a name="l02285"></a>02285 <span class="comment"> *      Return: Next template number, or -1 when finished</span>
<a name="l02286"></a>02286 <span class="comment"> *</span>
<a name="l02287"></a>02287 <span class="comment"> *  We have a hash table mapping template area to a list of template</span>
<a name="l02288"></a>02288 <span class="comment"> *  numbers with that area.  We wish to find similar sized templates,</span>
<a name="l02289"></a>02289 <span class="comment"> *  so we first look for templates with the same width and height, and</span>
<a name="l02290"></a>02290 <span class="comment"> *  then with width + 1, etc.  This walk is guided by the</span>
<a name="l02291"></a>02291 <span class="comment"> *  two_by_two_walk array, above.</span>
<a name="l02292"></a>02292 <span class="comment"> *</span>
<a name="l02293"></a>02293 <span class="comment"> *  We don&#39;t want to have to collect the whole list of templates first because</span>
<a name="l02294"></a>02294 <span class="comment"> *  (we hope) to find it quickly.  So we keep the context for this walk in an</span>
<a name="l02295"></a>02295 <span class="comment"> *  explictit state structure and this function acts like a generator.</span>
<a name="l02296"></a>02296 <span class="comment"> */</span>
<a name="l02297"></a>02297 <span class="keyword">static</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l02298"></a><a class="code" href="jbclass_8c.html#a0b32c0b0c58c190fce595dcb8bc51853">02298</a> <a class="code" href="jbclass_8c.html#a0b32c0b0c58c190fce595dcb8bc51853">findSimilarSizedTemplatesNext</a>(<a class="code" href="struct_jb_find_templates_state.html">JBFINDCTX</a>  *state)
<a name="l02299"></a>02299 {
<a name="l02300"></a>02300 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  desiredh, desiredw, <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>, templ;
<a name="l02301"></a>02301 <a class="code" href="struct_pix.html">PIX</a>     *pixt;
<a name="l02302"></a>02302 
<a name="l02303"></a>02303     <span class="keywordflow">while</span>(1) {  <span class="comment">/* Continue the walk over step &#39;i&#39; */</span>
<a name="l02304"></a>02304         <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a> &gt;= 25) {  <span class="comment">/* all done */</span>
<a name="l02305"></a>02305             <span class="keywordflow">return</span> -1;
<a name="l02306"></a>02306         }
<a name="l02307"></a>02307 
<a name="l02308"></a>02308         desiredw = state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a> + <a class="code" href="jbclass_8c.html#a17cdd08ccdb383b471e014b6ef9ca598">two_by_two_walk</a>[2 * state-&gt;<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>];
<a name="l02309"></a>02309         desiredh = state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a> + <a class="code" href="jbclass_8c.html#a17cdd08ccdb383b471e014b6ef9ca598">two_by_two_walk</a>[2 * state-&gt;<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a> + 1];
<a name="l02310"></a>02310         <span class="keywordflow">if</span> (desiredh &lt; 1 || desiredw &lt; 1) {  <span class="comment">/* invalid size */</span>
<a name="l02311"></a>02311             state-&gt;<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>++;
<a name="l02312"></a>02312             <span class="keywordflow">continue</span>;
<a name="l02313"></a>02313         }
<a name="l02314"></a>02314 
<a name="l02315"></a>02315         <span class="keywordflow">if</span> (!state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a>) {
<a name="l02316"></a>02316                 <span class="comment">/* We have yet to start walking the array for the step &#39;i&#39; */</span>
<a name="l02317"></a>02317             state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a> = <a class="code" href="leptprotos_8h.html#aa5bdf5d6be24d74a8b3ebf2464ba1007">numaHashGetNuma</a>(state-&gt;<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>-&gt;<a class="code" href="struct_jb_classer.html#a1d395848f89b39b2a6c0626c0b9d33c1">nahash</a>,
<a name="l02318"></a>02318                                           desiredh * desiredw);
<a name="l02319"></a>02319             <span class="keywordflow">if</span> (!state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a>) {  <span class="comment">/* nothing there */</span>
<a name="l02320"></a>02320                 state-&gt;<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>++;
<a name="l02321"></a>02321                 <span class="keywordflow">continue</span>;
<a name="l02322"></a>02322             }
<a name="l02323"></a>02323 
<a name="l02324"></a>02324             state-&gt;<a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a> = 0;  <span class="comment">/* OK, we got a numa. */</span>
<a name="l02325"></a>02325         }
<a name="l02326"></a>02326 
<a name="l02327"></a>02327             <span class="comment">/* Continue working on this numa */</span>
<a name="l02328"></a>02328         size = <a class="code" href="leptprotos_8h.html#a3d022536ec48f28421c56f586d697295">numaGetCount</a>(state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a>);
<a name="l02329"></a>02329         <span class="keywordflow">for</span> ( ; state-&gt;<a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a> &lt; <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>; ) {
<a name="l02330"></a>02330             templ = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a>-&gt;<a class="code" href="struct_numa.html#a61817e4e267f58a697b701a9728db6fe">array</a>[state-&gt;<a class="code" href="struct_jb_find_templates_state.html#aa72beb5cdf93736581378d4710025c34">n</a>++] + 0.5);
<a name="l02331"></a>02331             pixt = <a class="code" href="leptprotos_8h.html#a3f62a77cf11114981267a6cf9918fc45">pixaGetPix</a>(state-&gt;<a class="code" href="struct_jb_find_templates_state.html#abecb89a750be7f856b4304e46d606b71">classer</a>-&gt;<a class="code" href="struct_jb_classer.html#a0c01630c36a31b54f205536bd550a67a">pixat</a>, templ, <a class="code" href="pix_8h.html#a5d76b81b0ad4c19007a781d4edb8181fa890051b4927a821110da74bae0d3c529">L_CLONE</a>);
<a name="l02332"></a>02332             <span class="keywordflow">if</span> (<a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pixt) - 2 * <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a> == desiredw &amp;&amp;
<a name="l02333"></a>02333                 <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pixt) - 2 * <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a> == desiredh) {
<a name="l02334"></a>02334                 <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt);
<a name="l02335"></a>02335                 <span class="keywordflow">return</span> templ;
<a name="l02336"></a>02336             }
<a name="l02337"></a>02337             <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixt);
<a name="l02338"></a>02338         }
<a name="l02339"></a>02339 
<a name="l02340"></a>02340             <span class="comment">/* Exhausted the numa; take another step and try again */</span>
<a name="l02341"></a>02341         state-&gt;<a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>++;
<a name="l02342"></a>02342         <a class="code" href="leptprotos_8h.html#aba8d7e230092813965301cca699a6ebc">numaDestroy</a>(&amp;state-&gt;<a class="code" href="struct_jb_find_templates_state.html#a5b4e520906eb7819e9708b23f08e8e4c">numa</a>);
<a name="l02343"></a>02343         <span class="keywordflow">continue</span>;
<a name="l02344"></a>02344     }
<a name="l02345"></a>02345 }
<a name="l02346"></a>02346 
<a name="l02347"></a>02347 <span class="comment"></span>
<a name="l02348"></a>02348 <span class="comment">/*!</span>
<a name="l02349"></a>02349 <span class="comment"> *  finalPositioningForAlignment()</span>
<a name="l02350"></a>02350 <span class="comment"> *</span>
<a name="l02351"></a>02351 <span class="comment"> *      Input:  pixs (input page image)</span>
<a name="l02352"></a>02352 <span class="comment"> *              x, y (location of UL corner of bb of component in pixs)</span>
<a name="l02353"></a>02353 <span class="comment"> *              idelx, idely (compensation to match centroids of component</span>
<a name="l02354"></a>02354 <span class="comment"> *                            and template)</span>
<a name="l02355"></a>02355 <span class="comment"> *              pixt (template, with JB_ADDED_PIXELS of padding on all sides)</span>
<a name="l02356"></a>02356 <span class="comment"> *              sumtab (for summing fg pixels in an image)</span>
<a name="l02357"></a>02357 <span class="comment"> *              &amp;dx, &amp;dy (return delta on position for best match; each</span>
<a name="l02358"></a>02358 <span class="comment"> *                        one is in the set {-1, 0, 1})</span>
<a name="l02359"></a>02359 <span class="comment"> *      Return: 0 if OK, 1 on error</span>
<a name="l02360"></a>02360 <span class="comment"> *</span>
<a name="l02361"></a>02361 <span class="comment"> */</span>
<a name="l02362"></a>02362 <span class="keyword">static</span> <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l02363"></a><a class="code" href="jbclass_8c.html#a1daded8379f0aae4dc6b60e7b33b89ee">02363</a> <a class="code" href="jbclass_8c.html#a1daded8379f0aae4dc6b60e7b33b89ee">finalPositioningForAlignment</a>(<a class="code" href="struct_pix.html">PIX</a>      *pixs,
<a name="l02364"></a>02364                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   x,
<a name="l02365"></a>02365                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   y,
<a name="l02366"></a>02366                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   idelx,
<a name="l02367"></a>02367                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   idely,
<a name="l02368"></a>02368                              <a class="code" href="struct_pix.html">PIX</a>      *pixt,
<a name="l02369"></a>02369                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  *sumtab,
<a name="l02370"></a>02370                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  *pdx,
<a name="l02371"></a>02371                              <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  *pdy)
<a name="l02372"></a>02372 {
<a name="l02373"></a>02373 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>  <a class="code" href="struct_jb_find_templates_state.html#a75a3b55cd59b74c510cb01d0ac44bf3b">w</a>, <a class="code" href="struct_jb_find_templates_state.html#a8bd903fc5967dfe1f0be88ded6474296">h</a>, <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>, j, minx, miny, count, mincount;
<a name="l02374"></a>02374 <a class="code" href="struct_pix.html">PIX</a>     *pixi;  <span class="comment">/* clipped from source pixs */</span>
<a name="l02375"></a>02375 <a class="code" href="struct_pix.html">PIX</a>     *pixr;  <span class="comment">/* temporary storage */</span>
<a name="l02376"></a>02376 <a class="code" href="struct_box.html">BOX</a>     *box;
<a name="l02377"></a>02377 
<a name="l02378"></a>02378     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;finalPositioningForAlignment&quot;</span>);
<a name="l02379"></a>02379 
<a name="l02380"></a>02380     <span class="keywordflow">if</span> (!pixs)
<a name="l02381"></a>02381         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixs not defined&quot;</span>, procName, 1);
<a name="l02382"></a>02382     <span class="keywordflow">if</span> (!pixt)
<a name="l02383"></a>02383         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixt not defined&quot;</span>, procName, 1);
<a name="l02384"></a>02384     <span class="keywordflow">if</span> (!pdx || !pdy)
<a name="l02385"></a>02385         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;&amp;dx and &amp;dy not both defined&quot;</span>, procName, 1);
<a name="l02386"></a>02386     <span class="keywordflow">if</span> (!sumtab)
<a name="l02387"></a>02387         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;sumtab not defined&quot;</span>, procName, 1);
<a name="l02388"></a>02388     *pdx = *pdy = 0;
<a name="l02389"></a>02389 
<a name="l02390"></a>02390         <span class="comment">/* Use JB_ADDED_PIXELS pixels padding on each side */</span>
<a name="l02391"></a>02391     w = <a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pixt);
<a name="l02392"></a>02392     h = <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pixt);
<a name="l02393"></a>02393     box = <a class="code" href="boxbasic_8c.html#ad846c5f00e3aaed3dd4329347acac89d">boxCreate</a>(x - idelx - <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>,
<a name="l02394"></a>02394                     y - idely - <a class="code" href="jbclass_8c.html#a0e7b41571d5f2f46d4fc2304f69bd9f1">JB_ADDED_PIXELS</a>, w, h);
<a name="l02395"></a>02395     pixi = <a class="code" href="leptprotos_8h.html#a679fd22fd63f9c368f4417c0a2a11b2a">pixClipRectangle</a>(pixs, box, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02396"></a>02396     <a class="code" href="boxbasic_8c.html#a494a2b1bf2e00d030dae5e11e12dbddb">boxDestroy</a>(&amp;box);
<a name="l02397"></a>02397     <span class="keywordflow">if</span> (!pixi)
<a name="l02398"></a>02398         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixi not made&quot;</span>, procName, 1);
<a name="l02399"></a>02399 
<a name="l02400"></a>02400     pixr = <a class="code" href="leptprotos_8h.html#a009df4671d39f94b50a0368af210aebe">pixCreate</a>(<a class="code" href="leptprotos_8h.html#aa71e0b02548a56e723c76996ab145257">pixGetWidth</a>(pixi), <a class="code" href="leptprotos_8h.html#a511e60efcf1d9f3f59b5308ef5f49a06">pixGetHeight</a>(pixi), 1);
<a name="l02401"></a>02401     mincount = 0x7fffffff;
<a name="l02402"></a>02402     <span class="keywordflow">for</span> (i = -1; i &lt;= 1; i++) {
<a name="l02403"></a>02403         <span class="keywordflow">for</span> (j = -1; j &lt;= 1; j++) {
<a name="l02404"></a>02404             <a class="code" href="leptprotos_8h.html#a421e342a65236aa6770965d34101e0ee">pixCopy</a>(pixr, pixi);
<a name="l02405"></a>02405             <a class="code" href="leptprotos_8h.html#ac36759948f467dfed4c52c9c45332a80">pixRasterop</a>(pixr, j, i, w, h, <a class="code" href="pix_8h.html#aaa41a5eaf71eedad2360246d1ab5f19e">PIX_SRC</a> ^ <a class="code" href="pix_8h.html#a0bc9848843e824c84419cd73ec4af5f2">PIX_DST</a>, pixt, 0, 0);
<a name="l02406"></a>02406             <a class="code" href="leptprotos_8h.html#a5908448bd997449a0ebbb3bf8bcb4558">pixCountPixels</a>(pixr, &amp;count, sumtab);
<a name="l02407"></a>02407             <span class="keywordflow">if</span> (count &lt; mincount) {
<a name="l02408"></a>02408                 minx = j;
<a name="l02409"></a>02409                 miny = <a class="code" href="struct_jb_find_templates_state.html#ae11841937809252dd709e9d72efef834">i</a>;
<a name="l02410"></a>02410                 mincount = count;
<a name="l02411"></a>02411             }
<a name="l02412"></a>02412         }
<a name="l02413"></a>02413     }
<a name="l02414"></a>02414     <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixi);
<a name="l02415"></a>02415     <a class="code" href="leptprotos_8h.html#a1b238e61b64e4e5c62f44849cddb9658">pixDestroy</a>(&amp;pixr);
<a name="l02416"></a>02416 
<a name="l02417"></a>02417     *pdx = minx;
<a name="l02418"></a>02418     *pdy = miny;
<a name="l02419"></a>02419     <span class="keywordflow">return</span> 0;
<a name="l02420"></a>02420 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="jbclass_8c.html">jbclass.c</a>      </li>
      <li class="footer">Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
