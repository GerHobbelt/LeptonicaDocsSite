<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Leptonica: src/scalelow.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="moller52-tiny.jpg"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Leptonica&#160;<span id="projectnumber">1.68</span></div>
   <div id="projectbrief">C Image Processing Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('scalelow_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>scalelow.c</h1>  </div>
</div>
<div class="contents">
<a href="scalelow_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*====================================================================*</span>
<a name="l00002"></a>00002 <span class="comment"> -  Copyright (C) 2001 Leptonica.  All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> -  This software is distributed in the hope that it will be</span>
<a name="l00004"></a>00004 <span class="comment"> -  useful, but with NO WARRANTY OF ANY KIND.</span>
<a name="l00005"></a>00005 <span class="comment"> -  No author or distributor accepts responsibility to anyone for the</span>
<a name="l00006"></a>00006 <span class="comment"> -  consequences of using this software, or for whether it serves any</span>
<a name="l00007"></a>00007 <span class="comment"> -  particular purpose or works at all, unless he or she says so in</span>
<a name="l00008"></a>00008 <span class="comment"> -  writing.  Everyone is granted permission to copy, modify and</span>
<a name="l00009"></a>00009 <span class="comment"> -  redistribute this source code, for commercial or non-commercial</span>
<a name="l00010"></a>00010 <span class="comment"> -  purposes, with the following restrictions: (1) the origin of this</span>
<a name="l00011"></a>00011 <span class="comment"> -  source code must not be misrepresented; (2) modified versions must</span>
<a name="l00012"></a>00012 <span class="comment"> -  be plainly marked as such; and (3) this notice may not be removed</span>
<a name="l00013"></a>00013 <span class="comment"> -  or altered from any source or modified source distribution.</span>
<a name="l00014"></a>00014 <span class="comment"> *====================================================================*/</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment">/*</span>
<a name="l00018"></a>00018 <span class="comment"> *  scalelow.c</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> *         Color (interpolated) scaling: general case</span>
<a name="l00021"></a>00021 <span class="comment"> *                  void       scaleColorLILow()</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> *         Grayscale (interpolated) scaling: general case</span>
<a name="l00024"></a>00024 <span class="comment"> *                  void       scaleGrayLILow()</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> *         Color (interpolated) scaling: 2x upscaling</span>
<a name="l00027"></a>00027 <span class="comment"> *                  void       scaleColor2xLILow()</span>
<a name="l00028"></a>00028 <span class="comment"> *                  void       scaleColor2xLILineLow()</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> *         Grayscale (interpolated) scaling: 2x upscaling</span>
<a name="l00031"></a>00031 <span class="comment"> *                  void       scaleGray2xLILow()</span>
<a name="l00032"></a>00032 <span class="comment"> *                  void       scaleGray2xLILineLow()</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *         Grayscale (interpolated) scaling: 4x upscaling</span>
<a name="l00035"></a>00035 <span class="comment"> *                  void       scaleGray4xLILow()</span>
<a name="l00036"></a>00036 <span class="comment"> *                  void       scaleGray4xLILineLow()</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *         Grayscale and color scaling by closest pixel sampling</span>
<a name="l00039"></a>00039 <span class="comment"> *                  l_int32    scaleBySamplingLow()</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *         Color and grayscale downsampling with (antialias) lowpass filter</span>
<a name="l00042"></a>00042 <span class="comment"> *                  l_int32    scaleSmoothLow()</span>
<a name="l00043"></a>00043 <span class="comment"> *                  void       scaleRGBToGray2Low()</span>
<a name="l00044"></a>00044 <span class="comment"> *</span>
<a name="l00045"></a>00045 <span class="comment"> *         Color and grayscale downsampling with (antialias) area mapping</span>
<a name="l00046"></a>00046 <span class="comment"> *                  l_int32    scaleColorAreaMapLow()</span>
<a name="l00047"></a>00047 <span class="comment"> *                  l_int32    scaleGrayAreaMapLow()</span>
<a name="l00048"></a>00048 <span class="comment"> *                  l_int32    scaleAreaMapLow2()</span>
<a name="l00049"></a>00049 <span class="comment"> *</span>
<a name="l00050"></a>00050 <span class="comment"> *         Binary scaling by closest pixel sampling</span>
<a name="l00051"></a>00051 <span class="comment"> *                  l_int32    scaleBinaryLow()</span>
<a name="l00052"></a>00052 <span class="comment"> *</span>
<a name="l00053"></a>00053 <span class="comment"> *         Scale-to-gray 2x</span>
<a name="l00054"></a>00054 <span class="comment"> *                  void       scaleToGray2Low()</span>
<a name="l00055"></a>00055 <span class="comment"> *                  l_uint32  *makeSumTabSG2()</span>
<a name="l00056"></a>00056 <span class="comment"> *                  l_uint8   *makeValTabSG2()</span>
<a name="l00057"></a>00057 <span class="comment"> *</span>
<a name="l00058"></a>00058 <span class="comment"> *         Scale-to-gray 3x</span>
<a name="l00059"></a>00059 <span class="comment"> *                  void       scaleToGray3Low()</span>
<a name="l00060"></a>00060 <span class="comment"> *                  l_uint32  *makeSumTabSG3()</span>
<a name="l00061"></a>00061 <span class="comment"> *                  l_uint8   *makeValTabSG3()</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *         Scale-to-gray 4x</span>
<a name="l00064"></a>00064 <span class="comment"> *                  void       scaleToGray4Low()</span>
<a name="l00065"></a>00065 <span class="comment"> *                  l_uint32  *makeSumTabSG4()</span>
<a name="l00066"></a>00066 <span class="comment"> *                  l_uint8   *makeValTabSG4()</span>
<a name="l00067"></a>00067 <span class="comment"> *</span>
<a name="l00068"></a>00068 <span class="comment"> *         Scale-to-gray 6x</span>
<a name="l00069"></a>00069 <span class="comment"> *                  void       scaleToGray6Low()</span>
<a name="l00070"></a>00070 <span class="comment"> *                  l_uint8   *makeValTabSG6()</span>
<a name="l00071"></a>00071 <span class="comment"> *</span>
<a name="l00072"></a>00072 <span class="comment"> *         Scale-to-gray 8x</span>
<a name="l00073"></a>00073 <span class="comment"> *                  void       scaleToGray8Low()</span>
<a name="l00074"></a>00074 <span class="comment"> *                  l_uint8   *makeValTabSG8()</span>
<a name="l00075"></a>00075 <span class="comment"> *</span>
<a name="l00076"></a>00076 <span class="comment"> *         Scale-to-gray 16x</span>
<a name="l00077"></a>00077 <span class="comment"> *                  void       scaleToGray16Low()</span>
<a name="l00078"></a>00078 <span class="comment"> *</span>
<a name="l00079"></a>00079 <span class="comment"> *         Grayscale mipmap</span>
<a name="l00080"></a>00080 <span class="comment"> *                  l_int32    scaleMipmapLow()</span>
<a name="l00081"></a>00081 <span class="comment"> *</span>
<a name="l00082"></a>00082 <span class="comment"> */</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="allheaders_8h.html" title="Includes all required Leptonica header files.">allheaders.h</a>&quot;</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="preprocessor">#ifndef  NO_CONSOLE_IO</span>
<a name="l00090"></a><a class="code" href="scalelow_8c.html#a2e6ef1d051de5adf2891411a48101974">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define  DEBUG_OVERFLOW   0</span>
<a name="l00091"></a><a class="code" href="scalelow_8c.html#a6f3e911ef473940bb25b5f50c65055b7">00091</a> <span class="preprocessor"></span><span class="preprocessor">#define  DEBUG_UNROLLING  0</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">#endif  </span><span class="comment">/* ~NO_CONSOLE_IO */</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l00096"></a>00096 <span class="comment"> *            General linear interpolated color scaling             *</span>
<a name="l00097"></a>00097 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00098"></a>00098 <span class="comment">/*!</span>
<a name="l00099"></a>00099 <span class="comment"> *  scaleColorLILow()</span>
<a name="l00100"></a>00100 <span class="comment"> *</span>
<a name="l00101"></a>00101 <span class="comment"> *  We choose to divide each pixel into 16 x 16 sub-pixels.</span>
<a name="l00102"></a>00102 <span class="comment"> *  Linear interpolation is equivalent to finding the </span>
<a name="l00103"></a>00103 <span class="comment"> *  fractional area (i.e., number of sub-pixels divided</span>
<a name="l00104"></a>00104 <span class="comment"> *  by 256) associated with each of the four nearest src pixels,</span>
<a name="l00105"></a>00105 <span class="comment"> *  and weighting each pixel value by this fractional area.</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> *  P3 speed is about 7 x 10^6 dst pixels/sec/GHz</span>
<a name="l00108"></a>00108 <span class="comment"> */</span>
<a name="l00109"></a>00109 <span class="keywordtype">void</span>
<a name="l00110"></a><a class="code" href="scalelow_8c.html#a592f4ad0e4e0e4f0f71599a4279b4b7a">00110</a> <a class="code" href="leptprotos_8h.html#a98481d5a37a6463bf69e76c668bf064b">scaleColorLILow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l00111"></a>00111                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l00112"></a>00112                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l00113"></a>00113                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00114"></a>00114                <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l00115"></a>00115                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00116"></a>00116                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l00117"></a>00117                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, wm2, hm2;
<a name="l00120"></a>00120 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xpm, ypm;  <span class="comment">/* location in src image, to 1/16 of a pixel */</span>
<a name="l00121"></a>00121 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xp, yp, xf, yf;  <span class="comment">/* src pixel and pixel fraction coordinates */</span>
<a name="l00122"></a>00122 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v00r, v01r, v10r, v11r, v00g, v01g, v10g, v11g;
<a name="l00123"></a>00123 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v00b, v01b, v10b, v11b, area00, area01, area10, area11;
<a name="l00124"></a>00124 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   pixels1, pixels2, pixels3, pixels4, pixel;
<a name="l00125"></a>00125 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l00126"></a>00126 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  scx, scy;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128         <span class="comment">/* (scx, scy) are scaling factors that are applied to the</span>
<a name="l00129"></a>00129 <span class="comment">         * dest coords to get the corresponding src coords.</span>
<a name="l00130"></a>00130 <span class="comment">         * We need them because we iterate over dest pixels</span>
<a name="l00131"></a>00131 <span class="comment">         * and must find the corresponding set of src pixels. */</span>
<a name="l00132"></a>00132     scx = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)ws / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)wd;
<a name="l00133"></a>00133     scy = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hs / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hd;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     wm2 = ws - 2;
<a name="l00136"></a>00136     hm2 = hs - 2;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         <span class="comment">/* Iterate over the destination pixels */</span>
<a name="l00139"></a>00139     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l00140"></a>00140         ypm = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scy * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)i);
<a name="l00141"></a>00141         yp = ypm &gt;&gt; 4;
<a name="l00142"></a>00142         yf = ypm &amp; 0x0f;
<a name="l00143"></a>00143         lined = datad + i * wpld;
<a name="l00144"></a>00144         lines = datas + yp * wpls;
<a name="l00145"></a>00145         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l00146"></a>00146             xpm = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scx * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)j);
<a name="l00147"></a>00147             xp = xpm &gt;&gt; 4;
<a name="l00148"></a>00148             xf = xpm &amp; 0x0f;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150                 <span class="comment">/* Do bilinear interpolation.  This is a simple</span>
<a name="l00151"></a>00151 <span class="comment">                 * generalization of the calculation in scaleGrayLILow().</span>
<a name="l00152"></a>00152 <span class="comment">                 * Without this, we could simply subsample:</span>
<a name="l00153"></a>00153 <span class="comment">                 *     *(lined + j) = *(lines + xp);</span>
<a name="l00154"></a>00154 <span class="comment">                 * which is faster but gives lousy results!  */</span>
<a name="l00155"></a>00155             pixels1 = *(lines + xp);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157             <span class="keywordflow">if</span> (xp &gt; wm2 || yp &gt; hm2) {
<a name="l00158"></a>00158                 <span class="keywordflow">if</span> (yp &gt; hm2 &amp;&amp; xp &lt;= wm2) {  <span class="comment">/* pixels near bottom */</span>
<a name="l00159"></a>00159                     pixels2 = *(lines + xp + 1);
<a name="l00160"></a>00160                     pixels3 = pixels1;
<a name="l00161"></a>00161                     pixels4 = pixels2;
<a name="l00162"></a>00162                 }
<a name="l00163"></a>00163                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xp &gt; wm2 &amp;&amp; yp &lt;= hm2) {  <span class="comment">/* pixels near right side */</span>
<a name="l00164"></a>00164                     pixels2 = pixels1;
<a name="l00165"></a>00165                     pixels3 = *(lines + wpls + xp);
<a name="l00166"></a>00166                     pixels4 = pixels3;
<a name="l00167"></a>00167                 }
<a name="l00168"></a>00168                 <span class="keywordflow">else</span> {  <span class="comment">/* pixels at LR corner */</span>
<a name="l00169"></a>00169                     pixels4 = pixels3 = pixels2 = pixels1;
<a name="l00170"></a>00170                 }
<a name="l00171"></a>00171             }
<a name="l00172"></a>00172             <span class="keywordflow">else</span> {
<a name="l00173"></a>00173                 pixels2 = *(lines + xp + 1);
<a name="l00174"></a>00174                 pixels3 = *(lines + wpls + xp);
<a name="l00175"></a>00175                 pixels4 = *(lines + wpls + xp + 1);
<a name="l00176"></a>00176             }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178             area00 = (16 - xf) * (16 - yf);
<a name="l00179"></a>00179             area10 = xf * (16 - yf);
<a name="l00180"></a>00180             area01 = (16 - xf) * yf;
<a name="l00181"></a>00181             area11 = xf * yf;
<a name="l00182"></a>00182             v00r = area00 * ((pixels1 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l00183"></a>00183             v00g = area00 * ((pixels1 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l00184"></a>00184             v00b = area00 * ((pixels1 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l00185"></a>00185             v10r = area10 * ((pixels2 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l00186"></a>00186             v10g = area10 * ((pixels2 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l00187"></a>00187             v10b = area10 * ((pixels2 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l00188"></a>00188             v01r = area01 * ((pixels3 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l00189"></a>00189             v01g = area01 * ((pixels3 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l00190"></a>00190             v01b = area01 * ((pixels3 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l00191"></a>00191             v11r = area11 * ((pixels4 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l00192"></a>00192             v11g = area11 * ((pixels4 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l00193"></a>00193             v11b = area11 * ((pixels4 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l00194"></a>00194             pixel = (((v00r + v10r + v01r + v11r + 128) &lt;&lt; 16) &amp; 0xff000000) |
<a name="l00195"></a>00195                     (((v00g + v10g + v01g + v11g + 128) &lt;&lt; 8) &amp; 0x00ff0000) |
<a name="l00196"></a>00196                     ((v00b + v10b + v01b + v11b + 128) &amp; 0x0000ff00);
<a name="l00197"></a>00197             *(lined + j) = pixel;
<a name="l00198"></a>00198         }
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="keywordflow">return</span>;
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l00206"></a>00206 <span class="comment"> *            General linear interpolated gray scaling              *</span>
<a name="l00207"></a>00207 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00208"></a>00208 <span class="comment">/*!</span>
<a name="l00209"></a>00209 <span class="comment"> *  scaleGrayLILow()</span>
<a name="l00210"></a>00210 <span class="comment"> *</span>
<a name="l00211"></a>00211 <span class="comment"> *  We choose to divide each pixel into 16 x 16 sub-pixels.</span>
<a name="l00212"></a>00212 <span class="comment"> *  Linear interpolation is equivalent to finding the </span>
<a name="l00213"></a>00213 <span class="comment"> *  fractional area (i.e., number of sub-pixels divided</span>
<a name="l00214"></a>00214 <span class="comment"> *  by 256) associated with each of the four nearest src pixels,</span>
<a name="l00215"></a>00215 <span class="comment"> *  and weighting each pixel value by this fractional area.</span>
<a name="l00216"></a>00216 <span class="comment"> */</span>
<a name="l00217"></a>00217 <span class="keywordtype">void</span>
<a name="l00218"></a><a class="code" href="scalelow_8c.html#aaf42db601ffbb710c915f6e4cb43a82c">00218</a> <a class="code" href="leptprotos_8h.html#ac0d83ed0ff45b3a18c7edd2ba658896a">scaleGrayLILow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l00219"></a>00219                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l00220"></a>00220                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l00221"></a>00221                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00222"></a>00222                <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l00223"></a>00223                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00224"></a>00224                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l00225"></a>00225                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, wm2, hm2;
<a name="l00228"></a>00228 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xpm, ypm;  <span class="comment">/* location in src image, to 1/16 of a pixel */</span>
<a name="l00229"></a>00229 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xp, yp, xf, yf;  <span class="comment">/* src pixel and pixel fraction coordinates */</span>
<a name="l00230"></a>00230 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v00, v01, v10, v11, v00_val, v01_val, v10_val, v11_val;
<a name="l00231"></a>00231 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>    val;
<a name="l00232"></a>00232 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l00233"></a>00233 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  scx, scy;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235         <span class="comment">/* (scx, scy) are scaling factors that are applied to the</span>
<a name="l00236"></a>00236 <span class="comment">         * dest coords to get the corresponding src coords.</span>
<a name="l00237"></a>00237 <span class="comment">         * We need them because we iterate over dest pixels</span>
<a name="l00238"></a>00238 <span class="comment">         * and must find the corresponding set of src pixels. */</span>
<a name="l00239"></a>00239     scx = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)ws / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)wd;
<a name="l00240"></a>00240     scy = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hs / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hd;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     wm2 = ws - 2;
<a name="l00243"></a>00243     hm2 = hs - 2;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         <span class="comment">/* Iterate over the destination pixels */</span>
<a name="l00246"></a>00246     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l00247"></a>00247         ypm = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scy * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)i);
<a name="l00248"></a>00248         yp = ypm &gt;&gt; 4;
<a name="l00249"></a>00249         yf = ypm &amp; 0x0f;
<a name="l00250"></a>00250         lined = datad + i * wpld;
<a name="l00251"></a>00251         lines = datas + yp * wpls;
<a name="l00252"></a>00252         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l00253"></a>00253             xpm = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scx * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)j);
<a name="l00254"></a>00254             xp = xpm &gt;&gt; 4;
<a name="l00255"></a>00255             xf = xpm &amp; 0x0f;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257                 <span class="comment">/* Do bilinear interpolation.  Without this, we could</span>
<a name="l00258"></a>00258 <span class="comment">                 * simply subsample:</span>
<a name="l00259"></a>00259 <span class="comment">                 *   SET_DATA_BYTE(lined, j, GET_DATA_BYTE(lines, xp));</span>
<a name="l00260"></a>00260 <span class="comment">                 * which is faster but gives lousy results!  */</span>
<a name="l00261"></a>00261             v00_val = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xp);
<a name="l00262"></a>00262             <span class="keywordflow">if</span> (xp &gt; wm2 || yp &gt; hm2) {
<a name="l00263"></a>00263                 <span class="keywordflow">if</span> (yp &gt; hm2 &amp;&amp; xp &lt;= wm2) {  <span class="comment">/* pixels near bottom */</span>
<a name="l00264"></a>00264                     v01_val = v00_val;
<a name="l00265"></a>00265                     v10_val = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xp + 1);
<a name="l00266"></a>00266                     v11_val = v10_val;
<a name="l00267"></a>00267                 }
<a name="l00268"></a>00268                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xp &gt; wm2 &amp;&amp; yp &lt;= hm2) {  <span class="comment">/* pixels near right side */</span>
<a name="l00269"></a>00269                     v01_val = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, xp);
<a name="l00270"></a>00270                     v10_val = v00_val;
<a name="l00271"></a>00271                     v11_val = v01_val;
<a name="l00272"></a>00272                 }
<a name="l00273"></a>00273                 <span class="keywordflow">else</span> {  <span class="comment">/* pixels at LR corner */</span>
<a name="l00274"></a>00274                     v10_val = v01_val = v11_val = v00_val;
<a name="l00275"></a>00275                 }
<a name="l00276"></a>00276             }
<a name="l00277"></a>00277             <span class="keywordflow">else</span> {
<a name="l00278"></a>00278                 v10_val = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xp + 1);
<a name="l00279"></a>00279                 v01_val = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, xp);
<a name="l00280"></a>00280                 v11_val = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, xp + 1);
<a name="l00281"></a>00281             }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283             v00 = (16 - xf) * (16 - yf) * v00_val;
<a name="l00284"></a>00284             v10 = xf * (16 - yf) * v10_val;
<a name="l00285"></a>00285             v01 = (16 - xf) * yf * v01_val;
<a name="l00286"></a>00286             v11 = xf * yf * v11_val;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288             val = (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>)((v00 + v01 + v10 + v11 + 128) / 256);
<a name="l00289"></a>00289             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, val);
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="keywordflow">return</span>;
<a name="l00294"></a>00294 }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l00298"></a>00298 <span class="comment"> *                2x linear interpolated color scaling              *</span>
<a name="l00299"></a>00299 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00300"></a>00300 <span class="comment">/*!</span>
<a name="l00301"></a>00301 <span class="comment"> *  scaleColor2xLILow()</span>
<a name="l00302"></a>00302 <span class="comment"> *</span>
<a name="l00303"></a>00303 <span class="comment"> *  This is a special case of 2x expansion by linear</span>
<a name="l00304"></a>00304 <span class="comment"> *  interpolation.  Each src pixel contains 4 dest pixels.</span>
<a name="l00305"></a>00305 <span class="comment"> *  The 4 dest pixels in src pixel 1 are numbered at</span>
<a name="l00306"></a>00306 <span class="comment"> *  their UL corners.  The 4 dest pixels in src pixel 1</span>
<a name="l00307"></a>00307 <span class="comment"> *  are related to that src pixel and its 3 neighboring</span>
<a name="l00308"></a>00308 <span class="comment"> *  src pixels as follows:</span>
<a name="l00309"></a>00309 <span class="comment"> *</span>
<a name="l00310"></a>00310 <span class="comment"> *             1-----2-----|-----|-----|</span>
<a name="l00311"></a>00311 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00312"></a>00312 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00313"></a>00313 <span class="comment"> *  src 1 --&gt;  3-----4-----|     |     |  &lt;-- src 2</span>
<a name="l00314"></a>00314 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00315"></a>00315 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00316"></a>00316 <span class="comment"> *             |-----|-----|-----|-----|</span>
<a name="l00317"></a>00317 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00318"></a>00318 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00319"></a>00319 <span class="comment"> *  src 3 --&gt;  |     |     |     |     |  &lt;-- src 4</span>
<a name="l00320"></a>00320 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00321"></a>00321 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00322"></a>00322 <span class="comment"> *             |-----|-----|-----|-----|</span>
<a name="l00323"></a>00323 <span class="comment"> *</span>
<a name="l00324"></a>00324 <span class="comment"> *           dest      src</span>
<a name="l00325"></a>00325 <span class="comment"> *           ----      ---</span>
<a name="l00326"></a>00326 <span class="comment"> *           dp1    =  sp1</span>
<a name="l00327"></a>00327 <span class="comment"> *           dp2    =  (sp1 + sp2) / 2</span>
<a name="l00328"></a>00328 <span class="comment"> *           dp3    =  (sp1 + sp3) / 2</span>
<a name="l00329"></a>00329 <span class="comment"> *           dp4    =  (sp1 + sp2 + sp3 + sp4) / 4</span>
<a name="l00330"></a>00330 <span class="comment"> *</span>
<a name="l00331"></a>00331 <span class="comment"> *  We iterate over the src pixels, and unroll the calculation</span>
<a name="l00332"></a>00332 <span class="comment"> *  for each set of 4 dest pixels corresponding to that src</span>
<a name="l00333"></a>00333 <span class="comment"> *  pixel, caching pixels for the next src pixel whenever possible.</span>
<a name="l00334"></a>00334 <span class="comment"> *  The method is exactly analogous to the one we use for</span>
<a name="l00335"></a>00335 <span class="comment"> *  scaleGray2xLILow() and its line version.</span>
<a name="l00336"></a>00336 <span class="comment"> *</span>
<a name="l00337"></a>00337 <span class="comment"> *  P3 speed is about 5 x 10^7 dst pixels/sec/GHz</span>
<a name="l00338"></a>00338 <span class="comment"> */</span>
<a name="l00339"></a>00339 <span class="keywordtype">void</span>
<a name="l00340"></a><a class="code" href="scalelow_8c.html#a97e99bbfae0dd75d261cd6da43cfb51f">00340</a> <a class="code" href="leptprotos_8h.html#ad1a688c4e1f0b789b37657fdaa7fdf16">scaleColor2xLILow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l00341"></a>00341                   <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00342"></a>00342                   <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l00343"></a>00343                   <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00344"></a>00344                   <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l00345"></a>00345                   <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, hsm;
<a name="l00348"></a>00348 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     hsm = hs - 1;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="comment">/* We&#39;re taking 2 src and 2 dest lines at a time,</span>
<a name="l00353"></a>00353 <span class="comment">         * and for each src line, we&#39;re computing 2 dest lines.</span>
<a name="l00354"></a>00354 <span class="comment">         * Call these 2 dest lines:  destline1 and destline2.</span>
<a name="l00355"></a>00355 <span class="comment">         * The first src line is used for destline 1.</span>
<a name="l00356"></a>00356 <span class="comment">         * On all but the last src line, both src lines are </span>
<a name="l00357"></a>00357 <span class="comment">         * used in the linear interpolation for destline2.</span>
<a name="l00358"></a>00358 <span class="comment">         * On the last src line, both destline1 and destline2</span>
<a name="l00359"></a>00359 <span class="comment">         * are computed using only that src line (because there</span>
<a name="l00360"></a>00360 <span class="comment">         * isn&#39;t a lower src line). */</span>
<a name="l00361"></a>00361 
<a name="l00362"></a>00362         <span class="comment">/* iterate over all but the last src line */</span>
<a name="l00363"></a>00363     <span class="keywordflow">for</span> (i = 0; i &lt; hsm; i++) {
<a name="l00364"></a>00364         lines = datas + i * wpls;
<a name="l00365"></a>00365         lined = datad + 2 * i * wpld;
<a name="l00366"></a>00366         <a class="code" href="leptprotos_8h.html#ad9f6e17b9f6352596f357f63cffe7a22">scaleColor2xLILineLow</a>(lined, wpld, lines, ws, wpls, 0);
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368     
<a name="l00369"></a>00369         <span class="comment">/* last src line */</span>
<a name="l00370"></a>00370     lines = datas + hsm * wpls;
<a name="l00371"></a>00371     lined = datad + 2 * hsm * wpld;
<a name="l00372"></a>00372     <a class="code" href="leptprotos_8h.html#ad9f6e17b9f6352596f357f63cffe7a22">scaleColor2xLILineLow</a>(lined, wpld, lines, ws, wpls, 1);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="keywordflow">return</span>;
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 <span class="comment"></span>
<a name="l00378"></a>00378 <span class="comment">/*!</span>
<a name="l00379"></a>00379 <span class="comment"> *  scaleColor2xLILineLow()</span>
<a name="l00380"></a>00380 <span class="comment"> *</span>
<a name="l00381"></a>00381 <span class="comment"> *      Input:  lined   (ptr to top destline, to be made from current src line)</span>
<a name="l00382"></a>00382 <span class="comment"> *              wpld</span>
<a name="l00383"></a>00383 <span class="comment"> *              lines   (ptr to current src line)</span>
<a name="l00384"></a>00384 <span class="comment"> *              ws</span>
<a name="l00385"></a>00385 <span class="comment"> *              wpls</span>
<a name="l00386"></a>00386 <span class="comment"> *              lastlineflag  (1 if last src line; 0 otherwise)</span>
<a name="l00387"></a>00387 <span class="comment"> *      Return: void</span>
<a name="l00388"></a>00388 <span class="comment"> *</span>
<a name="l00389"></a>00389 <span class="comment"> *  *** Warning: implicit assumption about RGB component ordering ***</span>
<a name="l00390"></a>00390 <span class="comment"> */</span>
<a name="l00391"></a>00391 <span class="keywordtype">void</span>
<a name="l00392"></a><a class="code" href="scalelow_8c.html#a7513e12b4e88b95f40de6467f9819222">00392</a> <a class="code" href="leptprotos_8h.html#ad9f6e17b9f6352596f357f63cffe7a22">scaleColor2xLILineLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lined,
<a name="l00393"></a>00393                       <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00394"></a>00394                       <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines,
<a name="l00395"></a>00395                       <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00396"></a>00396                       <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l00397"></a>00397                       <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    lastlineflag)
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    j, jd, wsm;
<a name="l00400"></a>00400 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    rval1, rval2, rval3, rval4, gval1, gval2, gval3, gval4;
<a name="l00401"></a>00401 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    bval1, bval2, bval3, bval4;
<a name="l00402"></a>00402 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   pixels1, pixels2, pixels3, pixels4, pixel;
<a name="l00403"></a>00403 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *linesp, *linedp;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     wsm = ws - 1;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="keywordflow">if</span> (lastlineflag == 0) {
<a name="l00408"></a>00408         linesp = lines + wpls;
<a name="l00409"></a>00409         linedp = lined + wpld;
<a name="l00410"></a>00410         pixels1 = *lines;
<a name="l00411"></a>00411         pixels3 = *linesp;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413             <span class="comment">/* initialize with v(2) and v(4) */</span>
<a name="l00414"></a>00414         rval2 = pixels1 &gt;&gt; 24;
<a name="l00415"></a>00415         gval2 = (pixels1 &gt;&gt; 16) &amp; 0xff;
<a name="l00416"></a>00416         bval2 = (pixels1 &gt;&gt; 8) &amp; 0xff;
<a name="l00417"></a>00417         rval4 = pixels3 &gt;&gt; 24;
<a name="l00418"></a>00418         gval4 = (pixels3 &gt;&gt; 16) &amp; 0xff;
<a name="l00419"></a>00419         bval4 = (pixels3 &gt;&gt; 8) &amp; 0xff;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <span class="keywordflow">for</span> (j = 0, jd = 0; j &lt; wsm; j++, jd += 2) {
<a name="l00422"></a>00422                 <span class="comment">/* shift in previous src values */</span>
<a name="l00423"></a>00423             rval1 = rval2;
<a name="l00424"></a>00424             gval1 = gval2;
<a name="l00425"></a>00425             bval1 = bval2;
<a name="l00426"></a>00426             rval3 = rval4;
<a name="l00427"></a>00427             gval3 = gval4;
<a name="l00428"></a>00428             bval3 = bval4;
<a name="l00429"></a>00429                 <span class="comment">/* get new src values */</span>
<a name="l00430"></a>00430             pixels2 = *(lines + j + 1);
<a name="l00431"></a>00431             pixels4 = *(linesp + j + 1);
<a name="l00432"></a>00432             rval2 = pixels2 &gt;&gt; 24;
<a name="l00433"></a>00433             gval2 = (pixels2 &gt;&gt; 16) &amp; 0xff;
<a name="l00434"></a>00434             bval2 = (pixels2 &gt;&gt; 8) &amp; 0xff;
<a name="l00435"></a>00435             rval4 = pixels4 &gt;&gt; 24;
<a name="l00436"></a>00436             gval4 = (pixels4 &gt;&gt; 16) &amp; 0xff;
<a name="l00437"></a>00437             bval4 = (pixels4 &gt;&gt; 8) &amp; 0xff;
<a name="l00438"></a>00438                 <span class="comment">/* save dest values */</span>
<a name="l00439"></a>00439             pixel = (rval1 &lt;&lt; 24 | gval1 &lt;&lt; 16 | bval1 &lt;&lt; 8);
<a name="l00440"></a>00440             *(lined + jd) = pixel;                               <span class="comment">/* pix 1 */</span>
<a name="l00441"></a>00441             pixel = ((((rval1 + rval2) &lt;&lt; 23) &amp; 0xff000000) |
<a name="l00442"></a>00442                      (((gval1 + gval2) &lt;&lt; 15) &amp; 0x00ff0000) |
<a name="l00443"></a>00443                      (((bval1 + bval2) &lt;&lt; 7) &amp; 0x0000ff00));
<a name="l00444"></a>00444             *(lined + jd + 1) = pixel;                           <span class="comment">/* pix 2 */</span>
<a name="l00445"></a>00445             pixel = ((((rval1 + rval3) &lt;&lt; 23) &amp; 0xff000000) |
<a name="l00446"></a>00446                      (((gval1 + gval3) &lt;&lt; 15) &amp; 0x00ff0000) |
<a name="l00447"></a>00447                      (((bval1 + bval3) &lt;&lt; 7) &amp; 0x0000ff00));
<a name="l00448"></a>00448             *(linedp + jd) = pixel;                              <span class="comment">/* pix 3 */</span>
<a name="l00449"></a>00449             pixel = ((((rval1 + rval2 + rval3 + rval4) &lt;&lt; 22) &amp; 0xff000000) | 
<a name="l00450"></a>00450                      (((gval1 + gval2 + gval3 + gval4) &lt;&lt; 14) &amp; 0x00ff0000) |
<a name="l00451"></a>00451                      (((bval1 + bval2 + bval3 + bval4) &lt;&lt; 6) &amp; 0x0000ff00));
<a name="l00452"></a>00452             *(linedp + jd + 1) = pixel;                          <span class="comment">/* pix 4 */</span>
<a name="l00453"></a>00453         }  
<a name="l00454"></a>00454             <span class="comment">/* last src pixel on line */</span>
<a name="l00455"></a>00455         rval1 = rval2;
<a name="l00456"></a>00456         gval1 = gval2;
<a name="l00457"></a>00457         bval1 = bval2;
<a name="l00458"></a>00458         rval3 = rval4;
<a name="l00459"></a>00459         gval3 = gval4;
<a name="l00460"></a>00460         bval3 = bval4;
<a name="l00461"></a>00461         pixel = (rval1 &lt;&lt; 24 | gval1 &lt;&lt; 16 | bval1 &lt;&lt; 8);
<a name="l00462"></a>00462         *(lined + 2 * wsm) = pixel;                        <span class="comment">/* pix 1 */</span>
<a name="l00463"></a>00463         *(lined + 2 * wsm + 1) = pixel;                    <span class="comment">/* pix 2 */</span>
<a name="l00464"></a>00464         pixel = ((((rval1 + rval3) &lt;&lt; 23) &amp; 0xff000000) |
<a name="l00465"></a>00465                  (((gval1 + gval3) &lt;&lt; 15) &amp; 0x00ff0000) |
<a name="l00466"></a>00466                  (((bval1 + bval3) &lt;&lt; 7) &amp; 0x0000ff00));
<a name="l00467"></a>00467         *(linedp + 2 * wsm) = pixel;                       <span class="comment">/* pix 3 */</span>
<a name="l00468"></a>00468         *(linedp + 2 * wsm + 1) = pixel;                   <span class="comment">/* pix 4 */</span>
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     <span class="keywordflow">else</span> {   <span class="comment">/* last row of src pixels: lastlineflag == 1 */</span>
<a name="l00471"></a>00471         linedp = lined + wpld;
<a name="l00472"></a>00472         pixels2 = *lines;
<a name="l00473"></a>00473         rval2 = pixels2 &gt;&gt; 24;
<a name="l00474"></a>00474         gval2 = (pixels2 &gt;&gt; 16) &amp; 0xff;
<a name="l00475"></a>00475         bval2 = (pixels2 &gt;&gt; 8) &amp; 0xff;
<a name="l00476"></a>00476         <span class="keywordflow">for</span> (j = 0, jd = 0; j &lt; wsm; j++, jd += 2) {
<a name="l00477"></a>00477             rval1 = rval2;
<a name="l00478"></a>00478             gval1 = gval2;
<a name="l00479"></a>00479             bval1 = bval2;
<a name="l00480"></a>00480             pixels2 = *(lines + j + 1);
<a name="l00481"></a>00481             rval2 = pixels2 &gt;&gt; 24;
<a name="l00482"></a>00482             gval2 = (pixels2 &gt;&gt; 16) &amp; 0xff;
<a name="l00483"></a>00483             bval2 = (pixels2 &gt;&gt; 8) &amp; 0xff;
<a name="l00484"></a>00484             pixel = (rval1 &lt;&lt; 24 | gval1 &lt;&lt; 16 | bval1 &lt;&lt; 8);
<a name="l00485"></a>00485             *(lined + jd) = pixel;                            <span class="comment">/* pix 1 */</span>
<a name="l00486"></a>00486             *(linedp + jd) = pixel;                           <span class="comment">/* pix 2 */</span>
<a name="l00487"></a>00487             pixel = ((((rval1 + rval2) &lt;&lt; 23) &amp; 0xff000000) |
<a name="l00488"></a>00488                      (((gval1 + gval2) &lt;&lt; 15) &amp; 0x00ff0000) |
<a name="l00489"></a>00489                      (((bval1 + bval2) &lt;&lt; 7) &amp; 0x0000ff00));
<a name="l00490"></a>00490             *(lined + jd + 1) = pixel;                        <span class="comment">/* pix 3 */</span>
<a name="l00491"></a>00491             *(linedp + jd + 1) = pixel;                       <span class="comment">/* pix 4 */</span>
<a name="l00492"></a>00492         }  
<a name="l00493"></a>00493         rval1 = rval2;
<a name="l00494"></a>00494         gval1 = gval2;
<a name="l00495"></a>00495         bval1 = bval2;
<a name="l00496"></a>00496         pixel = (rval1 &lt;&lt; 24 | gval1 &lt;&lt; 16 | bval1 &lt;&lt; 8);
<a name="l00497"></a>00497         *(lined + 2 * wsm) = pixel;                           <span class="comment">/* pix 1 */</span>
<a name="l00498"></a>00498         *(lined + 2 * wsm + 1) = pixel;                       <span class="comment">/* pix 2 */</span>
<a name="l00499"></a>00499         *(linedp + 2 * wsm) = pixel;                          <span class="comment">/* pix 3 */</span>
<a name="l00500"></a>00500         *(linedp + 2 * wsm + 1) = pixel;                      <span class="comment">/* pix 4 */</span>
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502         
<a name="l00503"></a>00503     <span class="keywordflow">return</span>;
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l00508"></a>00508 <span class="comment"> *                2x linear interpolated gray scaling               *</span>
<a name="l00509"></a>00509 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00510"></a>00510 <span class="comment">/*!</span>
<a name="l00511"></a>00511 <span class="comment"> *  scaleGray2xLILow()</span>
<a name="l00512"></a>00512 <span class="comment"> *</span>
<a name="l00513"></a>00513 <span class="comment"> *  This is a special case of 2x expansion by linear</span>
<a name="l00514"></a>00514 <span class="comment"> *  interpolation.  Each src pixel contains 4 dest pixels.</span>
<a name="l00515"></a>00515 <span class="comment"> *  The 4 dest pixels in src pixel 1 are numbered at</span>
<a name="l00516"></a>00516 <span class="comment"> *  their UL corners.  The 4 dest pixels in src pixel 1</span>
<a name="l00517"></a>00517 <span class="comment"> *  are related to that src pixel and its 3 neighboring</span>
<a name="l00518"></a>00518 <span class="comment"> *  src pixels as follows:</span>
<a name="l00519"></a>00519 <span class="comment"> *</span>
<a name="l00520"></a>00520 <span class="comment"> *             1-----2-----|-----|-----|</span>
<a name="l00521"></a>00521 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00522"></a>00522 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00523"></a>00523 <span class="comment"> *  src 1 --&gt;  3-----4-----|     |     |  &lt;-- src 2</span>
<a name="l00524"></a>00524 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00525"></a>00525 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00526"></a>00526 <span class="comment"> *             |-----|-----|-----|-----|</span>
<a name="l00527"></a>00527 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00528"></a>00528 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00529"></a>00529 <span class="comment"> *  src 3 --&gt;  |     |     |     |     |  &lt;-- src 4</span>
<a name="l00530"></a>00530 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00531"></a>00531 <span class="comment"> *             |     |     |     |     |</span>
<a name="l00532"></a>00532 <span class="comment"> *             |-----|-----|-----|-----|</span>
<a name="l00533"></a>00533 <span class="comment"> *</span>
<a name="l00534"></a>00534 <span class="comment"> *           dest      src</span>
<a name="l00535"></a>00535 <span class="comment"> *           ----      ---</span>
<a name="l00536"></a>00536 <span class="comment"> *           dp1    =  sp1</span>
<a name="l00537"></a>00537 <span class="comment"> *           dp2    =  (sp1 + sp2) / 2</span>
<a name="l00538"></a>00538 <span class="comment"> *           dp3    =  (sp1 + sp3) / 2</span>
<a name="l00539"></a>00539 <span class="comment"> *           dp4    =  (sp1 + sp2 + sp3 + sp4) / 4</span>
<a name="l00540"></a>00540 <span class="comment"> *</span>
<a name="l00541"></a>00541 <span class="comment"> *  We iterate over the src pixels, and unroll the calculation</span>
<a name="l00542"></a>00542 <span class="comment"> *  for each set of 4 dest pixels corresponding to that src</span>
<a name="l00543"></a>00543 <span class="comment"> *  pixel, caching pixels for the next src pixel whenever possible.</span>
<a name="l00544"></a>00544 <span class="comment"> */</span>
<a name="l00545"></a>00545 <span class="keywordtype">void</span>
<a name="l00546"></a><a class="code" href="scalelow_8c.html#af6998eedccb3c9a22d61b0eb78160b5e">00546</a> <a class="code" href="leptprotos_8h.html#a1286355f0eb32c182e665bc8f6b53c81">scaleGray2xLILow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l00547"></a>00547                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00548"></a>00548                  <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l00549"></a>00549                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00550"></a>00550                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l00551"></a>00551                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, hsm;
<a name="l00554"></a>00554 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     hsm = hs - 1;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         <span class="comment">/* We&#39;re taking 2 src and 2 dest lines at a time,</span>
<a name="l00559"></a>00559 <span class="comment">         * and for each src line, we&#39;re computing 2 dest lines.</span>
<a name="l00560"></a>00560 <span class="comment">         * Call these 2 dest lines:  destline1 and destline2.</span>
<a name="l00561"></a>00561 <span class="comment">         * The first src line is used for destline 1.</span>
<a name="l00562"></a>00562 <span class="comment">         * On all but the last src line, both src lines are </span>
<a name="l00563"></a>00563 <span class="comment">         * used in the linear interpolation for destline2.</span>
<a name="l00564"></a>00564 <span class="comment">         * On the last src line, both destline1 and destline2</span>
<a name="l00565"></a>00565 <span class="comment">         * are computed using only that src line (because there</span>
<a name="l00566"></a>00566 <span class="comment">         * isn&#39;t a lower src line). */</span>
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         <span class="comment">/* iterate over all but the last src line */</span>
<a name="l00569"></a>00569     <span class="keywordflow">for</span> (i = 0; i &lt; hsm; i++) {
<a name="l00570"></a>00570         lines = datas + i * wpls;
<a name="l00571"></a>00571         lined = datad + 2 * i * wpld;
<a name="l00572"></a>00572         <a class="code" href="leptprotos_8h.html#abbe84ec3f9bca2f06b08e418fefa7b96">scaleGray2xLILineLow</a>(lined, wpld, lines, ws, wpls, 0);
<a name="l00573"></a>00573     }
<a name="l00574"></a>00574     
<a name="l00575"></a>00575         <span class="comment">/* last src line */</span>
<a name="l00576"></a>00576     lines = datas + hsm * wpls;
<a name="l00577"></a>00577     lined = datad + 2 * hsm * wpld;
<a name="l00578"></a>00578     <a class="code" href="leptprotos_8h.html#abbe84ec3f9bca2f06b08e418fefa7b96">scaleGray2xLILineLow</a>(lined, wpld, lines, ws, wpls, 1);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="keywordflow">return</span>;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 <span class="comment"></span>
<a name="l00584"></a>00584 <span class="comment">/*!</span>
<a name="l00585"></a>00585 <span class="comment"> *  scaleGray2xLILineLow()</span>
<a name="l00586"></a>00586 <span class="comment"> *</span>
<a name="l00587"></a>00587 <span class="comment"> *      Input:  lined   (ptr to top destline, to be made from current src line)</span>
<a name="l00588"></a>00588 <span class="comment"> *              wpld</span>
<a name="l00589"></a>00589 <span class="comment"> *              lines   (ptr to current src line)</span>
<a name="l00590"></a>00590 <span class="comment"> *              ws</span>
<a name="l00591"></a>00591 <span class="comment"> *              wpls</span>
<a name="l00592"></a>00592 <span class="comment"> *              lastlineflag  (1 if last src line; 0 otherwise)</span>
<a name="l00593"></a>00593 <span class="comment"> *      Return: void</span>
<a name="l00594"></a>00594 <span class="comment"> */</span>
<a name="l00595"></a>00595 <span class="keywordtype">void</span>
<a name="l00596"></a><a class="code" href="scalelow_8c.html#adab25ff9c53dacbdac09c507ee7bbb4a">00596</a> <a class="code" href="leptprotos_8h.html#abbe84ec3f9bca2f06b08e418fefa7b96">scaleGray2xLILineLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lined,
<a name="l00597"></a>00597                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00598"></a>00598                      <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines,
<a name="l00599"></a>00599                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00600"></a>00600                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l00601"></a>00601                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    lastlineflag)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    j, jd, wsm, w;
<a name="l00604"></a>00604 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    sval1, sval2, sval3, sval4;
<a name="l00605"></a>00605 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *linesp, *linedp;
<a name="l00606"></a>00606 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   words, wordsp, wordd, worddp;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     wsm = ws - 1;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordflow">if</span> (lastlineflag == 0) {
<a name="l00611"></a>00611         linesp = lines + wpls;
<a name="l00612"></a>00612         linedp = lined + wpld;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614             <span class="comment">/* Unroll the loop 4x and work on full words */</span>
<a name="l00615"></a>00615         words = lines[0];
<a name="l00616"></a>00616         wordsp = linesp[0];
<a name="l00617"></a>00617         sval2 = (words &gt;&gt; 24) &amp; 0xff;
<a name="l00618"></a>00618         sval4 = (wordsp &gt;&gt; 24) &amp; 0xff;
<a name="l00619"></a>00619         <span class="keywordflow">for</span> (j = 0, jd = 0, w = 0; j + 3 &lt; wsm; j += 4, jd += 8, w++) {
<a name="l00620"></a>00620                 <span class="comment">/* At the top of the loop,</span>
<a name="l00621"></a>00621 <span class="comment">                 * words == lines[w], wordsp == linesp[w]</span>
<a name="l00622"></a>00622 <span class="comment">                 * and the top bytes of those have been loaded into</span>
<a name="l00623"></a>00623 <span class="comment">                 * sval2 and sval4. */</span>
<a name="l00624"></a>00624             sval1 = sval2;
<a name="l00625"></a>00625             sval2 = (words &gt;&gt; 16) &amp; 0xff;
<a name="l00626"></a>00626             sval3 = sval4;
<a name="l00627"></a>00627             sval4 = (wordsp &gt;&gt; 16) &amp; 0xff;
<a name="l00628"></a>00628             wordd = (sval1 &lt;&lt; 24) | (((sval1 + sval2) &gt;&gt; 1) &lt;&lt; 16);
<a name="l00629"></a>00629             worddp = (((sval1 + sval3) &gt;&gt; 1) &lt;&lt; 24) |
<a name="l00630"></a>00630                 (((sval1 + sval2 + sval3 + sval4) &gt;&gt; 2) &lt;&lt; 16);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632             sval1 = sval2;
<a name="l00633"></a>00633             sval2 = (words &gt;&gt; 8) &amp; 0xff;
<a name="l00634"></a>00634             sval3 = sval4;
<a name="l00635"></a>00635             sval4 = (wordsp &gt;&gt; 8) &amp; 0xff;
<a name="l00636"></a>00636             wordd |= (sval1 &lt;&lt; 8) | ((sval1 + sval2) &gt;&gt; 1);
<a name="l00637"></a>00637             worddp |= (((sval1 + sval3) &gt;&gt; 1) &lt;&lt; 8) |
<a name="l00638"></a>00638                 ((sval1 + sval2 + sval3 + sval4) &gt;&gt; 2);
<a name="l00639"></a>00639             lined[w * 2] = wordd;
<a name="l00640"></a>00640             linedp[w * 2] = worddp;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642             sval1 = sval2;
<a name="l00643"></a>00643             sval2 = words &amp; 0xff;
<a name="l00644"></a>00644             sval3 = sval4;
<a name="l00645"></a>00645             sval4 = wordsp &amp; 0xff;
<a name="l00646"></a>00646             wordd = (sval1 &lt;&lt; 24) |                              <span class="comment">/* pix 1 */</span>
<a name="l00647"></a>00647                 (((sval1 + sval2) &gt;&gt; 1) &lt;&lt; 16);                  <span class="comment">/* pix 2 */</span>
<a name="l00648"></a>00648             worddp = (((sval1 + sval3) &gt;&gt; 1) &lt;&lt; 24) |            <span class="comment">/* pix 3 */</span>
<a name="l00649"></a>00649                 (((sval1 + sval2 + sval3 + sval4) &gt;&gt; 2) &lt;&lt; 16);  <span class="comment">/* pix 4 */</span>
<a name="l00650"></a>00650 
<a name="l00651"></a>00651                 <span class="comment">/* Load the next word as we need its first byte */</span>
<a name="l00652"></a>00652             words = lines[w + 1];
<a name="l00653"></a>00653             wordsp = linesp[w + 1];
<a name="l00654"></a>00654             sval1 = sval2;
<a name="l00655"></a>00655             sval2 = (words &gt;&gt; 24) &amp; 0xff;
<a name="l00656"></a>00656             sval3 = sval4;
<a name="l00657"></a>00657             sval4 = (wordsp &gt;&gt; 24) &amp; 0xff;
<a name="l00658"></a>00658             wordd |= (sval1 &lt;&lt; 8) |                              <span class="comment">/* pix 1 */</span>
<a name="l00659"></a>00659                 ((sval1 + sval2) &gt;&gt; 1);                          <span class="comment">/* pix 2 */</span>
<a name="l00660"></a>00660             worddp |= (((sval1 + sval3) &gt;&gt; 1) &lt;&lt; 8) |            <span class="comment">/* pix 3 */</span>
<a name="l00661"></a>00661                 ((sval1 + sval2 + sval3 + sval4) &gt;&gt; 2);          <span class="comment">/* pix 4 */</span>
<a name="l00662"></a>00662             lined[w * 2 + 1] = wordd;
<a name="l00663"></a>00663             linedp[w * 2 + 1] = worddp;
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666             <span class="comment">/* Finish up the last word */</span>
<a name="l00667"></a>00667         <span class="keywordflow">for</span> (; j &lt; wsm; j++, jd += 2) {
<a name="l00668"></a>00668             sval1 = sval2;
<a name="l00669"></a>00669             sval3 = sval4;
<a name="l00670"></a>00670             sval2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, j + 1);
<a name="l00671"></a>00671             sval4 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(linesp, j + 1);
<a name="l00672"></a>00672             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd, sval1);                     <span class="comment">/* pix 1 */</span>
<a name="l00673"></a>00673             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 1, (sval1 + sval2) / 2);   <span class="comment">/* pix 2 */</span>
<a name="l00674"></a>00674             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, jd, (sval1 + sval3) / 2);      <span class="comment">/* pix 3 */</span>
<a name="l00675"></a>00675             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, jd + 1,
<a name="l00676"></a>00676                           (sval1 + sval2 + sval3 + sval4) / 4);  <span class="comment">/* pix 4 */</span>
<a name="l00677"></a>00677         }
<a name="l00678"></a>00678         sval1 = sval2;
<a name="l00679"></a>00679         sval3 = sval4;
<a name="l00680"></a>00680         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, 2 * wsm, sval1);                     <span class="comment">/* pix 1 */</span>
<a name="l00681"></a>00681         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, 2 * wsm + 1, sval1);                 <span class="comment">/* pix 2 */</span>
<a name="l00682"></a>00682         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, 2 * wsm, (sval1 + sval3) / 2);      <span class="comment">/* pix 3 */</span>
<a name="l00683"></a>00683         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, 2 * wsm + 1, (sval1 + sval3) / 2);  <span class="comment">/* pix 4 */</span>
<a name="l00684"></a>00684 
<a name="l00685"></a>00685 <span class="preprocessor">#if DEBUG_UNROLLING</span>
<a name="l00686"></a>00686 <span class="preprocessor"></span><span class="preprocessor">#define CHECK_BYTE(a, b, c) if (GET_DATA_BYTE(a, b) != c) {\</span>
<a name="l00687"></a>00687 <span class="preprocessor">     fprintf(stderr, &quot;Error: mismatch at %d, %d vs %d\n&quot;, \</span>
<a name="l00688"></a>00688 <span class="preprocessor">             j, GET_DATA_BYTE(a, b), c); }</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span>
<a name="l00690"></a>00690         sval2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, 0);
<a name="l00691"></a>00691         sval4 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(linesp, 0);
<a name="l00692"></a>00692         <span class="keywordflow">for</span> (j = 0, jd = 0; j &lt; wsm; j++, jd += 2) {
<a name="l00693"></a>00693             sval1 = sval2;
<a name="l00694"></a>00694             sval3 = sval4;
<a name="l00695"></a>00695             sval2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, j + 1);
<a name="l00696"></a>00696             sval4 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(linesp, j + 1);
<a name="l00697"></a>00697             CHECK_BYTE(lined, jd, sval1);                     <span class="comment">/* pix 1 */</span>
<a name="l00698"></a>00698             CHECK_BYTE(lined, jd + 1, (sval1 + sval2) / 2);   <span class="comment">/* pix 2 */</span>
<a name="l00699"></a>00699             CHECK_BYTE(linedp, jd, (sval1 + sval3) / 2);      <span class="comment">/* pix 3 */</span>
<a name="l00700"></a>00700             CHECK_BYTE(linedp, jd + 1,
<a name="l00701"></a>00701                           (sval1 + sval2 + sval3 + sval4) / 4);  <span class="comment">/* pix 4 */</span>
<a name="l00702"></a>00702         }
<a name="l00703"></a>00703         sval1 = sval2;
<a name="l00704"></a>00704         sval3 = sval4;
<a name="l00705"></a>00705         CHECK_BYTE(lined, 2 * wsm, sval1);                     <span class="comment">/* pix 1 */</span>
<a name="l00706"></a>00706         CHECK_BYTE(lined, 2 * wsm + 1, sval1);                 <span class="comment">/* pix 2 */</span>
<a name="l00707"></a>00707         CHECK_BYTE(linedp, 2 * wsm, (sval1 + sval3) / 2);      <span class="comment">/* pix 3 */</span>
<a name="l00708"></a>00708         CHECK_BYTE(linedp, 2 * wsm + 1, (sval1 + sval3) / 2);  <span class="comment">/* pix 4 */</span>
<a name="l00709"></a>00709 <span class="preprocessor">#undef CHECK_BYTE</span>
<a name="l00710"></a>00710 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>    }
<a name="l00712"></a>00712     <span class="keywordflow">else</span> {   <span class="comment">/* last row of src pixels: lastlineflag == 1 */</span>
<a name="l00713"></a>00713         linedp = lined + wpld;
<a name="l00714"></a>00714         sval2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, 0);
<a name="l00715"></a>00715         <span class="keywordflow">for</span> (j = 0, jd = 0; j &lt; wsm; j++, jd += 2) {
<a name="l00716"></a>00716             sval1 = sval2;
<a name="l00717"></a>00717             sval2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, j + 1);
<a name="l00718"></a>00718             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd, sval1);                       <span class="comment">/* pix 1 */</span>
<a name="l00719"></a>00719             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, jd, sval1);                      <span class="comment">/* pix 3 */</span>
<a name="l00720"></a>00720             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 1, (sval1 + sval2) / 2);     <span class="comment">/* pix 2 */</span>
<a name="l00721"></a>00721             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, jd + 1, (sval1 + sval2) / 2);    <span class="comment">/* pix 4 */</span>
<a name="l00722"></a>00722         }  
<a name="l00723"></a>00723         sval1 = sval2;
<a name="l00724"></a>00724         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, 2 * wsm, sval1);                     <span class="comment">/* pix 1 */</span>
<a name="l00725"></a>00725         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, 2 * wsm + 1, sval1);                 <span class="comment">/* pix 2 */</span>
<a name="l00726"></a>00726         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, 2 * wsm, sval1);                    <span class="comment">/* pix 3 */</span>
<a name="l00727"></a>00727         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp, 2 * wsm + 1, sval1);                <span class="comment">/* pix 4 */</span>
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729         
<a name="l00730"></a>00730     <span class="keywordflow">return</span>;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l00735"></a>00735 <span class="comment"> *               4x linear interpolated gray scaling                *</span>
<a name="l00736"></a>00736 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00737"></a>00737 <span class="comment">/*!</span>
<a name="l00738"></a>00738 <span class="comment"> *  scaleGray4xLILow()</span>
<a name="l00739"></a>00739 <span class="comment"> *</span>
<a name="l00740"></a>00740 <span class="comment"> *  This is a special case of 4x expansion by linear</span>
<a name="l00741"></a>00741 <span class="comment"> *  interpolation.  Each src pixel contains 16 dest pixels.</span>
<a name="l00742"></a>00742 <span class="comment"> *  The 16 dest pixels in src pixel 1 are numbered at</span>
<a name="l00743"></a>00743 <span class="comment"> *  their UL corners.  The 16 dest pixels in src pixel 1</span>
<a name="l00744"></a>00744 <span class="comment"> *  are related to that src pixel and its 3 neighboring</span>
<a name="l00745"></a>00745 <span class="comment"> *  src pixels as follows:</span>
<a name="l00746"></a>00746 <span class="comment"> *</span>
<a name="l00747"></a>00747 <span class="comment"> *             1---2---3---4---|---|---|---|---|</span>
<a name="l00748"></a>00748 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00749"></a>00749 <span class="comment"> *             5---6---7---8---|---|---|---|---|</span>
<a name="l00750"></a>00750 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00751"></a>00751 <span class="comment"> *  src 1 --&gt;  9---a---b---c---|---|---|---|---|  &lt;-- src 2</span>
<a name="l00752"></a>00752 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00753"></a>00753 <span class="comment"> *             d---e---f---g---|---|---|---|---|</span>
<a name="l00754"></a>00754 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00755"></a>00755 <span class="comment"> *             |===|===|===|===|===|===|===|===|</span>
<a name="l00756"></a>00756 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00757"></a>00757 <span class="comment"> *             |---|---|---|---|---|---|---|---|</span>
<a name="l00758"></a>00758 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00759"></a>00759 <span class="comment"> *  src 3 --&gt;  |---|---|---|---|---|---|---|---|  &lt;-- src 4</span>
<a name="l00760"></a>00760 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00761"></a>00761 <span class="comment"> *             |---|---|---|---|---|---|---|---|</span>
<a name="l00762"></a>00762 <span class="comment"> *             |   |   |   |   |   |   |   |   |</span>
<a name="l00763"></a>00763 <span class="comment"> *             |---|---|---|---|---|---|---|---|</span>
<a name="l00764"></a>00764 <span class="comment"> *</span>
<a name="l00765"></a>00765 <span class="comment"> *           dest      src</span>
<a name="l00766"></a>00766 <span class="comment"> *           ----      ---</span>
<a name="l00767"></a>00767 <span class="comment"> *           dp1    =  sp1</span>
<a name="l00768"></a>00768 <span class="comment"> *           dp2    =  (3 * sp1 + sp2) / 4</span>
<a name="l00769"></a>00769 <span class="comment"> *           dp3    =  (sp1 + sp2) / 2</span>
<a name="l00770"></a>00770 <span class="comment"> *           dp4    =  (sp1 + 3 * sp2) / 4</span>
<a name="l00771"></a>00771 <span class="comment"> *           dp5    =  (3 * sp1 + sp3) / 4</span>
<a name="l00772"></a>00772 <span class="comment"> *           dp6    =  (9 * sp1 + 3 * sp2 + 3 * sp3 + sp4) / 16 </span>
<a name="l00773"></a>00773 <span class="comment"> *           dp7    =  (3 * sp1 + 3 * sp2 + sp3 + sp4) / 8</span>
<a name="l00774"></a>00774 <span class="comment"> *           dp8    =  (3 * sp1 + 9 * sp2 + 1 * sp3 + 3 * sp4) / 16 </span>
<a name="l00775"></a>00775 <span class="comment"> *           dp9    =  (sp1 + sp3) / 2</span>
<a name="l00776"></a>00776 <span class="comment"> *           dp10   =  (3 * sp1 + sp2 + 3 * sp3 + sp4) / 8</span>
<a name="l00777"></a>00777 <span class="comment"> *           dp11   =  (sp1 + sp2 + sp3 + sp4) / 4 </span>
<a name="l00778"></a>00778 <span class="comment"> *           dp12   =  (sp1 + 3 * sp2 + sp3 + 3 * sp4) / 8</span>
<a name="l00779"></a>00779 <span class="comment"> *           dp13   =  (sp1 + 3 * sp3) / 4</span>
<a name="l00780"></a>00780 <span class="comment"> *           dp14   =  (3 * sp1 + sp2 + 9 * sp3 + 3 * sp4) / 16 </span>
<a name="l00781"></a>00781 <span class="comment"> *           dp15   =  (sp1 + sp2 + 3 * sp3 + 3 * sp4) / 8</span>
<a name="l00782"></a>00782 <span class="comment"> *           dp16   =  (sp1 + 3 * sp2 + 3 * sp3 + 9 * sp4) / 16 </span>
<a name="l00783"></a>00783 <span class="comment"> *</span>
<a name="l00784"></a>00784 <span class="comment"> *  We iterate over the src pixels, and unroll the calculation</span>
<a name="l00785"></a>00785 <span class="comment"> *  for each set of 16 dest pixels corresponding to that src</span>
<a name="l00786"></a>00786 <span class="comment"> *  pixel, caching pixels for the next src pixel whenever possible.</span>
<a name="l00787"></a>00787 <span class="comment"> */</span>
<a name="l00788"></a>00788 <span class="keywordtype">void</span>
<a name="l00789"></a><a class="code" href="scalelow_8c.html#a3889645bd8f498bd51d67a00daf09d7a">00789</a> <a class="code" href="leptprotos_8h.html#a8b060cb263b3c5d95821273103dd5f21">scaleGray4xLILow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l00790"></a>00790                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00791"></a>00791                  <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l00792"></a>00792                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00793"></a>00793                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l00794"></a>00794                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l00795"></a>00795 {
<a name="l00796"></a>00796 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, hsm;
<a name="l00797"></a>00797 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     hsm = hs - 1;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         <span class="comment">/* We&#39;re taking 2 src and 4 dest lines at a time,</span>
<a name="l00802"></a>00802 <span class="comment">         * and for each src line, we&#39;re computing 4 dest lines.</span>
<a name="l00803"></a>00803 <span class="comment">         * Call these 4 dest lines:  destline1 - destline4.</span>
<a name="l00804"></a>00804 <span class="comment">         * The first src line is used for destline 1.</span>
<a name="l00805"></a>00805 <span class="comment">         * Two src lines are used for all other dest lines,</span>
<a name="l00806"></a>00806 <span class="comment">         * except for the last 4 dest lines, which are computed</span>
<a name="l00807"></a>00807 <span class="comment">         * using only the last src line. */</span>
<a name="l00808"></a>00808 
<a name="l00809"></a>00809         <span class="comment">/* iterate over all but the last src line */</span>
<a name="l00810"></a>00810     <span class="keywordflow">for</span> (i = 0; i &lt; hsm; i++) {
<a name="l00811"></a>00811         lines = datas + i * wpls;
<a name="l00812"></a>00812         lined = datad + 4 * i * wpld;
<a name="l00813"></a>00813         <a class="code" href="leptprotos_8h.html#af7ee25ab247b0604dd4623ba75675af9">scaleGray4xLILineLow</a>(lined, wpld, lines, ws, wpls, 0);
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     
<a name="l00816"></a>00816         <span class="comment">/* last src line */</span>
<a name="l00817"></a>00817     lines = datas + hsm * wpls;
<a name="l00818"></a>00818     lined = datad + 4 * hsm * wpld;
<a name="l00819"></a>00819     <a class="code" href="leptprotos_8h.html#af7ee25ab247b0604dd4623ba75675af9">scaleGray4xLILineLow</a>(lined, wpld, lines, ws, wpls, 1);
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     <span class="keywordflow">return</span>;
<a name="l00822"></a>00822 }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="comment"></span>
<a name="l00825"></a>00825 <span class="comment">/*!</span>
<a name="l00826"></a>00826 <span class="comment"> *  scaleGray4xLILineLow()</span>
<a name="l00827"></a>00827 <span class="comment"> *</span>
<a name="l00828"></a>00828 <span class="comment"> *      Input:  lined   (ptr to top destline, to be made from current src line)</span>
<a name="l00829"></a>00829 <span class="comment"> *              wpld</span>
<a name="l00830"></a>00830 <span class="comment"> *              lines   (ptr to current src line)</span>
<a name="l00831"></a>00831 <span class="comment"> *              ws</span>
<a name="l00832"></a>00832 <span class="comment"> *              wpls</span>
<a name="l00833"></a>00833 <span class="comment"> *              lastlineflag  (1 if last src line; 0 otherwise)</span>
<a name="l00834"></a>00834 <span class="comment"> *      Return: void</span>
<a name="l00835"></a>00835 <span class="comment"> */</span>
<a name="l00836"></a>00836 <span class="keywordtype">void</span>
<a name="l00837"></a><a class="code" href="scalelow_8c.html#a46296d89e124f7b1fe41b50bd5ea8be7">00837</a> <a class="code" href="leptprotos_8h.html#af7ee25ab247b0604dd4623ba75675af9">scaleGray4xLILineLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lined,
<a name="l00838"></a>00838                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00839"></a>00839                      <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines,
<a name="l00840"></a>00840                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00841"></a>00841                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l00842"></a>00842                      <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    lastlineflag)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    j, jd, wsm, wsm4;
<a name="l00845"></a>00845 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    s1, s2, s3, s4, s1t, s2t, s3t, s4t;
<a name="l00846"></a>00846 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *linesp, *linedp1, *linedp2, *linedp3;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     wsm = ws - 1;
<a name="l00849"></a>00849     wsm4 = 4 * wsm;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (lastlineflag == 0) {
<a name="l00852"></a>00852         linesp = lines + wpls;
<a name="l00853"></a>00853         linedp1 = lined + wpld;
<a name="l00854"></a>00854         linedp2 = lined + 2 * wpld;
<a name="l00855"></a>00855         linedp3 = lined + 3 * wpld;
<a name="l00856"></a>00856         s2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, 0);
<a name="l00857"></a>00857         s4 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(linesp, 0);
<a name="l00858"></a>00858         <span class="keywordflow">for</span> (j = 0, jd = 0; j &lt; wsm; j++, jd += 4) {
<a name="l00859"></a>00859             s1 = s2;
<a name="l00860"></a>00860             s3 = s4;
<a name="l00861"></a>00861             s2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, j + 1);
<a name="l00862"></a>00862             s4 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(linesp, j + 1);
<a name="l00863"></a>00863             s1t = 3 * s1;
<a name="l00864"></a>00864             s2t = 3 * s2;
<a name="l00865"></a>00865             s3t = 3 * s3;
<a name="l00866"></a>00866             s4t = 3 * s4;
<a name="l00867"></a>00867             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd, s1);                             <span class="comment">/* d1 */</span>
<a name="l00868"></a>00868             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 1, (s1t + s2) / 4);             <span class="comment">/* d2 */</span>
<a name="l00869"></a>00869             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 2, (s1 + s2) / 2);              <span class="comment">/* d3 */</span>
<a name="l00870"></a>00870             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 3, (s1 + s2t) / 4);             <span class="comment">/* d4 */</span>
<a name="l00871"></a>00871             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd, (s1t + s3) / 4);                <span class="comment">/* d5 */</span>
<a name="l00872"></a>00872             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd + 1, (9*s1 + s2t + s3t + s4) / 16); <span class="comment">/*d6*/</span>
<a name="l00873"></a>00873             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd + 2, (s1t + s2t + s3 + s4) / 8); <span class="comment">/* d7 */</span>
<a name="l00874"></a>00874             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd + 3, (s1t + 9*s2 + s3 + s4t) / 16);<span class="comment">/*d8*/</span>
<a name="l00875"></a>00875             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd, (s1 + s3) / 2);                <span class="comment">/* d9 */</span>
<a name="l00876"></a>00876             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd + 1, (s1t + s2 + s3t + s4) / 8);<span class="comment">/* d10 */</span>
<a name="l00877"></a>00877             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd + 2, (s1 + s2 + s3 + s4) / 4);  <span class="comment">/* d11 */</span>
<a name="l00878"></a>00878             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd + 3, (s1 + s2t + s3 + s4t) / 8);<span class="comment">/* d12 */</span>
<a name="l00879"></a>00879             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd, (s1 + s3t) / 4);               <span class="comment">/* d13 */</span>
<a name="l00880"></a>00880             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd + 1, (s1t + s2 + 9*s3 + s4t) / 16);<span class="comment">/*d14*/</span>
<a name="l00881"></a>00881             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd + 2, (s1 + s2 + s3t + s4t) / 8); <span class="comment">/* d15 */</span>
<a name="l00882"></a>00882             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd + 3, (s1 + s2t + s3t + 9*s4) / 16);<span class="comment">/*d16*/</span>
<a name="l00883"></a>00883         }  
<a name="l00884"></a>00884         s1 = s2;
<a name="l00885"></a>00885         s3 = s4;
<a name="l00886"></a>00886         s1t = 3 * s1;
<a name="l00887"></a>00887         s3t = 3 * s3;
<a name="l00888"></a>00888         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4, s1);                               <span class="comment">/* d1 */</span>
<a name="l00889"></a>00889         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4 + 1, s1);                           <span class="comment">/* d2 */</span>
<a name="l00890"></a>00890         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4 + 2, s1);                           <span class="comment">/* d3 */</span>
<a name="l00891"></a>00891         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4 + 3, s1);                           <span class="comment">/* d4 */</span>
<a name="l00892"></a>00892         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4, (s1t + s3) / 4);                 <span class="comment">/* d5 */</span>
<a name="l00893"></a>00893         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4 + 1, (s1t + s3) / 4);             <span class="comment">/* d6 */</span>
<a name="l00894"></a>00894         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4 + 2, (s1t + s3) / 4);             <span class="comment">/* d7 */</span>
<a name="l00895"></a>00895         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4 + 3, (s1t + s3) / 4);             <span class="comment">/* d8 */</span>
<a name="l00896"></a>00896         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4, (s1 + s3) / 2);                  <span class="comment">/* d9 */</span>
<a name="l00897"></a>00897         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4 + 1, (s1 + s3) / 2);              <span class="comment">/* d10 */</span>
<a name="l00898"></a>00898         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4 + 2, (s1 + s3) / 2);              <span class="comment">/* d11 */</span>
<a name="l00899"></a>00899         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4 + 3, (s1 + s3) / 2);              <span class="comment">/* d12 */</span>
<a name="l00900"></a>00900         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4, (s1 + s3t) / 4);                 <span class="comment">/* d13 */</span>
<a name="l00901"></a>00901         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4 + 1, (s1 + s3t) / 4);             <span class="comment">/* d14 */</span>
<a name="l00902"></a>00902         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4 + 2, (s1 + s3t) / 4);             <span class="comment">/* d15 */</span>
<a name="l00903"></a>00903         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4 + 3, (s1 + s3t) / 4);             <span class="comment">/* d16 */</span>
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905     <span class="keywordflow">else</span> {   <span class="comment">/* last row of src pixels: lastlineflag == 1 */</span>
<a name="l00906"></a>00906         linedp1 = lined + wpld;
<a name="l00907"></a>00907         linedp2 = lined + 2 * wpld;
<a name="l00908"></a>00908         linedp3 = lined + 3 * wpld;
<a name="l00909"></a>00909         s2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, 0);
<a name="l00910"></a>00910         <span class="keywordflow">for</span> (j = 0, jd = 0; j &lt; wsm; j++, jd += 4) {
<a name="l00911"></a>00911             s1 = s2;
<a name="l00912"></a>00912             s2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, j + 1);
<a name="l00913"></a>00913             s1t = 3 * s1;
<a name="l00914"></a>00914             s2t = 3 * s2;
<a name="l00915"></a>00915             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd, s1);                            <span class="comment">/* d1 */</span>
<a name="l00916"></a>00916             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 1, (s1t + s2) / 4 );           <span class="comment">/* d2 */</span>
<a name="l00917"></a>00917             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 2, (s1 + s2) / 2 );            <span class="comment">/* d3 */</span>
<a name="l00918"></a>00918             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, jd + 3, (s1 + s2t) / 4 );           <span class="comment">/* d4 */</span>
<a name="l00919"></a>00919             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd, s1);                          <span class="comment">/* d5 */</span>
<a name="l00920"></a>00920             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd + 1, (s1t + s2) / 4 );         <span class="comment">/* d6 */</span>
<a name="l00921"></a>00921             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd + 2, (s1 + s2) / 2 );          <span class="comment">/* d7 */</span>
<a name="l00922"></a>00922             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, jd + 3, (s1 + s2t) / 4 );         <span class="comment">/* d8 */</span>
<a name="l00923"></a>00923             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd, s1);                          <span class="comment">/* d9 */</span>
<a name="l00924"></a>00924             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd + 1, (s1t + s2) / 4 );         <span class="comment">/* d10 */</span>
<a name="l00925"></a>00925             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd + 2, (s1 + s2) / 2 );          <span class="comment">/* d11 */</span>
<a name="l00926"></a>00926             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, jd + 3, (s1 + s2t) / 4 );         <span class="comment">/* d12 */</span>
<a name="l00927"></a>00927             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd, s1);                          <span class="comment">/* d13 */</span>
<a name="l00928"></a>00928             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd + 1, (s1t + s2) / 4 );         <span class="comment">/* d14 */</span>
<a name="l00929"></a>00929             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd + 2, (s1 + s2) / 2 );          <span class="comment">/* d15 */</span>
<a name="l00930"></a>00930             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, jd + 3, (s1 + s2t) / 4 );         <span class="comment">/* d16 */</span>
<a name="l00931"></a>00931         }  
<a name="l00932"></a>00932         s1 = s2;
<a name="l00933"></a>00933         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4, s1);                              <span class="comment">/* d1 */</span>
<a name="l00934"></a>00934         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4 + 1, s1);                          <span class="comment">/* d2 */</span>
<a name="l00935"></a>00935         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4 + 2, s1);                          <span class="comment">/* d3 */</span>
<a name="l00936"></a>00936         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, wsm4 + 3, s1);                          <span class="comment">/* d4 */</span>
<a name="l00937"></a>00937         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4, s1);                            <span class="comment">/* d5 */</span>
<a name="l00938"></a>00938         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4 + 1, s1);                        <span class="comment">/* d6 */</span>
<a name="l00939"></a>00939         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4 + 2, s1);                        <span class="comment">/* d7 */</span>
<a name="l00940"></a>00940         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp1, wsm4 + 3, s1);                        <span class="comment">/* d8 */</span>
<a name="l00941"></a>00941         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4, s1);                            <span class="comment">/* d9 */</span>
<a name="l00942"></a>00942         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4 + 1, s1);                        <span class="comment">/* d10 */</span>
<a name="l00943"></a>00943         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4 + 2, s1);                        <span class="comment">/* d11 */</span>
<a name="l00944"></a>00944         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp2, wsm4 + 3, s1);                        <span class="comment">/* d12 */</span>
<a name="l00945"></a>00945         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4, s1);                            <span class="comment">/* d13 */</span>
<a name="l00946"></a>00946         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4 + 1, s1);                        <span class="comment">/* d14 */</span>
<a name="l00947"></a>00947         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4 + 2, s1);                        <span class="comment">/* d15 */</span>
<a name="l00948"></a>00948         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(linedp3, wsm4 + 3, s1);                        <span class="comment">/* d16 */</span>
<a name="l00949"></a>00949     }
<a name="l00950"></a>00950         
<a name="l00951"></a>00951     <span class="keywordflow">return</span>;
<a name="l00952"></a>00952 }
<a name="l00953"></a>00953 
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l00956"></a>00956 <span class="comment"> *       Grayscale and color scaling by closest pixel sampling      *</span>
<a name="l00957"></a>00957 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00958"></a>00958 <span class="comment">/*!</span>
<a name="l00959"></a>00959 <span class="comment"> *  scaleBySamplingLow()</span>
<a name="l00960"></a>00960 <span class="comment"> *</span>
<a name="l00961"></a>00961 <span class="comment"> *  Notes:</span>
<a name="l00962"></a>00962 <span class="comment"> *      (1) The dest must be cleared prior to this operation,</span>
<a name="l00963"></a>00963 <span class="comment"> *          and we clear it here in the low-level code.</span>
<a name="l00964"></a>00964 <span class="comment"> *      (2) We reuse dest pixels and dest pixel rows whenever</span>
<a name="l00965"></a>00965 <span class="comment"> *          possible.  This speeds the upscaling; downscaling</span>
<a name="l00966"></a>00966 <span class="comment"> *          is done by strict subsampling and is unaffected.</span>
<a name="l00967"></a>00967 <span class="comment"> *      (3) Because we are sampling and not interpolating, this</span>
<a name="l00968"></a>00968 <span class="comment"> *          routine works directly, without conversion to full</span>
<a name="l00969"></a>00969 <span class="comment"> *          RGB color, for 2, 4 or 8 bpp palette color images.</span>
<a name="l00970"></a>00970 <span class="comment"> */</span>
<a name="l00971"></a>00971 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l00972"></a><a class="code" href="scalelow_8c.html#abb71fc5353989682c2f402411b87b5b7">00972</a> <a class="code" href="leptprotos_8h.html#adba9a7021cc14c6f4fee2c0def3533eb">scaleBySamplingLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l00973"></a>00973                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l00974"></a>00974                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l00975"></a>00975                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l00976"></a>00976                    <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l00977"></a>00977                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l00978"></a>00978                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l00979"></a>00979                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    d,
<a name="l00980"></a>00980                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l00981"></a>00981 {
<a name="l00982"></a>00982 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, bpld;
<a name="l00983"></a>00983 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xs, prevxs, sval;
<a name="l00984"></a>00984 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *srow, *scol;
<a name="l00985"></a>00985 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   csval;
<a name="l00986"></a>00986 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *prevlines, *lined, *prevlined;
<a name="l00987"></a>00987 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  wratio, hratio;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;scaleBySamplingLow&quot;</span>);
<a name="l00990"></a>00990 
<a name="l00991"></a>00991         <span class="comment">/* clear dest */</span>
<a name="l00992"></a>00992     bpld = 4 * wpld;
<a name="l00993"></a>00993     memset((<span class="keywordtype">char</span> *)datad, 0, hd * bpld);
<a name="l00994"></a>00994     
<a name="l00995"></a>00995         <span class="comment">/* the source row corresponding to dest row i ==&gt; srow[i]</span>
<a name="l00996"></a>00996 <span class="comment">         * the source col corresponding to dest col j ==&gt; scol[j]  */</span>
<a name="l00997"></a>00997     <span class="keywordflow">if</span> ((srow = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(hd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00998"></a>00998         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;srow not made&quot;</span>, procName, 1);
<a name="l00999"></a>00999     <span class="keywordflow">if</span> ((scol = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(wd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01000"></a>01000         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;scol not made&quot;</span>, procName, 1);
<a name="l01001"></a>01001 
<a name="l01002"></a>01002     wratio = (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)ws / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)wd;
<a name="l01003"></a>01003     hratio = (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hs / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hd;
<a name="l01004"></a>01004     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++)
<a name="l01005"></a>01005         srow[i] = <a class="code" href="environ_8h.html#a67d588ee5ca71be19990efb07fa2ce72">L_MIN</a>((<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(hratio * i + 0.5), hs - 1);
<a name="l01006"></a>01006     <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++)
<a name="l01007"></a>01007         scol[j] = <a class="code" href="environ_8h.html#a67d588ee5ca71be19990efb07fa2ce72">L_MIN</a>((<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(wratio * j + 0.5), ws - 1);
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     prevlines = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01010"></a>01010     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01011"></a>01011         lines = datas + srow[i] * wpls;
<a name="l01012"></a>01012         lined = datad + i * wpld;
<a name="l01013"></a>01013         <span class="keywordflow">if</span> (lines != prevlines) {  <span class="comment">/* make dest from new source row */</span>
<a name="l01014"></a>01014             prevxs = -1;
<a name="l01015"></a>01015             sval = 0;
<a name="l01016"></a>01016             csval = 0;
<a name="l01017"></a>01017             <span class="keywordflow">switch</span> (d)
<a name="l01018"></a>01018             {
<a name="l01019"></a>01019             <span class="keywordflow">case</span> 2:
<a name="l01020"></a>01020                 <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01021"></a>01021                     xs = scol[j];
<a name="l01022"></a>01022                     <span class="keywordflow">if</span> (xs != prevxs) {  <span class="comment">/* get dest pix from source col */</span>
<a name="l01023"></a>01023                         sval = <a class="code" href="arrayaccess_8h.html#aa37f0d0f3189d384fb554b9d10fb1498">GET_DATA_DIBIT</a>(lines, xs);
<a name="l01024"></a>01024                         <a class="code" href="arrayaccess_8h.html#a450d6cf54e23dbca3270b5b4024b3450">SET_DATA_DIBIT</a>(lined, j, sval);
<a name="l01025"></a>01025                         prevxs = xs;
<a name="l01026"></a>01026                     }
<a name="l01027"></a>01027                     <span class="keywordflow">else</span>   <span class="comment">/* copy prev dest pix */</span>
<a name="l01028"></a>01028                         <a class="code" href="arrayaccess_8h.html#a450d6cf54e23dbca3270b5b4024b3450">SET_DATA_DIBIT</a>(lined, j, sval);
<a name="l01029"></a>01029                 }
<a name="l01030"></a>01030                 <span class="keywordflow">break</span>;
<a name="l01031"></a>01031             <span class="keywordflow">case</span> 4:
<a name="l01032"></a>01032                 <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01033"></a>01033                     xs = scol[j];
<a name="l01034"></a>01034                     <span class="keywordflow">if</span> (xs != prevxs) {  <span class="comment">/* get dest pix from source col */</span>
<a name="l01035"></a>01035                         sval = <a class="code" href="arrayaccess_8h.html#a0d694a93f7177f411859ccc24e4f92b8">GET_DATA_QBIT</a>(lines, xs);
<a name="l01036"></a>01036                         <a class="code" href="arrayaccess_8h.html#acce658a630554a51891ad7c8d45f7173">SET_DATA_QBIT</a>(lined, j, sval);
<a name="l01037"></a>01037                         prevxs = xs;
<a name="l01038"></a>01038                     }
<a name="l01039"></a>01039                     <span class="keywordflow">else</span>   <span class="comment">/* copy prev dest pix */</span>
<a name="l01040"></a>01040                         <a class="code" href="arrayaccess_8h.html#acce658a630554a51891ad7c8d45f7173">SET_DATA_QBIT</a>(lined, j, sval);
<a name="l01041"></a>01041                 }
<a name="l01042"></a>01042                 <span class="keywordflow">break</span>;
<a name="l01043"></a>01043             <span class="keywordflow">case</span> 8:
<a name="l01044"></a>01044                 <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01045"></a>01045                     xs = scol[j];
<a name="l01046"></a>01046                     <span class="keywordflow">if</span> (xs != prevxs) {  <span class="comment">/* get dest pix from source col */</span>
<a name="l01047"></a>01047                         sval = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xs);
<a name="l01048"></a>01048                         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, sval);
<a name="l01049"></a>01049                         prevxs = xs;
<a name="l01050"></a>01050                     }
<a name="l01051"></a>01051                     <span class="keywordflow">else</span>   <span class="comment">/* copy prev dest pix */</span>
<a name="l01052"></a>01052                         <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, sval);
<a name="l01053"></a>01053                 }
<a name="l01054"></a>01054                 <span class="keywordflow">break</span>;
<a name="l01055"></a>01055             <span class="keywordflow">case</span> 16:
<a name="l01056"></a>01056                 <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01057"></a>01057                     xs = scol[j];
<a name="l01058"></a>01058                     <span class="keywordflow">if</span> (xs != prevxs) {  <span class="comment">/* get dest pix from source col */</span>
<a name="l01059"></a>01059                         sval = <a class="code" href="arrayaccess_8h.html#a123c239e0f125d8afe9abacc11009e2b">GET_DATA_TWO_BYTES</a>(lines, xs);
<a name="l01060"></a>01060                         <a class="code" href="arrayaccess_8h.html#a69c67ec12d46eee91e6d94ee8077f281">SET_DATA_TWO_BYTES</a>(lined, j, sval);
<a name="l01061"></a>01061                         prevxs = xs;
<a name="l01062"></a>01062                     }
<a name="l01063"></a>01063                     <span class="keywordflow">else</span>   <span class="comment">/* copy prev dest pix */</span>
<a name="l01064"></a>01064                         <a class="code" href="arrayaccess_8h.html#a69c67ec12d46eee91e6d94ee8077f281">SET_DATA_TWO_BYTES</a>(lined, j, sval);
<a name="l01065"></a>01065                 }
<a name="l01066"></a>01066                 <span class="keywordflow">break</span>;
<a name="l01067"></a>01067             <span class="keywordflow">case</span> 32:
<a name="l01068"></a>01068                 <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01069"></a>01069                     xs = scol[j];
<a name="l01070"></a>01070                     <span class="keywordflow">if</span> (xs != prevxs) {  <span class="comment">/* get dest pix from source col */</span>
<a name="l01071"></a>01071                         csval = lines[xs];
<a name="l01072"></a>01072                         lined[j] = csval;
<a name="l01073"></a>01073                         prevxs = xs;
<a name="l01074"></a>01074                     }
<a name="l01075"></a>01075                     <span class="keywordflow">else</span>   <span class="comment">/* copy prev dest pix */</span>
<a name="l01076"></a>01076                         lined[j] = csval;
<a name="l01077"></a>01077                 }
<a name="l01078"></a>01078                 <span class="keywordflow">break</span>;
<a name="l01079"></a>01079             <span class="keywordflow">default</span>:
<a name="l01080"></a>01080                 <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;pixel depth not supported&quot;</span>, procName, 1);
<a name="l01081"></a>01081                 <span class="keywordflow">break</span>;
<a name="l01082"></a>01082             }
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084         <span class="keywordflow">else</span> {  <span class="comment">/* lines == prevlines; copy prev dest row */</span>
<a name="l01085"></a>01085             prevlined = lined - wpld;
<a name="l01086"></a>01086             memcpy((<span class="keywordtype">char</span> *)lined, (<span class="keywordtype">char</span> *)prevlined, bpld);
<a name="l01087"></a>01087         }
<a name="l01088"></a>01088         prevlines = lines;
<a name="l01089"></a>01089     }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(srow);
<a name="l01092"></a>01092     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(scol);
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     <span class="keywordflow">return</span> 0;
<a name="l01095"></a>01095 }
<a name="l01096"></a>01096 
<a name="l01097"></a>01097 
<a name="l01098"></a>01098 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l01099"></a>01099 <span class="comment"> *    Color and grayscale downsampling with (antialias) smoothing   *</span>
<a name="l01100"></a>01100 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01101"></a>01101 <span class="comment">/*!</span>
<a name="l01102"></a>01102 <span class="comment"> *  scaleSmoothLow()</span>
<a name="l01103"></a>01103 <span class="comment"> *</span>
<a name="l01104"></a>01104 <span class="comment"> *  Notes:</span>
<a name="l01105"></a>01105 <span class="comment"> *      (1) This function is called on 8 or 32 bpp src and dest images.</span>
<a name="l01106"></a>01106 <span class="comment"> *      (2) size is the full width of the lowpass smoothing filter.</span>
<a name="l01107"></a>01107 <span class="comment"> *          It is correlated with the reduction ratio, being the</span>
<a name="l01108"></a>01108 <span class="comment"> *          nearest integer such that size is approximately equal to hs / hd.</span>
<a name="l01109"></a>01109 <span class="comment"> */</span>
<a name="l01110"></a>01110 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l01111"></a><a class="code" href="scalelow_8c.html#a8de556e6c89d909ccae3cf6f32dc1ff0">01111</a> <a class="code" href="leptprotos_8h.html#a4f6f216c0b434f44dc767505b129a296">scaleSmoothLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01112"></a>01112                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01113"></a>01113                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01114"></a>01114                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01115"></a>01115                <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01116"></a>01116                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l01117"></a>01117                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l01118"></a>01118                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    d,
<a name="l01119"></a>01119                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l01120"></a>01120                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>)
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, m, n, xstart;
<a name="l01123"></a>01123 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    val, rval, gval, bval;
<a name="l01124"></a>01124 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *srow, *scol;
<a name="l01125"></a>01125 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined, *line, *ppixel;
<a name="l01126"></a>01126 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   pixel;
<a name="l01127"></a>01127 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  wratio, hratio, norm;
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;scaleSmoothLow&quot;</span>);
<a name="l01130"></a>01130 
<a name="l01131"></a>01131         <span class="comment">/* Clear dest */</span>
<a name="l01132"></a>01132     memset((<span class="keywordtype">char</span> *)datad, 0, 4 * wpld * hd);
<a name="l01133"></a>01133     
<a name="l01134"></a>01134         <span class="comment">/* Each dest pixel at (j,i) is computed as the average</span>
<a name="l01135"></a>01135 <span class="comment">           of size^2 corresponding src pixels.</span>
<a name="l01136"></a>01136 <span class="comment">           We store the UL corner location of the square of</span>
<a name="l01137"></a>01137 <span class="comment">           src pixels that correspond to dest pixel (j,i).</span>
<a name="l01138"></a>01138 <span class="comment">           The are labelled by the arrays srow[i] and scol[j]. */</span>
<a name="l01139"></a>01139     <span class="keywordflow">if</span> ((srow = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(hd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01140"></a>01140         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;srow not made&quot;</span>, procName, 1);
<a name="l01141"></a>01141     <span class="keywordflow">if</span> ((scol = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(wd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01142"></a>01142         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;scol not made&quot;</span>, procName, 1);
<a name="l01143"></a>01143 
<a name="l01144"></a>01144     norm = 1. / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)(size * size);
<a name="l01145"></a>01145     wratio = (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)ws / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)wd;
<a name="l01146"></a>01146     hratio = (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hs / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hd;
<a name="l01147"></a>01147     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++)
<a name="l01148"></a>01148         srow[i] = <a class="code" href="environ_8h.html#a67d588ee5ca71be19990efb07fa2ce72">L_MIN</a>((<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(hratio * i), hs - size);
<a name="l01149"></a>01149     <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++)
<a name="l01150"></a>01150         scol[j] = <a class="code" href="environ_8h.html#a67d588ee5ca71be19990efb07fa2ce72">L_MIN</a>((<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(wratio * j), ws - size);
<a name="l01151"></a>01151 
<a name="l01152"></a>01152         <span class="comment">/* For each dest pixel, compute average */</span>
<a name="l01153"></a>01153     <span class="keywordflow">if</span> (d == 8) {
<a name="l01154"></a>01154         <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01155"></a>01155             lines = datas + srow[i] * wpls;
<a name="l01156"></a>01156             lined = datad + i * wpld;
<a name="l01157"></a>01157             <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01158"></a>01158                 xstart = scol[j];
<a name="l01159"></a>01159                 val = 0;
<a name="l01160"></a>01160                 <span class="keywordflow">for</span> (m = 0; m &lt; <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>; m++) {
<a name="l01161"></a>01161                     line = lines + m * wpls;
<a name="l01162"></a>01162                     <span class="keywordflow">for</span> (n = 0; n &lt; <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>; n++) {
<a name="l01163"></a>01163                         val += <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(line, xstart + n);
<a name="l01164"></a>01164                     }
<a name="l01165"></a>01165                 }
<a name="l01166"></a>01166                 val = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)((<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)val * norm);
<a name="l01167"></a>01167                 <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, val);
<a name="l01168"></a>01168             }
<a name="l01169"></a>01169         }
<a name="l01170"></a>01170     }
<a name="l01171"></a>01171     <span class="keywordflow">else</span> {  <span class="comment">/* d == 32 */</span>
<a name="l01172"></a>01172         <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01173"></a>01173             lines = datas + srow[i] * wpls;
<a name="l01174"></a>01174             lined = datad + i * wpld;
<a name="l01175"></a>01175             <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01176"></a>01176                 xstart = scol[j];
<a name="l01177"></a>01177                 rval = gval = bval = 0;
<a name="l01178"></a>01178                 <span class="keywordflow">for</span> (m = 0; m &lt; <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>; m++) {
<a name="l01179"></a>01179                     ppixel = lines + m * wpls + xstart;
<a name="l01180"></a>01180                     <span class="keywordflow">for</span> (n = 0; n &lt; <a class="code" href="warper__reg_8c.html#a711275dc7bbe85bb6fa721bc60b8637c">size</a>; n++) {
<a name="l01181"></a>01181                         pixel = *(ppixel + n);
<a name="l01182"></a>01182                         rval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01183"></a>01183                         gval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01184"></a>01184                         bval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01185"></a>01185                     }
<a name="l01186"></a>01186                 }
<a name="l01187"></a>01187                 rval = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)((<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)rval * norm);
<a name="l01188"></a>01188                 gval = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)((<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)gval * norm);
<a name="l01189"></a>01189                 bval = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)((<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)bval * norm);
<a name="l01190"></a>01190                 *(lined + j) = rval &lt;&lt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a> |
<a name="l01191"></a>01191                                gval &lt;&lt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a> |
<a name="l01192"></a>01192                                bval &lt;&lt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>;
<a name="l01193"></a>01193             }
<a name="l01194"></a>01194         }
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(srow);
<a name="l01198"></a>01198     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(scol);
<a name="l01199"></a>01199     <span class="keywordflow">return</span> 0;
<a name="l01200"></a>01200 }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202 <span class="comment"></span>
<a name="l01203"></a>01203 <span class="comment">/*!</span>
<a name="l01204"></a>01204 <span class="comment"> *  scaleRGBToGray2Low()</span>
<a name="l01205"></a>01205 <span class="comment"> *</span>
<a name="l01206"></a>01206 <span class="comment"> *  Note: This function is called with 32 bpp RGB src and 8 bpp,</span>
<a name="l01207"></a>01207 <span class="comment"> *        half-resolution dest.  The weights should add to 1.0.</span>
<a name="l01208"></a>01208 <span class="comment"> */</span>
<a name="l01209"></a>01209 <span class="keywordtype">void</span>
<a name="l01210"></a><a class="code" href="scalelow_8c.html#a70b8d98d090b70c1cbba7e3b202bcd26">01210</a> <a class="code" href="leptprotos_8h.html#a69019df3a7ab17f0eeff3ae5b3e62baa">scaleRGBToGray2Low</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01211"></a>01211                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01212"></a>01212                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01213"></a>01213                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01214"></a>01214                    <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01215"></a>01215                    <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l01216"></a>01216                    <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  rwt,
<a name="l01217"></a>01217                    <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  gwt,
<a name="l01218"></a>01218                    <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  bwt)
<a name="l01219"></a>01219 {
<a name="l01220"></a>01220 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, val, rval, gval, bval;
<a name="l01221"></a>01221 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l01222"></a>01222 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   pixel;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     rwt *= 0.25;
<a name="l01225"></a>01225     gwt *= 0.25;
<a name="l01226"></a>01226     bwt *= 0.25;
<a name="l01227"></a>01227     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01228"></a>01228         lines = datas + 2 * i * wpls;
<a name="l01229"></a>01229         lined = datad + i * wpld;
<a name="l01230"></a>01230         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01231"></a>01231                 <span class="comment">/* Sum each of the color components from 4 src pixels */</span>
<a name="l01232"></a>01232             pixel = *(lines + 2 * j);
<a name="l01233"></a>01233             rval = (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01234"></a>01234             gval = (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01235"></a>01235             bval = (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01236"></a>01236             pixel = *(lines + 2 * j + 1);
<a name="l01237"></a>01237             rval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01238"></a>01238             gval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01239"></a>01239             bval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01240"></a>01240             pixel = *(lines + wpls + 2 * j);
<a name="l01241"></a>01241             rval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01242"></a>01242             gval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01243"></a>01243             bval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01244"></a>01244             pixel = *(lines + wpls + 2 * j + 1);
<a name="l01245"></a>01245             rval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01246"></a>01246             gval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01247"></a>01247             bval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01248"></a>01248                 <span class="comment">/* Generate the dest byte as a weighted sum of the averages */</span>
<a name="l01249"></a>01249             val = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(rwt * rval + gwt * gval + bwt * bval);
<a name="l01250"></a>01250             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, val);
<a name="l01251"></a>01251         }
<a name="l01252"></a>01252     }
<a name="l01253"></a>01253 }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255 
<a name="l01256"></a>01256 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l01257"></a>01257 <span class="comment"> *                  General area mapped gray scaling                *</span>
<a name="l01258"></a>01258 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01259"></a>01259 <span class="comment">/*!</span>
<a name="l01260"></a>01260 <span class="comment"> *  scaleColorAreaMapLow()</span>
<a name="l01261"></a>01261 <span class="comment"> *</span>
<a name="l01262"></a>01262 <span class="comment"> *  This should only be used for downscaling.</span>
<a name="l01263"></a>01263 <span class="comment"> *  We choose to divide each pixel into 16 x 16 sub-pixels.</span>
<a name="l01264"></a>01264 <span class="comment"> *  This is much slower than scaleSmoothLow(), but it gives a</span>
<a name="l01265"></a>01265 <span class="comment"> *  better representation, esp. for downscaling factors between</span>
<a name="l01266"></a>01266 <span class="comment"> *  1.5 and 5.  All src pixels are subdivided into 256 sub-pixels,</span>
<a name="l01267"></a>01267 <span class="comment"> *  and are weighted by the number of sub-pixels covered by</span>
<a name="l01268"></a>01268 <span class="comment"> *  the dest pixel.  This is about 2x slower than scaleSmoothLow(),</span>
<a name="l01269"></a>01269 <span class="comment"> *  but the results are significantly better on small text.</span>
<a name="l01270"></a>01270 <span class="comment"> */</span>
<a name="l01271"></a>01271 <span class="keywordtype">void</span>
<a name="l01272"></a><a class="code" href="scalelow_8c.html#a18b7cf1525f63218eadc128cf388a5f3">01272</a> <a class="code" href="leptprotos_8h.html#a8bb3a9efeb2ed3fecb282c360f4bf969">scaleColorAreaMapLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01273"></a>01273                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01274"></a>01274                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01275"></a>01275                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01276"></a>01276                     <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01277"></a>01277                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l01278"></a>01278                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l01279"></a>01279                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l01280"></a>01280 {
<a name="l01281"></a>01281 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, k, m, wm2, hm2;
<a name="l01282"></a>01282 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    area00, area10, area01, area11, areal, arear, areat, areab;
<a name="l01283"></a>01283 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xu, yu;  <span class="comment">/* UL corner in src image, to 1/16 of a pixel */</span>
<a name="l01284"></a>01284 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xl, yl;  <span class="comment">/* LR corner in src image, to 1/16 of a pixel */</span>
<a name="l01285"></a>01285 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xup, yup, xuf, yuf;  <span class="comment">/* UL src pixel: integer and fraction */</span>
<a name="l01286"></a>01286 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xlp, ylp, xlf, ylf;  <span class="comment">/* LR src pixel: integer and fraction */</span>
<a name="l01287"></a>01287 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    delx, dely, area;
<a name="l01288"></a>01288 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v00r, v00g, v00b;  <span class="comment">/* contrib. from UL src pixel */</span>
<a name="l01289"></a>01289 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v01r, v01g, v01b;  <span class="comment">/* contrib. from LL src pixel */</span>
<a name="l01290"></a>01290 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v10r, v10g, v10b;  <span class="comment">/* contrib from UR src pixel */</span>
<a name="l01291"></a>01291 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v11r, v11g, v11b;  <span class="comment">/* contrib from LR src pixel */</span>
<a name="l01292"></a>01292 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    vinr, ving, vinb;  <span class="comment">/* contrib from all full interior src pixels */</span>
<a name="l01293"></a>01293 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    vmidr, vmidg, vmidb;  <span class="comment">/* contrib from side parts */</span>
<a name="l01294"></a>01294 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    rval, gval, bval;
<a name="l01295"></a>01295 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   pixel00, pixel10, pixel01, pixel11, pixel;
<a name="l01296"></a>01296 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l01297"></a>01297 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  scx, scy;
<a name="l01298"></a>01298 
<a name="l01299"></a>01299         <span class="comment">/* (scx, scy) are scaling factors that are applied to the</span>
<a name="l01300"></a>01300 <span class="comment">         * dest coords to get the corresponding src coords.</span>
<a name="l01301"></a>01301 <span class="comment">         * We need them because we iterate over dest pixels</span>
<a name="l01302"></a>01302 <span class="comment">         * and must find the corresponding set of src pixels. */</span>
<a name="l01303"></a>01303     scx = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)ws / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)wd;
<a name="l01304"></a>01304     scy = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hs / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hd;
<a name="l01305"></a>01305 
<a name="l01306"></a>01306     wm2 = ws - 2;
<a name="l01307"></a>01307     hm2 = hs - 2;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309         <span class="comment">/* Iterate over the destination pixels */</span>
<a name="l01310"></a>01310     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01311"></a>01311         yu = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scy * i);
<a name="l01312"></a>01312         yl = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scy * (i + 1.0));
<a name="l01313"></a>01313         yup = yu &gt;&gt; 4;
<a name="l01314"></a>01314         yuf = yu &amp; 0x0f;
<a name="l01315"></a>01315         ylp = yl &gt;&gt; 4;
<a name="l01316"></a>01316         ylf = yl &amp; 0x0f;
<a name="l01317"></a>01317         dely = ylp - yup;
<a name="l01318"></a>01318         lined = datad + i * wpld;
<a name="l01319"></a>01319         lines = datas + yup * wpls;
<a name="l01320"></a>01320         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01321"></a>01321             xu = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scx * j);
<a name="l01322"></a>01322             xl = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scx * (j + 1.0));
<a name="l01323"></a>01323             xup = xu &gt;&gt; 4;
<a name="l01324"></a>01324             xuf = xu &amp; 0x0f;
<a name="l01325"></a>01325             xlp = xl &gt;&gt; 4;
<a name="l01326"></a>01326             xlf = xl &amp; 0x0f;
<a name="l01327"></a>01327             delx = xlp - xup;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329                 <span class="comment">/* If near the edge, just use a src pixel value */</span>
<a name="l01330"></a>01330             <span class="keywordflow">if</span> (xlp &gt; wm2 || ylp &gt; hm2) {
<a name="l01331"></a>01331                 *(lined + j) = *(lines + xup);
<a name="l01332"></a>01332                 <span class="keywordflow">continue</span>;
<a name="l01333"></a>01333             }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335                 <span class="comment">/* Area summed over, in subpixels.  This varies</span>
<a name="l01336"></a>01336 <span class="comment">                 * due to the quantization, so we can&#39;t simply take</span>
<a name="l01337"></a>01337 <span class="comment">                 * the area to be a constant: area = scx * scy. */</span>
<a name="l01338"></a>01338             area = ((16 - xuf) + 16 * (delx - 1) + xlf) *
<a name="l01339"></a>01339                    ((16 - yuf) + 16 * (dely - 1) + ylf);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341                 <span class="comment">/* Do area map summation */</span>
<a name="l01342"></a>01342             pixel00 = *(lines + xup);
<a name="l01343"></a>01343             pixel10 = *(lines + xlp);
<a name="l01344"></a>01344             pixel01 = *(lines + dely * wpls +  xup);
<a name="l01345"></a>01345             pixel11 = *(lines + dely * wpls +  xlp);
<a name="l01346"></a>01346             area00 = (16 - xuf) * (16 - yuf);
<a name="l01347"></a>01347             area10 = xlf * (16 - yuf);
<a name="l01348"></a>01348             area01 = (16 - xuf) * ylf;
<a name="l01349"></a>01349             area11 = xlf * ylf;
<a name="l01350"></a>01350             v00r = area00 * ((pixel00 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01351"></a>01351             v00g = area00 * ((pixel00 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01352"></a>01352             v00b = area00 * ((pixel00 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01353"></a>01353             v10r = area10 * ((pixel10 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01354"></a>01354             v10g = area10 * ((pixel10 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01355"></a>01355             v10b = area10 * ((pixel10 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01356"></a>01356             v01r = area01 * ((pixel01 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01357"></a>01357             v01g = area01 * ((pixel01 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01358"></a>01358             v01b = area01 * ((pixel01 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01359"></a>01359             v11r = area11 * ((pixel11 &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01360"></a>01360             v11g = area11 * ((pixel11 &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01361"></a>01361             v11b = area11 * ((pixel11 &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01362"></a>01362             vinr = ving = vinb = 0;
<a name="l01363"></a>01363             <span class="keywordflow">for</span> (k = 1; k &lt; dely; k++) {  <span class="comment">/* for full src pixels */</span>
<a name="l01364"></a>01364                 <span class="keywordflow">for</span> (m = 1; m &lt; delx; m++) {
<a name="l01365"></a>01365                     pixel = *(lines + k * wpls + xup + m);
<a name="l01366"></a>01366                     vinr += 256 * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01367"></a>01367                     ving += 256 * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01368"></a>01368                     vinb += 256 * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01369"></a>01369                 }
<a name="l01370"></a>01370             }
<a name="l01371"></a>01371             vmidr = vmidg = vmidb = 0;
<a name="l01372"></a>01372             areal = (16 - xuf) * 16;
<a name="l01373"></a>01373             arear = xlf * 16;
<a name="l01374"></a>01374             areat = 16 * (16 - yuf);
<a name="l01375"></a>01375             areab = 16 * ylf;
<a name="l01376"></a>01376             <span class="keywordflow">for</span> (k = 1; k &lt; dely; k++) {  <span class="comment">/* for left side */</span>
<a name="l01377"></a>01377                 pixel = *(lines + k * wpls + xup);
<a name="l01378"></a>01378                 vmidr += areal * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01379"></a>01379                 vmidg += areal * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01380"></a>01380                 vmidb += areal * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01381"></a>01381             }
<a name="l01382"></a>01382             <span class="keywordflow">for</span> (k = 1; k &lt; dely; k++) {  <span class="comment">/* for right side */</span>
<a name="l01383"></a>01383                 pixel = *(lines + k * wpls + xlp);
<a name="l01384"></a>01384                 vmidr += arear * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01385"></a>01385                 vmidg += arear * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01386"></a>01386                 vmidb += arear * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01387"></a>01387             }
<a name="l01388"></a>01388             <span class="keywordflow">for</span> (m = 1; m &lt; delx; m++) {  <span class="comment">/* for top side */</span>
<a name="l01389"></a>01389                 pixel = *(lines + xup + m);
<a name="l01390"></a>01390                 vmidr += areat * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01391"></a>01391                 vmidg += areat * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01392"></a>01392                 vmidb += areat * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01393"></a>01393             }
<a name="l01394"></a>01394             <span class="keywordflow">for</span> (m = 1; m &lt; delx; m++) {  <span class="comment">/* for bottom side */</span>
<a name="l01395"></a>01395                 pixel = *(lines + dely * wpls + xup + m);
<a name="l01396"></a>01396                 vmidr += areab * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff);
<a name="l01397"></a>01397                 vmidg += areab * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff);
<a name="l01398"></a>01398                 vmidb += areab * ((pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff);
<a name="l01399"></a>01399             }
<a name="l01400"></a>01400 
<a name="l01401"></a>01401                 <span class="comment">/* Sum all the contributions */</span>
<a name="l01402"></a>01402             rval = (v00r + v01r + v10r + v11r + vinr + vmidr + 128) / area;
<a name="l01403"></a>01403             gval = (v00g + v01g + v10g + v11g + ving + vmidg + 128) / area;
<a name="l01404"></a>01404             bval = (v00b + v01b + v10b + v11b + vinb + vmidb + 128) / area;
<a name="l01405"></a>01405 <span class="preprocessor">#if  DEBUG_OVERFLOW</span>
<a name="l01406"></a>01406 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (rval &gt; 255) fprintf(stderr, <span class="stringliteral">&quot;rval ovfl: %d\n&quot;</span>, rval);
<a name="l01407"></a>01407             <span class="keywordflow">if</span> (rval &gt; 255) fprintf(stderr, <span class="stringliteral">&quot;gval ovfl: %d\n&quot;</span>, gval);
<a name="l01408"></a>01408             <span class="keywordflow">if</span> (rval &gt; 255) fprintf(stderr, <span class="stringliteral">&quot;bval ovfl: %d\n&quot;</span>, bval);
<a name="l01409"></a>01409 <span class="preprocessor">#endif  </span><span class="comment">/* DEBUG_OVERFLOW */</span>
<a name="l01410"></a>01410             <a class="code" href="leptprotos_8h.html#a6f300d6236978e9fba198c760c500c4b">composeRGBPixel</a>(rval, gval, bval, lined + j);
<a name="l01411"></a>01411         }
<a name="l01412"></a>01412     }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414     <span class="keywordflow">return</span>;
<a name="l01415"></a>01415 }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417 <span class="comment"></span>
<a name="l01418"></a>01418 <span class="comment">/*!</span>
<a name="l01419"></a>01419 <span class="comment"> *  scaleGrayAreaMapLow()</span>
<a name="l01420"></a>01420 <span class="comment"> *</span>
<a name="l01421"></a>01421 <span class="comment"> *  This should only be used for downscaling.</span>
<a name="l01422"></a>01422 <span class="comment"> *  We choose to divide each pixel into 16 x 16 sub-pixels.</span>
<a name="l01423"></a>01423 <span class="comment"> *  This is about 2x slower than scaleSmoothLow(), but the results</span>
<a name="l01424"></a>01424 <span class="comment"> *  are significantly better on small text, esp. for downscaling</span>
<a name="l01425"></a>01425 <span class="comment"> *  factors between 1.5 and 5.  All src pixels are subdivided</span>
<a name="l01426"></a>01426 <span class="comment"> *  into 256 sub-pixels, and are weighted by the number of</span>
<a name="l01427"></a>01427 <span class="comment"> *  sub-pixels covered by the dest pixel.</span>
<a name="l01428"></a>01428 <span class="comment"> */</span>
<a name="l01429"></a>01429 <span class="keywordtype">void</span>
<a name="l01430"></a><a class="code" href="scalelow_8c.html#a7a9e414d7cd58f2837bc88f7d565b2de">01430</a> <a class="code" href="leptprotos_8h.html#a1981c522033d57cffaa880608ac1b034">scaleGrayAreaMapLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01431"></a>01431                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01432"></a>01432                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01433"></a>01433                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01434"></a>01434                     <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01435"></a>01435                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l01436"></a>01436                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l01437"></a>01437                     <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l01438"></a>01438 {
<a name="l01439"></a>01439 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, k, m, wm2, hm2;
<a name="l01440"></a>01440 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xu, yu;  <span class="comment">/* UL corner in src image, to 1/16 of a pixel */</span>
<a name="l01441"></a>01441 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xl, yl;  <span class="comment">/* LR corner in src image, to 1/16 of a pixel */</span>
<a name="l01442"></a>01442 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xup, yup, xuf, yuf;  <span class="comment">/* UL src pixel: integer and fraction */</span>
<a name="l01443"></a>01443 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xlp, ylp, xlf, ylf;  <span class="comment">/* LR src pixel: integer and fraction */</span>
<a name="l01444"></a>01444 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    delx, dely, area;
<a name="l01445"></a>01445 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v00;  <span class="comment">/* contrib. from UL src pixel */</span>
<a name="l01446"></a>01446 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v01;  <span class="comment">/* contrib. from LL src pixel */</span>
<a name="l01447"></a>01447 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v10;  <span class="comment">/* contrib from UR src pixel */</span>
<a name="l01448"></a>01448 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    v11;  <span class="comment">/* contrib from LR src pixel */</span>
<a name="l01449"></a>01449 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    vin;  <span class="comment">/* contrib from all full interior src pixels */</span>
<a name="l01450"></a>01450 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    vmid;  <span class="comment">/* contrib from side parts that are full in 1 direction */</span>
<a name="l01451"></a>01451 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    val;
<a name="l01452"></a>01452 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l01453"></a>01453 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  scx, scy;
<a name="l01454"></a>01454 
<a name="l01455"></a>01455         <span class="comment">/* (scx, scy) are scaling factors that are applied to the</span>
<a name="l01456"></a>01456 <span class="comment">         * dest coords to get the corresponding src coords.</span>
<a name="l01457"></a>01457 <span class="comment">         * We need them because we iterate over dest pixels</span>
<a name="l01458"></a>01458 <span class="comment">         * and must find the corresponding set of src pixels. */</span>
<a name="l01459"></a>01459     scx = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)ws / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)wd;
<a name="l01460"></a>01460     scy = 16. * (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hs / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hd;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     wm2 = ws - 2;
<a name="l01463"></a>01463     hm2 = hs - 2;
<a name="l01464"></a>01464 
<a name="l01465"></a>01465         <span class="comment">/* Iterate over the destination pixels */</span>
<a name="l01466"></a>01466     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01467"></a>01467         yu = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scy * i);
<a name="l01468"></a>01468         yl = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scy * (i + 1.0));
<a name="l01469"></a>01469         yup = yu &gt;&gt; 4;
<a name="l01470"></a>01470         yuf = yu &amp; 0x0f;
<a name="l01471"></a>01471         ylp = yl &gt;&gt; 4;
<a name="l01472"></a>01472         ylf = yl &amp; 0x0f;
<a name="l01473"></a>01473         dely = ylp - yup;
<a name="l01474"></a>01474         lined = datad + i * wpld;
<a name="l01475"></a>01475         lines = datas + yup * wpls;
<a name="l01476"></a>01476         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01477"></a>01477             xu = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scx * j);
<a name="l01478"></a>01478             xl = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(scx * (j + 1.0));
<a name="l01479"></a>01479             xup = xu &gt;&gt; 4;
<a name="l01480"></a>01480             xuf = xu &amp; 0x0f;
<a name="l01481"></a>01481             xlp = xl &gt;&gt; 4;
<a name="l01482"></a>01482             xlf = xl &amp; 0x0f;
<a name="l01483"></a>01483             delx = xlp - xup;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485                 <span class="comment">/* If near the edge, just use a src pixel value */</span>
<a name="l01486"></a>01486             <span class="keywordflow">if</span> (xlp &gt; wm2 || ylp &gt; hm2) {
<a name="l01487"></a>01487                 <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xup));
<a name="l01488"></a>01488                 <span class="keywordflow">continue</span>;
<a name="l01489"></a>01489             }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491                 <span class="comment">/* Area summed over, in subpixels.  This varies</span>
<a name="l01492"></a>01492 <span class="comment">                 * due to the quantization, so we can&#39;t simply take</span>
<a name="l01493"></a>01493 <span class="comment">                 * the area to be a constant: area = scx * scy. */</span>
<a name="l01494"></a>01494             area = ((16 - xuf) + 16 * (delx - 1) + xlf) *
<a name="l01495"></a>01495                    ((16 - yuf) + 16 * (dely - 1) + ylf);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497                 <span class="comment">/* Do area map summation */</span>
<a name="l01498"></a>01498             v00 = (16 - xuf) * (16 - yuf) * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xup);
<a name="l01499"></a>01499             v10 = xlf * (16 - yuf) * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xlp);
<a name="l01500"></a>01500             v01 = (16 - xuf) * ylf * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + dely * wpls, xup);
<a name="l01501"></a>01501             v11 = xlf * ylf * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + dely * wpls, xlp);
<a name="l01502"></a>01502             <span class="keywordflow">for</span> (vin = 0, k = 1; k &lt; dely; k++) {  <span class="comment">/* for full src pixels */</span>
<a name="l01503"></a>01503                  <span class="keywordflow">for</span> (m = 1; m &lt; delx; m++) {
<a name="l01504"></a>01504                      vin += 256 * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + k * wpls, xup + m);
<a name="l01505"></a>01505                  }
<a name="l01506"></a>01506             }
<a name="l01507"></a>01507             <span class="keywordflow">for</span> (vmid = 0, k = 1; k &lt; dely; k++)  <span class="comment">/* for left side */</span>
<a name="l01508"></a>01508                 vmid += (16 - xuf) * 16 * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + k * wpls, xup);
<a name="l01509"></a>01509             <span class="keywordflow">for</span> (k = 1; k &lt; dely; k++)  <span class="comment">/* for right side */</span>
<a name="l01510"></a>01510                 vmid += xlf * 16 * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + k * wpls, xlp);
<a name="l01511"></a>01511             <span class="keywordflow">for</span> (m = 1; m &lt; delx; m++)  <span class="comment">/* for top side */</span>
<a name="l01512"></a>01512                 vmid += 16 * (16 - yuf) * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, xup + m);
<a name="l01513"></a>01513             <span class="keywordflow">for</span> (m = 1; m &lt; delx; m++)  <span class="comment">/* for bottom side */</span>
<a name="l01514"></a>01514                 vmid += 16 * ylf * <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + dely * wpls, xup + m);
<a name="l01515"></a>01515             val = (v00 + v01 + v10 + v11 + vin + vmid + 128) / area;
<a name="l01516"></a>01516 <span class="preprocessor">#if  DEBUG_OVERFLOW</span>
<a name="l01517"></a>01517 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (val &gt; 255) fprintf(stderr, <span class="stringliteral">&quot;val overflow: %d\n&quot;</span>, val);
<a name="l01518"></a>01518 <span class="preprocessor">#endif  </span><span class="comment">/* DEBUG_OVERFLOW */</span>
<a name="l01519"></a>01519             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, val);
<a name="l01520"></a>01520         }
<a name="l01521"></a>01521     }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523     <span class="keywordflow">return</span>;
<a name="l01524"></a>01524 }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526 
<a name="l01527"></a>01527 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l01528"></a>01528 <span class="comment"> *                     2x area mapped downscaling                   *</span>
<a name="l01529"></a>01529 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01530"></a>01530 <span class="comment">/*!</span>
<a name="l01531"></a>01531 <span class="comment"> *  scaleAreaMapLow2()</span>
<a name="l01532"></a>01532 <span class="comment"> *</span>
<a name="l01533"></a>01533 <span class="comment"> *  Note: This function is called with either 8 bpp gray or 32 bpp RGB.</span>
<a name="l01534"></a>01534 <span class="comment"> *        The result is a 2x reduced dest.</span>
<a name="l01535"></a>01535 <span class="comment"> */</span>
<a name="l01536"></a>01536 <span class="keywordtype">void</span>
<a name="l01537"></a><a class="code" href="scalelow_8c.html#a2fe951ade88d82444eb05e1e891beea1">01537</a> <a class="code" href="leptprotos_8h.html#a5414b0dd9dab76d55ddd0531ad24c895">scaleAreaMapLow2</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01538"></a>01538                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01539"></a>01539                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01540"></a>01540                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01541"></a>01541                  <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01542"></a>01542                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    d,
<a name="l01543"></a>01543                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l01544"></a>01544 {
<a name="l01545"></a>01545 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, val, rval, gval, bval;
<a name="l01546"></a>01546 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l01547"></a>01547 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   pixel;
<a name="l01548"></a>01548 
<a name="l01549"></a>01549     <span class="keywordflow">if</span> (d == 8) {
<a name="l01550"></a>01550         <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01551"></a>01551             lines = datas + 2 * i * wpls;
<a name="l01552"></a>01552             lined = datad + i * wpld;
<a name="l01553"></a>01553             <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01554"></a>01554                     <span class="comment">/* Average each dest pixel using 4 src pixels */</span>
<a name="l01555"></a>01555                 val = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, 2 * j);
<a name="l01556"></a>01556                 val += <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, 2 * j + 1);
<a name="l01557"></a>01557                 val += <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, 2 * j);
<a name="l01558"></a>01558                 val += <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, 2 * j + 1);
<a name="l01559"></a>01559                 val &gt;&gt;= 2;
<a name="l01560"></a>01560                 <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, val);
<a name="l01561"></a>01561             }
<a name="l01562"></a>01562         }
<a name="l01563"></a>01563     }
<a name="l01564"></a>01564     <span class="keywordflow">else</span> {  <span class="comment">/* d == 32 */</span>
<a name="l01565"></a>01565         <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01566"></a>01566             lines = datas + 2 * i * wpls;
<a name="l01567"></a>01567             lined = datad + i * wpld;
<a name="l01568"></a>01568             <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01569"></a>01569                     <span class="comment">/* Average each of the color components from 4 src pixels */</span>
<a name="l01570"></a>01570                 pixel = *(lines + 2 * j);
<a name="l01571"></a>01571                 rval = (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01572"></a>01572                 gval = (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01573"></a>01573                 bval = (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01574"></a>01574                 pixel = *(lines + 2 * j + 1);
<a name="l01575"></a>01575                 rval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01576"></a>01576                 gval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01577"></a>01577                 bval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01578"></a>01578                 pixel = *(lines + wpls + 2 * j);
<a name="l01579"></a>01579                 rval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01580"></a>01580                 gval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01581"></a>01581                 bval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01582"></a>01582                 pixel = *(lines + wpls + 2 * j + 1);
<a name="l01583"></a>01583                 rval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad76bb710b35516e4025310abdb0c6057">L_RED_SHIFT</a>) &amp; 0xff;
<a name="l01584"></a>01584                 gval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#a242ab61c8f78c6c54469a999b82115a2">L_GREEN_SHIFT</a>) &amp; 0xff;
<a name="l01585"></a>01585                 bval += (pixel &gt;&gt; <a class="code" href="pix_8h.html#ad588346cb07a755e5dfb1f12bfb0eae1">L_BLUE_SHIFT</a>) &amp; 0xff;
<a name="l01586"></a>01586                 <a class="code" href="leptprotos_8h.html#a6f300d6236978e9fba198c760c500c4b">composeRGBPixel</a>(rval &gt;&gt; 2, gval &gt;&gt; 2, bval &gt;&gt; 2, &amp;pixel);
<a name="l01587"></a>01587                 *(lined + j) = pixel;
<a name="l01588"></a>01588             }
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591     <span class="keywordflow">return</span>;
<a name="l01592"></a>01592 }
<a name="l01593"></a>01593 
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l01596"></a>01596 <span class="comment"> *              Binary scaling by closest pixel sampling            *</span>
<a name="l01597"></a>01597 <span class="comment"> *------------------------------------------------------------------*/</span>
<a name="l01598"></a>01598 <span class="comment">/*</span>
<a name="l01599"></a>01599 <span class="comment"> *  scaleBinaryLow()</span>
<a name="l01600"></a>01600 <span class="comment"> *</span>
<a name="l01601"></a>01601 <span class="comment"> *  Notes:</span>
<a name="l01602"></a>01602 <span class="comment"> *      (1) The dest must be cleared prior to this operation,</span>
<a name="l01603"></a>01603 <span class="comment"> *          and we clear it here in the low-level code.</span>
<a name="l01604"></a>01604 <span class="comment"> *      (2) We reuse dest pixels and dest pixel rows whenever</span>
<a name="l01605"></a>01605 <span class="comment"> *          possible for upscaling; downscaling is done by</span>
<a name="l01606"></a>01606 <span class="comment"> *          strict subsampling.</span>
<a name="l01607"></a>01607 <span class="comment"> */</span>
<a name="l01608"></a>01608 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l01609"></a><a class="code" href="scalelow_8c.html#a5f55cf47bc784af128510175218a5df9">01609</a> <a class="code" href="leptprotos_8h.html#a22af42cf4497cd9f7ff6440bee1d4a1c">scaleBinaryLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01610"></a>01610                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01611"></a>01611                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01612"></a>01612                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01613"></a>01613                <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01614"></a>01614                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    ws,
<a name="l01615"></a>01615                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hs,
<a name="l01616"></a>01616                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls)
<a name="l01617"></a>01617 {
<a name="l01618"></a>01618 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, bpld;
<a name="l01619"></a>01619 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    xs, prevxs, sval;
<a name="l01620"></a>01620 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *srow, *scol;
<a name="l01621"></a>01621 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *prevlines, *lined, *prevlined;
<a name="l01622"></a>01622 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  wratio, hratio;
<a name="l01623"></a>01623 
<a name="l01624"></a>01624     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;scaleBinaryLow&quot;</span>);
<a name="l01625"></a>01625 
<a name="l01626"></a>01626         <span class="comment">/* clear dest */</span>
<a name="l01627"></a>01627     bpld = 4 * wpld;
<a name="l01628"></a>01628     memset((<span class="keywordtype">char</span> *)datad, 0, hd * bpld);
<a name="l01629"></a>01629     
<a name="l01630"></a>01630         <span class="comment">/* The source row corresponding to dest row i ==&gt; srow[i]</span>
<a name="l01631"></a>01631 <span class="comment">         * The source col corresponding to dest col j ==&gt; scol[j]  */</span>
<a name="l01632"></a>01632     <span class="keywordflow">if</span> ((srow = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(hd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01633"></a>01633         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;srow not made&quot;</span>, procName, 1);
<a name="l01634"></a>01634     <span class="keywordflow">if</span> ((scol = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(wd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01635"></a>01635         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;scol not made&quot;</span>, procName, 1);
<a name="l01636"></a>01636 
<a name="l01637"></a>01637     wratio = (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)ws / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)wd;
<a name="l01638"></a>01638     hratio = (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hs / (<a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>)hd;
<a name="l01639"></a>01639     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++)
<a name="l01640"></a>01640         srow[i] = <a class="code" href="environ_8h.html#a67d588ee5ca71be19990efb07fa2ce72">L_MIN</a>((<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(hratio * i + 0.5), hs - 1);
<a name="l01641"></a>01641     <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++)
<a name="l01642"></a>01642         scol[j] = <a class="code" href="environ_8h.html#a67d588ee5ca71be19990efb07fa2ce72">L_MIN</a>((<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(wratio * j + 0.5), ws - 1);
<a name="l01643"></a>01643 
<a name="l01644"></a>01644     prevlines = <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01645"></a>01645     prevxs = -1;
<a name="l01646"></a>01646     sval = 0;
<a name="l01647"></a>01647     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l01648"></a>01648         lines = datas + srow[i] * wpls;
<a name="l01649"></a>01649         lined = datad + i * wpld;
<a name="l01650"></a>01650         <span class="keywordflow">if</span> (lines != prevlines) {  <span class="comment">/* make dest from new source row */</span>
<a name="l01651"></a>01651             <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l01652"></a>01652                 xs = scol[j];
<a name="l01653"></a>01653                 <span class="keywordflow">if</span> (xs != prevxs) {  <span class="comment">/* get dest pix from source col */</span>
<a name="l01654"></a>01654                     <span class="keywordflow">if</span> ((sval = <a class="code" href="arrayaccess_8h.html#ac76be298c81846741bd3106d13a027b2">GET_DATA_BIT</a>(lines, xs)))
<a name="l01655"></a>01655                         <a class="code" href="arrayaccess_8h.html#a3e73bbbe42ece2b6e3d813fc10de9aaf">SET_DATA_BIT</a>(lined, j);
<a name="l01656"></a>01656                     prevxs = xs;
<a name="l01657"></a>01657                 }
<a name="l01658"></a>01658                 <span class="keywordflow">else</span> {  <span class="comment">/* copy prev dest pix, if set */</span>
<a name="l01659"></a>01659                     <span class="keywordflow">if</span> (sval)
<a name="l01660"></a>01660                         <a class="code" href="arrayaccess_8h.html#a3e73bbbe42ece2b6e3d813fc10de9aaf">SET_DATA_BIT</a>(lined, j);
<a name="l01661"></a>01661                 }
<a name="l01662"></a>01662             }
<a name="l01663"></a>01663         }
<a name="l01664"></a>01664         <span class="keywordflow">else</span> {  <span class="comment">/* lines == prevlines; copy prev dest row */</span>
<a name="l01665"></a>01665             prevlined = lined - wpld;
<a name="l01666"></a>01666             memcpy((<span class="keywordtype">char</span> *)lined, (<span class="keywordtype">char</span> *)prevlined, bpld);
<a name="l01667"></a>01667         }
<a name="l01668"></a>01668         prevlines = lines;
<a name="l01669"></a>01669     }
<a name="l01670"></a>01670 
<a name="l01671"></a>01671     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(srow);
<a name="l01672"></a>01672     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(scol);
<a name="l01673"></a>01673 
<a name="l01674"></a>01674     <span class="keywordflow">return</span> 0;
<a name="l01675"></a>01675 }
<a name="l01676"></a>01676 
<a name="l01677"></a>01677 
<a name="l01678"></a>01678 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l01679"></a>01679 <span class="comment"> *                         Scale-to-gray 2x                         *</span>
<a name="l01680"></a>01680 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01681"></a>01681 <span class="comment">/*!</span>
<a name="l01682"></a>01682 <span class="comment"> *  scaleToGray2Low()</span>
<a name="l01683"></a>01683 <span class="comment"> *</span>
<a name="l01684"></a>01684 <span class="comment"> *      Input:  usual image variables</span>
<a name="l01685"></a>01685 <span class="comment"> *              sumtab  (made from makeSumTabSG2())</span>
<a name="l01686"></a>01686 <span class="comment"> *              valtab  (made from makeValTabSG2())</span>
<a name="l01687"></a>01687 <span class="comment"> *      Return: 0 if OK; 1 on error.</span>
<a name="l01688"></a>01688 <span class="comment"> *</span>
<a name="l01689"></a>01689 <span class="comment"> *  The output is processed in sets of 4 output bytes on a row,</span>
<a name="l01690"></a>01690 <span class="comment"> *  corresponding to 4 2x2 bit-blocks in the input image.</span>
<a name="l01691"></a>01691 <span class="comment"> *  Two lookup tables are used.  The first, sumtab, gets the</span>
<a name="l01692"></a>01692 <span class="comment"> *  sum of ON pixels in 4 sets of two adjacent bits,</span>
<a name="l01693"></a>01693 <span class="comment"> *  storing the result in 4 adjacent bytes.  After sums from</span>
<a name="l01694"></a>01694 <span class="comment"> *  two rows have been added, the second table, valtab,</span>
<a name="l01695"></a>01695 <span class="comment"> *  converts from the sum of ON pixels in the 2x2 block to</span>
<a name="l01696"></a>01696 <span class="comment"> *  an 8 bpp grayscale value between 0 (for 4 bits ON)</span>
<a name="l01697"></a>01697 <span class="comment"> *  and 255 (for 0 bits ON).</span>
<a name="l01698"></a>01698 <span class="comment"> */</span>
<a name="l01699"></a>01699 <span class="keywordtype">void</span>
<a name="l01700"></a><a class="code" href="scalelow_8c.html#abb28f51421fcd982c83aaafc695bc45e">01700</a> <a class="code" href="leptprotos_8h.html#a7a657556e9f837142b3b37f5b69cc4d3">scaleToGray2Low</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01701"></a>01701                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01702"></a>01702                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01703"></a>01703                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01704"></a>01704                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01705"></a>01705                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l01706"></a>01706                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *sumtab,
<a name="l01707"></a>01707                 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>   *valtab)
<a name="l01708"></a>01708 {
<a name="l01709"></a>01709 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, l, k, m, wd4, extra;
<a name="l01710"></a>01710 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   sbyte1, sbyte2, sum;
<a name="l01711"></a>01711 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l01712"></a>01712 
<a name="l01713"></a>01713         <span class="comment">/* i indexes the dest lines</span>
<a name="l01714"></a>01714 <span class="comment">         * l indexes the source lines</span>
<a name="l01715"></a>01715 <span class="comment">         * j indexes the dest bytes</span>
<a name="l01716"></a>01716 <span class="comment">         * k indexes the source bytes</span>
<a name="l01717"></a>01717 <span class="comment">         * We take two bytes from the source (in 2 lines of 8 pixels</span>
<a name="l01718"></a>01718 <span class="comment">         * each) and convert them into four 8 bpp bytes of the dest. */</span>
<a name="l01719"></a>01719     wd4 = wd &amp; 0xfffffffc;
<a name="l01720"></a>01720     extra = wd - wd4;
<a name="l01721"></a>01721     <span class="keywordflow">for</span> (i = 0, l = 0; i &lt; hd; i++, l += 2) {
<a name="l01722"></a>01722         lines = datas + l * wpls;
<a name="l01723"></a>01723         lined = datad + i * wpld; 
<a name="l01724"></a>01724         <span class="keywordflow">for</span> (j = 0, k = 0; j &lt; wd4; j += 4, k++) {
<a name="l01725"></a>01725             sbyte1 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k);
<a name="l01726"></a>01726             sbyte2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k);
<a name="l01727"></a>01727             sum = sumtab[sbyte1] + sumtab[sbyte2];
<a name="l01728"></a>01728             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, valtab[sum &gt;&gt; 24]);
<a name="l01729"></a>01729             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 1, valtab[(sum &gt;&gt; 16) &amp; 0xff]);
<a name="l01730"></a>01730             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 2, valtab[(sum &gt;&gt; 8) &amp; 0xff]);
<a name="l01731"></a>01731             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 3, valtab[sum &amp; 0xff]);
<a name="l01732"></a>01732         }
<a name="l01733"></a>01733         <span class="keywordflow">if</span> (extra &gt; 0) {
<a name="l01734"></a>01734             sbyte1 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k);
<a name="l01735"></a>01735             sbyte2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k);
<a name="l01736"></a>01736             sum = sumtab[sbyte1] + sumtab[sbyte2];
<a name="l01737"></a>01737             <span class="keywordflow">for</span> (m = 0; m &lt; extra; m++) {
<a name="l01738"></a>01738                 <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + m,
<a name="l01739"></a>01739                               valtab[((sum &gt;&gt; (24 - 8 * m)) &amp; 0xff)]);
<a name="l01740"></a>01740             }
<a name="l01741"></a>01741         }
<a name="l01742"></a>01742         
<a name="l01743"></a>01743     }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745     <span class="keywordflow">return</span>;
<a name="l01746"></a>01746 }
<a name="l01747"></a>01747 
<a name="l01748"></a>01748 <span class="comment"></span>
<a name="l01749"></a>01749 <span class="comment">/*!</span>
<a name="l01750"></a>01750 <span class="comment"> *  makeSumTabSG2()</span>
<a name="l01751"></a>01751 <span class="comment"> *         </span>
<a name="l01752"></a>01752 <span class="comment"> *  Returns a table of 256 l_uint32s, giving the four output</span>
<a name="l01753"></a>01753 <span class="comment"> *  8-bit grayscale sums corresponding to 8 input bits of a binary</span>
<a name="l01754"></a>01754 <span class="comment"> *  image, for a 2x scale-to-gray op.  The sums from two</span>
<a name="l01755"></a>01755 <span class="comment"> *  adjacent scanlines are then added and transformed to</span>
<a name="l01756"></a>01756 <span class="comment"> *  output four 8 bpp pixel values, using makeValTabSG2().</span>
<a name="l01757"></a>01757 <span class="comment"> */</span>
<a name="l01758"></a>01758 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *
<a name="l01759"></a><a class="code" href="scalelow_8c.html#ab23684bf6a3b2976686ede0200967fe1">01759</a> <a class="code" href="leptprotos_8h.html#a47fe6e34800b3e9f72e9d6e456812765">makeSumTabSG2</a>(<span class="keywordtype">void</span>)
<a name="l01760"></a>01760 {
<a name="l01761"></a>01761 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i;
<a name="l01762"></a>01762 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    sum[] = {0, 1, 1, 2};
<a name="l01763"></a>01763 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *tab;
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeSumTabSG2&quot;</span>);
<a name="l01766"></a>01766 
<a name="l01767"></a>01767     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(256, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01768"></a>01768         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01769"></a>01769 
<a name="l01770"></a>01770         <span class="comment">/* Pack the four sums separately in four bytes */</span>
<a name="l01771"></a>01771     <span class="keywordflow">for</span> (i = 0; i &lt; 256; i++) {
<a name="l01772"></a>01772         tab[i] = (sum[i &amp; 0x3] | sum[(i &gt;&gt; 2) &amp; 0<a class="code" href="affine__reg_8c.html#a41b607021994d7ad321d656d6682186b">x3</a>] &lt;&lt; 8 |
<a name="l01773"></a>01773                   sum[(i &gt;&gt; 4) &amp; 0x3] &lt;&lt; 16 | sum[(i &gt;&gt; 6) &amp; 0<a class="code" href="affine__reg_8c.html#a41b607021994d7ad321d656d6682186b">x3</a>] &lt;&lt; 24);
<a name="l01774"></a>01774     }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776     <span class="keywordflow">return</span> tab;
<a name="l01777"></a>01777 }
<a name="l01778"></a>01778 
<a name="l01779"></a>01779 <span class="comment"></span>
<a name="l01780"></a>01780 <span class="comment">/*!</span>
<a name="l01781"></a>01781 <span class="comment"> *  makeValTabSG2()</span>
<a name="l01782"></a>01782 <span class="comment"> *         </span>
<a name="l01783"></a>01783 <span class="comment"> *  Returns an 8 bit value for the sum of ON pixels</span>
<a name="l01784"></a>01784 <span class="comment"> *  in a 2x2 square, according to</span>
<a name="l01785"></a>01785 <span class="comment"> *</span>
<a name="l01786"></a>01786 <span class="comment"> *         val = 255 - (255 * sum)/4</span>
<a name="l01787"></a>01787 <span class="comment"> *</span>
<a name="l01788"></a>01788 <span class="comment"> *  where sum is in set {0,1,2,3,4}</span>
<a name="l01789"></a>01789 <span class="comment"> */</span>
<a name="l01790"></a>01790 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *
<a name="l01791"></a><a class="code" href="scalelow_8c.html#a126b22cc5f168872bcb7c30838e1f050">01791</a> <a class="code" href="leptprotos_8h.html#a076aa5880b6941c76a856c3f5717333d">makeValTabSG2</a>(<span class="keywordtype">void</span>)
<a name="l01792"></a>01792 {
<a name="l01793"></a>01793 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   i;
<a name="l01794"></a>01794 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>  *tab;
<a name="l01795"></a>01795 
<a name="l01796"></a>01796     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeValTabSG2&quot;</span>);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(5, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01799"></a>01799         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01800"></a>01800 
<a name="l01801"></a>01801     <span class="keywordflow">for</span> (i = 0; i &lt; 5; i++)
<a name="l01802"></a>01802         tab[i] = 255 - (i * 255) / 4;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804     <span class="keywordflow">return</span> tab;
<a name="l01805"></a>01805 }
<a name="l01806"></a>01806 
<a name="l01807"></a>01807 
<a name="l01808"></a>01808 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l01809"></a>01809 <span class="comment"> *                         Scale-to-gray 3x                         *</span>
<a name="l01810"></a>01810 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01811"></a>01811 <span class="comment">/*!</span>
<a name="l01812"></a>01812 <span class="comment"> *  scaleToGray3Low()</span>
<a name="l01813"></a>01813 <span class="comment"> *</span>
<a name="l01814"></a>01814 <span class="comment"> *      Input:  usual image variables</span>
<a name="l01815"></a>01815 <span class="comment"> *              sumtab  (made from makeSumTabSG3())</span>
<a name="l01816"></a>01816 <span class="comment"> *              valtab  (made from makeValTabSG3())</span>
<a name="l01817"></a>01817 <span class="comment"> *      Return: 0 if OK; 1 on error</span>
<a name="l01818"></a>01818 <span class="comment"> *</span>
<a name="l01819"></a>01819 <span class="comment"> *  Each set of 8 3x3 bit-blocks in the source image, which</span>
<a name="l01820"></a>01820 <span class="comment"> *  consist of 72 pixels arranged 24 pixels wide by 3 scanlines,</span>
<a name="l01821"></a>01821 <span class="comment"> *  is converted to a row of 8 8-bit pixels in the dest image.</span>
<a name="l01822"></a>01822 <span class="comment"> *  These 72 pixels of the input image are runs of 24 pixels</span>
<a name="l01823"></a>01823 <span class="comment"> *  in three adjacent scanlines.  Each run of 24 pixels is</span>
<a name="l01824"></a>01824 <span class="comment"> *  stored in the 24 LSbits of a 32-bit word.  We use 2 LUTs.</span>
<a name="l01825"></a>01825 <span class="comment"> *  The first, sumtab, takes 6 of these bits and stores</span>
<a name="l01826"></a>01826 <span class="comment"> *  sum, taken 3 bits at a time, in two bytes.  (See</span>
<a name="l01827"></a>01827 <span class="comment"> *  makeSumTabSG3).  This is done for each of the 3 scanlines,</span>
<a name="l01828"></a>01828 <span class="comment"> *  and the results are added.  We now have the sum of ON pixels</span>
<a name="l01829"></a>01829 <span class="comment"> *  in the first two 3x3 blocks in two bytes.  The valtab LUT</span>
<a name="l01830"></a>01830 <span class="comment"> *  then converts these values (which go from 0 to 9) to</span>
<a name="l01831"></a>01831 <span class="comment"> *  grayscale values between between 255 and 0.  (See makeValTabSG3).</span>
<a name="l01832"></a>01832 <span class="comment"> *  This process is repeated for each of the other 3 sets of</span>
<a name="l01833"></a>01833 <span class="comment"> *  6x3 input pixels, giving 8 output pixels in total.</span>
<a name="l01834"></a>01834 <span class="comment"> *</span>
<a name="l01835"></a>01835 <span class="comment"> *  Note: because the input image is processed in groups of</span>
<a name="l01836"></a>01836 <span class="comment"> *        24 x 3 pixels, the process clips the input height to</span>
<a name="l01837"></a>01837 <span class="comment"> *        (h - h % 3) and the input width to (w - w % 24).</span>
<a name="l01838"></a>01838 <span class="comment"> */</span>
<a name="l01839"></a>01839 <span class="keywordtype">void</span>
<a name="l01840"></a><a class="code" href="scalelow_8c.html#a8571e7849f8427f566f439f64d246847">01840</a> <a class="code" href="leptprotos_8h.html#a7575744c99b24b79a58354b8c7ff751d">scaleToGray3Low</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01841"></a>01841                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01842"></a>01842                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01843"></a>01843                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01844"></a>01844                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01845"></a>01845                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l01846"></a>01846                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *sumtab,
<a name="l01847"></a>01847                 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>   *valtab)
<a name="l01848"></a>01848 {
<a name="l01849"></a>01849 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, l, k;
<a name="l01850"></a>01850 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   threebytes1, threebytes2, threebytes3, sum;
<a name="l01851"></a>01851 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l01852"></a>01852 
<a name="l01853"></a>01853         <span class="comment">/* i indexes the dest lines</span>
<a name="l01854"></a>01854 <span class="comment">         * l indexes the source lines</span>
<a name="l01855"></a>01855 <span class="comment">         * j indexes the dest bytes</span>
<a name="l01856"></a>01856 <span class="comment">         * k indexes the source bytes</span>
<a name="l01857"></a>01857 <span class="comment">         * We take 9 bytes from the source (72 binary pixels</span>
<a name="l01858"></a>01858 <span class="comment">         * in three lines of 24 pixels each) and convert it</span>
<a name="l01859"></a>01859 <span class="comment">         * into 8 bytes of the dest (8 8bpp pixels in one line)   */</span>
<a name="l01860"></a>01860     <span class="keywordflow">for</span> (i = 0, l = 0; i &lt; hd; i++, l += 3) {
<a name="l01861"></a>01861         lines = datas + l * wpls;
<a name="l01862"></a>01862         lined = datad + i * wpld; 
<a name="l01863"></a>01863         <span class="keywordflow">for</span> (j = 0, k = 0; j &lt; wd; j += 8, k += 3) {
<a name="l01864"></a>01864             threebytes1 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k) &lt;&lt; 16) |
<a name="l01865"></a>01865                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k + 1) &lt;&lt; 8) |
<a name="l01866"></a>01866                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k + 2);
<a name="l01867"></a>01867             threebytes2 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k) &lt;&lt; 16) |
<a name="l01868"></a>01868                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k + 1) &lt;&lt; 8) |
<a name="l01869"></a>01869                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k + 2);
<a name="l01870"></a>01870             threebytes3 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, k) &lt;&lt; 16) |
<a name="l01871"></a>01871                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, k + 1) &lt;&lt; 8) |
<a name="l01872"></a>01872                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, k + 2);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874             sum = sumtab[(threebytes1 &gt;&gt; 18)] +
<a name="l01875"></a>01875                   sumtab[(threebytes2 &gt;&gt; 18)] +
<a name="l01876"></a>01876                   sumtab[(threebytes3 &gt;&gt; 18)];
<a name="l01877"></a>01877             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 2)]);
<a name="l01878"></a>01878             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 1, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l01879"></a>01879 
<a name="l01880"></a>01880             sum = sumtab[((threebytes1 &gt;&gt; 12) &amp; 0x3f)] +
<a name="l01881"></a>01881                   sumtab[((threebytes2 &gt;&gt; 12) &amp; 0x3f)] +
<a name="l01882"></a>01882                   sumtab[((threebytes3 &gt;&gt; 12) &amp; 0x3f)];
<a name="l01883"></a>01883             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 2, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 2)]);
<a name="l01884"></a>01884             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 3, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l01885"></a>01885 
<a name="l01886"></a>01886             sum = sumtab[((threebytes1 &gt;&gt; 6) &amp; 0x3f)] +
<a name="l01887"></a>01887                   sumtab[((threebytes2 &gt;&gt; 6) &amp; 0x3f)] +
<a name="l01888"></a>01888                   sumtab[((threebytes3 &gt;&gt; 6) &amp; 0x3f)];
<a name="l01889"></a>01889             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 4, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 2)]);
<a name="l01890"></a>01890             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 5, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l01891"></a>01891 
<a name="l01892"></a>01892             sum = sumtab[(threebytes1 &amp; 0x3f)] +
<a name="l01893"></a>01893                   sumtab[(threebytes2 &amp; 0x3f)] +
<a name="l01894"></a>01894                   sumtab[(threebytes3 &amp; 0x3f)];
<a name="l01895"></a>01895             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 6, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 2)]);
<a name="l01896"></a>01896             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 7, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l01897"></a>01897         }
<a name="l01898"></a>01898     }
<a name="l01899"></a>01899 
<a name="l01900"></a>01900     <span class="keywordflow">return</span>;
<a name="l01901"></a>01901 }
<a name="l01902"></a>01902 
<a name="l01903"></a>01903 
<a name="l01904"></a>01904 <span class="comment"></span>
<a name="l01905"></a>01905 <span class="comment">/*!</span>
<a name="l01906"></a>01906 <span class="comment"> *  makeSumTabSG3()</span>
<a name="l01907"></a>01907 <span class="comment"> *         </span>
<a name="l01908"></a>01908 <span class="comment"> *  Returns a table of 64 l_uint32s, giving the two output</span>
<a name="l01909"></a>01909 <span class="comment"> *  8-bit grayscale sums corresponding to 6 input bits of a binary</span>
<a name="l01910"></a>01910 <span class="comment"> *  image, for a 3x scale-to-gray op.  In practice, this would</span>
<a name="l01911"></a>01911 <span class="comment"> *  be used three times (on adjacent scanlines), and the sums would</span>
<a name="l01912"></a>01912 <span class="comment"> *  be added and then transformed to output 8 bpp pixel values,</span>
<a name="l01913"></a>01913 <span class="comment"> *  using makeValTabSG3().</span>
<a name="l01914"></a>01914 <span class="comment"> */</span>
<a name="l01915"></a>01915 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *
<a name="l01916"></a><a class="code" href="scalelow_8c.html#a6014f31b37925b34a57a6efe30b80203">01916</a> <a class="code" href="leptprotos_8h.html#ab150f72dee435427b6d983d6767c0b23">makeSumTabSG3</a>(<span class="keywordtype">void</span>)
<a name="l01917"></a>01917 {
<a name="l01918"></a>01918 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i;
<a name="l01919"></a>01919 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    sum[] = {0, 1, 1, 2, 1, 2, 2, 3};
<a name="l01920"></a>01920 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *tab;
<a name="l01921"></a>01921 
<a name="l01922"></a>01922     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeSumTabSG3&quot;</span>);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(64, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01925"></a>01925         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01926"></a>01926 
<a name="l01927"></a>01927         <span class="comment">/* Pack the two sums separately in two bytes */</span>
<a name="l01928"></a>01928     <span class="keywordflow">for</span> (i = 0; i &lt; 64; i++) {
<a name="l01929"></a>01929         tab[i] = (sum[i &amp; 0x07]) | (sum[(i &gt;&gt; 3) &amp; 0x07] &lt;&lt; 8);
<a name="l01930"></a>01930     }
<a name="l01931"></a>01931 
<a name="l01932"></a>01932     <span class="keywordflow">return</span> tab;
<a name="l01933"></a>01933 }
<a name="l01934"></a>01934 
<a name="l01935"></a>01935 <span class="comment"></span>
<a name="l01936"></a>01936 <span class="comment">/*!</span>
<a name="l01937"></a>01937 <span class="comment"> *  makeValTabSG3()</span>
<a name="l01938"></a>01938 <span class="comment"> *         </span>
<a name="l01939"></a>01939 <span class="comment"> *  Returns an 8 bit value for the sum of ON pixels</span>
<a name="l01940"></a>01940 <span class="comment"> *  in a 3x3 square, according to</span>
<a name="l01941"></a>01941 <span class="comment"> *      val = 255 - (255 * sum)/9</span>
<a name="l01942"></a>01942 <span class="comment"> *  where sum is in set {0, ... ,9}</span>
<a name="l01943"></a>01943 <span class="comment"> */</span>
<a name="l01944"></a>01944 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *
<a name="l01945"></a><a class="code" href="scalelow_8c.html#a85ef3b0321bdb8b824caadad419c596e">01945</a> <a class="code" href="leptprotos_8h.html#a816198aa07e79f16736501a2733a7614">makeValTabSG3</a>(<span class="keywordtype">void</span>)
<a name="l01946"></a>01946 {
<a name="l01947"></a>01947 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   i;
<a name="l01948"></a>01948 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>  *tab;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeValTabSG3&quot;</span>);
<a name="l01951"></a>01951 
<a name="l01952"></a>01952     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(10, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01953"></a>01953         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++)
<a name="l01956"></a>01956         tab[i] = 0xff - (i * 255) / 9;
<a name="l01957"></a>01957 
<a name="l01958"></a>01958     <span class="keywordflow">return</span> tab;
<a name="l01959"></a>01959 }
<a name="l01960"></a>01960 
<a name="l01961"></a>01961 
<a name="l01962"></a>01962 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l01963"></a>01963 <span class="comment"> *                         Scale-to-gray 4x                         *</span>
<a name="l01964"></a>01964 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01965"></a>01965 <span class="comment">/*!</span>
<a name="l01966"></a>01966 <span class="comment"> *  scaleToGray4Low()</span>
<a name="l01967"></a>01967 <span class="comment"> *</span>
<a name="l01968"></a>01968 <span class="comment"> *      Input:  usual image variables</span>
<a name="l01969"></a>01969 <span class="comment"> *              sumtab  (made from makeSumTabSG4())</span>
<a name="l01970"></a>01970 <span class="comment"> *              valtab  (made from makeValTabSG4())</span>
<a name="l01971"></a>01971 <span class="comment"> *      Return: 0 if OK; 1 on error.</span>
<a name="l01972"></a>01972 <span class="comment"> *</span>
<a name="l01973"></a>01973 <span class="comment"> *  The output is processed in sets of 2 output bytes on a row,</span>
<a name="l01974"></a>01974 <span class="comment"> *  corresponding to 2 4x4 bit-blocks in the input image.</span>
<a name="l01975"></a>01975 <span class="comment"> *  Two lookup tables are used.  The first, sumtab, gets the</span>
<a name="l01976"></a>01976 <span class="comment"> *  sum of ON pixels in two sets of four adjacent bits,</span>
<a name="l01977"></a>01977 <span class="comment"> *  storing the result in 2 adjacent bytes.  After sums from</span>
<a name="l01978"></a>01978 <span class="comment"> *  four rows have been added, the second table, valtab,</span>
<a name="l01979"></a>01979 <span class="comment"> *  converts from the sum of ON pixels in the 4x4 block to</span>
<a name="l01980"></a>01980 <span class="comment"> *  an 8 bpp grayscale value between 0 (for 16 bits ON)</span>
<a name="l01981"></a>01981 <span class="comment"> *  and 255 (for 0 bits ON).</span>
<a name="l01982"></a>01982 <span class="comment"> */</span>
<a name="l01983"></a>01983 <span class="keywordtype">void</span>
<a name="l01984"></a><a class="code" href="scalelow_8c.html#a85ea1bd38387d4c18b3422f0efdb8ad9">01984</a> <a class="code" href="leptprotos_8h.html#a41a5c1ab3a3c18e628e016b5fa1ab474">scaleToGray4Low</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l01985"></a>01985                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l01986"></a>01986                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l01987"></a>01987                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l01988"></a>01988                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l01989"></a>01989                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l01990"></a>01990                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *sumtab,
<a name="l01991"></a>01991                 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>   *valtab)
<a name="l01992"></a>01992 {
<a name="l01993"></a>01993 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, l, k;
<a name="l01994"></a>01994 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   sbyte1, sbyte2, sbyte3, sbyte4, sum;
<a name="l01995"></a>01995 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l01996"></a>01996 
<a name="l01997"></a>01997         <span class="comment">/* i indexes the dest lines</span>
<a name="l01998"></a>01998 <span class="comment">         * l indexes the source lines</span>
<a name="l01999"></a>01999 <span class="comment">         * j indexes the dest bytes</span>
<a name="l02000"></a>02000 <span class="comment">         * k indexes the source bytes</span>
<a name="l02001"></a>02001 <span class="comment">         * We take four bytes from the source (in 4 lines of 8 pixels</span>
<a name="l02002"></a>02002 <span class="comment">         * each) and convert it into two 8 bpp bytes of the dest. */</span>
<a name="l02003"></a>02003     <span class="keywordflow">for</span> (i = 0, l = 0; i &lt; hd; i++, l += 4) {
<a name="l02004"></a>02004         lines = datas + l * wpls;
<a name="l02005"></a>02005         lined = datad + i * wpld; 
<a name="l02006"></a>02006         <span class="keywordflow">for</span> (j = 0, k = 0; j &lt; wd; j += 2, k++) {
<a name="l02007"></a>02007             sbyte1 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k);
<a name="l02008"></a>02008             sbyte2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k);
<a name="l02009"></a>02009             sbyte3 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, k);
<a name="l02010"></a>02010             sbyte4 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 3 * wpls, k);
<a name="l02011"></a>02011             sum = sumtab[sbyte1] + sumtab[sbyte2] +
<a name="l02012"></a>02012                   sumtab[sbyte3] + sumtab[sbyte4];
<a name="l02013"></a>02013             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 2)]);
<a name="l02014"></a>02014             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 1, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l02015"></a>02015         }
<a name="l02016"></a>02016     }
<a name="l02017"></a>02017 
<a name="l02018"></a>02018     <span class="keywordflow">return</span>;
<a name="l02019"></a>02019 }
<a name="l02020"></a>02020 
<a name="l02021"></a>02021 <span class="comment"></span>
<a name="l02022"></a>02022 <span class="comment">/*!</span>
<a name="l02023"></a>02023 <span class="comment"> *  makeSumTabSG4()</span>
<a name="l02024"></a>02024 <span class="comment"> *         </span>
<a name="l02025"></a>02025 <span class="comment"> *  Returns a table of 256 l_uint32s, giving the two output</span>
<a name="l02026"></a>02026 <span class="comment"> *  8-bit grayscale sums corresponding to 8 input bits of a binary</span>
<a name="l02027"></a>02027 <span class="comment"> *  image, for a 4x scale-to-gray op.  The sums from four</span>
<a name="l02028"></a>02028 <span class="comment"> *  adjacent scanlines are then added and transformed to</span>
<a name="l02029"></a>02029 <span class="comment"> *  output 8 bpp pixel values, using makeValTabSG4().</span>
<a name="l02030"></a>02030 <span class="comment"> */</span>
<a name="l02031"></a>02031 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *
<a name="l02032"></a><a class="code" href="scalelow_8c.html#a3ea5827cbcd52c55e0e8cd949bc5b746">02032</a> <a class="code" href="leptprotos_8h.html#a0c0304ed6a0dd7e88e8791b7af40e814">makeSumTabSG4</a>(<span class="keywordtype">void</span>)
<a name="l02033"></a>02033 {
<a name="l02034"></a>02034 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i;
<a name="l02035"></a>02035 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    sum[] = {0, 1, 1, 2, 1, 2, 2, 3, 1, 2, 2, 3, 2, 3, 3, 4};
<a name="l02036"></a>02036 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *tab;
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeSumTabSG4&quot;</span>);
<a name="l02039"></a>02039 
<a name="l02040"></a>02040     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(256, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02041"></a>02041         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02042"></a>02042 
<a name="l02043"></a>02043         <span class="comment">/* Pack the two sums separately in two bytes */</span>
<a name="l02044"></a>02044     <span class="keywordflow">for</span> (i = 0; i &lt; 256; i++) {
<a name="l02045"></a>02045         tab[i] = (sum[i &amp; 0xf]) | (sum[(i &gt;&gt; 4) &amp; 0xf] &lt;&lt; 8);
<a name="l02046"></a>02046     }
<a name="l02047"></a>02047 
<a name="l02048"></a>02048     <span class="keywordflow">return</span> tab;
<a name="l02049"></a>02049 }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051 <span class="comment"></span>
<a name="l02052"></a>02052 <span class="comment">/*!</span>
<a name="l02053"></a>02053 <span class="comment"> *  makeValTabSG4()</span>
<a name="l02054"></a>02054 <span class="comment"> *         </span>
<a name="l02055"></a>02055 <span class="comment"> *  Returns an 8 bit value for the sum of ON pixels</span>
<a name="l02056"></a>02056 <span class="comment"> *  in a 4x4 square, according to</span>
<a name="l02057"></a>02057 <span class="comment"> *</span>
<a name="l02058"></a>02058 <span class="comment"> *         val = 255 - (255 * sum)/16</span>
<a name="l02059"></a>02059 <span class="comment"> *</span>
<a name="l02060"></a>02060 <span class="comment"> *  where sum is in set {0, ... ,16}</span>
<a name="l02061"></a>02061 <span class="comment"> */</span>
<a name="l02062"></a>02062 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *
<a name="l02063"></a><a class="code" href="scalelow_8c.html#aec4315d8573eae1dc524ec79a6997cbe">02063</a> <a class="code" href="leptprotos_8h.html#a48a49271262147b91eef69297b678c7e">makeValTabSG4</a>(<span class="keywordtype">void</span>)
<a name="l02064"></a>02064 {
<a name="l02065"></a>02065 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   i;
<a name="l02066"></a>02066 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>  *tab;
<a name="l02067"></a>02067 
<a name="l02068"></a>02068     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeValTabSG4&quot;</span>);
<a name="l02069"></a>02069 
<a name="l02070"></a>02070     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(17, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02071"></a>02071         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02072"></a>02072 
<a name="l02073"></a>02073     <span class="keywordflow">for</span> (i = 0; i &lt; 17; i++)
<a name="l02074"></a>02074         tab[i] = 0xff - (i * 255) / 16;
<a name="l02075"></a>02075 
<a name="l02076"></a>02076     <span class="keywordflow">return</span> tab;
<a name="l02077"></a>02077 }
<a name="l02078"></a>02078 
<a name="l02079"></a>02079 
<a name="l02080"></a>02080 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l02081"></a>02081 <span class="comment"> *                         Scale-to-gray 6x                         *</span>
<a name="l02082"></a>02082 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l02083"></a>02083 <span class="comment">/*!</span>
<a name="l02084"></a>02084 <span class="comment"> *  scaleToGray6Low()</span>
<a name="l02085"></a>02085 <span class="comment"> *</span>
<a name="l02086"></a>02086 <span class="comment"> *      Input:  usual image variables</span>
<a name="l02087"></a>02087 <span class="comment"> *              tab8  (made from makePixelSumTab8())</span>
<a name="l02088"></a>02088 <span class="comment"> *              valtab  (made from makeValTabSG6())</span>
<a name="l02089"></a>02089 <span class="comment"> *      Return: 0 if OK; 1 on error</span>
<a name="l02090"></a>02090 <span class="comment"> *</span>
<a name="l02091"></a>02091 <span class="comment"> *  Each set of 4 6x6 bit-blocks in the source image, which</span>
<a name="l02092"></a>02092 <span class="comment"> *  consist of 144 pixels arranged 24 pixels wide by 6 scanlines,</span>
<a name="l02093"></a>02093 <span class="comment"> *  is converted to a row of 4 8-bit pixels in the dest image.</span>
<a name="l02094"></a>02094 <span class="comment"> *  These 144 pixels of the input image are runs of 24 pixels</span>
<a name="l02095"></a>02095 <span class="comment"> *  in six adjacent scanlines.  Each run of 24 pixels is</span>
<a name="l02096"></a>02096 <span class="comment"> *  stored in the 24 LSbits of a 32-bit word.  We use 2 LUTs.</span>
<a name="l02097"></a>02097 <span class="comment"> *  The first, tab8, takes 6 of these bits and stores</span>
<a name="l02098"></a>02098 <span class="comment"> *  sum in one byte.  This is done for each of the 6 scanlines,</span>
<a name="l02099"></a>02099 <span class="comment"> *  and the results are added.</span>
<a name="l02100"></a>02100 <span class="comment"> *  We now have the sum of ON pixels in the first 6x6 block.  The</span>
<a name="l02101"></a>02101 <span class="comment"> *  valtab LUT then converts these values (which go from 0 to 36) to</span>
<a name="l02102"></a>02102 <span class="comment"> *  grayscale values between between 255 and 0.  (See makeValTabSG6).</span>
<a name="l02103"></a>02103 <span class="comment"> *  This process is repeated for each of the other 3 sets of</span>
<a name="l02104"></a>02104 <span class="comment"> *  6x6 input pixels, giving 4 output pixels in total.</span>
<a name="l02105"></a>02105 <span class="comment"> *</span>
<a name="l02106"></a>02106 <span class="comment"> *  Note: because the input image is processed in groups of</span>
<a name="l02107"></a>02107 <span class="comment"> *        24 x 6 pixels, the process clips the input height to</span>
<a name="l02108"></a>02108 <span class="comment"> *        (h - h % 6) and the input width to (w - w % 24).</span>
<a name="l02109"></a>02109 <span class="comment"> *</span>
<a name="l02110"></a>02110 <span class="comment"> */</span>
<a name="l02111"></a>02111 <span class="keywordtype">void</span>
<a name="l02112"></a><a class="code" href="scalelow_8c.html#a07d63691356511ef4d5ed0458fc53afd">02112</a> <a class="code" href="leptprotos_8h.html#a2b3921f340b2ea97254cd13a5aa9838c">scaleToGray6Low</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l02113"></a>02113                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l02114"></a>02114                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l02115"></a>02115                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l02116"></a>02116                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l02117"></a>02117                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l02118"></a>02118                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *tab8,
<a name="l02119"></a>02119                 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>   *valtab)
<a name="l02120"></a>02120 {
<a name="l02121"></a>02121 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, l, k;
<a name="l02122"></a>02122 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   threebytes1, threebytes2, threebytes3;
<a name="l02123"></a>02123 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>   threebytes4, threebytes5, threebytes6, sum;
<a name="l02124"></a>02124 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l02125"></a>02125 
<a name="l02126"></a>02126         <span class="comment">/* i indexes the dest lines</span>
<a name="l02127"></a>02127 <span class="comment">         * l indexes the source lines</span>
<a name="l02128"></a>02128 <span class="comment">         * j indexes the dest bytes</span>
<a name="l02129"></a>02129 <span class="comment">         * k indexes the source bytes</span>
<a name="l02130"></a>02130 <span class="comment">         * We take 18 bytes from the source (144 binary pixels</span>
<a name="l02131"></a>02131 <span class="comment">         * in six lines of 24 pixels each) and convert it</span>
<a name="l02132"></a>02132 <span class="comment">         * into 4 bytes of the dest (four 8 bpp pixels in one line)   */</span>
<a name="l02133"></a>02133     <span class="keywordflow">for</span> (i = 0, l = 0; i &lt; hd; i++, l += 6) {
<a name="l02134"></a>02134         lines = datas + l * wpls;
<a name="l02135"></a>02135         lined = datad + i * wpld; 
<a name="l02136"></a>02136         <span class="keywordflow">for</span> (j = 0, k = 0; j &lt; wd; j += 4, k += 3) {
<a name="l02137"></a>02137                 <span class="comment">/* First grab the 18 bytes, 3 at a time, and put each set</span>
<a name="l02138"></a>02138 <span class="comment">                 * of 3 bytes into the LS bytes of a 32-bit word. */</span>
<a name="l02139"></a>02139             threebytes1 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k) &lt;&lt; 16) |
<a name="l02140"></a>02140                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k + 1) &lt;&lt; 8) |
<a name="l02141"></a>02141                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, k + 2);
<a name="l02142"></a>02142             threebytes2 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k) &lt;&lt; 16) |
<a name="l02143"></a>02143                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k + 1) &lt;&lt; 8) |
<a name="l02144"></a>02144                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, k + 2);
<a name="l02145"></a>02145             threebytes3 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, k) &lt;&lt; 16) |
<a name="l02146"></a>02146                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, k + 1) &lt;&lt; 8) |
<a name="l02147"></a>02147                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, k + 2);
<a name="l02148"></a>02148             threebytes4 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 3 * wpls, k) &lt;&lt; 16) |
<a name="l02149"></a>02149                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 3 * wpls, k + 1) &lt;&lt; 8) |
<a name="l02150"></a>02150                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 3 * wpls, k + 2);
<a name="l02151"></a>02151             threebytes5 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 4 * wpls, k) &lt;&lt; 16) |
<a name="l02152"></a>02152                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 4 * wpls, k + 1) &lt;&lt; 8) |
<a name="l02153"></a>02153                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 4 * wpls, k + 2);
<a name="l02154"></a>02154             threebytes6 = (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 5 * wpls, k) &lt;&lt; 16) |
<a name="l02155"></a>02155                           (<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 5 * wpls, k + 1) &lt;&lt; 8) |
<a name="l02156"></a>02156                           <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 5 * wpls, k + 2);
<a name="l02157"></a>02157 
<a name="l02158"></a>02158                 <span class="comment">/* Sum first set of 36 bits and convert to 0-255 */</span>
<a name="l02159"></a>02159             sum = tab8[(threebytes1 &gt;&gt; 18)] +
<a name="l02160"></a>02160                   tab8[(threebytes2 &gt;&gt; 18)] +
<a name="l02161"></a>02161                   tab8[(threebytes3 &gt;&gt; 18)] +
<a name="l02162"></a>02162                   tab8[(threebytes4 &gt;&gt; 18)] +
<a name="l02163"></a>02163                   tab8[(threebytes5 &gt;&gt; 18)] +
<a name="l02164"></a>02164                    tab8[(threebytes6 &gt;&gt; 18)];
<a name="l02165"></a>02165             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l02166"></a>02166 
<a name="l02167"></a>02167                 <span class="comment">/* Ditto for second set */</span>
<a name="l02168"></a>02168             sum = tab8[((threebytes1 &gt;&gt; 12) &amp; 0x3f)] +
<a name="l02169"></a>02169                   tab8[((threebytes2 &gt;&gt; 12) &amp; 0x3f)] +
<a name="l02170"></a>02170                   tab8[((threebytes3 &gt;&gt; 12) &amp; 0x3f)] +
<a name="l02171"></a>02171                   tab8[((threebytes4 &gt;&gt; 12) &amp; 0x3f)] +
<a name="l02172"></a>02172                   tab8[((threebytes5 &gt;&gt; 12) &amp; 0x3f)] +
<a name="l02173"></a>02173                   tab8[((threebytes6 &gt;&gt; 12) &amp; 0x3f)];
<a name="l02174"></a>02174             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 1, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l02175"></a>02175 
<a name="l02176"></a>02176             sum = tab8[((threebytes1 &gt;&gt; 6) &amp; 0x3f)] +
<a name="l02177"></a>02177                   tab8[((threebytes2 &gt;&gt; 6) &amp; 0x3f)] +
<a name="l02178"></a>02178                   tab8[((threebytes3 &gt;&gt; 6) &amp; 0x3f)] +
<a name="l02179"></a>02179                   tab8[((threebytes4 &gt;&gt; 6) &amp; 0x3f)] +
<a name="l02180"></a>02180                   tab8[((threebytes5 &gt;&gt; 6) &amp; 0x3f)] +
<a name="l02181"></a>02181                   tab8[((threebytes6 &gt;&gt; 6) &amp; 0x3f)];
<a name="l02182"></a>02182             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 2, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l02183"></a>02183 
<a name="l02184"></a>02184             sum = tab8[(threebytes1 &amp; 0x3f)] +
<a name="l02185"></a>02185                   tab8[(threebytes2 &amp; 0x3f)] +
<a name="l02186"></a>02186                   tab8[(threebytes3 &amp; 0x3f)] +
<a name="l02187"></a>02187                   tab8[(threebytes4 &amp; 0x3f)] +
<a name="l02188"></a>02188                   tab8[(threebytes5 &amp; 0x3f)] +
<a name="l02189"></a>02189                   tab8[(threebytes6 &amp; 0x3f)];
<a name="l02190"></a>02190             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j + 3, valtab[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(&amp;sum, 3)]);
<a name="l02191"></a>02191         }
<a name="l02192"></a>02192     }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194     <span class="keywordflow">return</span>;
<a name="l02195"></a>02195 }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197 <span class="comment"></span>
<a name="l02198"></a>02198 <span class="comment">/*!</span>
<a name="l02199"></a>02199 <span class="comment"> *  makeValTabSG6()</span>
<a name="l02200"></a>02200 <span class="comment"> *         </span>
<a name="l02201"></a>02201 <span class="comment"> *  Returns an 8 bit value for the sum of ON pixels</span>
<a name="l02202"></a>02202 <span class="comment"> *  in a 6x6 square, according to</span>
<a name="l02203"></a>02203 <span class="comment"> *      val = 255 - (255 * sum)/36</span>
<a name="l02204"></a>02204 <span class="comment"> *  where sum is in set {0, ... ,36}</span>
<a name="l02205"></a>02205 <span class="comment"> */</span>
<a name="l02206"></a>02206 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *
<a name="l02207"></a><a class="code" href="scalelow_8c.html#a7464e2122dbc5af586231de2e666ec51">02207</a> <a class="code" href="leptprotos_8h.html#a4e22341eb0683723e3b7133969a0276a">makeValTabSG6</a>(<span class="keywordtype">void</span>)
<a name="l02208"></a>02208 {
<a name="l02209"></a>02209 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   i;
<a name="l02210"></a>02210 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>  *tab;
<a name="l02211"></a>02211 
<a name="l02212"></a>02212     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeValTabSG6&quot;</span>);
<a name="l02213"></a>02213 
<a name="l02214"></a>02214     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(37, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02215"></a>02215         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02216"></a>02216 
<a name="l02217"></a>02217     <span class="keywordflow">for</span> (i = 0; i &lt; 37; i++)
<a name="l02218"></a>02218         tab[i] = 0xff - (i * 255) / 36;
<a name="l02219"></a>02219 
<a name="l02220"></a>02220     <span class="keywordflow">return</span> tab;
<a name="l02221"></a>02221 }
<a name="l02222"></a>02222 
<a name="l02223"></a>02223 
<a name="l02224"></a>02224 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l02225"></a>02225 <span class="comment"> *                         Scale-to-gray 8x                         *</span>
<a name="l02226"></a>02226 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l02227"></a>02227 <span class="comment">/*!</span>
<a name="l02228"></a>02228 <span class="comment"> *  scaleToGray8Low()</span>
<a name="l02229"></a>02229 <span class="comment"> *</span>
<a name="l02230"></a>02230 <span class="comment"> *      Input:  usual image variables</span>
<a name="l02231"></a>02231 <span class="comment"> *              tab8  (made from makePixelSumTab8())</span>
<a name="l02232"></a>02232 <span class="comment"> *              valtab  (made from makeValTabSG8())</span>
<a name="l02233"></a>02233 <span class="comment"> *      Return: 0 if OK; 1 on error.</span>
<a name="l02234"></a>02234 <span class="comment"> *</span>
<a name="l02235"></a>02235 <span class="comment"> *  The output is processed one dest byte at a time,</span>
<a name="l02236"></a>02236 <span class="comment"> *  corresponding to 8 rows of src bytes in the input image.</span>
<a name="l02237"></a>02237 <span class="comment"> *  Two lookup tables are used.  The first, tab8, gets the</span>
<a name="l02238"></a>02238 <span class="comment"> *  sum of ON pixels in a byte.  After sums from 8 rows have</span>
<a name="l02239"></a>02239 <span class="comment"> *  been added, the second table, valtab, converts from this</span>
<a name="l02240"></a>02240 <span class="comment"> *  value (which is between 0 and 64) to an 8 bpp grayscale</span>
<a name="l02241"></a>02241 <span class="comment"> *  value between 0 (for all 64 bits ON) and 255 (for 0 bits ON).</span>
<a name="l02242"></a>02242 <span class="comment"> */</span>
<a name="l02243"></a>02243 <span class="keywordtype">void</span>
<a name="l02244"></a><a class="code" href="scalelow_8c.html#a45747b96d255cff419f51091af7952c0">02244</a> <a class="code" href="leptprotos_8h.html#ad3a5584d750aca2612a6e47c15e1acbe">scaleToGray8Low</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l02245"></a>02245                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l02246"></a>02246                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l02247"></a>02247                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l02248"></a>02248                 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l02249"></a>02249                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l02250"></a>02250                 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *tab8,
<a name="l02251"></a>02251                 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>   *valtab)
<a name="l02252"></a>02252 {
<a name="l02253"></a>02253 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, k;
<a name="l02254"></a>02254 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    sbyte0, sbyte1, sbyte2, sbyte3, sbyte4, sbyte5, sbyte6, sbyte7, sum;
<a name="l02255"></a>02255 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l02256"></a>02256 
<a name="l02257"></a>02257         <span class="comment">/* i indexes the dest lines</span>
<a name="l02258"></a>02258 <span class="comment">         * k indexes the source lines</span>
<a name="l02259"></a>02259 <span class="comment">         * j indexes the src and dest bytes</span>
<a name="l02260"></a>02260 <span class="comment">         * We take 8 bytes from the source (in 8 lines of 8 pixels</span>
<a name="l02261"></a>02261 <span class="comment">         * each) and convert it into one 8 bpp byte of the dest. */</span>
<a name="l02262"></a>02262     <span class="keywordflow">for</span> (i = 0, k = 0; i &lt; hd; i++, k += 8) {
<a name="l02263"></a>02263         lines = datas + k * wpls;
<a name="l02264"></a>02264         lined = datad + i * wpld; 
<a name="l02265"></a>02265         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l02266"></a>02266             sbyte0 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, j);
<a name="l02267"></a>02267             sbyte1 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, j);
<a name="l02268"></a>02268             sbyte2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, j);
<a name="l02269"></a>02269             sbyte3 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 3 * wpls, j);
<a name="l02270"></a>02270             sbyte4 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 4 * wpls, j);
<a name="l02271"></a>02271             sbyte5 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 5 * wpls, j);
<a name="l02272"></a>02272             sbyte6 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 6 * wpls, j);
<a name="l02273"></a>02273             sbyte7 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 7 * wpls, j);
<a name="l02274"></a>02274             sum = tab8[sbyte0] + tab8[sbyte1] +
<a name="l02275"></a>02275                   tab8[sbyte2] + tab8[sbyte3] +
<a name="l02276"></a>02276                   tab8[sbyte4] + tab8[sbyte5] +
<a name="l02277"></a>02277                   tab8[sbyte6] + tab8[sbyte7];
<a name="l02278"></a>02278             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, valtab[sum]);
<a name="l02279"></a>02279         }
<a name="l02280"></a>02280     }
<a name="l02281"></a>02281 
<a name="l02282"></a>02282     <span class="keywordflow">return</span>;
<a name="l02283"></a>02283 }
<a name="l02284"></a>02284 
<a name="l02285"></a>02285 <span class="comment"></span>
<a name="l02286"></a>02286 <span class="comment">/*!</span>
<a name="l02287"></a>02287 <span class="comment"> *  makeValTabSG8()</span>
<a name="l02288"></a>02288 <span class="comment"> *         </span>
<a name="l02289"></a>02289 <span class="comment"> *  Returns an 8 bit value for the sum of ON pixels</span>
<a name="l02290"></a>02290 <span class="comment"> *  in an 8x8 square, according to</span>
<a name="l02291"></a>02291 <span class="comment"> *      val = 255 - (255 * sum)/64</span>
<a name="l02292"></a>02292 <span class="comment"> *  where sum is in set {0, ... ,64}</span>
<a name="l02293"></a>02293 <span class="comment"> */</span>
<a name="l02294"></a>02294 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *
<a name="l02295"></a><a class="code" href="scalelow_8c.html#a508ab0ecbc68053d0b7cf4100bf55f65">02295</a> <a class="code" href="leptprotos_8h.html#a84985477c21e8a7e81c66353e39d8c96">makeValTabSG8</a>(<span class="keywordtype">void</span>)
<a name="l02296"></a>02296 {
<a name="l02297"></a>02297 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   i;
<a name="l02298"></a>02298 <a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>  *tab;
<a name="l02299"></a>02299 
<a name="l02300"></a>02300     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;makeValTabSG8&quot;</span>);
<a name="l02301"></a>02301 
<a name="l02302"></a>02302     <span class="keywordflow">if</span> ((tab = (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(65, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02303"></a>02303         <span class="keywordflow">return</span> (<a class="code" href="environ_8h.html#a7ed60554e7d6dd89aca643189b1e70ad">l_uint8</a> *)<a class="code" href="environ_8h.html#a38a8310a83847948c9ce6620983be468">ERROR_PTR</a>(<span class="stringliteral">&quot;calloc fail for tab&quot;</span>, procName, <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02304"></a>02304 
<a name="l02305"></a>02305     <span class="keywordflow">for</span> (i = 0; i &lt; 65; i++)
<a name="l02306"></a>02306         tab[i] = 0xff - (i * 255) / 64;
<a name="l02307"></a>02307 
<a name="l02308"></a>02308     <span class="keywordflow">return</span> tab;
<a name="l02309"></a>02309 }
<a name="l02310"></a>02310 
<a name="l02311"></a>02311 
<a name="l02312"></a>02312 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l02313"></a>02313 <span class="comment"> *                         Scale-to-gray 16x                        *</span>
<a name="l02314"></a>02314 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l02315"></a>02315 <span class="comment">/*!</span>
<a name="l02316"></a>02316 <span class="comment"> *  scaleToGray16Low()</span>
<a name="l02317"></a>02317 <span class="comment"> *</span>
<a name="l02318"></a>02318 <span class="comment"> *      Input:  usual image variables</span>
<a name="l02319"></a>02319 <span class="comment"> *              tab8  (made from makePixelSumTab8())</span>
<a name="l02320"></a>02320 <span class="comment"> *      Return: 0 if OK; 1 on error.</span>
<a name="l02321"></a>02321 <span class="comment"> *</span>
<a name="l02322"></a>02322 <span class="comment"> *  The output is processed one dest byte at a time, corresponding</span>
<a name="l02323"></a>02323 <span class="comment"> *  to 16 rows consisting each of 2 src bytes in the input image.</span>
<a name="l02324"></a>02324 <span class="comment"> *  This uses one lookup table, tab8, which gives the sum of</span>
<a name="l02325"></a>02325 <span class="comment"> *  ON pixels in a byte.  After summing for all ON pixels in the</span>
<a name="l02326"></a>02326 <span class="comment"> *  32 src bytes, which is between 0 and 256, this is converted</span>
<a name="l02327"></a>02327 <span class="comment"> *  to an 8 bpp grayscale value between 0 (for 255 or 256 bits ON)</span>
<a name="l02328"></a>02328 <span class="comment"> *  and 255 (for 0 bits ON).</span>
<a name="l02329"></a>02329 <span class="comment"> */</span>
<a name="l02330"></a>02330 <span class="keywordtype">void</span>
<a name="l02331"></a><a class="code" href="scalelow_8c.html#ab0b0ddc2fb9b1b6c36db61e4749972bd">02331</a> <a class="code" href="leptprotos_8h.html#a17c4a960a07536d47acb976238c3ce6b">scaleToGray16Low</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l02332"></a>02332                   <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l02333"></a>02333                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l02334"></a>02334                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l02335"></a>02335                  <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas,
<a name="l02336"></a>02336                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls,
<a name="l02337"></a>02337                  <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *tab8)
<a name="l02338"></a>02338 {
<a name="l02339"></a>02339 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, k, m;
<a name="l02340"></a>02340 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    sum;
<a name="l02341"></a>02341 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines, *lined;
<a name="l02342"></a>02342 
<a name="l02343"></a>02343         <span class="comment">/* i indexes the dest lines</span>
<a name="l02344"></a>02344 <span class="comment">         * k indexes the source lines</span>
<a name="l02345"></a>02345 <span class="comment">         * j indexes the dest bytes</span>
<a name="l02346"></a>02346 <span class="comment">         * m indexes the src bytes</span>
<a name="l02347"></a>02347 <span class="comment">         * We take 32 bytes from the source (in 16 lines of 16 pixels</span>
<a name="l02348"></a>02348 <span class="comment">         * each) and convert it into one 8 bpp byte of the dest. */</span>
<a name="l02349"></a>02349     <span class="keywordflow">for</span> (i = 0, k = 0; i &lt; hd; i++, k += 16) {
<a name="l02350"></a>02350         lines = datas + k * wpls;
<a name="l02351"></a>02351         lined = datad + i * wpld; 
<a name="l02352"></a>02352         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l02353"></a>02353             m = 2 * j;
<a name="l02354"></a>02354             sum = tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, m)];
<a name="l02355"></a>02355             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines, m + 1)];
<a name="l02356"></a>02356             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, m)];
<a name="l02357"></a>02357             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + wpls, m + 1)];
<a name="l02358"></a>02358             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, m)];
<a name="l02359"></a>02359             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 2 * wpls, m + 1)];
<a name="l02360"></a>02360             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 3 * wpls, m)];
<a name="l02361"></a>02361             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 3 * wpls, m + 1)];
<a name="l02362"></a>02362             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 4 * wpls, m)];
<a name="l02363"></a>02363             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 4 * wpls, m + 1)];
<a name="l02364"></a>02364             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 5 * wpls, m)];
<a name="l02365"></a>02365             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 5 * wpls, m + 1)];
<a name="l02366"></a>02366             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 6 * wpls, m)];
<a name="l02367"></a>02367             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 6 * wpls, m + 1)];
<a name="l02368"></a>02368             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 7 * wpls, m)];
<a name="l02369"></a>02369             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 7 * wpls, m + 1)];
<a name="l02370"></a>02370             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 8 * wpls, m)];
<a name="l02371"></a>02371             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 8 * wpls, m + 1)];
<a name="l02372"></a>02372             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 9 * wpls, m)];
<a name="l02373"></a>02373             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 9 * wpls, m + 1)];
<a name="l02374"></a>02374             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 10 * wpls, m)];
<a name="l02375"></a>02375             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 10 * wpls, m + 1)];
<a name="l02376"></a>02376             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 11 * wpls, m)];
<a name="l02377"></a>02377             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 11 * wpls, m + 1)];
<a name="l02378"></a>02378             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 12 * wpls, m)];
<a name="l02379"></a>02379             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 12 * wpls, m + 1)];
<a name="l02380"></a>02380             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 13 * wpls, m)];
<a name="l02381"></a>02381             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 13 * wpls, m + 1)];
<a name="l02382"></a>02382             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 14 * wpls, m)];
<a name="l02383"></a>02383             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 14 * wpls, m + 1)];
<a name="l02384"></a>02384             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 15 * wpls, m)];
<a name="l02385"></a>02385             sum += tab8[<a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines + 15 * wpls, m + 1)];
<a name="l02386"></a>02386             sum = <a class="code" href="environ_8h.html#a67d588ee5ca71be19990efb07fa2ce72">L_MIN</a>(sum, 255);
<a name="l02387"></a>02387             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, 255 - sum);
<a name="l02388"></a>02388         }
<a name="l02389"></a>02389     }
<a name="l02390"></a>02390 
<a name="l02391"></a>02391     <span class="keywordflow">return</span>;
<a name="l02392"></a>02392 }
<a name="l02393"></a>02393 
<a name="l02394"></a>02394 
<a name="l02395"></a>02395 
<a name="l02396"></a>02396 <span class="comment">/*------------------------------------------------------------------*</span>
<a name="l02397"></a>02397 <span class="comment"> *                         Grayscale mipmap                         *</span>
<a name="l02398"></a>02398 <span class="comment"> *------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l02399"></a>02399 <span class="comment">/*!</span>
<a name="l02400"></a>02400 <span class="comment"> *  scaleMipmapLow()</span>
<a name="l02401"></a>02401 <span class="comment"> *</span>
<a name="l02402"></a>02402 <span class="comment"> *  See notes in scale.c for pixScaleToGrayMipmap().  This function</span>
<a name="l02403"></a>02403 <span class="comment"> *  is here for pedagogical reasons.  It gives poor results on document</span>
<a name="l02404"></a>02404 <span class="comment"> *  images because of aliasing.</span>
<a name="l02405"></a>02405 <span class="comment"> */</span>
<a name="l02406"></a>02406 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>
<a name="l02407"></a><a class="code" href="scalelow_8c.html#a7f4c020fc637467e19d4ef690b87ce61">02407</a> <a class="code" href="leptprotos_8h.html#a47b85cc3632882162f0e733b58df94f4">scaleMipmapLow</a>(<a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datad,
<a name="l02408"></a>02408                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wd,
<a name="l02409"></a>02409                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    hd,
<a name="l02410"></a>02410                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpld,
<a name="l02411"></a>02411                <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas1,
<a name="l02412"></a>02412                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls1,
<a name="l02413"></a>02413                <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *datas2,
<a name="l02414"></a>02414                <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    wpls2,
<a name="l02415"></a>02415                <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  red)
<a name="l02416"></a>02416 {
<a name="l02417"></a>02417 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>    i, j, val1, val2, val, row2, col2;
<a name="l02418"></a>02418 <a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>   *srow, *scol;
<a name="l02419"></a>02419 <a class="code" href="environ_8h.html#a4d4d7254020fc95aef5dde8884405358">l_uint32</a>  *lines1, *lines2, *lined;
<a name="l02420"></a>02420 <a class="code" href="environ_8h.html#af59419416d96ecf5fca70c8d05adb456">l_float32</a>  ratio, w1, w2;
<a name="l02421"></a>02421 
<a name="l02422"></a>02422     <a class="code" href="environ_8h.html#a1a16952819bcbc526c998e3ac86f2e78">PROCNAME</a>(<span class="stringliteral">&quot;scaleMipmapLow&quot;</span>);
<a name="l02423"></a>02423 
<a name="l02424"></a>02424         <span class="comment">/* Clear dest */</span>
<a name="l02425"></a>02425     memset((<span class="keywordtype">char</span> *)datad, 0, 4 * wpld * hd);
<a name="l02426"></a>02426     
<a name="l02427"></a>02427         <span class="comment">/* Each dest pixel at (j,i) is computed by interpolating</span>
<a name="l02428"></a>02428 <span class="comment">           between the two src images at the corresponding location.</span>
<a name="l02429"></a>02429 <span class="comment">           We store the UL corner locations of the square of</span>
<a name="l02430"></a>02430 <span class="comment">           src pixels in thelower-resolution image that correspond</span>
<a name="l02431"></a>02431 <span class="comment">           to dest pixel (j,i).  The are labelled by the arrays</span>
<a name="l02432"></a>02432 <span class="comment">           srow[i], scol[j].  The UL corner locations of the higher</span>
<a name="l02433"></a>02433 <span class="comment">           resolution src pixels are obtained from these arrays</span>
<a name="l02434"></a>02434 <span class="comment">           by multiplying by 2. */</span>
<a name="l02435"></a>02435     <span class="keywordflow">if</span> ((srow = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(hd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02436"></a>02436         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;srow not made&quot;</span>, procName, 1);
<a name="l02437"></a>02437     <span class="keywordflow">if</span> ((scol = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a> *)<a class="code" href="environ_8h.html#abc24891c647be0bd23e233d013175da0">CALLOC</a>(wd, <span class="keyword">sizeof</span>(<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>))) == <a class="code" href="environ_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02438"></a>02438         <span class="keywordflow">return</span> <a class="code" href="environ_8h.html#a8b17fe871312c2e1613fa694bb78a963">ERROR_INT</a>(<span class="stringliteral">&quot;scol not made&quot;</span>, procName, 1);
<a name="l02439"></a>02439     ratio = 1. / (2. * red);  <span class="comment">/* 0.5 for red = 1, 1 for red = 0.5 */</span>
<a name="l02440"></a>02440     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++)
<a name="l02441"></a>02441         srow[i] = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(ratio * i);
<a name="l02442"></a>02442     <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++)
<a name="l02443"></a>02443         scol[j] = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(ratio * j);
<a name="l02444"></a>02444 
<a name="l02445"></a>02445         <span class="comment">/* Get weights for linear interpolation: these are the</span>
<a name="l02446"></a>02446 <span class="comment">         * &#39;distances&#39; of the dest image plane from the two</span>
<a name="l02447"></a>02447 <span class="comment">         * src image planes. */</span>
<a name="l02448"></a>02448     w1 = 2. * red - 1.;   <span class="comment">/* w1 --&gt; 1 as red --&gt; 1 */</span>
<a name="l02449"></a>02449     w2 = 1. - w1;
<a name="l02450"></a>02450 
<a name="l02451"></a>02451         <span class="comment">/* For each dest pixel, compute linear interpolation */</span>
<a name="l02452"></a>02452     <span class="keywordflow">for</span> (i = 0; i &lt; hd; i++) {
<a name="l02453"></a>02453         row2 = srow[i];
<a name="l02454"></a>02454         lines1 = datas1 + 2 * row2 * wpls1;
<a name="l02455"></a>02455         lines2 = datas2 + row2 * wpls2;
<a name="l02456"></a>02456         lined = datad + i * wpld;
<a name="l02457"></a>02457         <span class="keywordflow">for</span> (j = 0; j &lt; wd; j++) {
<a name="l02458"></a>02458             col2 = scol[j];
<a name="l02459"></a>02459             val1 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines1, 2 * col2);
<a name="l02460"></a>02460             val2 = <a class="code" href="arrayaccess_8h.html#a9b285094ef3b18d30d8ad13262e61faf">GET_DATA_BYTE</a>(lines2, col2);
<a name="l02461"></a>02461             val = (<a class="code" href="environ_8h.html#a9085c7874153c280a4171244aa052e4e">l_int32</a>)(w1 * val1 + w2 * val2);
<a name="l02462"></a>02462             <a class="code" href="arrayaccess_8h.html#ab5257b730a14910443765f70e6c3d428">SET_DATA_BYTE</a>(lined, j, val);
<a name="l02463"></a>02463         }
<a name="l02464"></a>02464     }
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(srow);
<a name="l02467"></a>02467     <a class="code" href="environ_8h.html#a105949c59c998e38aad80266afac92bf">FREE</a>(scol);
<a name="l02468"></a>02468     <span class="keywordflow">return</span> 0;
<a name="l02469"></a>02469 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="scalelow_8c.html">scalelow.c</a>      </li>
      <li class="footer">Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
